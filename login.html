<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Đăng nhập | Hệ thống Quản lý Sinh Hoạt Hè </title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SHH App">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921222.png">
  
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Youth Union Theme */
    body {
        background: linear-gradient(-45deg, #0052D4, #4364F7, #6FB1FC);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Source Sans Pro', sans-serif;
        overflow: hidden;
        transition: opacity 0.5s ease-out; /* Hiệu ứng chuyển trang */
    }

    /* Galaxy Theme */
    body.theme-galaxy {
        background: #000 url('https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2011&auto=format&fit=crop') no-repeat center center fixed;
        background-size: cover;
        overflow: hidden;
    }

    /* Sunny Theme */
    body.theme-sunny {
        background: linear-gradient(to top, #2980b9, #6dd5fa, #ffffff);
    }
    .sun {
        position: absolute;
        top: -60px;
        right: -60px;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, #ffd200 20%, #f7971e 100%);
        border-radius: 50%;
        box-shadow: 0 0 40px #ff9800, 0 0 80px #ff5722;
        animation: sunShine 4s infinite alternate;
        z-index: 1;
        display: none;
    }
    @keyframes sunShine { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 1; } }

    /* Snow Theme */
    body.theme-snow {
        background: linear-gradient(to bottom, #203a43, #2c5364);
    }
    .snow-container {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; display: none;
    }
    .snowflake {
        position: absolute; top: -20px; color: #fff; font-size: 1.5em; opacity: 0.8; animation: fall linear infinite;
    }
    @keyframes fall { to { transform: translateY(105vh); } }

    /* Matrix Theme */
    body.theme-matrix {
        background: #000;
        animation: none;
    }
    #matrix-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: none;
    }
    #matrix-canvas { display: block; }
    body.theme-matrix .card-glass {
        background: rgba(0, 20, 0, 0.7);
        border: 2px solid #0f0;
        box-shadow: 0 0 20px #0f0, inset 0 0 10px rgba(0, 255, 0, 0.5);
        animation: none; /* Override neon animation */
    }
    body.theme-matrix .form-control,
    body.theme-matrix .input-group-text {
        background: rgba(0, 255, 0, 0.1) !important;
        border-color: rgba(0, 255, 0, 0.4) !important;
        color: #0f0 !important;
    }
    body.theme-matrix .form-control::placeholder { color: rgba(0, 255, 0, 0.5); }
    body.theme-matrix .btn-primary { background-color: #0f0; color: #000; }
    body.theme-matrix .btn-primary:hover { background-color: #fff; box-shadow: 0 0 15px #0f0; }
    body.theme-matrix .action-links a { color: #0f0; }

    /* Neon Theme */
    body.theme-neon {
        background: #000;
        animation: none;
    }
    body.theme-neon .card-glass {
        background-color: rgba(0, 0, 0, 0.85);
        border: 3px solid transparent;
        border-radius: 20px;
        background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
        background-origin: border-box;
        background-clip: padding-box, border-box;
        box-shadow: 0 0 30px rgba(255, 0, 200, 0.6);
        animation: neonRotate 2s linear infinite;
    }
    @keyframes neonRotate {
        0% { filter: hue-rotate(0deg); }
        100% { filter: hue-rotate(360deg); }
    }
    
    /* Tet Nguyen Dan Theme */
    body.theme-tet { background: linear-gradient(to bottom, #ff0000, #ffcc00); }
    .flower-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; display: none; }
    .flower { position: absolute; top: -10%; color: #ffeb3b; font-size: 20px; animation: fall-flower linear infinite; }
    @keyframes fall-flower { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }

    /* Mid-Autumn (Trung Thu) */
    body.theme-midautumn { background: radial-gradient(circle at 50% 20%, #1a2a6c, #b21f1f, #fdbb2d); }
    .moon { position: absolute; top: 50px; right: 50px; width: 100px; height: 100px; background: #ffeb3b; border-radius: 50%; box-shadow: 0 0 50px #ffeb3b; z-index: 1; }
    .lantern { position: absolute; font-size: 40px; color: #ff5722; animation: float-lantern 5s ease-in-out infinite alternate; }
    @keyframes float-lantern { from { transform: translateY(0); } to { transform: translateY(-20px); } }

    /* Noel Theme */
    body.theme-noel { background: linear-gradient(to bottom, #165b33, #bb2528); }
    /* Re-use snow container */

    /* UIA Meme Theme */
    body.theme-uia { 
        background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff0000); 
        background-size: 400% 400%; 
        animation: uia-party 0.5s infinite; 
    }
    @keyframes uia-party { 
        0% { background-position: 0% 50%; filter: hue-rotate(0deg); } 
        50% { background-position: 100% 50%; } 
        100% { background-position: 0% 50%; filter: hue-rotate(360deg); } 
    }
    .uia-img { position: absolute; width: 150px; animation: uia-spin 2s linear infinite; z-index: 2; }
    @keyframes uia-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Summer Theme */
    body.theme-summer { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); }
    .summer-sun { position: absolute; top: 10%; right: 10%; width: 100px; height: 100px; background: #ffeb3b; border-radius: 50%; box-shadow: 0 0 50px #f39c12; animation: sun-pulse 2s infinite alternate; }
    @keyframes sun-pulse { from { transform: scale(1); box-shadow: 0 0 50px #f39c12; } to { transform: scale(1.1); box-shadow: 0 0 80px #f39c12; } }
    .cloud { position: absolute; color: rgba(255,255,255,0.8); font-size: 50px; animation: cloud-move linear infinite; }
    @keyframes cloud-move { from { left: -100px; } to { left: 100vw; } }

    /* Retro 80s Theme */
    body.theme-retro80s {
        background: linear-gradient(45deg, #ff00ff, #00ffff, #ffff00, #ff0000);
        background-size: 400% 400%;
        animation: retro-bg 8s ease infinite;
    }
    @keyframes retro-bg {
        0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; filter: hue-rotate(360deg); }
    }
    body.theme-retro80s .card-glass {
        background: rgba(0, 0, 0, 0.7);
        border: 3px solid transparent;
        border-radius: 20px;
        background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
        background-origin: border-box;
        background-clip: padding-box, border-box;
        box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        animation: neonRotate 2s linear infinite;
    }

    /* Cat Paw Click Effect */
    .cat-paw-click {
        position: absolute;
        width: 40px;
        height: 40px;
        background-image: url('https://static.vecteezy.com/system/resources/previews/027/209/347/non_2x/cute-cat-paw-all-white-free-png.png');
        background-size: cover;
        pointer-events: none;
        z-index: 9999;
        animation: paw-fade 0.8s ease-out forwards;
    }
    @keyframes paw-fade { 0% { transform: translate(-50%, -50%) scale(0.5) rotate(0deg); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.2) rotate(20deg); opacity: 0; } }

    /* Halloween Theme */
    body.theme-halloween { background: linear-gradient(to bottom, #2e003e 0%, #000000 100%); overflow: hidden; }
    .pumpkin { position: absolute; font-size: 3rem; animation: pumpkin-bounce 3s ease-in-out infinite; bottom: -10px; z-index: 5; filter: drop-shadow(0 0 10px #ff6600); }
    @keyframes pumpkin-bounce { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(5deg); } }
    .bat { position: absolute; font-size: 2rem; animation: bat-fly 15s linear infinite; z-index: 6; color: #000; text-shadow: 0 0 5px #fff; }
    @keyframes bat-fly { 
        0% { transform: translateX(-10vw) translateY(10vh) scale(0.5); } 
        50% { transform: translateX(50vw) translateY(40vh) scale(1); }
        100% { transform: translateX(110vw) translateY(10vh) scale(0.5); } 
    }

    /* Cyberpunk Theme */
    body.theme-cyberpunk {
        background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%);
        overflow: hidden;
    }
    body.theme-cyberpunk::before {
        content: "";
        position: absolute;
        width: 200%; height: 200%;
        top: -50%; left: -50%;
        background: repeating-linear-gradient(transparent 0, transparent 40px, rgba(255, 0, 255, 0.3) 40px, rgba(255, 0, 255, 0.3) 41px),
                    repeating-linear-gradient(90deg, transparent 0, transparent 40px, rgba(0, 255, 255, 0.3) 40px, rgba(0, 255, 255, 0.3) 41px);
        transform: perspective(500px) rotateX(60deg);
        animation: cyber-grid 5s linear infinite;
        z-index: 0;
        pointer-events: none;
    }
    @keyframes cyber-grid { 0% { transform: perspective(500px) rotateX(60deg) translateY(0); } 100% { transform: perspective(500px) rotateX(60deg) translateY(41px); } }
    body.theme-cyberpunk .card-glass { background: rgba(10, 10, 20, 0.85); border: 1px solid #00ffff; box-shadow: 0 0 15px #ff00ff, inset 0 0 10px #00ffff; z-index: 1; }
    body.theme-cyberpunk .btn-primary { background: transparent; border: 2px solid #ff00ff; color: #ff00ff; text-shadow: 0 0 5px #ff00ff; box-shadow: 0 0 10px #ff00ff; }
    body.theme-cyberpunk .btn-primary:hover { background: #ff00ff; color: #000; box-shadow: 0 0 20px #ff00ff; }

    /* Custom Theme */
    #custom-bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; display: none; }
    #custom-bg-container img, #custom-bg-container video { width: 100%; height: 100%; object-fit: cover; }
    .static-star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; animation: twinkle 3s infinite; }

    /* Jack J97 Theme */
    body.theme-jack97 {
        background: #000 url('https://wallpaperaccess.com/full/6286375.jpg') no-repeat center center fixed;
        background-size: cover;
    }
    .firefly {
        position: absolute;
        width: 6px;
        height: 6px;
        background-color: #ffff00;
        border-radius: 50%;
        box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00;
        animation: fly 10s infinite alternate;
        pointer-events: none;
        z-index: 5;
    }
    @keyframes fly { 
        0% { transform: translate(0, 0); opacity: 0; } 
        10% { opacity: 1; } 
        90% { opacity: 1; } 
        100% { transform: translate(100vw, -50vh); opacity: 0; } 
    }

    /* Click Firework Particle */
    .click-firework-particle {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 9999;
        box-shadow: 0 0 10px currentColor;
    }

    /* Click Text Effect */
    .click-text-effect {
        position: absolute;
        color: #ffd700;
        font-weight: bold;
        font-size: 24px;
        pointer-events: none;
        z-index: 9999;
        text-shadow: 0 0 10px #ff0000;
        white-space: nowrap;
        transform: translate(-50%, -50%);
    }

    /* Theme Modal Grid */
    .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .theme-btn { 
        border: none; border-radius: 10px; padding: 15px; color: white; font-weight: bold; 
        cursor: pointer; transition: transform 0.2s; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100px;
    }
    .theme-btn {
        text-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }
    .theme-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .theme-btn i { font-size: 24px; margin-bottom: 5px; }
    
    /* Theme Button Colors */
    .btn-ocean { background: linear-gradient(to right, #0052D4, #4364F7); }
    .btn-galaxy { background: linear-gradient(to right, #1b2735, #090a0f); }
    .btn-sunny { background: linear-gradient(to right, #2980b9, #f7971e); }
    .btn-snow { background: linear-gradient(to right, #203a43, #2c5364); }
    .btn-neon { background: #000; border: 2px solid #ff00de; color: #ff00de; }
    .btn-matrix { background: #000; border: 2px solid #0f0; color: #0f0; }
    .btn-tet { background: linear-gradient(to right, #ff0000, #ffcc00); }
    .btn-midautumn { background: linear-gradient(to right, #1a2a6c, #b21f1f); }
    .btn-noel { background: linear-gradient(to right, #165b33, #bb2528); }
    .btn-uia { background: linear-gradient(45deg, #ff00ff, #00ffff); animation: uia-party 2s infinite; }
    .btn-summer { background: linear-gradient(to right, #4facfe, #00f2fe); }
    .btn-jack97 { background: #000; border: 2px solid #ffd700; color: #ffd700; }
    .btn-halloween { background: linear-gradient(to right, #ff6600, #4a00e0); }
    .btn-custom { background: #333; border: 1px dashed #fff; }
    .btn-cyberpunk { background: linear-gradient(45deg, #2b002b, #000); border: 1px solid #00ffff; color: #00ffff; }
    .btn-retro80s { background: linear-gradient(45deg, #ff00ff, #00ffff); color: white; }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .login-box {
        width: 400px;
        max-width: 90%;
        position: relative;
        z-index: 10;
    }

    .card-glass {
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        padding: 30px;
        color: white;
    }
    
    /* Fix Input Group Pill */
    .input-group-pill {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50rem;
    }
    .input-group-pill .form-control {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        color: white !important;
    }
    .input-group-pill .input-group-text {
        background: transparent !important;
        border: none !important;
        color: white !important;
    }

    .form-control::placeholder { color: rgba(255,255,255,0.7); }
    
    .btn-primary { background-color: rgba(30, 136, 229, 0.8); border: none; border-radius: 50px; padding: 10px 20px; font-weight: bold; }
    .btn-primary:hover { background-color: rgba(21, 101, 192, 0.9); box-shadow: 0 5px 15px rgba(30, 136, 229, 0.4); }

    /* New Glow Effect for Login Button */
    .btn-glow {
        box-shadow: 0 0 5px rgba(30, 136, 229, 0.8), 0 0 10px rgba(30, 136, 229, 0.6);
        animation: btn-glow-animation 2s ease-in-out infinite;
    }
    @keyframes btn-glow-animation {
        0% { box-shadow: 0 0 5px rgba(30, 136, 229, 0.8), 0 0 10px rgba(30, 136, 229, 0.6); }
        50% { box-shadow: 0 0 20px rgba(30, 136, 229, 1), 0 0 30px rgba(30, 136, 229, 0.8); }
        100% { box-shadow: 0 0 5px rgba(30, 136, 229, 0.8), 0 0 10px rgba(30, 136, 229, 0.6); }
    }

    .action-links a {
        color: #ffeb3b;
        text-decoration: none;
        font-weight: bold;
        transition: all 0.3s;
    }
    .action-links a:hover {
        color: #fff;
        text-decoration: underline;
    }

    /* New Side Panel Layout */
    .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
        transition: gap 0.5s ease;
    }
    .login-container.side-panel-active {
        gap: 30px;
    }
    .side-panel {
        width: 0;
        opacity: 0;
        transform: translateX(20px);
        transition: width 0.5s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease, transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
        z-index: 2000; /* Ensure it's above background effects */
    }
    .login-container.side-panel-active .side-panel {
        width: 420px;
        opacity: 1;
        transform: translateX(0);
    }
    .side-panel .card-glass { max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
    .side-panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .side-panel-title { font-weight: bold; margin: 0; }
    .side-panel-body { padding: 1.5rem; overflow-y: auto; }
    .close-side-panel { position: absolute; top: 10px; right: 20px; background: none; border: none; color: white; font-size: 2rem; cursor: pointer; z-index: 10; opacity: 0.7; }
    .close-side-panel:hover { opacity: 1; }

    /* Welcome Screen Animation */
    #welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e88e5, #1565c0);
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
      text-align: center;
      padding: 20px;
      transition: background 1s ease, opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
    }
    #welcome-screen.hidden {
      transform: translateY(-50px);
      opacity: 0;
      pointer-events: none;
    }
    #welcome-screen h1 {
      font-size: 2.5rem;
      font-weight: 300;
      margin-bottom: 1rem;
      animation: fadeInDown 1s ease-out;
    }
    #welcome-screen p {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      animation: fadeInUp 1s ease-out 0.3s;
      animation-fill-mode: backwards;
    }
    .welcome-loading-box {
        display: flex;
        align-items: center;
        background: rgba(255,255,255,0.2);
        padding: 10px 25px;
        border-radius: 50px;
        margin-top: 20px;
        animation: fadeInUp 1s ease-out 0.6s backwards;
    }
    .welcome-spinner { width: 1.5rem; height: 1.5rem; border-width: 0.2em; margin-right: 15px; }
    .welcome-text { font-weight: bold; font-size: 1.1rem; }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Intro Logo Animation */
    .intro-logo {
        width: 150px;
        height: 150px;
        filter: drop-shadow(0 0 20px #ffd700);
        animation: pulseLogo 2s infinite;
        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 0;
    }
    @keyframes pulseLogo {
        0% { transform: scale(1); filter: drop-shadow(0 0 20px #ffd700); }
        50% { transform: scale(1.1); filter: drop-shadow(0 0 40px #ffeb3b); }
        100% { transform: scale(1); filter: drop-shadow(0 0 20px #ffd700); }
    }
    
    #welcome-content {
        opacity: 1;
        max-height: 500px;
        overflow: hidden;
        transform: translateY(0);
        transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #welcome-screen.phase-2 { background: linear-gradient(135deg, #1e88e5, #1565c0); }
    #welcome-screen.phase-2 .intro-logo { width: 100px; height: 100px; margin-bottom: 20px; animation: none; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); transform: scale(1); }
    #welcome-screen.phase-2 #welcome-content { opacity: 1; max-height: 500px; transform: translateY(0); }

    /* Login Loading Styles */
    .login-loading-container {
        display: none;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        margin-bottom: 20px;
        padding: 2px; /* for the border */
        border-radius: 15px;
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.1);
        animation: fadeInUp 0.5s ease-out forwards; /* Hiệu ứng xuất hiện */
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .login-loading-container::before {
        content: '';
        position: absolute;
        width: 150%;
        height: 150%;
        top: -25%;
        left: -25%;
        background: conic-gradient(from 0deg at 50% 50%, transparent, #007bff, transparent 30%);
        animation: rotate-gradient 2s linear infinite;
    }
    @keyframes rotate-gradient {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .login-loading-content {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #1a1a1a;
        width: 100%;
        height: 100%;
        padding: 10px;
        border-radius: 13px;
        position: relative;
        z-index: 1;
    }

    /* Rain Effect */
    .rain {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        z-index: 1;
    }
    .rain-drop {
        position: absolute;
        width: 1px;
        height: 15px;
        background: rgba(255, 255, 255, 0.4);
        top: -20px;
        animation: rainFall 0.7s linear infinite;
    }
    @keyframes rainFall {
        to { transform: translateY(100vh); }
    }

    /* Shooting Star Effect */
    .star-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 1;
        pointer-events: none;
        display: none;
    }
    .star {
        position: absolute;
        top: 50%;
        left: 50%;
        height: 2px;
        background: linear-gradient(-45deg, #fff, rgba(0, 0, 255, 0));
        filter: drop-shadow(0 0 6px #fff);
        animation: tail 3000ms ease-in-out infinite, shooting 3000ms ease-in-out infinite;
    }
    @keyframes tail { 0% { width: 0; } 30% { width: 100px; } 100% { width: 0; } }
    @keyframes shooting {
        0% { transform: translateX(0) translateY(0) rotateZ(45deg); }
        100% { transform: translateX(300px) translateY(300px) rotateZ(45deg); }
    }

    /* Toggle Rain Button */
    .toggle-rain-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 100;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        cursor: pointer;
    }
    .toggle-rain-btn:hover {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 0.4);
    }

   

    /* Full Screen Modal for Registration */
    .modal-dialog.modal-fullscreen {
        max-width: 100%;
        margin: 0;
        height: 100%;
    }
    .modal-dialog.modal-fullscreen .modal-content {
        height: 100%;
        border: 0;
        border-radius: 0;
    }
    .modal-dialog.modal-fullscreen .modal-body {
        overflow-y: auto;
        padding: 2rem;
    }
    
    /* Mobile Modal Styles */
    #modalMobileAction .modal-content {
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
    }

    /* SweetAlert Z-Index Fix - Ensure it appears on top of modals */
    .swal2-container {
        z-index: 10000 !important;
    }
  </style>
</head>
<body class="hold-transition login-page">
<!-- Welcome Screen -->
<div id="welcome-screen">
  <div id="welcome-content">
      <h1>Chào mừng bạn!</h1>
      <p>Đến với Hệ thống Quản lý Sinh hoạt hè</p>
      <div class="w-75 mt-4 mx-auto" style="max-width: 300px;">
          <div class="progress" style="height: 6px; background-color: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden;">
              <div id="welcome-progress-bar" class="progress-bar bg-white" role="progressbar" style="width: 0%"></div>
          </div>
          <div class="d-flex justify-content-between mt-2 text-white small">
              <span id="welcome-status">Đang khởi động...</span>
              <span id="welcome-percent">0%</span>
          </div>
      </div>
  </div>
</div>

<!-- Rain Container -->
<div id="rain" class="rain"></div>
<div id="stars" class="star-container"></div>
<div id="snow" class="snow-container"></div>
<div id="sun" class="sun"></div>
<div id="matrix-container" style="display:none;"><canvas id="matrix-canvas"></canvas></div>
<div id="flowers" class="flower-container"></div>
<div id="midautumn" style="display:none;"><div class="moon"></div></div>
<div id="uia-container" style="display:none;"></div>
<div id="summer-container" style="display:none;"></div>
<div id="jack97-container" style="display:none;"></div>
<div id="halloween-container" style="display:none;"></div>
<div id="custom-bg-container"></div>
<input type="file" id="customFileInput" hidden accept="image/*,video/*">

<button id="resetEffectBtn" class="toggle-rain-btn" style="bottom: 80px; background: rgba(220, 53, 69, 0.3);" onclick="resetEffect()" title="Tắt hiệu ứng">
    <i class="fas fa-power-off"></i>
</button>
<button id="toggleRainBtn" class="toggle-rain-btn" onclick="$('#modalThemeSelection').modal('show')" title="Đổi giao diện">
    <i class="fas fa-cloud-rain"></i>
</button>

<button id="installPwaBtn" class="btn btn-success rounded-pill shadow-lg font-weight-bold" style="display: none; position: fixed; bottom: 60px; left: 20px; z-index: 9999; padding: 10px 20px;">
    <i class="fas fa-download mr-2"></i> Cài App
</button>

<div class="login-container" id="loginContainer">
  <div class="login-box">
  <div class="card-glass">
    <div class="text-center mb-4">
<!-- Connection Status Widget -->
<div id="connection-status" class="connection-status" style="display:none;">
    <i class="fas fa-wifi" id="conn-icon"></i>
    <span id="conn-text">Kết nối</span>
    <span id="conn-ms" class="ml-2 badge badge-dark">--ms</span>
</div>

      <div class="d-flex justify-content-center align-items-center">
          <img src="https://upload.wikimedia.org/wikipedia/vi/0/09/Huy_Hi%E1%BB%87u_%C4%90o%C3%A0n.png" alt="Logo Đoàn" style="height: 50px; margin-right: 15px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));">
          <div class="text-left">
              <h2 class="font-weight-bold mb-0" style="line-height: 1.2;">ĐĂNG NHẬP</h2>
              <p class="small mb-0">Hệ thống quản lý sinh hoạt hè</p>
          </div>
      </div>
    </div>

    <form id="loginForm">
        <div class="input-group mb-3 input-group-pill">
            <input type="text" id="username" class="form-control" placeholder="Tên đăng nhập" required style="padding-left: 20px;">
            <div class="input-group-append">
                <div class="input-group-text"><span class="fas fa-user"></span></div>
            </div>
        </div>
        <div class="input-group mb-3 input-group-pill">
            <input type="password" id="password" class="form-control" placeholder="Mật khẩu" required style="padding-left: 20px;">
            <div class="input-group-append">
                <div class="input-group-text" style="cursor: pointer;" onclick="togglePassword()">
                    <span id="password-icon" class="fas fa-eye"></span>
                </div>
            </div>
        </div>
        
        <!-- Captcha -->
        <div class="form-group mb-3">
            <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 border">
                <span id="captcha_code_login" class="font-weight-bold h5 mb-0 text-primary" style="letter-spacing: 5px; user-select: none;"></span>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="generateCaptcha('captcha_code_login')"><i class="fas fa-sync"></i></button>
            </div>
            <input type="text" id="captcha_input_login" class="form-control mt-2 text-center" placeholder="Nhập mã xác nhận ở trên" required>
        </div>

        <div class="login-loading-container" id="loginLoading">
            <div class="login-loading-content">
                <div class="spinner-border text-white" role="status" style="width: 1.5rem; height: 1.5rem; border-width: .2em;"></div>
                <span class="loading-text text-white ml-3" id="loadingText">Đang kết nối...</span>
            </div>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary btn-block shadow-sm mt-3 btn-glow">
            <i class="fas fa-sign-in-alt mr-2"></i> ĐĂNG NHẬP NGAY
        </button>

        <button type="button" class="btn btn-outline-light btn-block btn-sm mt-3 rounded-pill" onclick="syncData()">
            <i class="fas fa-sync mr-1"></i> Đồng bộ dữ liệu 
        </button>
    </form>

    <div class="text-center mt-5 action-links">
        <p class="mb-1 small">Chưa có thông tin học sinh?</p>
        <a href="javascript:void(0)" onclick="openRegisterModal()"><i class="fas fa-user-plus mr-1"></i> Đăng ký ngay</a>
    </div>
    
    <div class="text-center mt-4 small" style="opacity: 0.7;">
        <strong>Bản quyền và coding bởi Triết Võ.</strong><br>
        <small>Sản phẩm có sự hỗ trợ từ AI Gemini.</small>
    </div>
  </div>
</div>

<div class="side-panel" id="sidePanel">
    <div class="card-glass">
        <div class="side-panel-header">
            <h5 class="side-panel-title"></h5>
            <button class="close-side-panel" onclick="closeSidePanel()">&times;</button>
        </div>
        <div class="side-panel-body" id="sidePanelBody">
            <!-- Content injected by JS -->
        </div>
    </div>
</div>

<!-- Modal Mobile Action -->
<div class="modal fade" id="modalMobileAction" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title font-weight-bold" id="mobileModalTitle"></h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body" id="mobileModalBody"></div>
        </div>
    </div>
</div>

<!-- Modal Theme Selection -->
<div class="modal fade" id="modalThemeSelection" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-palette mr-2"></i>Chọn Giao Diện</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="theme-grid">
                    <button class="theme-btn btn-ocean" onclick="selectTheme(0)"><i class="fas fa-water"></i>Mặc định</button>
                    <button class="theme-btn btn-galaxy" onclick="selectTheme(1)"><i class="fas fa-star"></i>Galaxy</button>
                    <button class="theme-btn btn-sunny" onclick="selectTheme(2)"><i class="fas fa-sun"></i>Nắng</button>
                    <button class="theme-btn btn-snow" onclick="selectTheme(3)"><i class="fas fa-snowflake"></i>Tuyết</button>
                    <button class="theme-btn btn-neon" onclick="selectTheme(4)"><i class="fas fa-bolt"></i>Neon</button>
                    <button class="theme-btn btn-matrix" onclick="selectTheme(5)"><i class="fas fa-terminal"></i>Hacker</button>
                    
                    <button class="theme-btn btn-tet" onclick="selectTheme(6)"><i class="fas fa-fan"></i>Tết Nguyên Đán</button>
                    <button class="theme-btn btn-midautumn" onclick="selectTheme(9)"><i class="fas fa-moon"></i>Trung Thu</button>
                    <button class="theme-btn btn-noel" onclick="selectTheme(10)"><i class="fas fa-sleigh"></i>Noel</button>
                    
                    <button class="theme-btn btn-uia" onclick="selectTheme(12)"><i class="fas fa-music"></i>Meme UIA</button>
                    
                    <button class="theme-btn btn-summer" onclick="selectTheme(13)"><i class="fas fa-umbrella-beach"></i>Mùa Hè</button>
                    
                    <button class="theme-btn btn-jack97" onclick="selectTheme(16)"><i class="fas fa-fire"></i>Jack J97</button>
                    
                    <button class="theme-btn btn-halloween" onclick="selectTheme(17)"><i class="fas fa-ghost"></i>Halloween</button>
                    <button class="theme-btn btn-cyberpunk" onclick="selectTheme(19)"><i class="fas fa-vr-cardboard"></i>Cyberpunk</button>
                    <button class="theme-btn btn-retro80s" onclick="selectTheme(20)"><i class="fas fa-record-vinyl"></i>Retro 80s</button>
                    <button class="theme-btn btn-custom" onclick="triggerCustomUpload()"><i class="fas fa-upload"></i>Custom (50MB)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Update Available -->
<div class="modal fade" id="modalUpdateAvailable" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-sync-alt mr-2"></i>Cập nhật hệ thống</h5>
            </div>
            <div class="modal-body text-center">
                <p class="lead mb-2">Đã có phiên bản mới!</p>
                <p class="text-muted">Hệ thống vừa được cập nhật trên máy chủ. Vui lòng tải lại để áp dụng thay đổi.</p>
                <div class="alert alert-light border text-left small mb-3" style="max-height: 100px; overflow-y: auto; color: #333; white-space: pre-wrap;">
                    <strong>Nội dung cập nhật:</strong><br>
                    <span id="updateChangelog">...</span>
                </div>
                <button type="button" class="btn btn-success btn-lg font-weight-bold rounded-pill px-4 mt-2" onclick="window.location.reload(true)">
                    <i class="fas fa-redo mr-2"></i> Tải lại ngay
                </button>
            </div>
        </div>
    </div>
</div>

<audio id="switchSfx" preload="auto">
    <source src="https://cdn.freesound.org/previews/273/273122_5121236-lq.mp3" type="audio/mpeg">
</audio>
<audio id="fireworkSfx" preload="auto">
    <source src="https://www.soundjay.com/misc/sounds/fireworks-01.mp3" type="audio/mpeg">
</audio>
<audio id="angrybirdSfx" preload="auto">
    <source src="https://www.myinstants.com/media/sounds/angry-birds-red-bird-flying.mp3" type="audio/mpeg">
</audio>
<audio id="meowSfx" preload="auto">
    <source src="https://www.myinstants.com/media/sounds/cat-meow-short.mp3" type="audio/mpeg">
</audio>
<audio id="halloweenSfx" preload="auto">
    <source src="https://www.myinstants.com/media/sounds/spooky-scary-skeletons-song-hq.mp3" type="audio/mpeg">
</audio>
<audio id="boingSfx" preload="auto">
    <source src="https://www.myinstants.com/media/sounds/boing2.mp3" type="audio/mpeg">
</audio>
<!-- Theme Audios -->
<audio id="audio-tet" loop><source src="https://github.com/trietpko2002/trietpko2002.github.io/raw/main/music/tet_music.mp3" type="audio/mpeg"></audio>
<audio id="audio-nyan" loop><source src="https://www.myinstants.com/media/sounds/nyan-cat.mp3" type="audio/mpeg"></audio>
<audio id="audio-uia" loop><source src="music/uia.mp3" type="audio/mpeg"></audio>
<audio id="audio-jack" loop><source src="music/jack_j97_dom_dom.mp3" type="audio/mpeg"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";

    let schoolList = [];
    let tempUser = "";

    function generateCaptcha(elementId) {
        const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let result = '';
        for (let i = 0; i < 5; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById(elementId).innerText = result;
    }

    window.onload = () => { 
        // Define form templates
        window.registerFormTemplate = `
            <div class="form-group"><label>Họ và Tên học sinh <span class="text-danger">*</span></label><input type="text" id="reg_name" class="form-control" placeholder="Nguyễn Văn A"></div>
            <div class="form-group"><label>Giới tính</label>
                <select id="reg_gender" class="form-control">
                    <option value="">-- Chọn --</option><option value="Nam">Nam</option><option value="Nữ">Nữ</option><option value="Khác">Khác</option>
                </select>
            </div>
            <div class="form-group"><label>Ngày sinh</label><input type="date" id="reg_dob" class="form-control"></div>
            <div class="form-group"><label>Lớp hiện tại</label><input type="text" id="reg_class" class="form-control" placeholder="VD: 9A1"></div>                
            <div class="form-group">
                <label>Trường học</label>
                <select id="reg_school_select" class="form-control" onchange="toggleOtherSchool('reg_school_select', 'reg_school_other_div')">
                    <option value="">-- Vui lòng chọn trường --</option>
                </select>
            </div>
            <div class="form-group" id="reg_school_other_div" style="display:none;">
                <label>Tên trường khác</label>
                <input type="text" id="reg_school_other" class="form-control" placeholder="Nhập tên trường của bạn...">
            </div>
            <div class="form-group"><label>Địa chỉ nơi cư trú</label><input type="text" id="reg_address" class="form-control"></div>
            <div class="form-group"><label>Số điện thoại liên hệ</label><input type="text" id="reg_phone" class="form-control"></div>
            <div class="form-group">
                <label>Mã xác thực</label>
                <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 border mb-2">
                    <span id="captcha_code_reg" class="font-weight-bold h5 mb-0 text-success" style="letter-spacing: 5px; user-select: none;"></span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="generateCaptcha('captcha_code_reg')"><i class="fas fa-sync"></i></button>
                </div>
                <input type="text" id="captcha_input_reg" class="form-control text-center" placeholder="Nhập mã xác nhận">
            </div>
            <h6 class="text-primary font-weight-bold mt-3 border-top pt-2">Thông tin đăng ký</h6>
            <div class="form-group"><label>Thời gian sinh hoạt (Dự kiến)</label><input type="text" id="reg_time" class="form-control" value="Tháng 6" readonly></div>
            <div class="form-group"><label>Địa điểm dự kiến</label><input type="text" id="reg_loc" class="form-control" value="Trường Tiểu Học Đài Sơn địa chỉ 31 Ng. Gia Tự, phường Phan Rang, tỉnh Khánh Hoà" readonly></div>
            <button type="button" class="btn btn-success btn-block" onclick="submitRegister()">Đăng ký ngay</button>
        `;

        sessionStorage.clear(); 
        generateCaptcha('captcha_code_login');
        
        startLoadingProgress();

        function startLoadingProgress() {
            const states = [
                "Kết nối máy chủ...",
                "Kiểm tra phiên bản...",
                "Tải tài nguyên...",
                "Thiết lập bảo mật...",
                "Hoàn tất!"
            ];
            
            const statusEl = document.getElementById('welcome-status');
            const percentEl = document.getElementById('welcome-percent');
            const barEl = document.getElementById('welcome-progress-bar');
            
            barEl.style.transition = 'width 0.05s linear';
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += 1;
                if (progress > 100) progress = 100;
                
                barEl.style.width = `${progress}%`;
                percentEl.innerText = `${progress}%`;
                
                const step = Math.floor((progress / 100) * states.length);
                if(states[step]) statusEl.innerText = states[step];

                if (progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        document.getElementById('welcome-screen').classList.add('hidden');
                    }, 500);
                }
            }, 15); 
        }
        
        const effectState = parseInt(localStorage.getItem('bgEffect') || '0');
        applyEffect(effectState);
        
        // Real-time GitHub Update Detection
        let currentCommitSha = null;
        async function checkGitHubUpdate() {
            try {
                const response = await fetch('https://api.github.com/repos/trietpko2002/trietpko2002.github.io/commits?per_page=1');
                if (response.ok) {
                    const data = await response.json();
                    const latestSha = data[0].sha;
                    const message = data[0].commit.message;
                    if (!currentCommitSha) {
                        currentCommitSha = latestSha;
                    } else if (currentCommitSha !== latestSha) {
                        $('#updateChangelog').text(message);
                        $('#modalUpdateAvailable').modal('show');
                    }
                }
            } catch (e) { console.log('Update check skipped'); }
        }
        checkGitHubUpdate();
        setInterval(checkGitHubUpdate, 120000); // Check every 2 minutes
    };

    async function loadSchoolList() {
        if (schoolList.length > 0) return;
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_SCHOOL_LIST" }) });
            const res = await response.json();
            if (res.status === 'success') {
                schoolList = res.data;
            }
        } catch(e) { console.error("Failed to load school list", e); }
    }

    function populateSchoolDropdown(selectId) {
        const select = document.getElementById(selectId);
        if (!select || schoolList.length === 0) return;
        
        let html = '<option value="">-- Vui lòng chọn trường --</option>';
        schoolList.forEach(school => {
            html += `<option value="${school}">${school}</option>`;
        });
        html += '<option value="other">Trường khác...</option>';
        select.innerHTML = html;
    }

    function toggleOtherSchool(selectId, otherDivId) {
        const select = document.getElementById(selectId);
        const otherDiv = document.getElementById(otherDivId);
        otherDiv.style.display = (select.value === 'other') ? 'block' : 'none';
    }

    function getSelectedSchool(selectId, otherInputId) {
        const select = document.getElementById(selectId);
        return (select.value === 'other') ? document.getElementById(otherInputId).value.trim() : select.value;
    }


    // Sync Logic
    function syncData() {
        const btn = document.querySelector('button[onclick="syncData()"]');
        
        $(btn).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Đang đồng bộ...');
        setTimeout(() => window.location.reload(true), 500);
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const user = $('#username').val().trim();
        const pass = $('#password').val().trim();
        const loadingBox = $('#loginLoading');
        const captchaInput = $('#captcha_input_login').val().trim().toUpperCase();
        const captchaCode = $('#captcha_code_login').text().trim();

        if (captchaInput !== captchaCode) {
            toastr.error("Mã xác nhận không đúng!");
            return;
        }
        
        // UI Reset
        btn.style.display = 'none';
        loadingBox.css('display', 'flex');
        updateStatus("Đang kết nối máy chủ...");

        try {
            // Giả lập delay nhẹ để hiệu ứng mượt hơn
            await new Promise(r => setTimeout(r, 500));
            updateStatus("Đang xác thực thông tin...");

            const payload = { username: user, password: pass }; 

            const response = await fetch(API_URL, {
                method: "POST",
                redirect: "follow",
                body: JSON.stringify({ 
                    action: "LOGIN", 
                    payload: payload
                })
            });
            const res = await response.json();

            if (res.status === "success") {
                updateStatus("Đăng nhập thành công! Đang vào...");
                handleLoginSuccess(res.user);
            } else {
                toastr.error(res.message);
                resetLoginForm();
            }
        } catch (error) {
            toastr.error("Lỗi kết nối hệ thống!");
            generateCaptcha('captcha_code_login');
            $('#captcha_input_login').val('');
            resetLoginForm();
        }
    });

    function updateStatus(text) {
        $('#loadingText').text(text);
    }

    function resetLoginForm() {
        setTimeout(() => {
            $('#loginLoading').hide();
            const btn = document.getElementById('submitBtn');
            btn.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> ĐĂNG NHẬP NGAY';
        }, 1000);
    }

    function handleLoginSuccess(user) {
        sessionStorage.setItem('user', JSON.stringify(user));
        toastr.success("Đăng nhập thành công!");
        document.body.style.opacity = '0'; // Fade out effect
        setTimeout(() => {
            if (user.role === 'admin') window.location.replace('admin.html');
            else if (user.role === 'supervisor') window.location.replace('supervisor.html');
            else window.location.replace('index.html');
        }, 500);
    }

    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // --- SIDE PANEL LOGIC ---
    function openSidePanel(title, content) {
        const sidePanel = $('#sidePanel');
        sidePanel.find('.side-panel-title').html(title);
        $('#sidePanelBody').html(content);
        $('#loginContainer').addClass('side-panel-active');
    }

    function closeSidePanel() {
        $('#loginContainer').removeClass('side-panel-active');
    }

    function togglePassword() {
        const passwordInput = document.getElementById('password');
        const passwordIcon = document.getElementById('password-icon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            passwordIcon.classList.remove('fa-eye');
            passwordIcon.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            passwordIcon.classList.remove('fa-eye-slash');
            passwordIcon.classList.add('fa-eye');
        }
    }

    // --- LOGIC ĐĂNG KÝ ---
    async function openRegisterModal() {
        if (isMobile()) {
            $('#mobileModalTitle').html('<i class="fas fa-user-plus mr-2"></i> Đăng ký Thông tin');
            $('#mobileModalBody').html(window.registerFormTemplate);
            $('#modalMobileAction').modal('show');
        } else {
            openSidePanel('<i class="fas fa-user-plus mr-2"></i> Đăng ký Thông tin', window.registerFormTemplate);
        }
        await loadSchoolList();
        populateSchoolDropdown('reg_school_select');
        generateCaptcha('captcha_code_reg');
    }

    async function submitRegister() {
        const name = $('#reg_name').val().trim();
        if (!name) return toastr.warning("Vui lòng nhập họ tên!");
        
        const schoolName = getSelectedSchool('reg_school_select', 'reg_school_other');
        if (!schoolName) return toastr.warning("Vui lòng chọn hoặc nhập trường học!");

        const captchaInput = $('#captcha_input_reg').val().trim().toUpperCase();
        const captchaCode = $('#captcha_code_reg').text().trim();
        if (captchaInput !== captchaCode) {
            return toastr.error("Mã xác nhận không đúng!");
        }

        const payload = {
            fullname: name,
            gender: $('#reg_gender').val(),
            dob: $('#reg_dob').val(),
            class_name: $('#reg_class').val(),
            school: schoolName,
            address: $('#reg_address').val(),
            phone: $('#reg_phone').val(),
            reg_time: "Tháng 6",
            reg_loc: "Trường Tiểu Học Đài Sơn địa chỉ 31 Ng. Gia Tự, phường Phan Rang, tỉnh Khánh Hoà",
            reg_act: ""
        };

        Swal.fire({ title: 'Đang đăng ký...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "REGISTER_TEMP", payload: payload }) });
            const res = await response.json();
            if (res.status === "success") {
                if(isMobile()) $('#modalMobileAction').modal('hide');
                else closeSidePanel();
                
                const assignedGroup = res.data.group_name;
                const managerName = res.data.manager_name;
                const managerPhone = res.data.manager_phone;
                const dummyGroups = ["Nhóm 1", "Nhóm 2", "Nhóm 3", "Nhóm 4", "Nhóm 5", "Nhóm 6"]; 
                let timerInterval;

                Swal.fire({
                    title: 'Đang phân nhóm ngẫu nhiên...',
                    html: 'Hệ thống đang chọn nhóm phù hợp cho bạn!<br><h1 id="random-group-text" class="text-primary font-weight-bold my-4" style="font-size: 3rem;">...</h1>',
                    timer: 2500,
                    timerProgressBar: true,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        const b = Swal.getHtmlContainer().querySelector('#random-group-text');
                        timerInterval = setInterval(() => {
                            b.textContent = dummyGroups[Math.floor(Math.random() * dummyGroups.length)];
                        }, 100);
                    },
                    willClose: () => {
                        clearInterval(timerInterval);
                    }
                }).then((result) => {
                    if (result.dismiss === Swal.DismissReason.timer) {
                        if (typeof confetti === 'function') { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); }
                        Swal.fire({
                            icon: 'success',
                            title: 'Chúc mừng!',
                            html: `
                                Bạn đã chính thức là thành viên của:
                                <h2 class="text-success font-weight-bold text-uppercase mt-2 mb-3" style="font-size: 2rem;">${assignedGroup}</h2>
                                <div class="text-left bg-light p-3 rounded border">
                                    <p class="mb-1"><i class="fas fa-user-shield mr-2 text-primary"></i><b>Quản lý:</b> ${managerName}</p>
                                    <p class="mb-0"><i class="fas fa-phone mr-2 text-success"></i><b>Liên hệ:</b> <a href="tel:${managerPhone}" class="font-weight-bold">${managerPhone}</a></p>
                                </div>
                                <p class="mt-3 small text-muted">Hãy liên hệ ngay với anh/chị quản lý để được thêm vào nhóm Zalo nhé!</p>
                            `,
                            confirmButtonText: 'Tuyệt vời!',
                            confirmButtonColor: '#28a745'
                        });
                    }
                });
            } else { Swal.fire('Lỗi', res.message, 'error'); }
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    }

    // --- LOGIC CẬP NHẬT / HOÀN TẤT ---
    function openUpdateInfoModal() {
        if (isMobile()) {
            $('#mobileModalTitle').html('<i class="fas fa-edit mr-2"></i> Hoàn tất Hồ sơ');
            $('#mobileModalBody').html(window.updateInfoTemplate);
            $('#modalMobileAction').modal('show');
        } else {
            openSidePanel('<i class="fas fa-edit mr-2"></i> Hoàn tất Hồ sơ', window.updateInfoTemplate);
        }
        generateCaptcha('captcha_code_update'); // Generate for step 2
    }

    async function loginTemp() {
        const id = $('#temp_id').val().trim();
        const pass = $('#temp_pass').val().trim();
        if(!id || !pass) return toastr.warning("Nhập đầy đủ ID và Mật khẩu!");

        Swal.fire({ title: 'Đang kiểm tra...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "LOGIN_TEMP", payload: { id, pass } }) });
            const res = await response.json();
            if (res.status === "success") {
                Swal.close();
                const d = res.data;
                $('#conf_temp_id').val(d.id);
                $('#conf_name').val(d.fullname);
                $('#conf_gender').val(d.gender);
                $('#conf_dob').val(d.dob ? new Date(d.dob).toISOString().split('T')[0] : ''); // Format YYYY-MM-DD for input
                $('#conf_class').val(d.class_name);
                $('#conf_address').val(d.address);
                $('#conf_phone').val(d.phone);
                $('#conf_time').val(d.reg_time);
                $('#conf_loc').val(d.reg_loc);
                $('#conf_act').val(d.reg_act);
                
                // Check if allowed to change pass
                if (String(d.allow_change).toUpperCase() === 'TRUE') {
                    $('#change_pass_area').removeClass('d-none');
                }
                
                // Load groups and schools
                await Promise.all([loadSchoolList()]);
                populateSchoolDropdown('conf_school_select');

                // Set school value
                if (schoolList.includes(d.school)) {
                    $('#conf_school_select').val(d.school);
                } else if (d.school) {
                    $('#conf_school_select').val('other');
                    $('#conf_school_other').val(d.school);
                }
                toggleOtherSchool('conf_school_select', 'conf_school_other_div');
                
                $('#update_step1').hide();
                $('#update_step2').show();
            } else Swal.fire('Lỗi', res.message, 'error');
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    }

    function createRain() {
        const rainContainer = document.getElementById('rain');
        for (let i = 0; i < 80; i++) {
            const drop = document.createElement('div');
            drop.classList.add('rain-drop');
            drop.style.left = Math.random() * 100 + 'vw';
            drop.style.animationDuration = Math.random() * 0.5 + 0.5 + 's';
            drop.style.animationDelay = Math.random() * 2 + 's';
            rainContainer.appendChild(drop);
        }
    }

    function createStars() {
        const container = document.getElementById('stars');
        container.innerHTML = '';
        for (let i = 0; i < 50; i++) { // Increased for meteor shower effect
            const star = document.createElement('div');
            star.className = 'star';
            const duration = Math.random() * 2000 + 3000;
            const delay = Math.random() * 3000;
            star.style.top = Math.random() * 100 + 'vh';
            star.style.left = Math.random() * 100 + 'vw';
            star.style.animationDuration = duration + 'ms';
            star.style.animationDelay = delay + 'ms';
            container.appendChild(star);
        }
        // Add static stars for Galaxy feel
        for (let i = 0; i < 100; i++) {
            const s = document.createElement('div'); s.className = 'static-star';
            s.style.top = Math.random() * 100 + 'vh'; s.style.left = Math.random() * 100 + 'vw';
            s.style.animationDelay = Math.random() * 3 + 's';
            container.appendChild(s);
        }
    }

    function createSnow() {
        const container = document.getElementById('snow');
        container.innerHTML = '';
        for (let i = 0; i < 50; i++) {
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.innerHTML = '❄';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.animationDelay = Math.random() * 5 + 's';
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            flake.style.opacity = Math.random();
            container.appendChild(flake);
        }
    }

    function createMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const characters = katakana + latin + nums;

        const fontSize = 16;
        const columns = canvas.width / fontSize;

        const drops = [];
        for (let x = 0; x < columns; x++) {
            drops[x] = 1;
        }

        function draw() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#0F0';
            ctx.font = fontSize + 'px monospace';

            for (let i = 0; i < drops.length; i++) {
                const text = characters.charAt(Math.floor(Math.random() * characters.length));
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        
        if (canvas.dataset.intervalId) clearInterval(parseInt(canvas.dataset.intervalId));
        const intervalId = setInterval(draw, 33);
        canvas.dataset.intervalId = intervalId;

        window.addEventListener('resize', () => {
            if (!document.body.classList.contains('theme-matrix')) return;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
    }

    function cleanupEffects() {
        // Stop intervals/animations
        if (window.matrixInterval) { clearInterval(window.matrixInterval); window.matrixInterval = null; }
        if (window.uiaInterval) { cancelAnimationFrame(window.uiaInterval); window.uiaInterval = null; }

        // Stop all theme audios
        document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
            audio.pause();
            audio.currentTime = 0;
        });

        // Clear generated elements from containers
        ['rain', 'stars', 'snow', 'flowers', 'midautumn', 'uia-container', 'summer-container', 'jack97-container', 'halloween-container', 'custom-bg-container'].forEach(id => {
            const container = document.getElementById(id);
            if (container) container.innerHTML = '';
        });
    }

    function selectTheme(state) {
        document.getElementById('switchSfx')?.play().catch(e => {});
        applyEffect(state);
        localStorage.setItem('bgEffect', state);
        $('#modalThemeSelection').modal('hide');
    }

    function resetEffect() {
        document.getElementById('switchSfx')?.play().catch(e => {});
        applyEffect(-1);
        localStorage.setItem('bgEffect', '-1');
        toastr.info("Đã tắt toàn bộ hiệu ứng.");
    }

    function applyEffect(state) {
        cleanupEffects(); // Dọn dẹp hiệu ứng cũ trước khi áp dụng cái mới

        const body = document.body;
        const rainContainer = document.getElementById('rain');
        const starsContainer = document.getElementById('stars');
        const snowContainer = document.getElementById('snow');
        const sun = document.getElementById('sun');
        const matrixContainer = document.getElementById('matrix-container');
        const flowerContainer = document.getElementById('flowers');
        const midAutumn = document.getElementById('midautumn');
        const uiaContainer = document.getElementById('uia-container');
        const summerContainer = document.getElementById('summer-container');
        const jack97Container = document.getElementById('jack97-container');
        const halloweenContainer = document.getElementById('halloween-container');
        const customBgContainer = document.getElementById('custom-bg-container');
        const btnIcon = document.querySelector('#toggleRainBtn i');
        
        // Reset
        body.className = 'hold-transition login-page';
        rainContainer.style.display = 'none';
        sun.style.display = 'none';
        matrixContainer.style.display = 'none';
        midAutumn.style.display = 'none';
        uiaContainer.style.display = 'none';
        summerContainer.style.display = 'none';
        jack97Container.style.display = 'none';
        halloweenContainer.style.display = 'none';
        customBgContainer.style.display = 'none';
        
        btnIcon.className = 'fas fa-magic';
        
        // Hide containers that are not being re-created
        snowContainer.style.display = 'none';

        if (state === 0) { // Ocean + Rain
            rainContainer.style.display = 'block'; btnIcon.className = 'fas fa-cloud-rain'; if(rainContainer.children.length === 0) createRain();
        } else if (state === 1) { // Galaxy
            body.classList.add('theme-galaxy');
            starsContainer.style.display = 'block'; btnIcon.className = 'fas fa-star'; if(starsContainer.children.length === 0) createStars();
        } else if (state === 2) { // Sunny
            body.classList.add('theme-sunny');
            sun.style.display = 'block'; btnIcon.className = 'fas fa-sun';
        } else if (state === 3) { // Snow
            body.classList.add('theme-snow');
            snowContainer.style.display = 'block'; btnIcon.className = 'fas fa-snowflake'; if(snowContainer.children.length === 0) createSnow();
        } else if (state === 4) { // Neon
            body.classList.add('theme-neon');
            btnIcon.className = 'fas fa-bolt';
        } else if (state === 5) { // Matrix
            body.classList.add('theme-matrix');
            matrixContainer.style.display = 'block';
            btnIcon.className = 'fas fa-terminal';
            createMatrix();
        } else if (state === 6) { // Tet
            body.classList.add('theme-tet');
            flowerContainer.style.display = 'block';
            if(flowerContainer.children.length === 0) createFlowers();
            document.getElementById('audio-tet')?.play().catch(e=>{});
        } else if (state === 9) { // Trung Thu
            body.classList.add('theme-midautumn');
            midAutumn.style.display = 'block';
            if(midAutumn.children.length === 1) createLanterns();
        } else if (state === 10) { // Noel
            body.classList.add('theme-noel');
            snowContainer.style.display = 'block'; if(snowContainer.children.length === 0) createSnow();
        } else if (state === 12) { // UIA Meme
            body.classList.add('theme-uia');
            uiaContainer.style.display = 'block';
            createUiaMemes();
            document.getElementById('audio-uia')?.play().catch(e=>{});
        } else if (state === 13) { // Summer
            body.classList.add('theme-summer');
            summerContainer.style.display = 'block';
            if(summerContainer.children.length === 0) createSummer();
        } else if (state === 16) { // Jack J97
            body.classList.add('theme-jack97');
            jack97Container.style.display = 'block';
            if(jack97Container.children.length === 0) createFireflies();
            document.getElementById('audio-jack')?.play().catch(e=>{});
        } else if (state === 17) { // Halloween
            body.classList.add('theme-halloween');
            halloweenContainer.style.display = 'block';
            if(halloweenContainer.children.length === 0) createHalloween();
            document.getElementById('halloweenSfx')?.play().catch(e=>{});
        } else if (state === 18) { // Custom
            customBgContainer.style.display = 'block';
            loadCustomBg().then(file => {
                if (file) {
                    const url = URL.createObjectURL(file);
                    customBgContainer.innerHTML = '';
                    if (file.type.startsWith('video')) {
                        const vid = document.createElement('video');
                        vid.src = url; vid.autoplay = true; vid.loop = true; vid.muted = false; vid.playsInline = true;
                        customBgContainer.appendChild(vid);
                    } else {
                        const img = document.createElement('img'); img.src = url;
                        customBgContainer.appendChild(img);
                    }
                } else toastr.warning("Chưa có file custom nào được lưu.");
            });
            btnIcon.className = 'fas fa-user-cog';
        } else if (state === 19) { // Cyberpunk
            body.classList.add('theme-cyberpunk');
        } else if (state === 20) { // Retro 80s
            body.classList.add('theme-retro80s');
        }
    }

    function createFlowers() {
        const c = document.getElementById('flowers');
        const icons = ['🌸', '🏵️', '🧧'];
        for(let i=0; i<30; i++) {
            const f = document.createElement('div'); f.className = 'flower';
            f.innerHTML = icons[Math.floor(Math.random()*icons.length)];
            f.style.left = Math.random()*100+'vw'; f.style.animationDuration = (Math.random()*5+5)+'s'; f.style.animationDelay = Math.random()*5+'s';
            c.appendChild(f);
        }
    }
    function createLanterns() {
        const c = document.getElementById('midautumn');
        for(let i=0; i<10; i++) {
            const l = document.createElement('div'); l.className = 'lantern fas fa-lightbulb';
            l.style.left = Math.random()*100+'vw'; l.style.top = (Math.random()*50+20)+'%'; l.style.animationDelay = Math.random()+'s';
            c.appendChild(l);
        }
    }
    
    let uiaMemes = [];
    function createUiaMemes() {
        const c = document.getElementById('uia-container');
        c.innerHTML = '';
        uiaMemes = [];
        
        for(let i=0; i<15; i++) {
            const m = document.createElement('img'); 
            m.className = 'uia-img'; 
            m.src = 'https://media.tenor.com/sbfBfp3FeY8AAAAj/oia-uia.gif';
            
            let x = Math.random() * (window.innerWidth - 150);
            let y = Math.random() * (window.innerHeight - 150);
            
            m.style.left = x + 'px'; 
            m.style.top = y + 'px';
            m.style.cursor = 'grab';
            
            let vx = (Math.random() - 0.5) * 8;
            let vy = (Math.random() - 0.5) * 8;
            
            const meme = { el: m, x: x, y: y, vx: vx, vy: vy, isDragging: false };
            uiaMemes.push(meme);
            c.appendChild(m);
            
            const startHandler = (e) => {
                e.preventDefault();
                meme.isDragging = true;
                m.style.cursor = 'grabbing';
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                const shiftX = clientX - meme.x;
                const shiftY = clientY - meme.y;
                
                const moveHandler = (ev) => {
                    const cx = ev.clientX || ev.touches[0].clientX;
                    const cy = ev.clientY || ev.touches[0].clientY;
                    meme.x = cx - shiftX;
                    meme.y = cy - shiftY;
                    m.style.left = meme.x + 'px';
                    m.style.top = meme.y + 'px';
                };
                
                const endHandler = () => {
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', endHandler);
                    document.removeEventListener('touchmove', moveHandler);
                    document.removeEventListener('touchend', endHandler);
                    meme.isDragging = false;
                    m.style.cursor = 'grab';
                    
                    meme.vx = (Math.random() - 0.5) * 10;
                    meme.vy = (Math.random() - 0.5) * 10;
                };
                
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', endHandler);
                document.addEventListener('touchmove', moveHandler, {passive: false});
                document.addEventListener('touchend', endHandler);
            };
            m.addEventListener('mousedown', startHandler);
            m.addEventListener('touchstart', startHandler, {passive: false});
        }
        if (!window.uiaInterval) animateUiaMemes();
    }
    
    function animateUiaMemes() {
        if (!document.body.classList.contains('theme-uia')) {
            window.uiaInterval = null;
            return;
        }
        const boing = document.getElementById('boingSfx');
        const maxX = window.innerWidth - 150;
        const maxY = window.innerHeight - 150;

        uiaMemes.forEach(meme => {
            if (!meme.isDragging) {
                meme.x += meme.vx;
                meme.y += meme.vy;
                
                let hit = false;
                if (meme.x <= 0) {
                    if (meme.vx < 0) { meme.vx *= -1; hit = true; }
                } else if (meme.x >= maxX) {
                    if (meme.vx > 0) { meme.vx *= -1; hit = true; }
                }
                
                if (meme.y <= 0) {
                    if (meme.vy < 0) { meme.vy *= -1; hit = true; }
                } else if (meme.y >= maxY) {
                    if (meme.vy > 0) { meme.vy *= -1; hit = true; }
                }
                
                if (hit && boing) { const s = boing.cloneNode(); s.volume = 0.5; s.play().catch(()=>{}); }
                
                meme.el.style.left = meme.x + 'px';
                meme.el.style.top = meme.y + 'px';
            }
        });
        window.uiaInterval = requestAnimationFrame(animateUiaMemes);
    }

    function createSummer() {
        const c = document.getElementById('summer-container');
        const sun = document.createElement('div'); sun.className = 'summer-sun'; c.appendChild(sun);
        for(let i=0; i<5; i++) {
            const cloud = document.createElement('div'); cloud.className = 'cloud fas fa-cloud';
            cloud.style.top = (Math.random()*30+5)+'%'; cloud.style.animationDuration = (Math.random()*20+20)+'s'; cloud.style.animationDelay = (Math.random()*10)+'s';
            c.appendChild(cloud);
        }
    }
    function createFireflies() {
        const c = document.getElementById('jack97-container');
        for(let i=0; i<30; i++) {
            const f = document.createElement('div'); f.className = 'firefly';
            f.style.top = Math.random() * 100 + 'vh';
            f.style.left = Math.random() * 100 + 'vw';
            f.style.animationDuration = (Math.random() * 5 + 5) + 's';
            f.style.animationDelay = Math.random() * 5 + 's';
            c.appendChild(f);
        }
    }

    const meowSounds = [
        'https://www.myinstants.com/media/sounds/cat-meow-short.mp3'
    ];

    function playRandomMeow() {
        const src = meowSounds[0];
        const audio = new Audio(src);
        audio.volume = 0.5;
        audio.play().catch(e => {});
    }

    // Click Firework Effect
    document.addEventListener('click', (e) => {
        const body = document.body;
        if (body.classList.contains('theme-tet')) {
            createClickFirework(e.clientX, e.clientY);
            createClickText(e.clientX, e.clientY);
            
            // Play sound
            const audio = document.getElementById('fireworkSfx');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        } else if (body.classList.contains('theme-jack97') || body.classList.contains('theme-uia')) {
            // Cat Paw Effect + Random Meow
            createPawEffect(e.clientX, e.clientY);
            playRandomMeow();
        }
    });

    function createClickFirework(x, y) {
        const colors = ['#ff0000', '#ffd700', '#00ff00', '#00ffff', '#ff00ff', '#ffffff', '#ff4500'];
        for (let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.className = 'click-firework-particle';
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            p.style.color = p.style.backgroundColor;
            document.body.appendChild(p);
            const angle = Math.random() * Math.PI * 2, velocity = Math.random() * 150 + 50;
            const anim = p.animate([{ transform: 'translate(0, 0) scale(1)', opacity: 1 }, { transform: `translate(${Math.cos(angle)*velocity}px, ${Math.sin(angle)*velocity}px) scale(0)`, opacity: 0 }], { duration: Math.random() * 600 + 400, easing: 'ease-out' });
            anim.onfinish = () => p.remove();
        }
    }

    function createClickText(x, y) {
        const t = document.createElement('div');
        t.className = 'click-text-effect';
        t.innerText = "Chúc Mừng Năm Mới";
        t.style.left = x + 'px';
        t.style.top = y + 'px';
        document.body.appendChild(t);
        const anim = t.animate([
            { transform: 'translate(-50%, -50%) scale(0.5)', opacity: 0 },
            { transform: 'translate(-50%, -50%) scale(1.2)', opacity: 1, offset: 0.2 },
            { transform: 'translate(-50%, -150px) scale(1)', opacity: 0 }
        ], { duration: 1500, easing: 'ease-out' });
        anim.onfinish = () => t.remove();
    }

    function createPawEffect(x, y) {
        const p = document.createElement('div');
        p.className = 'cat-paw-click';
        p.style.left = x + 'px';
        p.style.top = y + 'px';
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 800);
    }

    function createHalloween() {
        const c = document.getElementById('halloween-container');
        const pumpkins = ['🎃', '👻', '💀'];
        for(let i=0; i<10; i++) {
            const p = document.createElement('div'); p.className = 'pumpkin';
            p.innerText = pumpkins[Math.floor(Math.random()*pumpkins.length)];
            p.style.left = Math.random()*90 + 'vw';
            p.style.animationDelay = Math.random()*2 + 's';
            c.appendChild(p);
        }
        for(let i=0; i<5; i++) {
            const b = document.createElement('div'); b.className = 'bat';
            b.innerText = '🦇';
            b.style.top = Math.random()*50 + 'vh';
            b.style.animationDuration = (Math.random()*10 + 10) + 's';
            b.style.animationDelay = Math.random()*5 + 's';
            c.appendChild(b);
        }
    }

    // IndexedDB for Custom Theme
    const dbName = 'SHH_ThemeDB'; const storeName = 'custom_bg';
    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (e) => { if (!e.target.result.objectStoreNames.contains(storeName)) e.target.result.createObjectStore(storeName); };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e.target.error);
        });
    }
    async function saveCustomBg(file) {
        const db = await initDB(); const tx = db.transaction(storeName, 'readwrite');
        tx.objectStore(storeName).put(file, 'user_file');
        return new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = rej; });
    }
    async function loadCustomBg() {
        try { const db = await initDB(); return new Promise((res, rej) => { const req = db.transaction(storeName, 'readonly').objectStore(storeName).get('user_file'); req.onsuccess = () => res(req.result); req.onerror = rej; }); } catch(e){return null;}
    }

    function triggerCustomUpload() { document.getElementById('customFileInput').click(); }
    document.getElementById('customFileInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 50 * 1024 * 1024) { toastr.error("File quá lớn! Giới hạn 50MB."); return; }
        toastr.info("Đang lưu file vào bộ nhớ máy...");
        await saveCustomBg(file);
        toastr.success("Đã lưu giao diện custom!");
        selectTheme(18);
    });

    // PWA Install Logic
    let deferredPrompt;
    const installBtn = document.getElementById('installPwaBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
    });
    
    async function installPwa() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            installBtn.style.display = 'none';
        }
    }
    installBtn.addEventListener('click', installPwa);
    window.addEventListener('appinstalled', () => {
        installBtn.style.display = 'none';
    });

    // --- CONNECTION STATUS LOGIC ---
    function updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        const iconEl = document.getElementById('conn-icon');
        const textEl = document.getElementById('conn-text');
        const msEl = document.getElementById('conn-ms');
        
        if(!statusEl) return;

        if (!navigator.onLine) {
            setConnStatus('offline', 'Mất kết nối', '--');
            return;
        }

        const start = Date.now();
        // Fetch file nhỏ để check ping (cache busting)
        fetch('manifest.json?t=' + start, { method: 'HEAD', cache: 'no-store' })
        .then(() => {
            const latency = Date.now() - start;
            if (latency < 300) setConnStatus('online', 'Tốt', latency + 'ms');
            else if (latency < 1000) setConnStatus('slow', 'Trung bình', latency + 'ms');
            else setConnStatus('offline', 'Yếu', latency + 'ms');
        })
        .catch(() => setConnStatus('offline', 'Lỗi mạng', '--'));
    }

    function setConnStatus(type, text, ms) {
        const el = document.getElementById('connection-status');
        const icon = document.getElementById('conn-icon');
        const txt = document.getElementById('conn-text');
        const badge = document.getElementById('conn-ms');
        
        // Create Blocking Overlay if not exists
        let blockOverlay = document.getElementById('connection-block-overlay');
        if (!blockOverlay) {
            blockOverlay = document.createElement('div');
            blockOverlay.id = 'connection-block-overlay';
            blockOverlay.style.cssText = 'display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; backdrop-filter: blur(5px);';
            blockOverlay.innerHTML = '<i class="fas fa-wifi fa-4x mb-4 text-danger" style="animation: pulse 2s infinite"></i><h3 class="font-weight-bold">KẾT NỐI KHÔNG ỔN ĐỊNH</h3><p class="lead">Hệ thống yêu cầu mạng ổn định để đảm bảo dữ liệu.</p><button class="btn btn-danger font-weight-bold mt-3" onclick="updateConnectionStatus()"><i class="fas fa-sync mr-2"></i>Thử lại kết nối</button>';
            document.body.appendChild(blockOverlay);
        }

        el.style.display = 'flex';
        el.className = 'connection-status ' + type;
        txt.innerText = text;
        badge.innerText = ms;
        
        // Reset styles
        el.style.border = '1px solid rgba(255,255,255,0.1)';
        el.style.background = 'rgba(0, 0, 0, 0.7)';
        
        if(type === 'online') { 
            icon.className = 'fas fa-wifi'; badge.className = 'ml-2 badge badge-success'; el.style.borderColor = '#28a745'; icon.style.color = '#28a745';
            blockOverlay.style.display = 'none';
        } else if(type === 'slow') { 
            icon.className = 'fas fa-network-wired'; badge.className = 'ml-2 badge badge-warning'; el.style.borderColor = '#ffc107'; icon.style.color = '#ffc107';
            blockOverlay.style.display = 'none';
        } else { 
            icon.className = 'fas fa-exclamation-triangle'; badge.className = 'ml-2 badge badge-danger'; el.style.borderColor = '#dc3545'; el.style.background = 'rgba(50, 0, 0, 0.8)'; icon.style.color = '#dc3545';
            blockOverlay.style.display = 'flex';
        }
    }

    // Style injection for Login Page
    const style = document.createElement('style');
    style.innerHTML = `
        .connection-status {
            position: fixed; bottom: 10px; left: 10px; z-index: 10000;
            background: rgba(0, 0, 0, 0.7); color: #fff; padding: 6px 12px;
            border-radius: 30px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1); user-select: none;
        }
        .connection-status i { margin-right: 6px; }
    `;
    document.head.appendChild(style);

    setInterval(updateConnectionStatus, 5000);
    window.addEventListener('load', updateConnectionStatus);
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', () => setConnStatus('offline', 'Mất kết nối', '--'));
</script>
</body>
</html>