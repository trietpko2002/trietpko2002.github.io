<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Qu·∫£n tr·ªã - H·ªá th·ªëng Qu·∫£n l√Ω SHH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        .small-box { border-radius: 12px; overflow: hidden; transition: transform 0.3s; }
        .small-box:hover { transform: translateY(-5px); }
        .text-dob { color: #007bff; font-weight: bold; }
        .badge-group { font-size: 0.85rem; padding: 4px 8px; }
        .table-history { font-size: 0.9rem; }
        .history-card-body { max-height: 600px; overflow-y: auto; }
        .img-manager { width: 35px; height: 35px; object-fit: cover; border-radius: 50%; }
        .btn-action { padding: 2px 5px; font-size: 0.8rem; }
        .nav-link p { font-weight: 500; }
        .sidebar-dark-primary { background-color: #343a40; }
        /* Youth Union Theme */
        .navbar-primary { background-color: #1e88e5 !important; }
        .brand-link.bg-primary { background-color: #1e88e5 !important; }
        .sidebar-light-primary .nav-sidebar>.nav-item>.nav-link.active { background-color: #1e88e5; color: #fff; }
        .btn-primary { background-color: #1e88e5; border-color: #1976d2; }
        .btn-primary:hover { background-color: #1565c0; border-color: #0d47a1; }
        /* Dark Mode Full Coverage */
        body.dark-mode .modal-content { background-color: #343a40; color: #fff; }
        body.dark-mode .modal-header { border-bottom-color: #454d55; }
        body.dark-mode .modal-footer { border-top-color: #454d55; }
        body.dark-mode .close { color: #fff; text-shadow: none; }
        body.dark-mode .form-control { background-color: #454d55; color: #fff; border-color: #6c757d; }
        body.dark-mode .form-control:focus { background-color: #454d55; color: #fff; }
        body.dark-mode .custom-file-label { background-color: #454d55; color: #fff; }
        body.dark-mode .custom-file-label::after { background-color: #56606a; color: #fff; }

        @media print {
            /* Hide all UI chrome */
            .main-sidebar, .main-header, .btn, .modal, .nav-tabs, .card-outline, .content-header, .nav-header, .small-box, .modal-backdrop {
                display: none !important;
            }
            /* Hide non-active tabs */
            .tab-pane:not(.active) {
                display: none !important;
            }
            /* Reset layout for printing */
            .content-wrapper {
                margin-left: 0 !important;
                padding-top: 0 !important;
                background: #fff !important;
            }
            .tab-pane.active {
                display: block !important;
                opacity: 1 !important;
            }
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
            /* Hide datatable controls for cleaner print */
            .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
                display: none !important;
            }
            .table-responsive {
                overflow-x: visible !important;
            }
        }
        /* Poll Tabs */
        .poll-tab-content { max-height: 400px; overflow-y: auto; }
        .poll-group-header { background: #f4f6f9; padding: 10px; font-weight: bold; border-bottom: 2px solid #ddd; }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed">
<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user || user.role.toLowerCase() !== 'admin') {
            window.location.replace('login.html');
        }
    })();

    function logout() {
        sessionStorage.clear();
        window.location.replace('login.html');
    }
</script>

<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <span class="nav-link">Xin ch√†o, <b id="adminNameDisplay" class="text-primary">Admin</b></span>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript:void(0)" onclick="openSettingsModal()" title="C√†i ƒë·∫∑t h·ªá th·ªëng">
                    <i class="fas fa-cog"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-danger" href="javascript:void(0)" onclick="logout()">
                    <i class="fas fa-power-off"></i> Tho√°t
                </a>
            </li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-light-primary elevation-4">
        <div class="brand-link bg-primary text-center">
            <span class="brand-text font-weight-bold text-white">QU·∫¢N TR·ªä ADMIN</span>
        </div>
        <div class="sidebar">
            <nav class="mt-3">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="tablist">
                    <li class="nav-item">
                        <a href="#tab-dashboard" class="nav-link active" data-toggle="pill">
                            <i class="nav-icon fas fa-chart-pie"></i> <p>T·ªïng quan & L·ªãch s·ª≠</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-students-list" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-id-card"></i> <p>D·ªØ li·ªáu h·ªçc sinh</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-managers-list" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-user-shield"></i> <p>Qu·∫£n l√Ω t√†i kho·∫£n</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-groups-list" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-users-cog"></i> <p>Danh s√°ch nh√≥m</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-upload" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-folder-open"></i> <p>Qu·∫£n l√Ω tr√¨nh duy·ªát file</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-notifications" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-bell"></i> <p>Th√¥ng b√°o h·ªá th·ªëng</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-feedbacks" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-comments"></i> <p>Qu·∫£n l√Ω G√≥p √Ω</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-evaluations" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-star"></i> <p>Qu·∫£n l√Ω ƒê√°nh gi√°</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-system-logs" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-history"></i> <p>Log h·ªá th·ªëng</p>
                        </a>
                    </li>
                    <li class="nav-header">XU·∫§T B√ÅO C√ÅO</li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="exportExcelHistory()" class="nav-link text-success">
                            <i class="nav-icon fas fa-file-excel"></i> <p>Xu·∫•t L·ªãch S·ª≠ (.xlsx)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="exportExcelStudents()" class="nav-link text-info">
                            <i class="nav-icon fas fa-file-download"></i> <p>Xu·∫•t DS H·ªçc Sinh (.xlsx)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="backupSystem()" class="nav-link text-warning">
                            <i class="nav-icon fas fa-database"></i> <p>Sao l∆∞u H·ªá th·ªëng (Backup)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="openRestoreModal()" class="nav-link text-danger">
                            <i class="nav-icon fas fa-undo-alt"></i> <p>Ph·ª•c h·ªìi H·ªá th·ªëng (Restore)</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <div class="content-wrapper">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-dashboard">
                <section class="content-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1>Th·ªëng k√™ & To√†n b·ªô l·ªãch s·ª≠</h1>
                            <button onclick="refreshAll()" class="btn btn-primary"><i class="fas fa-sync"></i> L√†m m·ªõi</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-info">
                                    <div class="inner"><h3 id="countHS">0</h3><p>H·ªçc sinh</p></div>
                                    <div class="icon"><i class="fas fa-users"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-success">
                                    <div class="inner"><h3 id="countPresent">0</h3><p>C√≥ m·∫∑t</p></div>
                                    <div class="icon"><i class="fas fa-check"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-warning text-white">
                                    <div class="inner"><h3 id="countAbsentP">0</h3><p>V·∫Øng (P)</p></div>
                                    <div class="icon"><i class="fas fa-envelope"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-danger">
                                    <div class="inner"><h3 id="countAbsent">0</h3><p>V·∫Øng (K)</p></div>
                                    <div class="icon"><i class="fas fa-times"></i></div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="card card-outline card-success shadow">
                                    <div class="card-header d-flex p-2 align-items-center">
                                        <h3 class="card-title font-weight-bold pl-2">Nh·∫≠t k√Ω ƒëi·ªÉm danh</h3>
                                        <div class="ml-auto d-flex">
                                            <select id="filter_status" class="form-control form-control-sm mr-1" style="width: 120px;">
                                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                                <option value="present">C√≥ m·∫∑t</option>
                                                <option value="absent_perm">V·∫Øng c√≥ ph√©p</option>
                                                <option value="absent">V·∫Øng kh√¥ng ph√©p</option>
                                            </select>
                                            <input type="text" id="filter_history_name" class="form-control form-control-sm mr-1" style="width: 150px;" placeholder="T√™n h·ªçc sinh...">
                                            <input type="date" id="filter_from" class="form-control form-control-sm mr-1" style="width: 130px;" title="T·ª´ ng√†y">
                                            <span class="align-self-center mr-1">-</span>
                                            <input type="date" id="filter_to" class="form-control form-control-sm mr-1" style="width: 130px;" title="ƒê·∫øn ng√†y">
                                            <button class="btn btn-sm btn-primary" onclick="filterHistory()"><i class="fas fa-filter"></i></button>
                                            <button class="btn btn-sm btn-secondary ml-1" onclick="resetFilter()" title="X√≥a l·ªçc"><i class="fas fa-undo"></i></button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0 table-responsive history-card-body">
                                        <table class="table table-head-fixed table-hover table-history text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>Th·ªùi gian</th>
                                                    <th>H·ªçc sinh</th>
                                                    <th>Nh√≥m</th>
                                                    <th>Tr·∫°ng th√°i</th>
                                                    <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                                                </tr>
                                            </thead>
                                            <tbody id="historyAttendanceData">
                                                <!-- Data loaded by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-students-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh s√°ch h·ªçc sinh to√†n h·ªá th·ªëng</h1>
                        <div>
                            <button class="btn btn-default" onclick="printStudents()"><i class="fas fa-print"></i> In</button>
                            <button class="btn btn-info" onclick="openImportModal('admin')"><i class="fas fa-file-import"></i> Nh·∫≠p t·ª´ Excel</button>
                            <button class="btn btn-success" onclick="openStudentModal()"><i class="fas fa-plus"></i> Th√™m H·ªçc Sinh</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card card-outline card-info shadow mb-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-filter mr-2"></i>B·ªô l·ªçc t√¨m ki·∫øm</h3></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" id="st_filter_name" class="form-control" placeholder="H·ªç t√™n...">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="st_filter_group" class="form-control"><option value="">-- T·∫•t c·∫£ Nh√≥m --</option></select>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <select id="st_filter_school" class="form-control"><option value="">-- T·∫•t c·∫£ Tr∆∞·ªùng --</option></select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" id="st_filter_from" class="form-control" title="Ng√†y th√™m (T·ª´)">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" id="st_filter_to" class="form-control" title="Ng√†y th√™m (ƒê·∫øn)">
                                    </div>
                                    <div class="col-12 text-right">
                                        <button class="btn btn-primary" onclick="filterStudents()"><i class="fas fa-search mr-2"></i>T√¨m ki·∫øm</button>
                                        <button class="btn btn-secondary" onclick="resetStudentFilter()"><i class="fas fa-undo mr-2"></i>ƒê·∫∑t l·∫°i</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="studentTable" class="table table-striped table-bordered w-100">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>H·ªç t√™n</th>
                                            <th>Ng√†y sinh</th>
                                            <th>Nh√≥m</th>
                                            <th>Tr∆∞·ªùng h·ªçc</th>
                                            <th>SƒêT h·ªçc sinh</th>
                                            <th>ƒê·ªãa ch·ªâ</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-managers-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh s√°ch t√†i kho·∫£n qu·∫£n l√Ω</h1>
                        <button class="btn btn-warning mr-2" onclick="showVipConfigHelp()"><i class="fas fa-crown"></i> C·∫•u h√¨nh Vinh danh</button>
                        <button class="btn btn-success" onclick="openUserModal()"><i class="fas fa-plus"></i> Th√™m T√†i Kho·∫£n</button>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="managerTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-primary text-white">
                                        <tr>
                                            <th>Avatar</th>
                                            <th>Username</th>
                                            <th>H·ªç t√™n Qu·∫£n l√Ω</th>
                                            <th>Nh√≥m ph·ª• tr√°ch</th>
                                            <th>Quy·ªÅn h·∫°n</th>
                                            <th>Email</th>
                                            <th>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="managerData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-groups-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh s√°ch c√°c nh√≥m sinh ho·∫°t</h1>
                        <button class="btn btn-success" onclick="openGroupModal()"><i class="fas fa-plus"></i> Th√™m Nh√≥m</button>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row" id="groupCardsContainer"></div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-upload">
                <section class="content-header">
                    <div class="container-fluid">
                        <h1>Qu·∫£n l√Ω tr√¨nh duy·ªát file</h1>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-header bg-primary"><h3 class="card-title"><i class="fas fa-cloud-download-alt mr-2"></i>Qu·∫£n l√Ω T√†i nguy√™n & T·ªáp tin</h3></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <p class="mb-0 text-muted"><i class="fas fa-info-circle mr-1"></i>Danh s√°ch file t·ª´ Qu·∫£n l√Ω v√† Admin.</p>
                                    <button class="btn btn-sm btn-success" onclick="loadUploadedFiles()"><i class="fas fa-sync mr-1"></i>L√†m m·ªõi danh s√°ch</button>
                                </div>
                                
                                <div class="form-group bg-light p-3 border rounded">
                                    <label class="text-info"><i class="fas fa-upload mr-2"></i>Admin Upload (T√†i nguy√™n chung cho c√°c nh√≥m)</label>
                                    <input type="file" id="file_upload_generic" class="form-control-file border p-2 bg-white">
                                    <button type="button" class="btn btn-info mt-2" onclick="uploadFileGeneric('admin')"><i class="fas fa-upload mr-2"></i>T·∫£i l√™n ngay</button>
                                </div>

                                <div class="table-responsive mt-2" style="max-height: 500px;">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Th·ªùi gian</th>
                                                <th>Ng∆∞·ªùi g·ª≠i (Qu·∫£n l√Ω)</th>
                                                <th>Nh√≥m</th>
                                                <th>Lo·∫°i</th>
                                                <th>N·ªôi dung / T√™n file</th>
                                                <th>Thao t√°c</th>
                                            </tr>
                                        </thead>
                                        <tbody id="uploadedFilesList"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-notifications">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Th√¥ng b√°o chung h·ªá th·ªëng</h1>
                        <div>
                            <button class="btn btn-warning mr-2" onclick="openPollModal()"><i class="fas fa-poll"></i> T·∫°o B√¨nh ch·ªçn</button>
                            <button class="btn btn-success" onclick="openNotiModal()"><i class="fas fa-paper-plane"></i> T·∫°o th√¥ng b√°o</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="notiTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-warning">
                                        <tr>
                                            <th>ID</th>
                                            <th>Ti√™u ƒë·ªÅ</th>
                                            <th>N·ªôi dung</th>
                                            <th>Th·ªùi gian di·ªÖn ra</th>
                                            <th>ƒêi·ªÉm danh s·ªõm</th>
                                            <th>H√¨nh th·ª©c</th>
                                            <th>Ng∆∞·ªùi ƒë√£ xem</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notiData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-feedbacks">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh s√°ch G√≥p √Ω & Ph·∫£n h·ªìi</h1>
                        <button class="btn btn-primary" onclick="loadFeedbacks()"><i class="fas fa-sync"></i> T·∫£i l·∫°i</button>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="feedbackTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-info">
                                        <tr>
                                            <th>Th·ªùi gian</th>
                                            <th>Ng∆∞·ªùi g·ª≠i</th>
                                            <th>N·ªôi dung G√≥p √Ω</th>
                                            <th>Ph·∫£n h·ªìi c·ªßa Admin</th>
                                            <th>Thao t√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedbackData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-evaluations">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>T·ªïng h·ª£p ƒê√°nh gi√° & X·∫øp lo·∫°i</h1>
                        <div>
                            <button class="btn btn-warning mr-2" onclick="openEvalConfigModal()"><i class="fas fa-cogs"></i> C·∫•u h√¨nh</button>
                            <button class="btn btn-primary mr-2" onclick="loadEvaluations()"><i class="fas fa-sync"></i> T·∫£i l·∫°i</button>
                            <button class="btn btn-success" onclick="exportExcelEvaluations()"><i class="fas fa-file-excel"></i> Xu·∫•t B√°o C√°o</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <!-- C·∫•u h√¨nh ƒë√°nh gi√° -->
                        <div class="card card-outline card-purple shadow mb-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-filter mr-2"></i>B·ªô l·ªçc ƒê√°nh gi√°</h3></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" id="eval_filter_name" class="form-control" placeholder="T√™n h·ªçc sinh...">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_group" class="form-control"><option value="">-- T·∫•t c·∫£ Nh√≥m --</option></select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_status" class="form-control">
                                            <option value="">-- Tr·∫°ng th√°i --</option>
                                            <option value="evaluated">ƒê√£ ƒë√°nh gi√°</option>
                                            <option value="not_evaluated">Ch∆∞a ƒë√°nh gi√°</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_class" class="form-control">
                                            <option value="">-- X·∫øp lo·∫°i --</option>
                                            <option value="Xu·∫•t s·∫Øc">Xu·∫•t s·∫Øc</option>
                                            <option value="T·ªët">T·ªët</option>
                                            <option value="Trung b√¨nh">Trung b√¨nh</option>
                                            <option value="Y·∫øu">Y·∫øu</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2 text-right">
                                        <button class="btn btn-primary" onclick="filterEvaluations()"><i class="fas fa-search mr-2"></i>L·ªçc</button>
                                        <button class="btn btn-secondary" onclick="resetEvaluationFilter()"><i class="fas fa-undo"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="evalTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-purple text-white">
                                        <tr>
                                            <th>H·ªçc sinh</th>
                                            <th>Nh√≥m</th>
                                            <th>√ù th·ª©c k·ª∑ lu·∫≠t</th>
                                            <th>M·ª©c ƒë·ªô t√≠ch c·ª±c</th>
                                            <th>Ho·∫°t ƒë·ªông t√¨nh nguy·ªán</th>
                                            <th>X·∫øp lo·∫°i</th>
                                        </tr>
                                    </thead>
                                    <tbody id="evalData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-system-logs">
                <section class="content-header">
                    <div class="container-fluid">
                        <h1>Nh·∫≠t k√Ω ho·∫°t ƒë·ªông (Logs)</h1>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="logTable" class="table table-sm table-striped w-100">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th>Th·ªùi gian</th>
                                            <th>T√†i kho·∫£n</th>
                                            <th>H√†nh ƒë·ªông</th>
                                            <th>Chi ti·∫øt</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<!-- Modal Student -->
<div class="modal fade" id="modalStudent" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title">Th√¥ng tin H·ªçc sinh</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="student_id_old">
                <div class="form-group"><label>M√£ H·ªçc sinh (ID)</label><input type="text" id="st_id" class="form-control" placeholder="Nh·∫≠p m√£ HS..."></div>
                <div class="form-group"><label>H·ªç v√† T√™n</label><input type="text" id="st_name" class="form-control" placeholder="Nguy·ªÖn VƒÉn A"></div>
                <div class="form-group"><label>Ng√†y sinh</label><input type="text" id="st_dob" class="form-control" placeholder="dd/mm/yyyy"></div>
                <div class="form-group"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="st_address" class="form-control"></div>
                <div class="form-group"><label>S·ªë ƒëi·ªán tho·∫°i h·ªçc sinh</label><input type="text" id="st_phone" class="form-control"></div>
                <div class="form-group"><label>M√£ Nh√≥m</label><input type="text" id="st_group" class="form-control" placeholder="VD: 1, 2, 3..."></div>
                <div class="form-group"><label>Tr∆∞·ªùng h·ªçc</label><input type="text" id="st_school" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('students')">L∆∞u d·ªØ li·ªáu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Restore System -->
<div class="modal fade" id="modalRestore" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-undo-alt mr-2"></i>Ph·ª•c h·ªìi H·ªá th·ªëng t·ª´ Backup</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>C·∫¢NH B√ÅO!</strong> H√†nh ƒë·ªông n√†y s·∫Ω <strong>X√ìA S·∫†CH</strong> to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu t·ª´ file backup. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ ch·ªçn ƒë√∫ng file.
                </div>
                <div class="form-group">
                    <label>Ch·ªçn file Backup (.xlsx)</label>
                    <input type="file" id="file_restore" class="form-control-file border p-2" accept=".xlsx">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="processRestore()">B·∫Øt ƒë·∫ßu Ph·ª•c h·ªìi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Students -->
<div class="modal fade" id="modalImport" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-file-import mr-2"></i>Nh·∫≠p danh s√°ch h·ªçc sinh t·ª´ Excel</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Vui l√≤ng s·ª≠ d·ª•ng file Excel theo ƒë√∫ng ƒë·ªãnh d·∫°ng m·∫´u. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông b·ªè qua c√°c h·ªçc sinh ƒë√£ t·ªìn t·∫°i (tr√πng T√™n v√† Nh√≥m).</p>
                <div class="form-group">
                    <label>1. T·∫£i file m·∫´u</label><br>
                    <button class="btn btn-success" id="btnDownloadTemplate"><i class="fas fa-download mr-2"></i>T·∫£i m·∫´u Excel</button>
                </div>
                <div class="form-group">
                    <label>2. Ch·ªçn file Excel c·ªßa b·∫°n</label>
                    <input type="file" id="file_import" class="form-control-file border p-2" accept=".xlsx, .xls">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-info" id="btnProcessImport">B·∫Øt ƒë·∫ßu Nh·∫≠p</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal User -->
<div class="modal fade" id="modalUser" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title">Th√¥ng tin T√†i kho·∫£n</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user_id_old">
                <div class="form-group"><label>T√™n ƒëƒÉng nh·∫≠p</label><input type="text" id="u_name" class="form-control"></div>
                <div class="form-group" id="pass_area"><label>M·∫≠t kh·∫©u</label><input type="text" id="u_pass" class="form-control"></div>
                <div class="form-group"><label>H·ªç t√™n hi·ªÉn th·ªã</label><input type="text" id="u_fullname" class="form-control"></div>
                <div class="form-group"><label>Ph√¢n quy·ªÅn</label>
                    <select id="u_role" class="form-control">
                        <option value="manager">Qu·∫£n l√Ω (Manager)</option>
                        <option value="admin">Qu·∫£n tr·ªã (Admin)</option>
                    </select>
                </div>
                <div class="form-group"><label>Nh√≥m ph·ª• tr√°ch</label><input type="text" id="u_group" class="form-control" placeholder="ƒê·ªÉ tr·ªëng n·∫øu l√† Admin"></div>
                <div class="form-group"><label>Email</label><input type="email" id="u_email" class="form-control" placeholder="example@email.com"></div>
                <div class="form-group"><label>Link Avatar</label><input type="text" id="u_avatar" class="form-control"></div>
                
                <hr>
                <h6 class="text-warning font-weight-bold"><i class="fas fa-crown mr-2"></i>H·ªá th·ªëng Vinh danh (VIP)</h6>
                <div class="form-group">
                    <label>C·∫•p ƒë·ªô VIP</label>
                    <select id="u_vip_level" class="form-control">
                        <option value="">-- Kh√¥ng --</option>
                        <option value="vip1">VIP 1 (Khung B·∫°c)</option>
                        <option value="vip2">VIP 2 (Khung V√†ng + V∆∞∆°ng mi·ªán)</option>
                        <option value="vip3">VIP 3 (Khung Kim C∆∞∆°ng + Hi·ªáu ·ª©ng)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Danh hi·ªáu (Ch·ªçn nhi·ªÅu)</label>
                    <div class="d-flex flex-wrap" id="u_honors_container">
                        <!-- Checkboxes generated by JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('users')">L∆∞u t√†i kho·∫£n</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Group -->
<div class="modal fade" id="modalGroup" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title">Th√¥ng tin Nh√≥m</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="group_id_old">
                <div class="form-group"><label>M√£ Nh√≥m</label><input type="text" id="g_id" class="form-control"></div>
                <div class="form-group"><label>T√™n Nh√≥m</label><input type="text" id="g_name" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('groups')">L∆∞u nh√≥m</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNoti" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title font-weight-bold">Th√¥ng tin th√¥ng b√°o</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="noti_id_old">
                <div class="form-group"><label>M√£ TB (ID)</label><input type="text" id="n_id" class="form-control" placeholder="NOTI01..."></div>
                <div class="form-group"><label>Ti√™u ƒë·ªÅ</label><input type="text" id="n_title" class="form-control"></div>
                <div class="form-group"><label>N·ªôi dung</label><textarea id="n_content" class="form-control" rows="3"></textarea></div>
                <div class="form-group"><label>Th·ªùi gian sinh ho·∫°t</label><input type="datetime-local" id="n_datetime" class="form-control"></div>
                <div class="form-group"><button class="btn btn-sm btn-info" onclick="previewNotification()"><i class="fas fa-eye mr-1"></i>Xem tr∆∞·ªõc hi·ªÉn th·ªã</button></div>
                <div class="form-group"><label>Cho ph√©p ƒëi·ªÉm danh s·ªõm?</label>
                    <select id="n_early" class="form-control">
                        <option value="TRUE">Cho ph√©p (M·ªü m·ªçi l√∫c)</option>
                        <option value="FALSE">Kh√¥ng (Ch·ªâ m·ªü khi ƒë·∫øn gi·ªù)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>H√¨nh th·ª©c th√¥ng b√°o</label>
                    <select id="n_type" class="form-control" onchange="toggleLocationInput()">
                        <option value="normal">Th√¥ng b√°o th∆∞·ªùng</option>
                        <option value="online">H·ªçp Online (Google Meet/Zoom)</option>
                        <option value="offline">H·ªçp Tr·ª±c ti·∫øp (T·∫°i ƒë·ªãa ƒëi·ªÉm)</option>
                    </select>
                </div>
                <div class="form-group d-none" id="grp_location"><label id="lbl_location">ƒê·ªãa ƒëi·ªÉm / Link h·ªçp</label><input type="text" id="n_location" class="form-control"></div>
                <div class="form-group">
                    <label>ƒê√≠nh k√®m t·ªáp tin</label>
                    <input type="file" id="n_file" class="form-control-file border p-1">
                    <small class="text-muted">Gi·ªõi h·∫°n: Word/PDF < 50MB, File kh√°c < 100MB</small>
                    <input type="hidden" id="n_attachment_base64">
                    <input type="hidden" id="n_file_name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('notifications')">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Create Poll -->
<div class="modal fade" id="modalPoll" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-poll mr-2"></i>T·∫°o B√¨nh ch·ªçn M·ªõi</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>C√¢u h·ªèi / Ch·ªß ƒë·ªÅ</label><input type="text" id="poll_question" class="form-control" placeholder="VD: Ch·ªçn tr√≤ ch∆°i sinh ho·∫°t..."></div>
                <div class="form-group"><label>C√°c l·ª±a ch·ªçn (NgƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y)</label><textarea id="poll_options" class="form-control" rows="3" placeholder="K√©o co, Nh·∫£y bao b·ªë, ƒê·ªë vui..."></textarea></div>
                <div class="form-group"><label>H·∫°n ch√≥t b√¨nh ch·ªçn</label><input type="datetime-local" id="poll_deadline" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="createPoll()">Ph√°t h√†nh B√¨nh ch·ªçn</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Poll Results Detail -->
<div class="modal fade" id="modalPollDetail" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title"><i class="fas fa-chart-pie mr-2"></i>K·∫øt qu·∫£ B√¨nh ch·ªçn Chi ti·∫øt</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6"><h5 id="pollDetailTitle" class="font-weight-bold text-primary"></h5></div>
                    <div class="col-md-6"><input type="text" id="pollSearch" class="form-control" placeholder="üîç T√¨m t√™n h·ªçc sinh ho·∫∑c l·ª±a ch·ªçn..." onkeyup="filterPollResults()"></div>
                </div>
                <ul class="nav nav-tabs" id="pollGroupTabs" role="tablist"></ul>
                <div class="tab-content border border-top-0 p-3 poll-tab-content" id="pollGroupContent"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button></div>
        </div>
    </div>
</div>

<!-- Modal Reply Feedback -->
<div class="modal fade" id="modalReply" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title">Ph·∫£n h·ªìi G√≥p √Ω</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reply_id">
                <div class="form-group"><label>N·ªôi dung ph·∫£n h·ªìi:</label><textarea id="reply_content" class="form-control" rows="4"></textarea></div>
                <div class="form-group"><label>Ng∆∞·ªùi tr·∫£ l·ªùi:</label><input type="text" id="reply_responder" class="form-control"></div>
                <div class="form-group"><label>SƒêT li√™n h·ªá (n·∫øu th·∫Øc m·∫Øc):</label><input type="text" id="reply_phone" class="form-control" placeholder="Nh·∫≠p SƒêT..."></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="submitReply()">G·ª≠i ph·∫£n h·ªìi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Settings -->
<div class="modal fade" id="modalSettings" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-cogs mr-2"></i>C√†i ƒë·∫∑t h·ªá th·ªëng</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="settingTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tab-interface">Giao di·ªán</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-troll">Th√¥ng b√°o Kh·∫©n</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-features">T√≠nh nƒÉng & Ch·ªØ ch·∫°y</a></li>
                </ul>
                <div class="tab-content">
                    <!-- Tab Giao di·ªán -->
                    <div class="tab-pane fade show active" id="tab-interface">
                        <div class="form-group d-flex justify-content-between align-items-center">
                            <label class="mb-0">Ch·∫ø ƒë·ªô T·ªëi (Dark Mode)</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="darkModeSwitch" onchange="toggleDarkMode()">
                                <label class="custom-control-label" for="darkModeSwitch"></label>
                            </div>
                        </div>
                        
                        <!-- C·∫•u h√¨nh B·∫£o tr√¨ N√¢ng cao -->
                        <div class="card card-danger card-outline mt-3 shadow-sm">
                            <div class="card-header"><h6 class="card-title font-weight-bold mb-0"><i class="fas fa-tools mr-2"></i>C·∫•u h√¨nh B·∫£o tr√¨ H·ªá th·ªëng</h6></div>
                            <div class="card-body">
                                <div class="form-group d-flex justify-content-between align-items-center border-bottom pb-3">
                                    <div><label class="mb-0 text-danger">B·∫£o tr√¨ Th·ªß c√¥ng (Ngay l·∫≠p t·ª©c)</label><br><small class="text-muted">G·∫°t n√∫t ƒë·ªÉ b·∫≠t b·∫£o tr√¨ ngay, b·∫•t k·ªÉ l·ªãch tr√¨nh.</small></div>
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="maintenanceSwitch" onchange="toggleMaintenance()">
                                        <label class="custom-control-label" for="maintenanceSwitch"></label>
                                    </div>
                                </div>
                                <label class="mt-2 text-primary"><i class="fas fa-calendar-alt mr-2"></i>L√™n l·ªãch B·∫£o tr√¨ T·ª± ƒë·ªông</label>
                                <div class="row">
                                    <div class="col-6"><div class="form-group"><label class="small text-muted">B·∫Øt ƒë·∫ßu</label><input type="datetime-local" id="maint_start_input" class="form-control form-control-sm"></div></div>
                                    <div class="col-6"><div class="form-group"><label class="small text-muted">K·∫øt th√∫c (Reset)</label><input type="datetime-local" id="maint_end_input" class="form-control form-control-sm"></div></div>
                                </div>
                                <button class="btn btn-sm btn-primary btn-block" onclick="saveMaintenanceSchedule()"><i class="fas fa-save mr-2"></i>L∆∞u L·ªãch B·∫£o Tr√¨</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-warning btn-block mt-4" onclick="cleanUpChat()"><i class="fas fa-trash-alt mr-2"></i>D·ªçn d·∫πp tin nh·∫Øn c≈© (>7 ng√†y)</button>
                        <p class="text-muted small">Chuy·ªÉn ƒë·ªïi giao di·ªán s√°ng/t·ªëi ƒë·ªÉ d·ªÖ nh√¨n h∆°n.</p>
                    </div>
                    <!-- Tab Th√¥ng b√°o Kh·∫©n -->
                    <div class="tab-pane fade" id="tab-troll">
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <label class="mb-0 text-danger font-weight-bold">K√≠ch ho·∫°t Th√¥ng b√°o Kh·∫©n</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="troll_enabled">
                                <label class="custom-control-label" for="troll_enabled"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded mt-2">
                            <label class="mb-0 text-primary"><i class="fas fa-mobile-alt mr-2"></i>Hi·ªÉn th·ªã d·∫°ng Th√¥ng b√°o ƒëi·ªán tho·∫°i (Banner)</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="troll_mode">
                                <label class="custom-control-label" for="troll_mode"></label>
                            </div>
                        </div>
                        <div class="form-group"><label>Ti√™u ƒë·ªÅ Th√¥ng b√°o</label><input type="text" id="troll_title" class="form-control" placeholder="VD: TH√îNG B√ÅO KH·∫®N..."></div>
                        <div class="form-group"><label>N·ªôi dung</label><textarea id="troll_content" class="form-control" rows="3" placeholder="N·ªôi dung hi·ªÉn th·ªã..."></textarea></div>
                        <div class="form-group"><label>Link YouTube (T√πy ch·ªçn)</label><input type="text" id="troll_youtube" class="form-control" placeholder="https://youtu.be/..."></div>
                        <div class="form-group">
                            <label>File ƒë√≠nh k√®m (·∫¢nh/Word/Excel/Zip...)</label>
                            <input type="file" id="troll_file" class="form-control-file border p-1">
                            <small class="text-muted">Gi·ªõi h·∫°n: Word/PDF < 50MB, File kh√°c < 100MB</small>
                            <input type="hidden" id="troll_image_base64">
                            <input type="hidden" id="troll_file_name">
                        </div>
                        <div class="d-flex">
                            <button class="btn btn-secondary flex-grow-1 mr-2" onclick="resetPushNotification()"><i class="fas fa-undo mr-2"></i>Reset & T·∫Øt</button>
                            <button class="btn btn-primary flex-grow-1" onclick="saveTrollConfig()"><i class="fas fa-save mr-2"></i>L∆∞u C·∫•u h√¨nh</button>
                        </div>
                    </div>
                    <!-- Tab T√≠nh nƒÉng & Ch·ªØ ch·∫°y -->
                    <div class="tab-pane fade" id="tab-features">
                        <h6 class="text-primary font-weight-bold"><i class="fas fa-scroll mr-2"></i>C·∫•u h√¨nh Ch·ªØ ch·∫°y (Marquee)</h6>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <label class="mb-0">B·∫≠t ch·ªØ ch·∫°y</label>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_marquee_enabled"><label class="custom-control-label" for="conf_marquee_enabled"></label></div>
                        </div>
                        <div class="form-group"><label>N·ªôi dung hi·ªÉn th·ªã</label><input type="text" id="conf_marquee_text" class="form-control" placeholder="VD: Ch√∫c m·ª´ng nƒÉm m·ªõi..."></div>
                        <hr>
                        <h6 class="text-danger font-weight-bold"><i class="fas fa-tools mr-2"></i>B·∫£o tr√¨ t·ª´ng t√≠nh nƒÉng (Manager)</h6>
                        <p class="small text-muted">B·∫≠t switch ƒë·ªÉ ƒê√ìNG (B·∫£o tr√¨) t√≠nh nƒÉng ƒë√≥.</p>
                        <div class="row">
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_attendance"><label class="custom-control-label" for="maint_attendance">ƒêi·ªÉm danh</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_students"><label class="custom-control-label" for="maint_students">DS H·ªçc sinh</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_funds"><label class="custom-control-label" for="maint_funds">Qu·ªπ nh√≥m</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_notis"><label class="custom-control-label" for="maint_notis">Th√¥ng b√°o</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_eval"><label class="custom-control-label" for="maint_eval">ƒê√°nh gi√°</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_feedback"><label class="custom-control-label" for="maint_feedback">G√≥p √Ω</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_upload"><label class="custom-control-label" for="maint_upload">Trung t√¢m T·∫£i file</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_calendar"><label class="custom-control-label" for="maint_calendar">L·ªãch ho·∫°t ƒë·ªông</label></div></div>
                        </div>
                        <hr>
                        <h6 class="text-warning font-weight-bold"><i class="fas fa-user-lock mr-2"></i>Kh√≥a nh·∫≠p li·ªáu H·ªçc sinh</h6>
                        <div class="form-group d-flex justify-content-between align-items-center">
                            <label class="mb-0">Kh√≥a nh·∫≠p/th√™m h·ªçc sinh m·ªõi</label>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_student_import_locked"><label class="custom-control-label" for="conf_student_import_locked"></label></div>
                        </div>
                        <div class="form-group"><label>H·∫°n ch√≥t nh·∫≠p li·ªáu (T·ª± ƒë·ªông kh√≥a sau ng√†y n√†y)</label><input type="date" id="conf_student_import_deadline" class="form-control"></div>

                        <div class="form-group mt-2 border-top pt-2">
                            <label>Gi·ªõi h·∫°n dung l∆∞·ª£ng file Upload (MB)</label>
                            <input type="number" id="conf_max_upload_size" class="form-control" placeholder="M·∫∑c ƒë·ªãnh: 200" value="200">
                        </div>
                        <button class="btn btn-primary btn-block mt-3" onclick="saveFeatureConfig()"><i class="fas fa-save mr-2"></i>L∆∞u C·∫•u h√¨nh T√≠nh nƒÉng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";
let globalHistoryData = [], globalStudentsData = [], globalUsersData = [], globalGroupsData = [], globalNotisData = [];
let currentHistoryView = []; // D·ªØ li·ªáu l·ªãch s·ª≠ ƒëang hi·ªÉn th·ªã (ƒë√£ l·ªçc)
let currentStudentView = []; // D·ªØ li·ªáu h·ªçc sinh ƒëang hi·ªÉn th·ªã
let currentEvaluationView = []; // D·ªØ li·ªáu ƒë√°nh gi√° ƒëang hi·ªÉn th·ªã
let globalMaxUploadSize = 200; // Default 200MB

function getLoadingRowHtml(colspan) {
    return `<tr><td colspan="${colspan}" class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p></td></tr>`;
}

function getErrorRowHtml(colspan, message = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.") {
    return `<tr><td colspan="${colspan}" class="text-center text-danger p-5"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></td></tr>`;
}


$(document).ready(function() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    if(user) $('#adminNameDisplay').text(user.fullname);
    
    // Load Dark Mode setting
    if (localStorage.getItem('darkMode') === 'true') {
        $('body').addClass('dark-mode');
    }
    refreshAll();
});

async function refreshAll() {
    await loadStudents();
    updateAttendanceStats();
    loadExtraData();
    loadLogs();
    loadFeedbacks();
    loadEvaluations();
    loadSystemSettings(); // Load config (Eval + Troll)
    loadEvalConfig();
}

async function loadStudents() {
    $('#studentData').html(getLoadingRowHtml(7));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_USERS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalStudentsData = res.data.students;
            $('#countHS').text(res.data.totalStudents);
            
            // Populate Filters
            populateStudentFilters();
            
            // Render Table
            currentStudentView = globalStudentsData;
            renderStudentTable(currentStudentView);
        }
    } catch (e) { 
        toastr.error("L·ªói t·∫£i danh s√°ch h·ªçc sinh."); 
        $('#studentData').html(getErrorRowHtml(7));
    }
}

function populateStudentFilters() {
    const groups = [...new Set(globalStudentsData.map(s => s.group_display))].sort();
    const schools = [...new Set(globalStudentsData.map(s => s.school).filter(s => s))].sort();
    
    let gHtml = '<option value="">-- T·∫•t c·∫£ Nh√≥m --</option>';
    groups.forEach(g => gHtml += `<option value="${g}">${g}</option>`);
    $('#st_filter_group').html(gHtml);

    let sHtml = '<option value="">-- T·∫•t c·∫£ Tr∆∞·ªùng --</option>';
    schools.forEach(s => sHtml += `<option value="${s}">${s}</option>`);
    $('#st_filter_school').html(sHtml);
}

function renderStudentTable(data) {
    let html = '';
    data.forEach((st, index) => {
        html += `<tr>
            <td class="font-weight-bold">${st.fullname}</td>
            <td class="text-dob">${st.dob}</td>
            <td><span class="badge badge-info badge-group">${st.group_display}</span></td>
            <td><small>${st.school}</small></td>
            <td><a href="tel:${st.phone}">${st.phone || '-'}</a></td>
            <td><small>${st.address || '-'}</small></td>
            <td>
                <button class="btn btn-info btn-action" onclick="editStudent('${st.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-action" onclick="deleteData('students', '${st.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
    
    if ($.fn.DataTable.isDataTable('#studentTable')) {
        $('#studentTable').DataTable().destroy();
    }
    $('#studentData').html(html);
    $('#studentTable').DataTable({ 
        "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "T·∫•t c·∫£"]]
    });
}

function filterStudents() {
    const name = $('#st_filter_name').val().toLowerCase();
    const group = $('#st_filter_group').val();
    const school = $('#st_filter_school').val();
    const from = $('#st_filter_from').val();
    const to = $('#st_filter_to').val();

    let d1, d2;
    if (from) { d1 = new Date(from); d1.setHours(0,0,0,0); } // Start of day
    if (to) { d2 = new Date(to); d2.setHours(23,59,59,999); } // End of day

    currentStudentView = globalStudentsData.filter(st => {
        const matchName = !name || (st.fullname && st.fullname.toLowerCase().includes(name));
        const matchGroup = !group || (st.group_display && st.group_display === group);
        const matchSchool = !school || (st.school && st.school === school);
        
        let matchDate = true;
        if (d1 || d2) {
            // Extract timestamp from ID (ST + timestamp)
            const ts = parseInt(st.id.replace('ST', ''));
            if (!isNaN(ts)) {
                const dateAdded = new Date(ts);
                if (d1 && dateAdded.getTime() < d1.getTime()) matchDate = false;
                if (d2 && dateAdded.getTime() > d2.getTime()) matchDate = false;
            }
        }

        return matchName && matchGroup && matchSchool && matchDate;
    });

    renderStudentTable(currentStudentView);
    toastr.success(`T√¨m th·∫•y ${currentStudentView.length} h·ªçc sinh`);
}

function resetStudentFilter() {
    $('#st_filter_name, #st_filter_group, #st_filter_school, #st_filter_from, #st_filter_to').val('');
    currentStudentView = globalStudentsData;
    renderStudentTable(currentStudentView);
}

async function loadExtraData() {
    $('#managerData').html(getLoadingRowHtml(8));
    $('#notiData').html(getLoadingRowHtml(8));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalUsersData = res.data.managers;
            globalGroupsData = res.data.groups;
            globalNotisData = res.data.notifications || [];
            
            // Managers Table
            let mHtml = '';
            res.data.managers.forEach((m, idx) => {
                let honorBadge = '';
                try {
                    const h = JSON.parse(m.honors || '{}');
                    if(h.level) honorBadge = `<span class="badge badge-warning ml-1">${h.level.toUpperCase()}</span>`;
                } catch(e){}
                mHtml += `<tr>
                    <td class="text-center"><img src="${m.avatar || 'https://via.placeholder.com/50'}" class="img-manager shadow-sm"></td>
                    <td><code>${m.username}</code></td>
                    <td class="font-weight-bold">${m.fullname}</td>
                    <td><span class="badge badge-warning">${m.group_id}</span></td>
                    <td><span class="badge badge-secondary">${m.role}</span></td>
                    <td><small>${m.email || '-'}</small></td>
                    <td><small>${m.last_login || '-'}</small></td>
                    <td>
                        <button class="btn btn-info btn-action" onclick="editUser('${m.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-warning btn-action" onclick="resetPassword('${m.username}')" title="Reset Pass"><i class="fas fa-key"></i></button>
                        <button class="btn btn-danger btn-action" onclick="deleteData('users', '${m.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            if ($.fn.DataTable.isDataTable('#managerTable')) {
                $('#managerTable').DataTable().destroy();
            }
            $('#managerData').html(mHtml);
            $('#managerTable').DataTable({ "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }});
 
            // Groups View
            let gHtml = '';
            res.data.groups.forEach((g, idx) => {
                gHtml += `<div class="col-md-3">
                    <div class="info-box shadow-sm position-relative">
                        <span class="info-box-icon bg-info elevation-1"><i class="fas fa-layer-group"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text text-bold">${g.group_name}</span>
                            <span class="info-box-number">M√£: ${g.group_id}</span>
                        </div>
                        <div style="position:absolute; right:5px; top:5px;">
                             <button class="btn btn-xs btn-outline-info" onclick="editGroup(${idx})"><i class="fas fa-edit"></i></button>
                             <button class="btn btn-xs btn-outline-danger" onclick="deleteData('groups', '${g.group_id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            $('#groupCardsContainer').html(gHtml || '<div class="col-12 text-center">Kh√¥ng c√≥ d·ªØ li·ªáu nh√≥m</div>');

            // Notifications Table
            let nHtml = '';
            globalNotisData.forEach((n, idx) => {
                let readers = n.read_by || [];
                if (typeof readers === 'string') readers = readers.split(',').filter(x => x);
                let readersHtml = readers.length > 0
                    ? `<span class="badge badge-info">${readers.length}</span> <small class="d-block" style="max-height:60px;overflow-y:auto;">${readers.join(', ')}</small>` 
                    : '<small class="text-muted">Ch∆∞a c√≥</small>';

                let typeBadge = '<span class="badge badge-secondary">Th∆∞·ªùng</span>';
                let pollActions = '';
                
                if (n.type === 'online') typeBadge = '<span class="badge badge-primary"><i class="fas fa-video mr-1"></i>Online</span>';
                if (n.type === 'offline') typeBadge = '<span class="badge badge-success"><i class="fas fa-map-marker-alt mr-1"></i>Tr·ª±c ti·∫øp</span>';
                if (n.type === 'poll') {
                    typeBadge = '<span class="badge badge-warning"><i class="fas fa-poll mr-1"></i>B√¨nh ch·ªçn</span>';
                    pollActions = `
                        <div class="mt-1">
                            <button class="btn btn-xs btn-outline-primary" onclick="viewPollDetail('${n.id}', '${n.title}')" title="Xem chi ti·∫øt"><i class="fas fa-list-ol"></i></button>
                            <button class="btn btn-xs btn-outline-success" onclick="exportPollExcel('${n.id}', '${n.title}')" title="Xu·∫•t Excel"><i class="fas fa-file-excel"></i></button>
                        </div>`;
                }
                
                let locationInfo = n.location ? `<br><small class="text-muted">${n.type === 'online' ? 'Link: ' : 'ƒêƒê: '}${n.location}</small>` : '';
                let attachIcon = n.attachment ? `<br><span class="badge badge-warning"><i class="fas fa-paperclip"></i> C√≥ file</span>` : '';

                nHtml += `<tr>
                    <td>${n.id}</td>
                    <td class="font-weight-bold">${n.title}</td>
                    <td><small>${n.content}</small></td>
                    <td><code>${n.datetime}</code></td>
                    <td><span class="badge badge-${n.early === 'TRUE' ? 'success' : 'secondary'}">${n.early}</span></td>
                    <td>${typeBadge}${locationInfo}${attachIcon}</td>
                    <td>${readersHtml}${pollActions}</td>
                    <td>
                        <button class="btn btn-danger btn-action" onclick="deleteData('notifications', '${n.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            $('#notiData').html(nHtml);
        }
    } catch (e) { 
        console.error("Error loading extra data", e); 
        $('#managerData').html(getErrorRowHtml(6));
        $('#notiData').html(getErrorRowHtml(8));
    }
}

async function loadLogs() {
    $('#logData').html(getLoadingRowHtml(4));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_LOGS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            res.data.forEach(log => {
                html += `<tr>
                    <td><small>${log.timestamp}</small></td>
                    <td><code>${log.username}</code></td>
                    <td><span class="badge badge-light border">${log.action}</span></td>
                    <td><small>${log.details}</small></td>
                </tr>`;
            });
            $('#logData').html(html);
        }
    } catch (e) { console.log("Logs error"); $('#logData').html(getErrorRowHtml(4)); }
}

let globalFeedbacksData = [];
async function loadFeedbacks() {
    $('#feedbackData').html(getLoadingRowHtml(5));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_FEEDBACKS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            globalFeedbacksData = res.data || [];
            renderFeedbacks(globalFeedbacksData);
        }
    } catch (e) { console.error("Feedback error", e); $('#feedbackData').html(getErrorRowHtml(5)); }
}

function renderFeedbacks(data) {
    let html = '';
    if (data.length === 0) {
        html = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ g√≥p √Ω n√†o.</td></tr>';
    } else {
        data.forEach(fb => {
            const contentAndAttachments = `
                <b>${fb.title || '(Kh√¥ng c√≥ ti√™u ƒë·ªÅ)'}</b><br>
                <small>
                    <span class="text-danger">Kh√≥ khƒÉn:</span> ${fb.difficulty || 'Kh√¥ng'}<br>
                    <span class="text-info">G√≥p √Ω:</span> ${fb.suggestion || 'Kh√¥ng'}
                </small>
                <div class="mt-2">
                    ${fb.drive_link ? `<a href="${fb.drive_link}" target="_blank" class="btn btn-xs btn-info mb-1"><i class="fab fa-google-drive mr-1"></i>Link Drive</a> ` : ''}
                    ${fb.attachment ? `<a href="${fb.attachment}" download="${fb.attachment_name || 'file'}" class="btn btn-xs btn-secondary"><i class="fas fa-download mr-1"></i>T·∫£i File</a>` : ''}
                </div>
            `;

            html += `<tr>
                <td><small>${fb.timestamp}</small></td>
                <td>
                    <b>${fb.fullname || 'V√¥ danh'}</b><br>
                    <small>SƒêT: ${fb.phone}</small><br>
                    <span class="badge badge-secondary">Nh√≥m ${fb.group_id}</span>
                </td>
                <td>
                    ${contentAndAttachments}
                </td>
                <td>
                    ${fb.reply ? `<div class="alert alert-light border">${fb.reply}</div>` : '<i class="text-muted">Ch∆∞a c√≥ ph·∫£n h·ªìi</i>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openReply('${fb.id}')"><i class="fas fa-reply"></i> Tr·∫£ l·ªùi</button>
                </td>
            </tr>`;
        });
    }
    
    // Re-init DataTable if needed, or just rely on manual filter
    if ($.fn.DataTable.isDataTable('#feedbackTable')) {
        $('#feedbackTable').DataTable().destroy();
    }
    $('#feedbackData').html(html);
    $('#feedbackTable').DataTable({ 
        "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }, 
        "order": [[ 0, "desc" ]],
        "searching": true
    });
}

// Load config cho c·∫£ Eval v√† Troll
async function loadEvalConfig() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_CONFIG" }) });
        const res = await response.json();
        if (res.status === "success") {
            $('#conf_eval_enabled').prop('checked', String(res.data.evaluation_enabled).toUpperCase() === 'TRUE');
            // Format date for input type=date (YYYY-MM-DD)
            if (res.data.evaluation_deadline) {
                const d = new Date(res.data.evaluation_deadline);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                $('#conf_eval_deadline').val(`${yyyy}-${mm}-${dd}`);
            }
            
            // Load Troll Config
            $('#troll_enabled').prop('checked', String(res.data.troll_enabled).toUpperCase() === 'TRUE');
            $('#troll_mode').prop('checked', String(res.data.troll_mode).toUpperCase() === 'TRUE');
            $('#troll_title').val(res.data.troll_title || '');
            $('#troll_content').val(res.data.troll_content || '');
            $('#troll_youtube').val(res.data.troll_youtube || '');
            $('#troll_file_name').val(res.data.troll_file_name || '');

            // Load Maintenance Config
            $('#maintenanceSwitch').prop('checked', String(res.data.maintenance_mode).toUpperCase() === 'TRUE');
            
            // Helper format datetime-local
            const fmtDate = (iso) => {
                if(!iso) return '';
                const d = new Date(iso);
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };
            $('#maint_start_input').val(fmtDate(res.data.maintenance_start));
            $('#maint_end_input').val(fmtDate(res.data.maintenance_end));

            // Load Marquee Config
            $('#conf_marquee_enabled').prop('checked', String(res.data.marquee_enabled).toUpperCase() === 'TRUE');
            $('#conf_marquee_text').val(res.data.marquee_text || '');

            // Load Feature Maintenance Config
            $('#maint_attendance').prop('checked', String(res.data.maint_attendance).toUpperCase() === 'TRUE');
            $('#maint_students').prop('checked', String(res.data.maint_students).toUpperCase() === 'TRUE');
            $('#maint_funds').prop('checked', String(res.data.maint_funds).toUpperCase() === 'TRUE');
            $('#maint_notis').prop('checked', String(res.data.maint_notis).toUpperCase() === 'TRUE');
            $('#maint_eval').prop('checked', String(res.data.maint_eval).toUpperCase() === 'TRUE');
            $('#maint_feedback').prop('checked', String(res.data.maint_feedback).toUpperCase() === 'TRUE');
            $('#maint_upload').prop('checked', String(res.data.maint_upload).toUpperCase() === 'TRUE');
            $('#maint_calendar').prop('checked', String(res.data.maint_calendar).toUpperCase() === 'TRUE');
            
            // Student Import Lock
            $('#conf_student_import_locked').prop('checked', String(res.data.student_import_locked).toUpperCase() === 'TRUE');
            if(res.data.student_import_deadline) $('#conf_student_import_deadline').val(res.data.student_import_deadline.split('T')[0]);
            
            // Load Max Upload Size
            globalMaxUploadSize = parseInt(res.data.max_upload_size) || 200;
            $('#conf_max_upload_size').val(globalMaxUploadSize);
        }
    } catch (e) { console.error("Config error", e); }
}

async function saveEvalConfig() {
    const enabled = $('#conf_eval_enabled').is(':checked') ? 'TRUE' : 'FALSE';
    const deadline = $('#conf_eval_deadline').val();
    
    Swal.fire({ title: 'ƒêang l∆∞u...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { evaluation_enabled: enabled, evaluation_deadline: deadline } }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ l∆∞u c·∫•u h√¨nh ƒë√°nh gi√°!', 'success');
            $('#modalEvalConfig').modal('hide');
        }
        else Swal.fire('L·ªói', res.message, 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

// --- SETTINGS & TROLL FUNCTIONS ---
function openSettingsModal() {
    $('#modalSettings').modal('show');
    $('#darkModeSwitch').prop('checked', $('body').hasClass('dark-mode'));
    loadEvalConfig(); // Reload config ƒë·ªÉ l·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t
}

function toggleDarkMode() {
    if ($('#darkModeSwitch').is(':checked')) {
        $('body').addClass('dark-mode');
        localStorage.setItem('darkMode', 'true');
    } else {
        $('body').removeClass('dark-mode');
        localStorage.setItem('darkMode', 'false');
    }
}

async function toggleMaintenance() {
    const enabled = $('#maintenanceSwitch').is(':checked') ? 'TRUE' : 'FALSE';
    const msg = enabled === 'TRUE' ? 'B·∫¨T ch·∫ø ƒë·ªô b·∫£o tr√¨? T·∫•t c·∫£ Qu·∫£n l√Ω s·∫Ω b·ªã ƒëƒÉng xu·∫•t.' : 'T·∫ÆT ch·∫ø ƒë·ªô b·∫£o tr√¨?';
    
    if(!confirm(msg)) {
        $('#maintenanceSwitch').prop('checked', !$('#maintenanceSwitch').is(':checked')); // Revert
        return;
    }

    try {
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { maintenance_mode: enabled } }) });
        toastr.success("ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i b·∫£o tr√¨!");
    } catch (e) { toastr.error("L·ªói k·∫øt n·ªëi"); }
}

async function saveMaintenanceSchedule() {
    const start = $('#maint_start_input').val();
    const end = $('#maint_end_input').val();
    
    if (start && end && new Date(start) >= new Date(end)) {
        return Swal.fire('L·ªói', 'Th·ªùi gian k·∫øt th√∫c ph·∫£i sau th·ªùi gian b·∫Øt ƒë·∫ßu!', 'error');
    }

    Swal.fire({ title: 'ƒêang l∆∞u l·ªãch...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { maintenance_start: start, maintenance_end: end } }) });
        const res = await response.json();
        if (res.status === 'success') Swal.fire('Th√†nh c√¥ng', 'ƒê√£ l∆∞u l·ªãch b·∫£o tr√¨!', 'success');
        else Swal.fire('L·ªói', res.message, 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

// X·ª≠ l√Ω ·∫£nh Troll
$('#troll_file').change(function() {
    const file = this.files[0];
    if (file) {
        const isWord = file.name.match(/\.(doc|docx|pdf)$/i);
        const limit = isWord ? 50 * 1024 * 1024 : 100 * 1024 * 1024;
        
        if (file.size > limit) {
            toastr.warning(`File qu√° l·ªõn! Gi·ªõi h·∫°n: ${isWord ? '50MB (Word/PDF)' : '100MB (Kh√°c)'}`);
            this.value = ''; $('#troll_image_base64').val(''); $('#troll_file_name').val('');
            return;
        }
        $('#troll_file_name').val(file.name);
        const reader = new FileReader();
        reader.onload = function(e) { $('#troll_image_base64').val(e.target.result); };
        reader.readAsDataURL(file);
    }
});

async function saveTrollConfig() {
    const enabled = $('#troll_enabled').is(':checked') ? 'TRUE' : 'FALSE';
    const payload = {
        troll_enabled: enabled,
        troll_mode: $('#troll_mode').is(':checked') ? 'TRUE' : 'FALSE',
        troll_title: $('#troll_title').val(),
        troll_content: $('#troll_content').val(),
        troll_youtube: $('#troll_youtube').val(),
        troll_file_name: $('#troll_file_name').val()
    };
    
    // Ch·ªâ g·ª≠i ·∫£nh n·∫øu c√≥ ch·ªçn ·∫£nh m·ªõi (ƒë·ªÉ tr√°nh x√≥a ·∫£nh c≈© n·∫øu kh√¥ng ch·ªçn)
    const imgBase64 = $('#troll_image_base64').val();
    if (imgBase64) payload.troll_image = imgBase64;
    else if (!enabled) payload.troll_image = ''; // N·∫øu t·∫Øt th√¨ c√≥ th·ªÉ x√≥a ·∫£nh

    Swal.fire({ title: 'ƒêang l∆∞u c·∫•u h√¨nh...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') Swal.fire('Th√†nh c√¥ng', 'ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh Th√¥ng b√°o Kh·∫©n!', 'success');
        else Swal.fire('L·ªói', res.message, 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

async function saveFeatureConfig() {
    const payload = {
        marquee_enabled: $('#conf_marquee_enabled').is(':checked') ? 'TRUE' : 'FALSE',
        marquee_text: $('#conf_marquee_text').val(),
        maint_attendance: $('#maint_attendance').is(':checked') ? 'TRUE' : 'FALSE',
        maint_students: $('#maint_students').is(':checked') ? 'TRUE' : 'FALSE',
        maint_funds: $('#maint_funds').is(':checked') ? 'TRUE' : 'FALSE',
        maint_notis: $('#maint_notis').is(':checked') ? 'TRUE' : 'FALSE',
        maint_eval: $('#maint_eval').is(':checked') ? 'TRUE' : 'FALSE',
        maint_feedback: $('#maint_feedback').is(':checked') ? 'TRUE' : 'FALSE',
        maint_upload: $('#maint_upload').is(':checked') ? 'TRUE' : 'FALSE',
        maint_calendar: $('#maint_calendar').is(':checked') ? 'TRUE' : 'FALSE',
        student_import_locked: $('#conf_student_import_locked').is(':checked') ? 'TRUE' : 'FALSE',
        student_import_deadline: $('#conf_student_import_deadline').val(),
        max_upload_size: $('#conf_max_upload_size').val() || '200'
    };
    Swal.fire({ title: 'ƒêang l∆∞u...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Th√†nh c√¥ng', 'ƒê√£ l∆∞u c·∫•u h√¨nh t√≠nh nƒÉng!', 'success'); loadEvalConfig(); }
        else Swal.fire('L·ªói', res.message, 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

async function resetPushNotification() {
    Swal.fire({
        title: 'Reset Th√¥ng b√°o Kh·∫©n?',
        text: "To√†n b·ªô n·ªôi dung th√¥ng b√°o s·∫Ω b·ªã x√≥a v√† t·∫Øt k√≠ch ho·∫°t. B·∫°n c√≥ ch·∫Øc kh√¥ng?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'V√¢ng, Reset!',
        cancelButtonText: 'H·ªßy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            $('#troll_enabled').prop('checked', false);
            $('#troll_title, #troll_content, #troll_youtube, #troll_file, #troll_image_base64, #troll_file_name').val(''); $('#troll_mode').prop('checked', false);

            const payload = { troll_enabled: 'FALSE', troll_title: '', troll_content: '', troll_youtube: '', troll_image: '', troll_file_name: '' };

            Swal.fire({ title: 'ƒêang reset...', didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
                const res = await response.json();
                if (res.status === 'success') Swal.fire('ƒê√£ Reset', 'Th√¥ng b√°o kh·∫©n ƒë√£ ƒë∆∞·ª£c x√≥a v√† t·∫Øt.', 'success');
                else Swal.fire('L·ªói', res.message, 'error');
            } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi khi reset.', 'error'); }
        }
    });
}

// Alias function ƒë·ªÉ load config chung
function loadSystemSettings() {
    // ƒê√£ g·ªôp v√†o loadEvalConfig nh∆∞ng gi·ªØ h√†m n√†y n·∫øu c·∫ßn m·ªü r·ªông
    loadEvalConfig();
}

function resetEvaluations() {
    Swal.fire({
        title: 'B·∫Øt ƒë·∫ßu ƒë·ª£t ƒë√°nh gi√° m·ªõi?',
        text: "H√†nh ƒë·ªông n√†y s·∫Ω X√ìA TO√ÄN B·ªò d·ªØ li·ªáu ƒë√°nh gi√° hi·ªán t·∫°i c·ªßa t·∫•t c·∫£ h·ªçc sinh ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·ª£t m·ªõi. B·∫°n c√≥ ch·∫Øc ch·∫Øn kh√¥ng?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'X√≥a & Reset',
        cancelButtonText: 'H·ªßy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            const user = JSON.parse(sessionStorage.getItem('user'));
            Swal.fire({ title: 'ƒêang x·ª≠ l√Ω...', didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(API_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ 
                        action: "RESET_EVALUATIONS", 
                        payload: { admin_user: user.username } 
                    }) 
                });
                const res = await response.json();
                if (res.status === 'success') {
                    Swal.fire('Th√†nh c√¥ng', res.message, 'success');
                    loadEvaluations();
                } else Swal.fire('L·ªói', res.message, 'error');
            } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
        }
    });
}

let globalEvaluationsData = [];
async function loadEvaluations() {
    $('#evalData').html(getLoadingRowHtml(6));
    $('#eval_filter_group').html('<option value="">-- T·∫•t c·∫£ Nh√≥m --</option>'); // Reset filter nh√≥m
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_EVALUATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            const rawEvaluations = res.data; // [ID, Name, Group, Disc, Pos, Vol, Class, By, Time]
            
            const mergedList = globalStudentsData.map(st => {
                const evalItem = rawEvaluations.find(e => String(e[0]) === String(st.id));
                if (evalItem) {
                    return {
                        name: st.fullname,
                        group: st.group_display,
                        disc: evalItem[3],
                        pos: evalItem[4],
                        vol: evalItem[5],
                        class: evalItem[6]
                    };
                } else {
                    return {
                        name: st.fullname,
                        group: st.group_display,
                        disc: '',
                        pos: '',
                        vol: '',
                        class: 'Ch∆∞a ƒë√°nh gi√°'
                    };
                }
            });
            
            globalEvaluationsData = mergedList; // L∆∞u d·ªØ li·ªáu ƒë√£ gh√©p ƒë·ªÉ xu·∫•t Excel
            
            // Populate Group Filter
            const groups = [...new Set(globalEvaluationsData.map(e => e.group))].sort();
            let gHtml = '<option value="">-- T·∫•t c·∫£ Nh√≥m --</option>';
            groups.forEach(g => gHtml += `<option value="${g}">${g}</option>`);
            $('#eval_filter_group').html(gHtml);

            // Render Default
            filterEvaluations();
        }
    } catch (e) { console.error("Eval error", e); $('#evalData').html(getErrorRowHtml(6)); }
}

function filterEvaluations() {
    const name = $('#eval_filter_name').val().toLowerCase();
    const group = $('#eval_filter_group').val();
    const status = $('#eval_filter_status').val();
    const classification = $('#eval_filter_class').val();

    currentEvaluationView = globalEvaluationsData.filter(e => {
        const matchName = !name || (e.name && e.name.toLowerCase().includes(name));
        const matchGroup = !group || e.group === group;
        
        let matchStatus = true;
        if (status === 'evaluated') matchStatus = e.class !== 'Ch∆∞a ƒë√°nh gi√°';
        if (status === 'not_evaluated') matchStatus = e.class === 'Ch∆∞a ƒë√°nh gi√°';

        let matchClass = true;
        if (classification) matchClass = e.class === classification;

        return matchName && matchGroup && matchStatus && matchClass;
    });

    renderEvaluationTable(currentEvaluationView);
}

function renderEvaluationTable(data) {
    let html = '';
    if (data.length === 0) {
        html = '<tr><td colspan="6" class="text-center">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</td></tr>';
    } else {
        data.forEach(e => {
            let badgeClass = 'secondary';
            if (e.class === 'Xu·∫•t s·∫Øc') badgeClass = 'success';
            else if (e.class === 'T·ªët') badgeClass = 'primary';
            else if (e.class === 'Trung b√¨nh') badgeClass = 'warning';
            else if (e.class === 'Y·∫øu') badgeClass = 'danger';
            else badgeClass = 'light border'; // Ch∆∞a ƒë√°nh gi√°

            html += `<tr>
                <td class="font-weight-bold">${e.name}</td>
                <td><span class="badge badge-light border">${e.group}</span></td>
                <td><small>${e.disc || '-'}</small></td>
                <td><small>${e.pos || '-'}</small></td>
                <td><small>${e.vol || '-'}</small></td>
                <td><span class="badge badge-${badgeClass}">${e.class}</span></td>
            </tr>`;
        });
    }
    if ($.fn.DataTable.isDataTable('#evalTable')) {
        $('#evalTable').DataTable().destroy();
    }
    $('#evalData').html(html);
    $('#evalTable').DataTable({ "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }, "searching": false });
}

function resetEvaluationFilter() {
    $('#eval_filter_name, #eval_filter_group, #eval_filter_status, #eval_filter_class').val('');
    filterEvaluations();
}

async function updateAttendanceStats() {
    $('#historyAttendanceData').html(getLoadingRowHtml(5));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_ADMIN_STATS" }) });
        const res = await response.json();
        if (res.status === "success") {
            const s = res.data;
            $('#countPresent').text(s.present);
            $('#countAbsentP').text(s.absent_perm);
            $('#countAbsent').text(s.absent);
            globalHistoryData = s.history || [];
            currentHistoryView = globalHistoryData; // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã t·∫•t c·∫£
            renderHistoryTable(currentHistoryView);
        }
    } catch (e) { 
        toastr.error("Kh√¥ng th·ªÉ k·∫øt n·ªëi Server."); 
        $('#historyAttendanceData').html(getErrorRowHtml(5));
    }
}

function renderHistoryTable(history) {
    let html = '';
    history.forEach(row => {
        let statusBadge = row.status === 'present' ? '<span class="badge badge-success">C√≥ m·∫∑t</span>' : 
                          (row.status === 'absent_perm' ? '<span class="badge badge-warning">V·∫Øng (P)</span>' : '<span class="badge badge-danger">V·∫Øng</span>');
        let reasonHtml = row.reason ? `<br><small class="text-muted font-italic">L√Ω do: ${row.reason}</small>` : '';
        html += `<tr>
            <td><small class="text-muted">${row.timestamp}</small></td>
            <td><b>${row.student_name}</b></td>
            <td><span class="badge badge-light border">${row.group_id}</span></td>
            <td>${statusBadge}${reasonHtml}</td>
            <td><small>${row.recorded_by}</small></td>
        </tr>`;
    });
    $('#historyAttendanceData').html(html || '<tr><td colspan="5" class="text-center">Tr·ªëng</td></tr>');
}

function filterHistory() {
    const from = $('#filter_from').val();
    const to = $('#filter_to').val();
    const status = $('#filter_status').val();
    const name = $('#filter_history_name').val().toLowerCase();

    let d1, d2;
    if (from && to) {
        d1 = new Date(from); d1.setHours(0,0,0,0);
        d2 = new Date(to); d2.setHours(23,59,59,999);
    }
    
    currentHistoryView = globalHistoryData.filter(h => {
        let dateMatch = true;
        if (d1 && d2) {
            const parts = h.timestamp.split(' ')[0].split('/'); // dd/mm/yyyy
            const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // yyyy-mm-dd
            dateMatch = d >= d1 && d <= d2;
        }
        
        let statusMatch = true;
        if (status) {
            statusMatch = h.status === status;
        }

        let nameMatch = true;
        if (name) {
            nameMatch = h.student_name.toLowerCase().includes(name);
        }
        return dateMatch && statusMatch && nameMatch;
    });
    renderHistoryTable(currentHistoryView);
    toastr.success(`ƒê√£ l·ªçc: ${currentHistoryView.length} b·∫£n ghi`);
}

function resetFilter() {
    $('#filter_from, #filter_to, #filter_status, #filter_history_name').val('');
    currentHistoryView = globalHistoryData;
    renderHistoryTable(currentHistoryView);
}

// AUTO GENERATE ID FUNCTION
function getNextId(list, prop, prefix = '') {
    if (!list || list.length === 0) return prefix + '1';
    let max = 0;
    list.forEach(item => {
        let val = String(item[prop]);
        // L·∫•y s·ªë ·ªü cu·ªëi chu·ªói ID hi·ªán t·∫°i
        const match = val.match(/(\d+)$/);
        if (match) {
            const num = parseInt(match[1]);
            if (num > max) max = num;
        }
    });
    // Tr·∫£ v·ªÅ prefix + s·ªë ti·∫øp theo
    return prefix + (max + 1);
}

// OPEN MODAL FUNCTIONS
function openStudentModal() { $('#modalStudent').modal('show'); $('#student_id_old').val(''); $('#st_id').prop('readonly', false).val(getNextId(globalStudentsData, 'id', '')); $('#st_name, #st_dob, #st_address, #st_phone, #st_group, #st_school').val(''); }

const HONOR_TITLES = ["NƒÉng n·ªï nh·∫•t", "Si√™ng nƒÉng nh·∫•t", "ChƒÉm ch·ªâ nh·∫•t", "√ù t∆∞·ªüng s√°ng t·∫°o", "L·∫ßy l·ªôi nh·∫•t", "VƒÉn ngh·ªá tuy·ªát nh·∫•t", "ƒêo√†n k·∫øt nh·∫•t"];

function renderHonorCheckboxes(selected = []) {
    let html = '';
    HONOR_TITLES.forEach(t => {
        const checked = selected.includes(t) ? 'checked' : '';
        html += `
        <div class="custom-control custom-checkbox mr-3 mb-2">
            <input type="checkbox" class="custom-control-input honor-check" id="h_${t}" value="${t}" ${checked}>
            <label class="custom-control-label" for="h_${t}">${t}</label>
        </div>`;
    });
    $('#u_honors_container').html(html);
}

function openUserModal() { 
    $('#modalUser').modal('show'); $('#user_id_old').val(''); $('#pass_area').show(); $('#u_name').val(getNextId(globalUsersData, 'username', 'user')); $('#u_pass, #u_role, #u_group, #u_fullname, #u_avatar, #u_email').val(''); 
    $('#u_vip_level').val(''); renderHonorCheckboxes();
}
function openGroupModal() { $('#modalGroup').modal('show'); $('#group_id_old').val(''); $('#g_id').val(getNextId(globalGroupsData, 'group_id', '')); $('#g_name').val(''); }
function openNotiModal() { 
    $('#modalNoti').modal('show'); 
    $('#noti_id_old').val(''); 
    $('#n_id').val(getNextId(globalNotisData, 'id', 'NOTI')); 
    $('#n_title, #n_content, #n_datetime, #n_location, #n_file, #n_attachment_base64, #n_file_name').val(''); 
    $('#n_type').val('normal');
    toggleLocationInput();
}

function toggleLocationInput() {
    const type = $('#n_type').val();
    if (type === 'normal') {
        $('#grp_location').addClass('d-none');
    } else {
        $('#grp_location').removeClass('d-none');
        $('#lbl_location').text(type === 'online' ? 'Link cu·ªôc h·ªçp (Google Meet/Zoom)' : 'ƒê·ªãa ƒëi·ªÉm t·ªï ch·ª©c');
        $('#n_location').attr('placeholder', type === 'online' ? 'https://meet.google.com/...' : 'Ph√≤ng h·ªçp s·ªë 1, T·∫ßng 2...');
    }
}

// X·ª≠ l√Ω file ƒë√≠nh k√®m (Chuy·ªÉn sang Base64)
$('#n_file').change(function() {
    const file = this.files[0];
    if (file) {
        $('#n_file_name').val(file.name); // L∆∞u t√™n file
        const isWord = file.name.match(/\.(doc|docx|pdf)$/i);
        const limit = isWord ? 50 * 1024 * 1024 : 100 * 1024 * 1024;

        if (file.size > limit) {
            toastr.warning(`File qu√° l·ªõn! Gi·ªõi h·∫°n: ${isWord ? '50MB (Word/PDF)' : '100MB (Kh√°c)'}`);
            this.value = ''; // Reset input
            $('#n_attachment_base64').val('');
            $('#n_file_name').val('');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) { $('#n_attachment_base64').val(e.target.result); };
        reader.readAsDataURL(file);
    }
});

// EDIT FUNCTIONS
function editStudent(studentId) {
    const s = globalStudentsData.find(st => String(st.id) === String(studentId));
    if (!s) {
        return toastr.error("Kh√¥ng t√¨m th·∫•y h·ªçc sinh ƒë·ªÉ s·ª≠a!");
    }
    $('#student_id_old').val(s.id);
    $('#st_id').val(s.id).prop('readonly', true);
    $('#st_name').val(s.fullname);
    $('#st_dob').val(s.dob);
    $('#st_address').val(s.address);
    $('#st_phone').val(s.phone);
    $('#st_group').val(s.group_id);
    $('#st_school').val(s.school);
    $('#modalStudent').modal('show');
}

function editUser(username) {
    const u = globalUsersData.find(user => String(user.username) === String(username));
    if (!u) {
        return toastr.error("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n ƒë·ªÉ s·ª≠a!");
    }
    $('#user_id_old').val(u.username);
    $('#u_name').val(u.username);
    $('#u_role').val(u.role);
    $('#u_group').val(u.group_id);
    $('#u_fullname').val(u.fullname);
    $('#u_email').val(u.email || '');
    $('#u_avatar').val(u.avatar);
    
    // Load Honors
    let honors = { level: '', titles: [] };
    try { honors = JSON.parse(u.honors || '{}'); } catch(e){}
    $('#u_vip_level').val(honors.level || '');
    renderHonorCheckboxes(honors.titles || []);

    $('#pass_area').hide();
    $('#modalUser').modal('show');
}

function showVipConfigHelp() {
    Swal.fire({
        title: 'C·∫•u h√¨nh Vinh danh',
        html: 'ƒê·ªÉ c·∫•u h√¨nh VIP v√† Danh hi·ªáu cho m·ªôt qu·∫£n l√Ω:<br>1. Nh·∫•n n√∫t <b><i class="fas fa-edit text-info"></i> S·ª≠a</b> t·∫°i d√≤ng c·ªßa qu·∫£n l√Ω ƒë√≥.<br>2. K√©o xu·ªëng ph·∫ßn <b>H·ªá th·ªëng Vinh danh (VIP)</b>.<br>3. Ch·ªçn c·∫•p ƒë·ªô VIP v√† c√°c danh hi·ªáu mong mu·ªën.<br>4. Nh·∫•n L∆∞u.',
        icon: 'info'
    });
}

function editGroup(idx) {
    const g = globalGroupsData[idx];
    $('#group_id_old').val(g.group_id);
    $('#g_id').val(g.group_id);
    $('#g_name').val(g.group_name);
    $('#modalGroup').modal('show');
}

function openReply(id) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#reply_id').val(id);
    $('#reply_content').val('');
    $('#reply_responder').val(user ? user.fullname : '');
    $('#reply_phone').val('');
    $('#modalReply').modal('show');
}

async function submitReply() {
    const id = $('#reply_id').val();
    const content = $('#reply_content').val();
    const responder = $('#reply_responder').val();
    const phone = $('#reply_phone').val();

    if(!content || !responder) return toastr.warning("Vui l√≤ng nh·∫≠p n·ªôi dung v√† t√™n ng∆∞·ªùi tr·∫£ l·ªùi!");
    
    const fullReply = `${content}<br><br>----------------<br><b>Ng∆∞·ªùi tr·∫£ l·ªùi:</b> ${responder}<br><b>SƒêT h·ªó tr·ª£:</b> ${phone || 'Kh√¥ng c√≥'}`;
    
    Swal.fire({ title: 'ƒêang g·ª≠i...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'REPLY_FEEDBACK', payload: { id: id, reply: fullReply } }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Th√†nh c√¥ng', 'ƒê√£ g·ª≠i ph·∫£n h·ªìi', 'success'); $('#modalReply').modal('hide'); loadFeedbacks(); }
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

async function resetPassword(username) {
    const user = globalUsersData.find(u => String(u.username) === String(username));
    if (!user) return;
    
    const result = await Swal.fire({
        title: 'X√°c nh·∫≠n reset?',
        text: `M·∫≠t kh·∫©u c·ªßa ${username} s·∫Ω v·ªÅ m·∫∑c ƒë·ªãnh: Abc@123`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Reset ngay',
        cancelButtonText: 'H·ªßy'
    });
    
    if (result.isConfirmed) {
        Swal.fire({ title: 'ƒêang x·ª≠ l√Ω...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'RESET_PASSWORD', payload: { username: username, admin_user: JSON.parse(sessionStorage.getItem('user')).username } }) });
            const res = await response.json();
            if (res.status === 'success') Swal.fire('Th√†nh c√¥ng!', res.message, 'success');
            else Swal.fire('L·ªói', res.message, 'error');
        } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
    }
}

// SAVE & DELETE DATA
async function saveData(type) {
    let action = 'ADD_DATA', idOld = "", dataArr = [];
    if (type === 'students') {
        idOld = $('#student_id_old').val();
        dataArr = [$('#st_id').val(), $('#st_name').val(), $('#st_dob').val(), $('#st_address').val(), $('#st_phone').val(), $('#st_group').val(), '', $('#st_school').val()];
    } else if (type === 'users') {
        idOld = $('#user_id_old').val();
        // Get Honors
        const titles = [];
        $('.honor-check:checked').each(function() { titles.push($(this).val()); });
        const honorsJson = JSON.stringify({ level: $('#u_vip_level').val(), titles: titles });

        // Special handling for Users to preserve timestamps in backend
        const payload = {
            action: 'SAVE_USER_ADMIN',
            payload: {
                is_add: !idOld,
                id: idOld || $('#u_name').val(),
                data: [$('#u_name').val(), $('#u_pass').val(), $('#u_role').val(), $('#u_group').val(), $('#u_fullname').val(), $('#u_avatar').val(), $('#u_email').val(), honorsJson],
                admin_user: JSON.parse(sessionStorage.getItem('user')).username
            }
        };
        // Bypass generic call
        callApiAndRefresh(payload);
        return;
    } else if (type === 'groups') {
        idOld = $('#group_id_old').val();
        dataArr = [$('#g_id').val(), $('#g_name').val()];
    } else if (type === 'notifications') {
        idOld = $('#noti_id_old').val();
        let dt = $('#n_datetime').val().replace('T', ' '); // Format l·∫°i: b·ªè ch·ªØ T ·ªü gi·ªØa
        // C·∫•u tr√∫c: ID, Title, Content, DateTime, Early, CreatedAt, Readers(Auto), Type, Location, Attachment, AttachmentName
        dataArr = [$('#n_id').val(), $('#n_title').val(), $('#n_content').val(), dt, $('#n_early').val(), new Date().toLocaleString(), "", $('#n_type').val(), $('#n_location').val(), $('#n_attachment_base64').val(), $('#n_file_name').val()];
    }

    if (idOld) action = 'UPDATE_DATA';
    Swal.fire({ title: 'ƒêang x·ª≠ l√Ω...', didOpen: () => Swal.showLoading() });
    callApiAndRefresh({ action: action, payload: { type: type, id: idOld, data: dataArr } });
}

async function callApiAndRefresh(bodyData) {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(bodyData) });
        const res = await response.json();
        if (res.status === 'success') {
            $('.modal').modal('hide');
            Swal.fire('Th√†nh c√¥ng!', res.message, 'success');
            refreshAll();
        } else Swal.fire('L·ªói', res.message, 'error');
    } catch (e) { Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi Server', 'error'); }
}

function printStudents() {
    const table = $('#studentTable').DataTable();
    const pageLength = table.page.len();
    
    const afterPrint = () => {
        table.page.len(pageLength).draw();
        window.removeEventListener('afterprint', afterPrint);
    };
    window.addEventListener('afterprint', afterPrint);

    // Show all entries for printing
    table.page.len(-1).draw();

    // Use a timeout to allow the table to redraw before printing
    setTimeout(() => {
        window.print();
    }, 300);
}

function deleteData(type, id) {
    Swal.fire({ title: 'X√≥a d·ªØ li·ªáu?', text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'X√≥a' }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: type, id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { Swal.fire('ƒê√£ x√≥a!', res.message, 'success'); refreshAll(); }
            } catch (e) { toastr.error("L·ªói x√≥a d·ªØ li·ªáu"); }
        }
    });
}

// EXPORT FUNCTIONS
function exportExcelHistory() {
    if (currentHistoryView.length === 0) return toastr.warning("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
    const data = currentHistoryView.map(item => {
        let st = "V·∫Øng kh√¥ng ph√©p";
        if (item.status === 'present') st = "C√≥ m·∫∑t";
        else if (item.status === 'absent_perm') st = "V·∫Øng c√≥ ph√©p";
        
        return { "Th·ªùi Gian": item.timestamp, "H·ªçc Sinh": item.student_name, "Nh√≥m": item.group_id, "Tr·∫°ng Th√°i": st, "L√Ω do": item.reason || "", "Ng∆∞·ªùi Th·ª±c Hi·ªán": item.recorded_by };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "L·ªãch S·ª≠");
    XLSX.writeFile(wb, `Lich_Su_Diem_Danh.xlsx`);
}

function exportExcelStudents() {
    if (currentStudentView.length === 0) return toastr.warning("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
    
    const data = currentStudentView.map(st => {
        let dateAdded = "";
        const ts = parseInt(st.id.replace('ST', ''));
        if (!isNaN(ts)) {
            dateAdded = new Date(ts).toLocaleDateString('vi-VN');
        }
        return { "H·ªç V√† T√™n": st.fullname, "Ng√†y Sinh": st.dob, "Nh√≥m": st.group_display, "Tr∆∞·ªùng": st.school, "SƒêT": st.phone, "ƒê·ªãa ch·ªâ": st.address, "Ng√†y th√™m": dateAdded };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DSHS");
    XLSX.writeFile(wb, `Danh_Sach_Hoc_Sinh.xlsx`);
}

function exportExcelEvaluations() {
    if (currentEvaluationView.length === 0) return toastr.warning("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
    
    const data = currentEvaluationView.map(e => ({
        "H·ªç v√† T√™n": e.name,
        "Nh√≥m": e.group,
        "√ù th·ª©c t·ªï ch·ª©c k·ª∑ lu·∫≠t": e.disc,
        "M·ª©c ƒë·ªô t√≠ch c·ª±c": e.pos,
        "Ho·∫°t ƒë·ªông t√¨nh nguy·ªán": e.vol,
        "X·∫øp lo·∫°i": e.class
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DanhGia");
    XLSX.writeFile(wb, `Tong_Hop_Danh_Gia_SHH.xlsx`);
}

async function backupSystem() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    Swal.fire({ title: 'ƒêang t·∫°o b·∫£n sao l∆∞u...', text: 'Vui l√≤ng ch·ªù, qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y.', didOpen: () => Swal.showLoading() });
    
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "BACKUP_SYSTEM", 
                payload: { admin_user: user.username } 
            }) 
        });
        const res = await response.json();
        
        if (res.status === 'success') {
            const wb = XLSX.utils.book_new();
            const data = res.data;
            
            for (const [sheetName, sheetData] of Object.entries(data)) {
                if (sheetData && sheetData.length > 0) {
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            }
            
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
            XLSX.writeFile(wb, `FULL_BACKUP_SHH_${timestamp}.xlsx`);
            
            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ t·∫£i xu·ªëng file sao l∆∞u to√†n b·ªô h·ªá th·ªëng!', 'success');
        } else {
            Swal.fire('L·ªói', res.message, 'error');
        }
    } catch (e) {
        console.error(e);
        Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi Server khi backup', 'error');
    }
}

function downloadTemplateAdmin() {
    const data = [
        { "H·ªç v√† T√™n": "Nguy·ªÖn VƒÉn A", "Ng√†y sinh": "20/10/2010", "Nh√≥m": "1", "Tr∆∞·ªùng h·ªçc": "THCS A", "SƒêT": "0909123456", "ƒê·ªãa ch·ªâ": "123 ƒê∆∞·ªùng ABC" },
        { "H·ªç v√† T√™n": "Tr·∫ßn Th·ªã B", "Ng√†y sinh": "01/01/2011", "Nh√≥m": "2", "Tr∆∞·ªùng h·ªçc": "THCS B", "SƒêT": "0909654321", "ƒê·ªãa ch·ªâ": "456 ƒê∆∞·ªùng XYZ" }
    ];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
    XLSX.writeFile(wb, `Mau_Nhap_Lieu_Admin_Full.xlsx`);
}
 
async function uploadFileGeneric(source) {
    const fileInput = document.getElementById(source === 'admin' ? 'file_upload_generic' : 'file_upload_generic');
    const file = fileInput.files[0];
    if (!file) return toastr.warning("Vui l√≤ng ch·ªçn file!");
    
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File qu√° l·ªõn! Gi·ªõi h·∫°n: ${globalMaxUploadSize}MB`);
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64 = e.target.result;
        const user = JSON.parse(sessionStorage.getItem('user'));
        
        Swal.fire({ title: 'ƒêang t·∫£i l√™n...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { 
                method: "POST", 
                body: JSON.stringify({ 
                    action: "UPLOAD_FILE", 
                    payload: { 
                        uploader: user.username, 
                        group_id: 'ADMIN', 
                        filename: file.name, 
                        size: (file.size / 1024 / 1024).toFixed(2) + ' MB', 
                        data: base64,
                        type: 'FILE'
                    } 
                }) 
            });
            const res = await response.json();
            if (res.status === 'success') {
                Swal.fire('Th√†nh c√¥ng', 'File ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n!', 'success');
                fileInput.value = '';
                loadUploadedFiles();
            } else Swal.fire('L·ªói', res.message, 'error');
        } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
    };
    reader.readAsDataURL(file);
}

async function loadUploadedFiles() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_UPLOADS" }) });
        const res = await response.json();
        if (res.status === 'success') {
            let html = '';
            res.data.forEach(f => {
                const isLink = f.type === 'LINK';
                const icon = isLink ? '<i class="fab fa-google-drive text-success fa-lg"></i>' : '<i class="fas fa-file-alt text-primary fa-lg"></i>';
                const content = isLink 
                    ? `<a href="${f.data}" target="_blank" class="font-weight-bold text-success">${f.data}</a>` 
                    : `<a href="${f.data}" download="${f.filename}" class="font-weight-bold">${f.filename}</a> <small class="text-muted">(${f.size})</small>`;

                html += `<tr>
                    <td><small>${f.timestamp}</small></td>
                    <td class="font-weight-bold text-primary">${f.uploader}</td>
                    <td><span class="badge badge-secondary">${f.group_id}</span></td>
                    <td class="text-center">${icon}</td>
                    <td>${content}</td>
                    <td><button class="btn btn-xs btn-danger" onclick="deleteData('uploads', '${f.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            $('#uploadedFilesList').html(html || '<tr><td colspan="6" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>');
        }
    } catch (e) { console.error(e); }
}

// Add loadUploadedFiles to refreshAll
const originalRefreshAll = refreshAll;
refreshAll = async function() {
    await originalRefreshAll();
    loadUploadedFiles();
};

function processImportAdminTab() {
    const file = document.getElementById('file_import').files[0];
    if (!file) return toastr.warning("Vui l√≤ng ch·ªçn file!");
    
    // Check size limit
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File qu√° l·ªõn! Gi·ªõi h·∫°n cho ph√©p l√† ${globalMaxUploadSize}MB.`);
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if (jsonData.length === 0) return toastr.warning("File r·ªóng!");

        // Map data to standard format
        const mappedData = jsonData.map(row => ({
            fullname: row["H·ªç v√† T√™n"] || "",
            dob: row["Ng√†y sinh"] || "",
            group_id: String(row["Nh√≥m"] || "").trim(),
            school: row["Tr∆∞·ªùng h·ªçc"] || "",
            phone: row["SƒêT"] || "",
            address: row["ƒê·ªãa ch·ªâ"] || ""
        })).filter(item => item.fullname && item.group_id); // Filter invalid rows

        if (mappedData.length === 0) return toastr.warning("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá (C·∫ßn c√≥ T√™n v√† Nh√≥m)!");

        Swal.fire({ title: 'ƒêang nh·∫≠p li·ªáu...', didOpen: () => Swal.showLoading() });
        const user = JSON.parse(sessionStorage.getItem('user'));
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ 
                action: "IMPORT_STUDENTS", 
                payload: { students: mappedData, admin_user: user.username } 
            })
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                Swal.fire('Th√†nh c√¥ng', res.message, 'success');
                $('#modalImport').modal('hide');
                loadStudents();
            } else Swal.fire('L·ªói', res.message, 'error');
        })
        .catch(() => Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'));
    };
    reader.readAsArrayBuffer(file);
}

function openImportModal(context) {
    if (context === 'admin') {
        $('#btnDownloadTemplate').attr('onclick', 'downloadTemplateAdmin()');
        $('#btnProcessImport').attr('onclick', 'processImportAdminTab()');
    }
    $('#modalImport').modal('show');
    $('#file_import').val('');
}

function openRestoreModal() {
    $('#modalRestore').modal('show');
    $('#file_restore').val('');
}

function processRestore() {
    const file = document.getElementById('file_restore').files[0];
    if (!file) return toastr.warning("Vui l√≤ng ch·ªçn file backup!");

    Swal.fire({
        title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?',
        text: "To√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®. H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'V√¢ng, ph·ª•c h·ªìi ngay!',
        cancelButtonText: 'H·ªßy'
    }).then((result) => {
        if (result.isConfirmed) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const restoreData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (sheetData.length > 0) {
                            restoreData[sheetName] = sheetData;
                        }
                    });

                    if (Object.keys(restoreData).length === 0) {
                        return Swal.fire('L·ªói', 'File backup r·ªóng ho·∫∑c kh√¥ng h·ª£p l·ªá.', 'error');
                    }

                    Swal.fire({ title: 'ƒêang ph·ª•c h·ªìi...', text: 'Vui l√≤ng kh√¥ng ƒë√≥ng trang.', didOpen: () => Swal.showLoading() });

                    const user = JSON.parse(sessionStorage.getItem('user'));
                    fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify({ 
                            action: "RESTORE_SYSTEM", 
                            payload: { data: restoreData, admin_user: user.username } 
                        })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'success') {
                            Swal.fire('Th√†nh c√¥ng!', 'H·ªá th·ªëng ƒë√£ ƒë∆∞·ª£c ph·ª•c h·ªìi. Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i.', 'success').then(() => window.location.reload());
                            $('#modalRestore').modal('hide');
                        } else Swal.fire('L·ªói', res.message, 'error');
                    })
                    .catch(() => Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi khi ph·ª•c h·ªìi.', 'error'));
                } catch (err) { Swal.fire('L·ªói', 'ƒê√£ x·∫£y ra l·ªói khi ƒë·ªçc file backup. File c√≥ th·ªÉ b·ªã h·ªèng.', 'error'); console.error(err); }
            };
            reader.readAsArrayBuffer(file);
        }
    });
}

function openPollModal() {
    $('#modalPoll').modal('show');
    $('#poll_question, #poll_options, #poll_deadline').val('');
}

function openEvalConfigModal() {
    $('#modalEvalConfig').modal('show');
}

async function createPoll() {
    const question = $('#poll_question').val().trim();
    const optionsStr = $('#poll_options').val().trim();
    const deadline = $('#poll_deadline').val();

    if (!question || !optionsStr || !deadline) return toastr.warning("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");

    const options = optionsStr.split(',').map(s => s.trim()).filter(s => s);
    if (options.length < 2) return toastr.warning("C·∫ßn √≠t nh·∫•t 2 l·ª±a ch·ªçn!");

    const pollContent = JSON.stringify({ question: question, options: options, deadline: deadline });
    const pollId = 'POLL' + new Date().getTime();
    
    // Save as Notification with type 'poll'
    // ID, Title, Content, DateTime, Early, CreatedAt, Readers, Type, Location, Attachment, AttachmentName
    const dataArr = [pollId, question, pollContent, deadline, 'FALSE', new Date().toLocaleString(), "", 'poll', '', '', ''];

    Swal.fire({ title: 'ƒêang t·∫°o b√¨nh ch·ªçn...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "ADD_DATA", payload: { type: 'notifications', data: dataArr } }) });
        const res = await response.json();
        if (res.status === 'success') {
            $('#modalPoll').modal('hide');
            Swal.fire('Th√†nh c√¥ng', 'ƒê√£ t·∫°o b√¨nh ch·ªçn!', 'success');
            refreshAll();
        } else Swal.fire('L·ªói', res.message, 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

async function viewPollResults(pollId) {
    Swal.fire({ title: 'ƒêang t·∫£i k·∫øt qu·∫£...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_POLL_RESULTS", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const counts = res.data;
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let html = `<div class="text-left">`;
            for (const [opt, count] of Object.entries(counts)) {
                const percent = total === 0 ? 0 : Math.round((count / total) * 100);
                html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between small"><span>${opt}</span><span>${count} phi·∫øu (${percent}%)</span></div>
                    <div class="progress" style="height: 10px;"><div class="progress-bar bg-success" style="width: ${percent}%"></div></div>
                </div>`;
            }
            html += `</div>`;
            Swal.fire({ title: `K·∫øt qu·∫£ (${total} phi·∫øu)`, html: html });
        } else Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£', 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}

async function exportPollExcel(pollId, title) {
    Swal.fire({ title: 'ƒêang xu·∫•t Excel...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_POLL_VOTES", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const data = res.data.map(v => ({
                "Th·ªùi gian": v.timestamp,
                "Qu·∫£n l√Ω": v.manager,
                "Nh√≥m": v.group_id,
                "H·ªçc sinh": v.student_name,
                "L·ª±a ch·ªçn": v.option
            }));
            
            if (data.length === 0) return Swal.fire('Th√¥ng b√°o', 'Ch∆∞a c√≥ d·ªØ li·ªáu b√¨nh ch·ªçn n√†o.', 'info');
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQua");
            XLSX.writeFile(wb, `Binh_Chon_${title.replace(/\s+/g, '_')}.xlsx`);
            Swal.close();
        } else Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu', 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}
</script>
</body>
</html>     XLSX.writeFile(wb, `Binh_Chon_${title.replace(/\s+/g, '_')}.xlsx`);
            Swal.close();
        } else Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu', 'error');
    } catch (e) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
}
</script>

<!-- Modal Eval Config -->
<div class="modal fade" id="modalEvalConfig" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-cogs mr-2"></i>C·∫•u h√¨nh ƒê·ª£t ƒë√°nh gi√°</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tr·∫°ng th√°i ƒë√°nh gi√°</label>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="conf_eval_enabled">
                        <label class="custom-control-label font-weight-bold" for="conf_eval_enabled">Cho ph√©p ƒë√°nh gi√°</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>H·∫°n ch√≥t (Deadline)</label>
                    <input type="date" id="conf_eval_deadline" class="form-control">
                </div>
                <hr>
                <div class="form-group">
                    <label class="text-danger font-weight-bold">Khu v·ª±c nguy hi·ªÉm</label>
                    <button class="btn btn-warning btn-block font-weight-bold" onclick="resetEvaluations()">
                        <i class="fas fa-redo-alt mr-2"></i>Reset ƒê·ª£t M·ªõi (X√≥a h·∫øt ƒë√°nh gi√°)
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-danger" onclick="saveEvalConfig()">L∆∞u c·∫•u h√¨nh</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>