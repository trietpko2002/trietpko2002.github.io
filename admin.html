<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản trị - Hệ thống Quản lý SHH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        .small-box { border-radius: 12px; overflow: hidden; transition: transform 0.3s; }
        .small-box:hover { transform: translateY(-5px); }
        .text-dob { color: #007bff; font-weight: bold; }
        .badge-group { font-size: 0.85rem; padding: 4px 8px; }
        .table-history { font-size: 0.9rem; }
        .history-card-body { max-height: 600px; overflow-y: auto; }
        .img-manager { width: 35px; height: 35px; object-fit: cover; border-radius: 50%; }
        .btn-action { padding: 2px 5px; font-size: 0.8rem; }
        .nav-link p { font-weight: 500; }
        .sidebar-dark-primary { background-color: #343a40; }
        /* Youth Union Theme */
        .navbar-primary { background-color: #1e88e5 !important; }
        .brand-link.bg-primary { background-color: #1e88e5 !important; }
        .sidebar-light-primary .nav-sidebar>.nav-item>.nav-link.active { background-color: #1e88e5; color: #fff; }
        .btn-primary { background-color: #1e88e5; border-color: #1976d2; }
        .btn-primary:hover { background-color: #1565c0; border-color: #0d47a1; }
        /* Dark Mode Full Coverage */
        body.dark-mode .modal-content { background-color: #343a40; color: #fff; }
        body.dark-mode .modal-header { border-bottom-color: #454d55; }
        body.dark-mode .modal-footer { border-top-color: #454d55; }
        body.dark-mode .close { color: #fff; text-shadow: none; }
        body.dark-mode .form-control { background-color: #454d55; color: #fff; border-color: #6c757d; }
        body.dark-mode .form-control:focus { background-color: #454d55; color: #fff; }
        body.dark-mode .custom-file-label { background-color: #454d55; color: #fff; }
        body.dark-mode .custom-file-label::after { background-color: #56606a; color: #fff; }

        @media print {
            /* Hide all UI chrome */
            .main-sidebar, .main-header, .btn, .modal, .nav-tabs, .card-outline, .content-header, .nav-header, .small-box, .modal-backdrop {
                display: none !important;
            }
            /* Hide non-active tabs */
            .tab-pane:not(.active) {
                display: none !important;
            }
            /* Reset layout for printing */
            .content-wrapper {
                margin-left: 0 !important;
                padding-top: 0 !important;
                background: #fff !important;
            }
            .tab-pane.active {
                display: block !important;
                opacity: 1 !important;
            }
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
            /* Hide datatable controls for cleaner print */
            .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
                display: none !important;
            }
            .table-responsive {
                overflow-x: visible !important;
            }
        }
        /* Poll Tabs */
        .poll-tab-content { max-height: 400px; overflow-y: auto; }
        .poll-group-header { background: #f4f6f9; padding: 10px; font-weight: bold; border-bottom: 2px solid #ddd; }
    </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed">
<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user || user.role.toLowerCase() !== 'admin') {
            window.location.replace('login.html');
        }
    })();

    function logout() {
        sessionStorage.clear();
        window.location.replace('login.html');
    }
</script>

<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <span class="nav-link">Xin chào, <b id="adminNameDisplay" class="text-primary">Admin</b></span>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript:void(0)" onclick="openSettingsModal()" title="Cài đặt hệ thống">
                    <i class="fas fa-cog"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-danger" href="javascript:void(0)" onclick="logout()">
                    <i class="fas fa-power-off"></i> Thoát
                </a>
            </li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-light-primary elevation-4">
        <div class="brand-link bg-primary text-center">
            <span class="brand-text font-weight-bold text-white">QUẢN TRỊ ADMIN</span>
        </div>
        <div class="sidebar">
            <nav class="mt-3">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="tablist">
                    <li class="nav-item">
                        <a href="#tab-dashboard" class="nav-link active" data-toggle="pill">
                            <i class="nav-icon fas fa-chart-pie"></i> <p>Tổng quan & Lịch sử</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-students-list" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-id-card"></i> <p>Dữ liệu học sinh</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-managers-list" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-user-shield"></i> <p>Quản lý tài khoản</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-groups-list" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-users-cog"></i> <p>Danh sách nhóm</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-upload" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-folder-open"></i> <p>Quản lý trình duyệt file</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-notifications" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-bell"></i> <p>Thông báo hệ thống</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-feedbacks" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-comments"></i> <p>Quản lý Phản ánh kiến nghị</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-evaluations" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-star"></i> <p>Quản lý Đánh giá</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-system-logs" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-history"></i> <p>Log hệ thống</p>
                        </a>
                    </li>
                    <li class="nav-header">XUẤT BÁO CÁO</li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="exportExcelHistory()" class="nav-link text-success">
                            <i class="nav-icon fas fa-file-excel"></i> <p>Xuất Lịch Sử (.xlsx)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="exportExcelStudents()" class="nav-link text-info">
                            <i class="nav-icon fas fa-file-download"></i> <p>Xuất DS Học Sinh (.xlsx)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="backupSystem()" class="nav-link text-warning">
                            <i class="nav-icon fas fa-database"></i> <p>Sao lưu Hệ thống (Backup)</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="javascript:void(0)" onclick="openRestoreModal()" class="nav-link text-danger">
                            <i class="nav-icon fas fa-undo-alt"></i> <p>Phục hồi Hệ thống (Restore)</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <div class="content-wrapper">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-dashboard">
                <section class="content-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1>Thống kê & Toàn bộ lịch sử</h1>
                            <button onclick="refreshAll()" class="btn btn-primary"><i class="fas fa-sync"></i> Làm mới</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-info" style="cursor: pointer;" onclick="showChartsFor('students')">
                                    <div class="inner"><h3 id="countHS">0</h3><p>Học sinh</p></div>
                                    <div class="icon"><i class="fas fa-users"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-success" style="cursor: pointer;" onclick="showChartsFor('attendance')">
                                    <div class="inner"><h3 id="countPresent">0</h3><p>Có mặt</p></div>
                                    <div class="icon"><i class="fas fa-check"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-warning text-white" style="cursor: pointer;" onclick="showChartsFor('attendance')">
                                    <div class="inner"><h3 id="countAbsentP">0</h3><p>Vắng (P)</p></div>
                                    <div class="icon"><i class="fas fa-envelope"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-danger" style="cursor: pointer;" onclick="showChartsFor('attendance')">
                                    <div class="inner"><h3 id="countAbsent">0</h3><p>Vắng (K)</p></div>
                                    <div class="icon"><i class="fas fa-times"></i></div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-purple" style="cursor: pointer;" onclick="showChartsFor('managers')"><div class="inner"><h3 id="countManagers">0</h3><p>Quản lý</p></div><div class="icon"><i class="fas fa-user-shield"></i></div></div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-indigo" style="cursor: pointer;" onclick="showChartsFor('groups')"><div class="inner"><h3 id="countGroups">0</h3><p>Nhóm SHH</p></div><div class="icon"><i class="fas fa-layer-group"></i></div></div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-orange text-white" style="cursor: pointer;" onclick="showChartsFor('notifications')"><div class="inner"><h3 id="countNotis">0</h3><p>Thông báo</p></div><div class="icon"><i class="fas fa-bell"></i></div></div>
                            </div>
                            <div class="col-lg-3 col-6">
                                <div class="small-box bg-teal" style="cursor: pointer;" onclick="showChartsFor('feedbacks')"><div class="inner"><h3 id="countFeedbacks">0</h3><p>Phản ánh</p></div><div class="icon"><i class="fas fa-comments"></i></div></div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="card card-outline card-success shadow">
                                    <div class="card-header d-flex p-2 align-items-center">
                                        <h3 class="card-title font-weight-bold pl-2">Nhật ký điểm danh</h3>
                                        <div class="ml-auto d-flex">
                                            <select id="filter_status" class="form-control form-control-sm mr-1" style="width: 120px;">
                                                <option value="">Tất cả trạng thái</option>
                                                <option value="present">Có mặt</option>
                                                <option value="absent_perm">Vắng có phép</option>
                                                <option value="absent">Vắng không phép</option>
                                            </select>
                                            <input type="text" id="filter_history_name" class="form-control form-control-sm mr-1" style="width: 150px;" placeholder="Tên học sinh...">
                                            <input type="date" id="filter_from" class="form-control form-control-sm mr-1" style="width: 130px;" title="Từ ngày">
                                            <span class="align-self-center mr-1">-</span>
                                            <input type="date" id="filter_to" class="form-control form-control-sm mr-1" style="width: 130px;" title="Đến ngày">
                                            <button class="btn btn-sm btn-primary" onclick="filterHistory()"><i class="fas fa-filter"></i></button>
                                            <button class="btn btn-sm btn-secondary ml-1" onclick="resetFilter()" title="Xóa lọc"><i class="fas fa-undo"></i></button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0 table-responsive history-card-body">
                                        <table class="table table-head-fixed table-hover table-history text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>Thời gian</th>
                                                    <th>Học sinh</th>
                                                    <th>Nhóm</th>
                                                    <th>Trạng thái</th>
                                                    <th>Người thực hiện</th>
                                                </tr>
                                            </thead>
                                            <tbody id="historyAttendanceData">
                                                <!-- Data loaded by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-students-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Quản lý Dữ liệu Học sinh</h1>
                        <div>
                            <button class="btn btn-default" onclick="printStudents()"><i class="fas fa-print"></i> In</button>
                            <button class="btn btn-info" onclick="openImportModal('admin')"><i class="fas fa-file-import"></i> Nhập từ Excel</button>
                            <button class="btn btn-success" onclick="openStudentModal()"><i class="fas fa-plus"></i> Thêm Học Sinh</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <ul class="nav nav-tabs mb-3" role="tablist">
                            <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#subtab-official">Học sinh Chính thức</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#subtab-pending" onclick="loadRegistrations()">Đăng ký Chờ duyệt</a></li>
                        </ul>
                        
                        <div class="tab-content">
                        <!-- Charts Section for Students -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card card-info"><div class="card-header"><h3 class="card-title">Phân bố Học sinh theo Nhóm</h3></div><div class="card-body"><div class="chart-container" style="height: 250px;"><canvas id="chartStGroup"></canvas></div></div></div>
                            </div>
                            <div class="col-md-6">
                                <div class="card card-success"><div class="card-header"><h3 class="card-title">Biểu đồ Tăng trưởng Học sinh</h3></div><div class="card-body"><div class="chart-container" style="height: 250px;"><canvas id="chartStTrend"></canvas></div></div></div>
                            </div>
                        </div>

                        <!-- Subtab Official -->
                        <div class="tab-pane fade show active" id="subtab-official">
                        <div class="card card-outline card-info shadow mb-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-filter mr-2"></i>Bộ lọc tìm kiếm</h3></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" id="st_filter_name" class="form-control" placeholder="Họ tên...">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="st_filter_group" class="form-control"><option value="">-- Tất cả Nhóm --</option></select>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <select id="st_filter_school" class="form-control"><option value="">-- Tất cả Trường --</option></select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" id="st_filter_from" class="form-control" title="Ngày thêm (Từ)">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" id="st_filter_to" class="form-control" title="Ngày thêm (Đến)">
                                    </div>
                                    <div class="col-12 text-right">
                                        <button class="btn btn-primary" onclick="filterStudents()"><i class="fas fa-search mr-2"></i>Tìm kiếm</button>
                                        <button class="btn btn-secondary" onclick="resetStudentFilter()"><i class="fas fa-undo mr-2"></i>Đặt lại</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="studentTable" class="table table-striped table-bordered w-100">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Họ tên</th>
                                            <th>Ngày sinh</th>
                                            <th>Lớp</th>
                                            <th>Nhóm</th>
                                            <th>Trường học</th>
                                            <th>SĐT học sinh</th>
                                            <th>Địa chỉ</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Subtab Pending -->
                        <div class="tab-pane fade" id="subtab-pending">
                            <div class="card shadow">
                                <div class="card-header bg-warning"><h3 class="card-title">Danh sách đăng ký tạm (Chưa vào nhóm)</h3></div>
                                <div class="card-body table-responsive">
                                    <table id="regTable" class="table table-bordered w-100">
                                        <thead>
                                            <tr>
                                                <th>ID Tạm</th>
                                                <th>Mật khẩu</th>
                                                <th>Họ tên</th>
                                                <th>Lớp</th>
                                                <th>Trường</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="regData"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-managers-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh sách tài khoản quản lý</h1>
                        <button class="btn btn-warning mr-2" onclick="showVipConfigHelp()"><i class="fas fa-crown"></i> Cấu hình Vinh danh</button>
                        <button class="btn btn-success" onclick="openUserModal()"><i class="fas fa-plus"></i> Thêm Tài Khoản</button>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="managerTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-primary text-white">
                                        <tr>
                                            <th>Avatar</th>
                                            <th>Username</th>
                                            <th>Họ tên Quản lý</th>
                                            <th>Nhóm phụ trách</th>
                                            <th>Quyền hạn</th>
                                            <th>Email</th>
                                            <th>SĐT</th>
                                            <th>Lần đăng nhập cuối</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="managerData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-groups-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh sách các nhóm sinh hoạt</h1>
                        <button class="btn btn-success" onclick="openGroupModal()"><i class="fas fa-plus"></i> Thêm Nhóm</button>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row" id="groupCardsContainer"></div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-upload">
                <section class="content-header">
                    <div class="container-fluid">
                        <h1>Quản lý trình duyệt file</h1>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-header bg-primary"><h3 class="card-title"><i class="fas fa-cloud-download-alt mr-2"></i>Quản lý Tài nguyên & Tệp tin</h3></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <p class="mb-0 text-muted"><i class="fas fa-info-circle mr-1"></i>Danh sách file từ Quản lý và Admin.</p>
                                    <button class="btn btn-sm btn-success" onclick="loadUploadedFiles()"><i class="fas fa-sync mr-1"></i>Làm mới danh sách</button>
                                </div>
                                
                                <div class="form-group bg-light p-3 border rounded">
                                    <label class="text-info"><i class="fas fa-upload mr-2"></i>Admin Upload (Tài nguyên chung cho các nhóm)</label>
                                    <input type="file" id="file_upload_generic" class="form-control-file border p-2 bg-white">
                                    <button type="button" class="btn btn-info mt-2" onclick="uploadFileGeneric('admin')"><i class="fas fa-upload mr-2"></i>Tải lên ngay</button>
                                </div>

                                <div class="table-responsive mt-2" style="max-height: 500px;">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th>Thời gian</th>
                                                <th>Người gửi (Quản lý)</th>
                                                <th>Nhóm</th>
                                                <th>Loại</th>
                                                <th>Nội dung / Tên file</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="uploadedFilesList"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-notifications">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Thông báo chung hệ thống</h1>
                        <div>
                            <button class="btn btn-warning mr-2" onclick="openPollModal()"><i class="fas fa-poll"></i> Tạo Bình chọn</button>
                            <button class="btn btn-success" onclick="openNotiModal()"><i class="fas fa-paper-plane"></i> Tạo thông báo</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="notiTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-warning">
                                        <tr>
                                            <th>ID</th>
                                            <th>Tiêu đề</th>
                                            <th>Nội dung</th>
                                            <th>Thời gian diễn ra</th>
                                            <th>Điểm danh sớm</th>
                                            <th>Hình thức</th>
                                            <th>Người đã xem</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notiData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-feedbacks">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh sách Phản ánh & Kiến nghị</h1>
                        <button class="btn btn-primary" onclick="loadFeedbacks()"><i class="fas fa-sync"></i> Tải lại</button>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="feedbackTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-info">
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Người gửi</th>
                                            <th>Nội dung Phản ánh</th>
                                            <th>Phản hồi của Admin</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedbackData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-evaluations">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Tổng hợp Đánh giá & Xếp loại</h1>
                        <div>
                            <button class="btn btn-warning mr-2" onclick="openEvalConfigModal()"><i class="fas fa-cogs"></i> Cấu hình</button>
                            <button class="btn btn-primary mr-2" onclick="loadEvaluations()"><i class="fas fa-sync"></i> Tải lại</button>
                            <button class="btn btn-success" onclick="exportExcelEvaluations()"><i class="fas fa-file-excel"></i> Xuất Báo Cáo</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <!-- Evaluation Chart -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card card-purple"><div class="card-header"><h3 class="card-title">Thống kê Kết quả Đánh giá</h3></div><div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="chartEvaluation"></canvas></div></div></div>
                            </div>
                        </div>
                        <!-- Cấu hình đánh giá -->
                        <div class="card card-outline card-purple shadow mb-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-filter mr-2"></i>Bộ lọc Đánh giá</h3></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" id="eval_filter_name" class="form-control" placeholder="Tên học sinh...">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_group" class="form-control"><option value="">-- Tất cả Nhóm --</option></select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_status" class="form-control">
                                            <option value="">-- Trạng thái --</option>
                                            <option value="evaluated">Đã đánh giá</option>
                                            <option value="not_evaluated">Chưa đánh giá</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_class" class="form-control">
                                            <option value="">-- Xếp loại --</option>
                                            <option value="Xuất sắc">Xuất sắc</option>
                                            <option value="Tốt">Tốt</option>
                                            <option value="Trung bình">Trung bình</option>
                                            <option value="Yếu">Yếu</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2 text-right">
                                        <button class="btn btn-primary" onclick="filterEvaluations()"><i class="fas fa-search mr-2"></i>Lọc</button>
                                        <button class="btn btn-secondary" onclick="resetEvaluationFilter()"><i class="fas fa-undo"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="evalTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-purple text-white">
                                        <tr>
                                            <th>Học sinh</th>
                                            <th>Nhóm</th>
                                            <th>Ý thức kỷ luật</th>
                                            <th>Mức độ tích cực</th>
                                            <th>Hoạt động tình nguyện</th>
                                            <th>Xếp loại</th>
                                        </tr>
                                    </thead>
                                    <tbody id="evalData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-system-logs">
                <section class="content-header">
                    <div class="container-fluid">
                        <h1>Nhật ký hoạt động (Logs)</h1>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="logTable" class="table table-sm table-striped w-100">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Tài khoản</th>
                                            <th>Hành động</th>
                                            <th>Chi tiết</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>

<!-- Modal Student -->
<div class="modal fade" id="modalStudent" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title">Thông tin Học sinh</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="student_id_old">
                <div class="form-group"><label>Mã Học sinh (ID)</label><input type="text" id="st_id" class="form-control" placeholder="Nhập mã HS..."></div>
                <div class="form-group"><label>Họ và Tên</label><input type="text" id="st_name" class="form-control" placeholder="Nguyễn Văn A"></div>
                <div class="form-group"><label>Ngày sinh</label><input type="text" id="st_dob" class="form-control" placeholder="dd/mm/yyyy"></div>
                <div class="form-group"><label>Lớp</label><input type="text" id="st_class" class="form-control"></div>
                <div class="form-group"><label>Địa chỉ</label><input type="text" id="st_address" class="form-control"></div>
                <div class="form-group"><label>Số điện thoại học sinh</label><input type="text" id="st_phone" class="form-control"></div>
                <div class="form-group"><label>Mã Nhóm</label><input type="text" id="st_group" class="form-control" placeholder="VD: 1, 2, 3..."></div>
                <div class="form-group"><label>Trường học</label><input type="text" id="st_school" class="form-control"></div>
                <h6 class="text-info border-top pt-2 mt-2">Thông tin đăng ký</h6>
                <div class="form-group"><label>Thời gian</label><input type="text" id="st_reg_time" class="form-control"></div>
                <div class="form-group"><label>Địa điểm</label><input type="text" id="st_reg_loc" class="form-control"></div>
                <div class="form-group"><label>Hoạt động</label><textarea id="st_reg_act" class="form-control" rows="2"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('students')">Lưu dữ liệu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Restore System -->
<div class="modal fade" id="modalRestore" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-undo-alt mr-2"></i>Phục hồi Hệ thống từ Backup</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>CẢNH BÁO!</strong> Hành động này sẽ <strong>XÓA SẠCH</strong> toàn bộ dữ liệu hiện tại và thay thế bằng dữ liệu từ file backup. Hãy chắc chắn bạn đã chọn đúng file.
                </div>
                <div class="form-group">
                    <label>Chọn file Backup (.xlsx)</label>
                    <input type="file" id="file_restore" class="form-control-file border p-2" accept=".xlsx">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="processRestore()">Bắt đầu Phục hồi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Students -->
<div class="modal fade" id="modalImport" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-file-import mr-2"></i>Nhập danh sách học sinh từ Excel</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Vui lòng sử dụng file Excel theo đúng định dạng mẫu. Hệ thống sẽ tự động bỏ qua các học sinh đã tồn tại (trùng Tên và Nhóm).</p>
                <div class="form-group">
                    <label>1. Tải file mẫu</label><br>
                    <button class="btn btn-success" id="btnDownloadTemplate"><i class="fas fa-download mr-2"></i>Tải mẫu Excel</button>
                </div>
                <div class="form-group">
                    <label>2. Chọn file Excel của bạn</label>
                    <input type="file" id="file_import" class="form-control-file border p-2" accept=".xlsx, .xls">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-info" id="btnProcessImport">Bắt đầu Nhập</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal User -->
<div class="modal fade" id="modalUser" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title">Thông tin Tài khoản</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user_id_old">
                <div class="form-group"><label>Tên đăng nhập</label><input type="text" id="u_name" class="form-control"></div>
                <div class="form-group" id="pass_area"><label>Mật khẩu</label><input type="text" id="u_pass" class="form-control"></div>
                <div class="form-group"><label>Họ tên hiển thị</label><input type="text" id="u_fullname" class="form-control"></div>
                <div class="form-group"><label>Phân quyền</label>
                    <select id="u_role" class="form-control">
                        <option value="manager">Quản lý (Manager)</option>
                        <option value="supervisor">Cấp quản lý (Supervisor)</option>
                        <option value="admin">Quản trị (Admin)</option>
                    </select>
                </div>
                <div class="form-group"><label>Nhóm phụ trách</label><input type="text" id="u_group" class="form-control" placeholder="Để trống nếu là Admin"></div>
                <div class="form-group"><label>Email</label><input type="email" id="u_email" class="form-control" placeholder="example@email.com"></div>
                <div class="form-group"><label>Số điện thoại</label><input type="text" id="u_phone" class="form-control"></div>
                <div class="form-group"><label>Link Avatar</label><input type="text" id="u_avatar" class="form-control"></div>
                
                <hr>
                <h6 class="text-warning font-weight-bold"><i class="fas fa-crown mr-2"></i>Hệ thống Vinh danh (VIP)</h6>
                <div class="form-group">
                    <label>Cấp độ VIP</label>
                    <select id="u_vip_level" class="form-control">
                        <option value="">-- Không --</option>
                        <option value="vip1">VIP 1 (Khung Bạc)</option>
                        <option value="vip2">VIP 2 (Khung Vàng + Vương miện)</option>
                        <option value="vip3">VIP 3 (Khung Kim Cương + Hiệu ứng)</option>
                        <option value="vip4">VIP 4 (Bạch Kim - Supervisor)</option>
                        <option value="vip5">VIP 5 (Hoàng Kim - Supervisor)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Danh hiệu (Chọn nhiều)</label>
                    <div class="d-flex flex-wrap" id="u_honors_container">
                        <!-- Checkboxes generated by JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('users')">Lưu tài khoản</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Group -->
<div class="modal fade" id="modalGroup" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title">Thông tin Nhóm</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="group_id_old">
                <div class="form-group"><label>Mã Nhóm</label><input type="text" id="g_id" class="form-control"></div>
                <div class="form-group"><label>Tên Nhóm</label><input type="text" id="g_name" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('groups')">Lưu nhóm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNoti" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title font-weight-bold">Thông tin thông báo</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="noti_id_old">
                <div class="form-group"><label>Mã TB (ID)</label><input type="text" id="n_id" class="form-control" placeholder="NOTI01..."></div>
                <div class="form-group"><label>Tiêu đề</label><input type="text" id="n_title" class="form-control"></div>
                <div class="form-group"><label>Nội dung</label><textarea id="n_content" class="form-control" rows="3"></textarea></div>
                <div class="form-group"><label>Thời gian sinh hoạt</label><input type="datetime-local" id="n_datetime" class="form-control"></div>
                <div class="form-group"><button class="btn btn-sm btn-info" onclick="previewNotification()"><i class="fas fa-eye mr-1"></i>Xem trước hiển thị</button></div>
                <div class="form-group"><label>Cho phép điểm danh sớm?</label>
                    <select id="n_early" class="form-control">
                        <option value="TRUE">Cho phép (Mở mọi lúc)</option>
                        <option value="FALSE">Không (Chỉ mở khi đến giờ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Hình thức thông báo</label>
                    <select id="n_type" class="form-control" onchange="toggleLocationInput()">
                        <option value="normal">Thông báo thường</option>
                        <option value="online">Họp Online (Google Meet/Zoom)</option>
                        <option value="offline">Họp Trực tiếp (Tại địa điểm)</option>
                    </select>
                </div>
                <div class="form-group d-none" id="grp_location"><label id="lbl_location">Địa điểm / Link họp</label><input type="text" id="n_location" class="form-control"></div>
                <div class="form-group">
                    <label>Đính kèm tệp tin</label>
                    <input type="file" id="n_file" class="form-control-file border p-1">
                    <small class="text-muted">Giới hạn: Word/PDF < 50MB, File khác < 100MB</small>
                    <input type="hidden" id="n_attachment_base64">
                    <input type="hidden" id="n_file_name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('notifications')">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Create Poll -->
<div class="modal fade" id="modalPoll" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-poll mr-2"></i>Tạo Bình chọn Mới</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Câu hỏi / Chủ đề</label><input type="text" id="poll_question" class="form-control" placeholder="VD: Chọn trò chơi sinh hoạt..."></div>
                <div class="form-group"><label>Các lựa chọn (Ngăn cách bằng dấu phẩy)</label><textarea id="poll_options" class="form-control" rows="3" placeholder="Kéo co, Nhảy bao bố, Đố vui..."></textarea></div>
                <div class="form-group"><label>Hạn chót bình chọn</label><input type="datetime-local" id="poll_deadline" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="createPoll()">Phát hành Bình chọn</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Poll Results Detail -->
<div class="modal fade" id="modalPollDetail" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title"><i class="fas fa-chart-pie mr-2"></i>Kết quả Bình chọn Chi tiết</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6"><h5 id="pollDetailTitle" class="font-weight-bold text-primary"></h5></div>
                    <div class="col-md-6"><input type="text" id="pollSearch" class="form-control" placeholder="🔍 Tìm tên học sinh hoặc lựa chọn..." onkeyup="filterPollResults()"></div>
                </div>
                <ul class="nav nav-tabs" id="pollGroupTabs" role="tablist"></ul>
                <div class="tab-content border border-top-0 p-3 poll-tab-content" id="pollGroupContent"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button></div>
        </div>
    </div>
</div>

<!-- Modal Reply Feedback -->
<div class="modal fade" id="modalReply" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title">Phản hồi Góp ý</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reply_id">
                <div class="form-group"><label>Nội dung phản hồi:</label><textarea id="reply_content" class="form-control" rows="4"></textarea></div>
                <div class="form-group"><label>Người trả lời:</label><input type="text" id="reply_responder" class="form-control"></div>
                <div class="form-group"><label>SĐT liên hệ (nếu thắc mắc):</label><input type="text" id="reply_phone" class="form-control" placeholder="Nhập SĐT..."></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="submitReply()">Gửi phản hồi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Settings -->
<div class="modal fade" id="modalSettings" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-cogs mr-2"></i>Cài đặt hệ thống</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="settingTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tab-interface">Giao diện</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-troll">Thông báo Khẩn</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-features">Tính năng & Chữ chạy</a></li>
                </ul>
                <div class="tab-content">
                    <!-- Tab Giao diện -->
                    <div class="tab-pane fade show active" id="tab-interface">
                        <div class="form-group d-flex justify-content-between align-items-center">
                            <label class="mb-0">Chế độ Tối (Dark Mode)</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="darkModeSwitch" onchange="toggleDarkMode()">
                                <label class="custom-control-label" for="darkModeSwitch"></label>
                            </div>
                        </div>
                        
                        <!-- Cấu hình Bảo trì Nâng cao -->
                        <div class="card card-danger card-outline mt-3 shadow-sm">
                            <div class="card-header"><h6 class="card-title font-weight-bold mb-0"><i class="fas fa-tools mr-2"></i>Cấu hình Bảo trì Hệ thống</h6></div>
                            <div class="card-body">
                                <div class="form-group d-flex justify-content-between align-items-center border-bottom pb-3">
                                    <div><label class="mb-0 text-danger">Bảo trì Thủ công (Ngay lập tức)</label><br><small class="text-muted">Gạt nút để bật bảo trì ngay, bất kể lịch trình.</small></div>
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="maintenanceSwitch" onchange="toggleMaintenance()">
                                        <label class="custom-control-label" for="maintenanceSwitch"></label>
                                    </div>
                                </div>
                                <label class="mt-2 text-primary"><i class="fas fa-calendar-alt mr-2"></i>Lên lịch Bảo trì Tự động</label>
                                <div class="row">
                                    <div class="col-6"><div class="form-group"><label class="small text-muted">Bắt đầu</label><input type="datetime-local" id="maint_start_input" class="form-control form-control-sm"></div></div>
                                    <div class="col-6"><div class="form-group"><label class="small text-muted">Kết thúc (Reset)</label><input type="datetime-local" id="maint_end_input" class="form-control form-control-sm"></div></div>
                                </div>
                                <button class="btn btn-sm btn-primary btn-block" onclick="saveMaintenanceSchedule()"><i class="fas fa-save mr-2"></i>Lưu Lịch Bảo Trì</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-warning btn-block mt-4" onclick="cleanUpChat()"><i class="fas fa-trash-alt mr-2"></i>Dọn dẹp tin nhắn cũ (>7 ngày)</button>
                        <p class="text-muted small">Chuyển đổi giao diện sáng/tối để dễ nhìn hơn.</p>
                    </div>
                    <!-- Tab Thông báo Khẩn -->
                    <div class="tab-pane fade" id="tab-troll">
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <label class="mb-0 text-danger font-weight-bold">Kích hoạt Thông báo Khẩn</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="troll_enabled">
                                <label class="custom-control-label" for="troll_enabled"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded mt-2">
                            <label class="mb-0 text-primary"><i class="fas fa-mobile-alt mr-2"></i>Hiển thị dạng Thông báo điện thoại (Banner)</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="troll_mode">
                                <label class="custom-control-label" for="troll_mode"></label>
                            </div>
                        </div>
                        <div class="form-group"><label>Tiêu đề Thông báo</label><input type="text" id="troll_title" class="form-control" placeholder="VD: THÔNG BÁO KHẨN..."></div>
                        <div class="form-group"><label>Nội dung</label><textarea id="troll_content" class="form-control" rows="3" placeholder="Nội dung hiển thị..."></textarea></div>
                        <div class="form-group"><label>Link YouTube (Tùy chọn)</label><input type="text" id="troll_youtube" class="form-control" placeholder="https://youtu.be/..."></div>
                        <div class="form-group">
                            <label>File đính kèm (Ảnh/Word/Excel/Zip...)</label>
                            <input type="file" id="troll_file" class="form-control-file border p-1">
                            <small class="text-muted">Giới hạn: Word/PDF < 50MB, File khác < 100MB</small>
                            <input type="hidden" id="troll_image_base64">
                            <input type="hidden" id="troll_file_name">
                        </div>
                        <div class="d-flex">
                            <button class="btn btn-secondary flex-grow-1 mr-2" onclick="resetPushNotification()"><i class="fas fa-undo mr-2"></i>Reset & Tắt</button>
                            <button class="btn btn-primary flex-grow-1" onclick="saveTrollConfig()"><i class="fas fa-save mr-2"></i>Lưu Cấu hình</button>
                        </div>
                    </div>
                    <!-- Tab Tính năng & Chữ chạy -->
                    <div class="tab-pane fade" id="tab-features">
                        <h6 class="text-primary font-weight-bold"><i class="fas fa-scroll mr-2"></i>Cấu hình Chữ chạy (Marquee)</h6>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <label class="mb-0">Bật chữ chạy</label>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_marquee_enabled"><label class="custom-control-label" for="conf_marquee_enabled"></label></div>
                        </div>
                        <div class="form-group"><label>Nội dung hiển thị</label><input type="text" id="conf_marquee_text" class="form-control" placeholder="VD: Chúc mừng năm mới..."></div>
                        <hr>
                        <h6 class="text-danger font-weight-bold"><i class="fas fa-tools mr-2"></i>Bảo trì từng tính năng (Manager)</h6>
                        <p class="small text-muted">Bật switch để ĐÓNG (Bảo trì) tính năng đó.</p>
                        <div class="row">
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_attendance"><label class="custom-control-label" for="maint_attendance">Điểm danh</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_students"><label class="custom-control-label" for="maint_students">DS Học sinh</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_funds"><label class="custom-control-label" for="maint_funds">Quỹ nhóm</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_notis"><label class="custom-control-label" for="maint_notis">Thông báo</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_eval"><label class="custom-control-label" for="maint_eval">Đánh giá</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_feedback"><label class="custom-control-label" for="maint_feedback">Phản ánh kiến nghị</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_upload"><label class="custom-control-label" for="maint_upload">Trung tâm Tải file</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_calendar"><label class="custom-control-label" for="maint_calendar">Lịch hoạt động</label></div></div>
                        </div>
                        <hr>
                        <h6 class="text-warning font-weight-bold"><i class="fas fa-user-lock mr-2"></i>Khóa nhập liệu Học sinh</h6>
                        <div class="form-group d-flex justify-content-between align-items-center">
                            <label class="mb-0">Khóa nhập/thêm học sinh mới</label>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_student_import_locked"><label class="custom-control-label" for="conf_student_import_locked"></label></div>
                        </div>
                        <div class="form-group"><label>Hạn chót nhập liệu (Tự động khóa sau ngày này)</label><input type="date" id="conf_student_import_deadline" class="form-control"></div>

                        <div class="form-group mt-2 border-top pt-2">
                            <label>Giới hạn dung lượng file Upload (MB)</label>
                            <input type="number" id="conf_max_upload_size" class="form-control" placeholder="Mặc định: 200" value="200">
                        </div>
                        <button class="btn btn-primary btn-block mt-3" onclick="saveFeatureConfig()"><i class="fas fa-save mr-2"></i>Lưu Cấu hình Tính năng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Charts -->
<div class="modal fade" id="modalCharts" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title" id="chartModalTitle">Thống kê chi tiết</h5>
                <div class="d-flex align-items-center ml-auto">
                    <div id="chartFilterContainer" class="mr-2" style="display:none;">
                        <select id="chartGroupFilter" class="form-control form-control-sm" onchange="updateModalCharts()">
                            <option value="">-- Tất cả Nhóm --</option>
                        </select>
                    </div>
                    <button type="button" class="close text-white ml-2" data-dismiss="modal"><span>&times;</span></button>
                </div>
            </div>
            <div class="modal-body bg-light">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow-sm"><div class="card-header d-flex justify-content-between align-items-center"><h3 class="card-title font-weight-bold" id="chartTitle1">Phân bố</h3><button class="btn btn-xs btn-outline-secondary" onclick="downloadChartImage('modalChart1', 'Bieu_do_phan_bo.png')"><i class="fas fa-download"></i> PNG</button></div><div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="modalChart1"></canvas></div></div></div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm"><div class="card-header d-flex justify-content-between align-items-center"><h3 class="card-title font-weight-bold" id="chartTitle2">Biến động</h3><button class="btn btn-xs btn-outline-secondary" onclick="downloadChartImage('modalChart2', 'Bieu_do_bien_dong.png')"><i class="fas fa-download"></i> PNG</button></div><div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="modalChart2"></canvas></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";
let globalHistoryData = [], globalStudentsData = [], globalUsersData = [], globalGroupsData = [], globalNotisData = [];
let chartEval, chartStGroup, chartStTrend;
let modalChart1, modalChart2, currentChartCategory = '';
let currentHistoryView = []; // Dữ liệu lịch sử đang hiển thị (đã lọc)
let currentStudentView = []; // Dữ liệu học sinh đang hiển thị
let currentEvaluationView = []; // Dữ liệu đánh giá đang hiển thị
let globalMaxUploadSize = 200; // Default 200MB

function getLoadingRowHtml(colspan) {
    return `<tr><td colspan="${colspan}" class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Đang tải dữ liệu...</p></td></tr>`;
}

function getErrorRowHtml(colspan, message = "Không thể tải dữ liệu.") {
    return `<tr><td colspan="${colspan}" class="text-center text-danger p-5"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></td></tr>`;
}


$(document).ready(function() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    if(user) $('#adminNameDisplay').text(user.fullname);
    
    // Load Dark Mode setting
    if (localStorage.getItem('darkMode') === 'true') {
        $('body').addClass('dark-mode');
    }
    refreshAll();
});

async function refreshAll() {
    await loadStudents();
    updateAttendanceStats();
    loadExtraData();
    loadLogs();
    loadFeedbacks();
    loadEvaluations();
    loadSystemSettings(); // Load config (Eval + Troll)
    loadEvalConfig();
    setTimeout(renderDashboardStats, 1000);
}

async function loadStudents() {
    $('#studentData').html(getLoadingRowHtml(7));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_USERS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalStudentsData = res.data.students;
            $('#countHS').text(res.data.totalStudents);
            
            // Populate Filters
            populateStudentFilters();
            
            // Render Table
            currentStudentView = globalStudentsData;
            renderStudentTable(currentStudentView);
        }
    } catch (e) { 
        toastr.error("Lỗi tải danh sách học sinh."); 
        $('#studentData').html(getErrorRowHtml(7));
    }
}

function populateStudentFilters() {
    const groups = [...new Set(globalStudentsData.map(s => s.group_display))].sort();
    const schools = [...new Set(globalStudentsData.map(s => s.school).filter(s => s))].sort();
    
    let gHtml = '<option value="">-- Tất cả Nhóm --</option>';
    groups.forEach(g => gHtml += `<option value="${g}">${g}</option>`);
    $('#st_filter_group').html(gHtml);

    let sHtml = '<option value="">-- Tất cả Trường --</option>';
    schools.forEach(s => sHtml += `<option value="${s}">${s}</option>`);
    $('#st_filter_school').html(sHtml);
}

function renderStudentTable(data) {
    let html = '';
    data.forEach((st, index) => {
        html += `<tr>
            <td class="font-weight-bold">${st.fullname}</td>
            <td class="text-dob">${st.dob}</td>
            <td>${st.class_name || '-'}</td>
            <td><span class="badge badge-info badge-group">${st.group_display}</span></td>
            <td><small>${st.school}</small></td>
            <td><a href="tel:${st.phone}">${st.phone || '-'}</a></td>
            <td><small>${st.address || '-'}</small></td>
            <td>
                <button class="btn btn-info btn-action" onclick="editStudent('${st.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-action" onclick="deleteData('students', '${st.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
    
    if ($.fn.DataTable.isDataTable('#studentTable')) {
        $('#studentTable').DataTable().destroy();
    }
    $('#studentData').html(html);
    $('#studentTable').DataTable({ 
        "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Tất cả"]]
    });
}

function filterStudents() {
    const name = $('#st_filter_name').val().toLowerCase();
    const group = $('#st_filter_group').val();
    const school = $('#st_filter_school').val();
    const from = $('#st_filter_from').val();
    const to = $('#st_filter_to').val();

    let d1, d2;
    if (from) { d1 = new Date(from); d1.setHours(0,0,0,0); } // Start of day
    if (to) { d2 = new Date(to); d2.setHours(23,59,59,999); } // End of day

    currentStudentView = globalStudentsData.filter(st => {
        const matchName = !name || (st.fullname && st.fullname.toLowerCase().includes(name));
        const matchGroup = !group || (st.group_display && st.group_display === group);
        const matchSchool = !school || (st.school && st.school === school);
        
        let matchDate = true;
        if (d1 || d2) {
            // Extract timestamp from ID (ST + timestamp)
            const ts = parseInt(st.id.replace('ST', ''));
            if (!isNaN(ts)) {
                const dateAdded = new Date(ts);
                if (d1 && dateAdded.getTime() < d1.getTime()) matchDate = false;
                if (d2 && dateAdded.getTime() > d2.getTime()) matchDate = false;
            }
        }

        return matchName && matchGroup && matchSchool && matchDate;
    });

    renderStudentTable(currentStudentView);
    toastr.success(`Tìm thấy ${currentStudentView.length} học sinh`);
}

function resetStudentFilter() {
    $('#st_filter_name, #st_filter_group, #st_filter_school, #st_filter_from, #st_filter_to').val('');
    currentStudentView = globalStudentsData;
    renderStudentTable(currentStudentView);
}

async function loadRegistrations() {
    $('#regData').html(getLoadingRowHtml(6));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_REGISTRATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            res.data.forEach(r => {
                html += `<tr>
                    <td><code>${r.id}</code></td>
                    <td class="font-weight-bold text-danger">${r.pass}</td>
                    <td>${r.fullname}</td>
                    <td>${r.class_name}</td>
                    <td>${r.school}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="regeneratePass('${r.id}')"><i class="fas fa-sync mr-1"></i>Đổi Pass</button>
                    </td>
                </tr>`;
            });
            $('#regData').html(html || '<tr><td colspan="6" class="text-center">Không có đăng ký chờ duyệt.</td></tr>');
        }
    } catch (e) { $('#regData').html(getErrorRowHtml(6)); }
}

async function regeneratePass(id) {
    if(!confirm('Tạo lại mật khẩu ngẫu nhiên cho ID này?')) return;
    const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "REGENERATE_PASS", payload: { id } }) });
    const res = await response.json();
    if(res.status === 'success') { toastr.success('Mật khẩu mới: ' + res.new_pass); loadRegistrations(); }
}

async function loadExtraData() {
    $('#managerData').html(getLoadingRowHtml(8));
    $('#notiData').html(getLoadingRowHtml(8));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalUsersData = res.data.managers;
            globalGroupsData = res.data.groups;
            globalNotisData = res.data.notifications || [];
            
            // Managers Table
            let mHtml = '';
            res.data.managers.forEach((m, idx) => {
                let honorBadge = '';
                try {
                    const h = JSON.parse(m.honors || '{}');
                    if(h.level) honorBadge = `<span class="badge badge-warning ml-1">${h.level.toUpperCase()}</span>`;
                } catch(e){}
                mHtml += `<tr>
                    <td class="text-center"><img src="${m.avatar || 'https://via.placeholder.com/50'}" class="img-manager shadow-sm"></td>
                    <td><code>${m.username}</code></td>
                    <td class="font-weight-bold">${m.fullname}</td>
                    <td><span class="badge badge-warning">${m.group_id}</span></td>
                    <td><span class="badge badge-secondary">${m.role}</span></td>
                    <td><small>${m.email || '-'}</small></td>
                    <td><small>${m.phone || '-'}</small></td>
                    <td><small>${m.last_login || '-'}</small></td>
                    <td>
                        <button class="btn btn-info btn-action" onclick="editUser('${m.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-warning btn-action" onclick="resetPassword('${m.username}')" title="Reset Pass"><i class="fas fa-key"></i></button>
                        <button class="btn btn-danger btn-action" onclick="deleteData('users', '${m.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            if ($.fn.DataTable.isDataTable('#managerTable')) {
                $('#managerTable').DataTable().destroy();
            }
            $('#managerData').html(mHtml);
            $('#managerTable').DataTable({ "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }});
 
            // Groups View
            let gHtml = '';
            res.data.groups.forEach((g, idx) => {
                gHtml += `<div class="col-md-3">
                    <div class="info-box shadow-sm position-relative">
                        <span class="info-box-icon bg-info elevation-1"><i class="fas fa-layer-group"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text text-bold">${g.group_name}</span>
                            <span class="info-box-number">Mã: ${g.group_id}</span>
                        </div>
                        <div style="position:absolute; right:5px; top:5px;">
                             <button class="btn btn-xs btn-outline-info" onclick="editGroup(${idx})"><i class="fas fa-edit"></i></button>
                             <button class="btn btn-xs btn-outline-danger" onclick="deleteData('groups', '${g.group_id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            $('#groupCardsContainer').html(gHtml || '<div class="col-12 text-center">Không có dữ liệu nhóm</div>');

            // Notifications Table
            let nHtml = '';
            globalNotisData.forEach((n, idx) => {
                let readers = n.read_by || [];
                if (typeof readers === 'string') readers = readers.split(',').filter(x => x);
                let readersHtml = readers.length > 0
                    ? `<span class="badge badge-info">${readers.length}</span> <small class="d-block" style="max-height:60px;overflow-y:auto;">${readers.join(', ')}</small>` 
                    : '<small class="text-muted">Chưa có</small>';

                let typeBadge = '<span class="badge badge-secondary">Thường</span>';
                let pollActions = '';
                
                if (n.type === 'online') typeBadge = '<span class="badge badge-primary"><i class="fas fa-video mr-1"></i>Online</span>';
                if (n.type === 'offline') typeBadge = '<span class="badge badge-success"><i class="fas fa-map-marker-alt mr-1"></i>Trực tiếp</span>';
                if (n.type === 'poll') {
                    typeBadge = '<span class="badge badge-warning"><i class="fas fa-poll mr-1"></i>Bình chọn</span>';
                    pollActions = `
                        <div class="mt-1">
                            <button class="btn btn-xs btn-outline-primary" onclick="viewPollDetail('${n.id}', '${n.title}')" title="Xem chi tiết"><i class="fas fa-list-ol"></i></button>
                            <button class="btn btn-xs btn-outline-success" onclick="exportPollExcel('${n.id}', '${n.title}')" title="Xuất Excel"><i class="fas fa-file-excel"></i></button>
                        </div>`;
                }
                
                let locationInfo = n.location ? `<br><small class="text-muted">${n.type === 'online' ? 'Link: ' : 'ĐĐ: '}${n.location}</small>` : '';
                let attachIcon = n.attachment ? `<br><span class="badge badge-warning"><i class="fas fa-paperclip"></i> Có file</span>` : '';

                nHtml += `<tr>
                    <td>${n.id}</td>
                    <td class="font-weight-bold">${n.title}</td>
                    <td><small>${n.content}</small></td>
                    <td><code>${n.datetime}</code></td>
                    <td><span class="badge badge-${n.early === 'TRUE' ? 'success' : 'secondary'}">${n.early}</span></td>
                    <td>${typeBadge}${locationInfo}${attachIcon}</td>
                    <td>${readersHtml}${pollActions}</td>
                    <td>
                        <button class="btn btn-danger btn-action" onclick="deleteData('notifications', '${n.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            $('#notiData').html(nHtml);
        }
    } catch (e) { 
        console.error("Error loading extra data", e); 
        $('#managerData').html(getErrorRowHtml(6));
        $('#notiData').html(getErrorRowHtml(8));
    }
}

async function loadLogs() {
    $('#logData').html(getLoadingRowHtml(4));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_LOGS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            res.data.forEach(log => {
                html += `<tr>
                    <td><small>${log.timestamp}</small></td>
                    <td><code>${log.username}</code></td>
                    <td><span class="badge badge-light border">${log.action}</span></td>
                    <td><small>${log.details}</small></td>
                </tr>`;
            });
            $('#logData').html(html);
        }
    } catch (e) { console.log("Logs error"); $('#logData').html(getErrorRowHtml(4)); }
}

let globalFeedbacksData = [];
async function loadFeedbacks() {
    $('#feedbackData').html(getLoadingRowHtml(5));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_FEEDBACKS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            globalFeedbacksData = res.data || [];
            renderFeedbacks(globalFeedbacksData);
        }
    } catch (e) { console.error("Feedback error", e); $('#feedbackData').html(getErrorRowHtml(5)); }
}

function renderFeedbacks(data) {
    let html = '';
    if (data.length === 0) {
        html = '<tr><td colspan="5" class="text-center">Không có phản ánh nào.</td></tr>';
    } else {
        data.forEach(fb => {
            const contentAndAttachments = `
                <b>${fb.title || '(Không có tiêu đề)'}</b><br>
                <small>
                    <span class="text-danger">Nội dung:</span> ${fb.difficulty || 'Không'}<br>
                    <span class="text-info">Kiến nghị:</span> ${fb.suggestion || 'Không'}
                </small>
                <div class="mt-2">
                    ${fb.drive_link ? `<a href="${fb.drive_link}" target="_blank" class="btn btn-xs btn-info mb-1"><i class="fab fa-google-drive mr-1"></i>Link Drive</a> ` : ''}
                    ${fb.attachment ? `<a href="${fb.attachment}" download="${fb.attachment_name || 'file'}" class="btn btn-xs btn-secondary"><i class="fas fa-download mr-1"></i>Tải File</a>` : ''}
                </div>
            `;

            html += `<tr>
                <td><small>${fb.timestamp}</small></td>
                <td>
                    <b>${fb.fullname || 'Vô danh'}</b><br>
                    <small>SĐT: ${fb.phone}</small><br>
                    <span class="badge badge-secondary">Nhóm ${fb.group_id}</span>
                </td>
                <td>
                    ${contentAndAttachments}
                </td>
                <td>
                    ${fb.reply ? `<div class="alert alert-light border">${fb.reply}</div>` : '<i class="text-muted">Chưa có phản hồi</i>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openReply('${fb.id}')"><i class="fas fa-reply"></i> Trả lời</button>
                </td>
            </tr>`;
        });
    }
    
    // Re-init DataTable if needed, or just rely on manual filter
    if ($.fn.DataTable.isDataTable('#feedbackTable')) {
        $('#feedbackTable').DataTable().destroy();
    }
    $('#feedbackData').html(html);
    $('#feedbackTable').DataTable({ 
        "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }, 
        "order": [[ 0, "desc" ]],
        "searching": true
    });
}

// Load config cho cả Eval và Troll
async function loadEvalConfig() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_CONFIG" }) });
        const res = await response.json();
        if (res.status === "success") {
            $('#conf_eval_enabled').prop('checked', String(res.data.evaluation_enabled).toUpperCase() === 'TRUE');
            // Format date for input type=date (YYYY-MM-DD)
            if (res.data.evaluation_deadline) {
                const d = new Date(res.data.evaluation_deadline);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                $('#conf_eval_deadline').val(`${yyyy}-${mm}-${dd}`);
            }
            
            // Load Troll Config
            $('#troll_enabled').prop('checked', String(res.data.troll_enabled).toUpperCase() === 'TRUE');
            $('#troll_mode').prop('checked', String(res.data.troll_mode).toUpperCase() === 'TRUE');
            $('#troll_title').val(res.data.troll_title || '');
            $('#troll_content').val(res.data.troll_content || '');
            $('#troll_youtube').val(res.data.troll_youtube || '');
            $('#troll_file_name').val(res.data.troll_file_name || '');

            // Load Maintenance Config
            $('#maintenanceSwitch').prop('checked', String(res.data.maintenance_mode).toUpperCase() === 'TRUE');
            
            // Helper format datetime-local
            const fmtDate = (iso) => {
                if(!iso) return '';
                const d = new Date(iso);
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };
            $('#maint_start_input').val(fmtDate(res.data.maintenance_start));
            $('#maint_end_input').val(fmtDate(res.data.maintenance_end));

            // Load Marquee Config
            $('#conf_marquee_enabled').prop('checked', String(res.data.marquee_enabled).toUpperCase() === 'TRUE');
            $('#conf_marquee_text').val(res.data.marquee_text || '');

            // Load Feature Maintenance Config
            $('#maint_attendance').prop('checked', String(res.data.maint_attendance).toUpperCase() === 'TRUE');
            $('#maint_students').prop('checked', String(res.data.maint_students).toUpperCase() === 'TRUE');
            $('#maint_funds').prop('checked', String(res.data.maint_funds).toUpperCase() === 'TRUE');
            $('#maint_notis').prop('checked', String(res.data.maint_notis).toUpperCase() === 'TRUE');
            $('#maint_eval').prop('checked', String(res.data.maint_eval).toUpperCase() === 'TRUE');
            $('#maint_feedback').prop('checked', String(res.data.maint_feedback).toUpperCase() === 'TRUE');
            $('#maint_upload').prop('checked', String(res.data.maint_upload).toUpperCase() === 'TRUE');
            $('#maint_calendar').prop('checked', String(res.data.maint_calendar).toUpperCase() === 'TRUE');
            
            // Student Import Lock
            $('#conf_student_import_locked').prop('checked', String(res.data.student_import_locked).toUpperCase() === 'TRUE');
            if(res.data.student_import_deadline) $('#conf_student_import_deadline').val(res.data.student_import_deadline.split('T')[0]);
            
            // Load Max Upload Size
            globalMaxUploadSize = parseInt(res.data.max_upload_size) || 200;
            $('#conf_max_upload_size').val(globalMaxUploadSize);
        }
    } catch (e) { console.error("Config error", e); }
}

async function saveEvalConfig() {
    const enabled = $('#conf_eval_enabled').is(':checked') ? 'TRUE' : 'FALSE';
    const deadline = $('#conf_eval_deadline').val();
    
    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { evaluation_enabled: enabled, evaluation_deadline: deadline } }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu cấu hình đánh giá!', 'success');
            $('#modalEvalConfig').modal('hide');
        }
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- SETTINGS & TROLL FUNCTIONS ---
function openSettingsModal() {
    $('#modalSettings').modal('show');
    $('#darkModeSwitch').prop('checked', $('body').hasClass('dark-mode'));
    loadEvalConfig(); // Reload config để lấy dữ liệu mới nhất
}

function toggleDarkMode() {
    if ($('#darkModeSwitch').is(':checked')) {
        $('body').addClass('dark-mode');
        localStorage.setItem('darkMode', 'true');
    } else {
        $('body').removeClass('dark-mode');
        localStorage.setItem('darkMode', 'false');
    }
}

async function toggleMaintenance() {
    const enabled = $('#maintenanceSwitch').is(':checked') ? 'TRUE' : 'FALSE';
    const msg = enabled === 'TRUE' ? 'BẬT chế độ bảo trì? Tất cả Quản lý sẽ bị đăng xuất.' : 'TẮT chế độ bảo trì?';
    
    if(!confirm(msg)) {
        $('#maintenanceSwitch').prop('checked', !$('#maintenanceSwitch').is(':checked')); // Revert
        return;
    }

    try {
        await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { maintenance_mode: enabled } }) });
        toastr.success("Đã cập nhật trạng thái bảo trì!");
    } catch (e) { toastr.error("Lỗi kết nối"); }
}

async function saveMaintenanceSchedule() {
    const start = $('#maint_start_input').val();
    const end = $('#maint_end_input').val();
    
    if (start && end && new Date(start) >= new Date(end)) {
        return Swal.fire('Lỗi', 'Thời gian kết thúc phải sau thời gian bắt đầu!', 'error');
    }

    Swal.fire({ title: 'Đang lưu lịch...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { maintenance_start: start, maintenance_end: end } }) });
        const res = await response.json();
        if (res.status === 'success') Swal.fire('Thành công', 'Đã lưu lịch bảo trì!', 'success');
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// Xử lý ảnh Troll
$('#troll_file').change(function() {
    const file = this.files[0];
    if (file) {
        const isWord = file.name.match(/\.(doc|docx|pdf)$/i);
        const limit = isWord ? 50 * 1024 * 1024 : 100 * 1024 * 1024;
        
        if (file.size > limit) {
            toastr.warning(`File quá lớn! Giới hạn: ${isWord ? '50MB (Word/PDF)' : '100MB (Khác)'}`);
            this.value = ''; $('#troll_image_base64').val(''); $('#troll_file_name').val('');
            return;
        }
        $('#troll_file_name').val(file.name);
        const reader = new FileReader();
        reader.onload = function(e) { $('#troll_image_base64').val(e.target.result); };
        reader.readAsDataURL(file);
    }
});

async function saveTrollConfig() {
    const enabled = $('#troll_enabled').is(':checked') ? 'TRUE' : 'FALSE';
    const payload = {
        troll_enabled: enabled,
        troll_mode: $('#troll_mode').is(':checked') ? 'TRUE' : 'FALSE',
        troll_title: $('#troll_title').val(),
        troll_content: $('#troll_content').val(),
        troll_youtube: $('#troll_youtube').val(),
        troll_file_name: $('#troll_file_name').val()
    };
    
    // Chỉ gửi ảnh nếu có chọn ảnh mới (để tránh xóa ảnh cũ nếu không chọn)
    const imgBase64 = $('#troll_image_base64').val();
    if (imgBase64) payload.troll_image = imgBase64;
    else if (!enabled) payload.troll_image = ''; // Nếu tắt thì có thể xóa ảnh

    Swal.fire({ title: 'Đang lưu cấu hình...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') Swal.fire('Thành công', 'Đã cập nhật cấu hình Thông báo Khẩn!', 'success');
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function saveFeatureConfig() {
    const payload = {
        marquee_enabled: $('#conf_marquee_enabled').is(':checked') ? 'TRUE' : 'FALSE',
        marquee_text: $('#conf_marquee_text').val(),
        maint_attendance: $('#maint_attendance').is(':checked') ? 'TRUE' : 'FALSE',
        maint_students: $('#maint_students').is(':checked') ? 'TRUE' : 'FALSE',
        maint_funds: $('#maint_funds').is(':checked') ? 'TRUE' : 'FALSE',
        maint_notis: $('#maint_notis').is(':checked') ? 'TRUE' : 'FALSE',
        maint_eval: $('#maint_eval').is(':checked') ? 'TRUE' : 'FALSE',
        maint_feedback: $('#maint_feedback').is(':checked') ? 'TRUE' : 'FALSE',
        maint_upload: $('#maint_upload').is(':checked') ? 'TRUE' : 'FALSE',
        maint_calendar: $('#maint_calendar').is(':checked') ? 'TRUE' : 'FALSE',
        student_import_locked: $('#conf_student_import_locked').is(':checked') ? 'TRUE' : 'FALSE',
        student_import_deadline: $('#conf_student_import_deadline').val(),
        max_upload_size: $('#conf_max_upload_size').val() || '200'
    };
    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Thành công', 'Đã lưu cấu hình tính năng!', 'success'); loadEvalConfig(); }
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function resetPushNotification() {
    Swal.fire({
        title: 'Reset Thông báo Khẩn?',
        text: "Toàn bộ nội dung thông báo sẽ bị xóa và tắt kích hoạt. Bạn có chắc không?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Vâng, Reset!',
        cancelButtonText: 'Hủy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            $('#troll_enabled').prop('checked', false);
            $('#troll_title, #troll_content, #troll_youtube, #troll_file, #troll_image_base64, #troll_file_name').val(''); $('#troll_mode').prop('checked', false);

            const payload = { troll_enabled: 'FALSE', troll_title: '', troll_content: '', troll_youtube: '', troll_image: '', troll_file_name: '' };

            Swal.fire({ title: 'Đang reset...', didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
                const res = await response.json();
                if (res.status === 'success') Swal.fire('Đã Reset', 'Thông báo khẩn đã được xóa và tắt.', 'success');
                else Swal.fire('Lỗi', res.message, 'error');
            } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối khi reset.', 'error'); }
        }
    });
}

// Alias function để load config chung
function loadSystemSettings() {
    // Đã gộp vào loadEvalConfig nhưng giữ hàm này nếu cần mở rộng
    loadEvalConfig();
}

function resetEvaluations() {
    Swal.fire({
        title: 'Bắt đầu đợt đánh giá mới?',
        text: "Hành động này sẽ XÓA TOÀN BỘ dữ liệu đánh giá hiện tại của tất cả học sinh để bắt đầu đợt mới. Bạn có chắc chắn không?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Xóa & Reset',
        cancelButtonText: 'Hủy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            const user = JSON.parse(sessionStorage.getItem('user'));
            Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(API_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ 
                        action: "RESET_EVALUATIONS", 
                        payload: { admin_user: user.username } 
                    }) 
                });
                const res = await response.json();
                if (res.status === 'success') {
                    Swal.fire('Thành công', res.message, 'success');
                    loadEvaluations();
                } else Swal.fire('Lỗi', res.message, 'error');
            } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
        }
    });
}

let globalEvaluationsData = [];
async function loadEvaluations() {
    $('#evalData').html(getLoadingRowHtml(6));
    $('#eval_filter_group').html('<option value="">-- Tất cả Nhóm --</option>'); // Reset filter nhóm
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_EVALUATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            const rawEvaluations = res.data; // [ID, Name, Group, Disc, Pos, Vol, Class, By, Time]
            
            const mergedList = globalStudentsData.map(st => {
                const evalItem = rawEvaluations.find(e => String(e[0]) === String(st.id));
                if (evalItem) {
                    return {
                        name: st.fullname,
                        group: st.group_display,
                        disc: evalItem[3],
                        pos: evalItem[4],
                        vol: evalItem[5],
                        class: evalItem[6]
                    };
                } else {
                    return {
                        name: st.fullname,
                        group: st.group_display,
                        disc: '',
                        pos: '',
                        vol: '',
                        class: 'Chưa đánh giá'
                    };
                }
            });
            
            globalEvaluationsData = mergedList; // Lưu dữ liệu đã ghép để xuất Excel
            
            // Populate Group Filter
            const groups = [...new Set(globalEvaluationsData.map(e => e.group))].sort();
            let gHtml = '<option value="">-- Tất cả Nhóm --</option>';
            groups.forEach(g => gHtml += `<option value="${g}">${g}</option>`);
            $('#eval_filter_group').html(gHtml);

            // Render Default
            filterEvaluations();
        }
    } catch (e) { console.error("Eval error", e); $('#evalData').html(getErrorRowHtml(6)); }
}

function filterEvaluations() {
    const name = $('#eval_filter_name').val().toLowerCase();
    const group = $('#eval_filter_group').val();
    const status = $('#eval_filter_status').val();
    const classification = $('#eval_filter_class').val();

    currentEvaluationView = globalEvaluationsData.filter(e => {
        const matchName = !name || (e.name && e.name.toLowerCase().includes(name));
        const matchGroup = !group || e.group === group;
        
        let matchStatus = true;
        if (status === 'evaluated') matchStatus = e.class !== 'Chưa đánh giá';
        if (status === 'not_evaluated') matchStatus = e.class === 'Chưa đánh giá';

        let matchClass = true;
        if (classification) matchClass = e.class === classification;

        return matchName && matchGroup && matchStatus && matchClass;
    });

    renderEvaluationTable(currentEvaluationView);
}

function renderEvaluationTable(data) {
    let html = '';
    if (data.length === 0) {
        html = '<tr><td colspan="6" class="text-center">Không tìm thấy kết quả</td></tr>';
    } else {
        data.forEach(e => {
            let badgeClass = 'secondary';
            if (e.class === 'Xuất sắc') badgeClass = 'success';
            else if (e.class === 'Tốt') badgeClass = 'primary';
            else if (e.class === 'Trung bình') badgeClass = 'warning';
            else if (e.class === 'Yếu') badgeClass = 'danger';
            else badgeClass = 'light border'; // Chưa đánh giá

            html += `<tr>
                <td class="font-weight-bold">${e.name}</td>
                <td><span class="badge badge-light border">${e.group}</span></td>
                <td><small>${e.disc || '-'}</small></td>
                <td><small>${e.pos || '-'}</small></td>
                <td><small>${e.vol || '-'}</small></td>
                <td><span class="badge badge-${badgeClass}">${e.class}</span></td>
            </tr>`;
        });
    }
    if ($.fn.DataTable.isDataTable('#evalTable')) {
        $('#evalTable').DataTable().destroy();
    }
    $('#evalData').html(html);
    $('#evalTable').DataTable({ "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }, "searching": false });
}

function resetEvaluationFilter() {
    $('#eval_filter_name, #eval_filter_group, #eval_filter_status, #eval_filter_class').val('');
    filterEvaluations();
}

async function updateAttendanceStats() {
    $('#historyAttendanceData').html(getLoadingRowHtml(5));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_ADMIN_STATS" }) });
        const res = await response.json();
        if (res.status === "success") {
            const s = res.data;
            $('#countPresent').text(s.present);
            $('#countAbsentP').text(s.absent_perm);
            $('#countAbsent').text(s.absent);
            globalHistoryData = s.history || [];
            currentHistoryView = globalHistoryData; // Mặc định hiển thị tất cả
            renderHistoryTable(currentHistoryView);
        }
    } catch (e) { 
        toastr.error("Không thể kết nối Server."); 
        $('#historyAttendanceData').html(getErrorRowHtml(5));
    }
}

function renderDashboardStats() {
    $('#countManagers').text(globalUsersData.length);
    $('#countGroups').text(globalGroupsData.length);
    $('#countNotis').text(globalNotisData.length);
    $('#countFeedbacks').text(globalFeedbacksData.length);
}

function showChartsFor(category) {
    currentChartCategory = category;
    $('#modalCharts').modal('show');
    
    // Populate Group Filter
    const groupSelect = $('#chartGroupFilter');
    groupSelect.empty().append('<option value="">-- Tất cả Nhóm --</option>');
    
    if (['students', 'attendance', 'feedbacks'].includes(category)) {
        $('#chartFilterContainer').show();
        if(globalGroupsData) {
            globalGroupsData.forEach(g => {
                groupSelect.append(`<option value="${g.group_name}">${g.group_name}</option>`);
            });
        }
    } else {
        $('#chartFilterContainer').hide();
    }
    
    updateModalCharts();
}

function updateModalCharts() {
    const groupFilter = $('#chartGroupFilter').val();
    const ctx1 = document.getElementById('modalChart1').getContext('2d');
    const ctx2 = document.getElementById('modalChart2').getContext('2d');
    
    if (modalChart1) modalChart1.destroy();
    if (modalChart2) modalChart2.destroy();
    
    let data1 = {}, data2 = {};
    let type1 = 'pie', type2 = 'line';
    let title1 = 'Phân bố', title2 = 'Biến động';

    if (currentChartCategory === 'students') {
        title1 = 'Phân bố Học sinh'; title2 = 'Tăng trưởng Học sinh';
        let filtered = globalStudentsData;
        if (groupFilter) filtered = filtered.filter(s => s.group_display === groupFilter);
        
        // Chart 1: Group Distribution (or Class if filtered)
        const counts = {};
        filtered.forEach(s => { 
            const key = groupFilter ? (s.class_name || 'Khác') : s.group_display;
            counts[key] = (counts[key] || 0) + 1; 
        });
        data1 = { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de'] }] };
        
        // Chart 2: Growth
        const growth = {};
        filtered.forEach(s => {
            const ts = parseInt(s.id.replace('ST', ''));
            if(!isNaN(ts)) {
                const d = new Date(ts);
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                growth[key] = (growth[key] || 0) + 1;
            }
        });
        const keys = Object.keys(growth).sort();
        let acc = 0;
        const vals = keys.map(k => { acc += growth[k]; return acc; });
        data2 = { labels: keys, datasets: [{ label: 'Tổng HS', data: vals, borderColor: '#17a2b8', fill: true }] };

    } else if (currentChartCategory === 'attendance') {
        title1 = 'Tỉ lệ Điểm danh'; title2 = 'Xu hướng 7 ngày';
        let filtered = globalHistoryData;
        if (groupFilter) filtered = filtered.filter(h => h.group_id === groupFilter);
        
        // Chart 1
        let p=0, ap=0, a=0;
        filtered.forEach(h => { if(h.status==='present') p++; else if(h.status==='absent_perm') ap++; else a++; });
        data1 = { labels: [`Có mặt (${p})`, `Vắng P (${ap})`, `Vắng K (${a})`], datasets: [{ data: [p, ap, a], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }] };
        type1 = 'doughnut';

        // Chart 2
        const trend = {};
        filtered.forEach(h => {
            const d = h.timestamp.split(' ')[0];
            if(!trend[d]) trend[d] = {p:0, ap:0, a:0};
            if(h.status==='present') trend[d].p++; else if(h.status==='absent_perm') trend[d].ap++; else trend[d].a++;
        });
        const dates = Object.keys(trend).sort((a,b) => { const [d1,m1,y1]=a.split('/'); const [d2,m2,y2]=b.split('/'); return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`); }).slice(-7);
        data2 = {
            labels: dates,
            datasets: [
                { label: 'Có mặt', data: dates.map(d=>trend[d].p), borderColor: '#28a745', fill: false },
                { label: 'Vắng P', data: dates.map(d=>trend[d].ap), borderColor: '#ffc107', fill: false },
                { label: 'Vắng K', data: dates.map(d=>trend[d].a), borderColor: '#dc3545', fill: false }
            ]
        };

    } else if (currentChartCategory === 'managers') {
        title1 = 'Phân bố Quyền hạn'; title2 = 'Quản lý theo Nhóm';
        // Chart 1
        const roles = {};
        globalUsersData.forEach(u => { roles[u.role] = (roles[u.role]||0)+1; });
        data1 = { labels: Object.keys(roles), datasets: [{ data: Object.values(roles), backgroundColor: ['#dc3545', '#ffc107', '#007bff'] }] };
        
        // Chart 2
        const groups = {};
        globalUsersData.forEach(u => { groups[u.group_id] = (groups[u.group_id]||0)+1; });
        data2 = { labels: Object.keys(groups), datasets: [{ label: 'Số lượng', data: Object.values(groups), backgroundColor: '#6f42c1' }] };
        type2 = 'bar';

    } else if (currentChartCategory === 'groups') {
        title1 = 'Học sinh theo Nhóm'; title2 = 'Số lượng Quản lý';
        // Chart 1 (Same as Students Dist)
        const counts = {};
        globalStudentsData.forEach(s => { counts[s.group_display] = (counts[s.group_display] || 0) + 1; });
        data1 = { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc'] }] };
        
        // Chart 2
        const mgrs = {};
        globalUsersData.forEach(u => { mgrs[u.group_id] = (mgrs[u.group_id]||0)+1; });
        data2 = { labels: Object.keys(mgrs), datasets: [{ label: 'Quản lý', data: Object.values(mgrs), backgroundColor: '#17a2b8' }] };
        type2 = 'bar';

    } else if (currentChartCategory === 'notifications') {
        title1 = 'Loại Thông báo'; title2 = 'Lịch sử tạo';
        const types = {};
        globalNotisData.forEach(n => { types[n.type] = (types[n.type]||0)+1; });
        data1 = { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: ['#6c757d', '#007bff', '#28a745', '#ffc107'] }] };
        
        const dates = {};
        globalNotisData.forEach(n => { const d = n.datetime.split(' ')[0]; dates[d] = (dates[d]||0)+1; });
        const sorted = Object.keys(dates).sort();
        data2 = { labels: sorted, datasets: [{ label: 'Số TB', data: sorted.map(d=>dates[d]), borderColor: '#fd7e14', fill: false }] };

    } else if (currentChartCategory === 'feedbacks') {
        title1 = 'Trạng thái Phản hồi'; title2 = 'Lịch sử Gửi';
        let filtered = globalFeedbacksData;
        if (groupFilter) filtered = filtered.filter(f => f.group_id == groupFilter); // Loose equality for ID vs Name match attempt
        
        const status = { 'Đã trả lời': 0, 'Chờ xử lý': 0 };
        filtered.forEach(f => { f.reply ? status['Đã trả lời']++ : status['Chờ xử lý']++; });
        data1 = { labels: Object.keys(status), datasets: [{ data: Object.values(status), backgroundColor: ['#28a745', '#ffc107'] }] };
        
        const dates = {};
        filtered.forEach(f => { const d = f.timestamp.split(' ')[0]; dates[d] = (dates[d]||0)+1; });
        const sorted = Object.keys(dates).sort((a,b) => { const [d1,m1,y1]=a.split('/'); const [d2,m2,y2]=b.split('/'); return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`); });
        data2 = { labels: sorted, datasets: [{ label: 'Số phản ánh', data: sorted.map(d=>dates[d]), backgroundColor: '#17a2b8' }] };
        type2 = 'bar';
    }

    $('#chartTitle1').text(title1);
    $('#chartTitle2').text(title2);
    
    modalChart1 = new Chart(ctx1, { type: type1, data: data1, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    modalChart2 = new Chart(ctx2, { type: type2, data: data2, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
}

function downloadChartImage(canvasId, filename) {
    const canvas = document.getElementById(canvasId);
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function renderCharts(data) {
    // 1. Attendance Ratio (Doughnut)
    const ctxAttRatio = document.getElementById('chartAttendanceRatio').getContext('2d');
    if (chartAttRatio) chartAttRatio.destroy();
    chartAttRatio = new Chart(ctxAttRatio, {
        type: 'doughnut',
        data: {
            labels: [`Có mặt (${data.present})`, `Vắng P (${data.absent_perm})`, `Vắng K (${data.absent})`],
            datasets: [{ data: [data.present, data.absent_perm, data.absent], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // 2. Attendance Trend (Line) - Process History Data
    const historyByDate = {};
    (data.history || []).forEach(h => {
        const date = h.timestamp.split(' ')[0]; // dd/mm/yyyy
        if (!historyByDate[date]) historyByDate[date] = { p: 0, ap: 0, a: 0 };
        if (h.status === 'present') historyByDate[date].p++;
        else if (h.status === 'absent_perm') historyByDate[date].ap++;
        else historyByDate[date].a++;
    });
    // Sort dates
    const sortedDates = Object.keys(historyByDate).sort((a,b) => {
        const [d1,m1,y1] = a.split('/'); const [d2,m2,y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
    }).slice(-7); // Last 7 days

    const ctxAttTrend = document.getElementById('chartAttendanceTrend').getContext('2d');
    if (chartAttTrend) chartAttTrend.destroy();
    chartAttTrend = new Chart(ctxAttTrend, {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: [
                { label: 'Có mặt', data: sortedDates.map(d => historyByDate[d].p), borderColor: '#28a745', fill: false, tension: 0.1 },
                { label: 'Vắng (P)', data: sortedDates.map(d => historyByDate[d].ap), borderColor: '#ffc107', fill: false, tension: 0.1 },
                { label: 'Vắng (K)', data: sortedDates.map(d => historyByDate[d].a), borderColor: '#dc3545', fill: false, tension: 0.1 }
            ]
        },
        options: { maintainAspectRatio: false }
    });

    // 3. Evaluation Chart (Bar)
    if(globalEvaluationsData.length > 0) {
        const counts = { 'Xuất sắc': 0, 'Tốt': 0, 'Trung bình': 0, 'Yếu': 0, 'Chưa đánh giá': 0 };
        globalEvaluationsData.forEach(e => { counts[e.class] = (counts[e.class] || 0) + 1; });
        const ctxEval = document.getElementById('chartEvaluation').getContext('2d');
        if (chartEval) chartEval.destroy();
        chartEval = new Chart(ctxEval, {
            type: 'bar',
            data: { labels: Object.keys(counts), datasets: [{ label: 'Số lượng', data: Object.values(counts), backgroundColor: '#007bff' }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // 4. Student Charts (Group & Trend)
    if(globalStudentsData.length > 0) {
        // Group Distribution
        const groupCounts = {};
        globalStudentsData.forEach(s => { groupCounts[s.group_display] = (groupCounts[s.group_display] || 0) + 1; });
        
        const ctxStGroup = document.getElementById('chartStGroup').getContext('2d');
        if (chartStGroup) chartStGroup.destroy();
        chartStGroup = new Chart(ctxStGroup, {
            type: 'pie',
            data: {
                labels: Object.keys(groupCounts),
                datasets: [{ data: Object.values(groupCounts), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de', '#605ca8', '#ff851b'] }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        // Student Growth Trend (Based on ID timestamp)
        const growth = {};
        globalStudentsData.forEach(s => {
            const ts = parseInt(s.id.replace('ST', ''));
            if(!isNaN(ts)) {
                const d = new Date(ts);
                const key = `${d.getDate()}/${d.getMonth()+1}`;
                growth[key] = (growth[key] || 0) + 1;
            }
        });
        // Sort keys roughly (simple sort for dd/mm might fail across years but ok for demo)
        const growthKeys = Object.keys(growth).sort((a,b) => a.localeCompare(b)); // Simple sort
        let cumulative = 0;
        const growthData = growthKeys.map(k => { cumulative += growth[k]; return cumulative; });

        const ctxStTrend = document.getElementById('chartStTrend').getContext('2d');
        if (chartStTrend) chartStTrend.destroy();
        chartStTrend = new Chart(ctxStTrend, {
            type: 'line',
            data: { labels: growthKeys, datasets: [{ label: 'Tổng học sinh', data: growthData, borderColor: '#17a2b8', backgroundColor: 'rgba(23, 162, 184, 0.2)', fill: true }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }
}

function renderHistoryTable(history) {
    let html = '';
    history.forEach(row => {
        let statusBadge = row.status === 'present' ? '<span class="badge badge-success">Có mặt</span>' : 
                          (row.status === 'absent_perm' ? '<span class="badge badge-warning">Vắng (P)</span>' : '<span class="badge badge-danger">Vắng</span>');
        let reasonHtml = row.reason ? `<br><small class="text-muted font-italic">Lý do: ${row.reason}</small>` : '';
        html += `<tr>
            <td><small class="text-muted">${row.timestamp}</small></td>
            <td><b>${row.student_name}</b></td>
            <td><span class="badge badge-light border">${row.group_id}</span></td>
            <td>${statusBadge}${reasonHtml}</td>
            <td><small>${row.recorded_by}</small></td>
        </tr>`;
    });
    $('#historyAttendanceData').html(html || '<tr><td colspan="5" class="text-center">Trống</td></tr>');
}

function filterHistory() {
    const from = $('#filter_from').val();
    const to = $('#filter_to').val();
    const status = $('#filter_status').val();
    const name = $('#filter_history_name').val().toLowerCase();

    let d1, d2;
    if (from && to) {
        d1 = new Date(from); d1.setHours(0,0,0,0);
        d2 = new Date(to); d2.setHours(23,59,59,999);
    }
    
    currentHistoryView = globalHistoryData.filter(h => {
        let dateMatch = true;
        if (d1 && d2) {
            const parts = h.timestamp.split(' ')[0].split('/'); // dd/mm/yyyy
            const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // yyyy-mm-dd
            dateMatch = d >= d1 && d <= d2;
        }
        
        let statusMatch = true;
        if (status) {
            statusMatch = h.status === status;
        }

        let nameMatch = true;
        if (name) {
            nameMatch = h.student_name.toLowerCase().includes(name);
        }
        return dateMatch && statusMatch && nameMatch;
    });
    renderHistoryTable(currentHistoryView);
    toastr.success(`Đã lọc: ${currentHistoryView.length} bản ghi`);
}

function resetFilter() {
    $('#filter_from, #filter_to, #filter_status, #filter_history_name').val('');
    currentHistoryView = globalHistoryData;
    renderHistoryTable(currentHistoryView);
}

// AUTO GENERATE ID FUNCTION
function getNextId(list, prop, prefix = '') {
    if (!list || list.length === 0) return prefix + '1';
    let max = 0;
    list.forEach(item => {
        let val = String(item[prop]);
        // Lấy số ở cuối chuỗi ID hiện tại
        const match = val.match(/(\d+)$/);
        if (match) {
            const num = parseInt(match[1]);
            if (num > max) max = num;
        }
    });
    // Trả về prefix + số tiếp theo
    return prefix + (max + 1);
}

// OPEN MODAL FUNCTIONS
function openStudentModal() { $('#modalStudent').modal('show'); $('#student_id_old').val(''); $('#st_id').prop('readonly', false).val(getNextId(globalStudentsData, 'id', '')); $('#st_name, #st_dob, #st_class, #st_address, #st_phone, #st_group, #st_school, #st_reg_time, #st_reg_loc, #st_reg_act').val(''); }

const HONOR_TITLES = ["Năng nổ nhất", "Siêng năng nhất", "Chăm chỉ nhất", "Ý tưởng sáng tạo", "Lầy lội nhất", "Văn nghệ tuyệt nhất", "Đoàn kết nhất"];

function renderHonorCheckboxes(selected = []) {
    let html = '';
    HONOR_TITLES.forEach(t => {
        const checked = selected.includes(t) ? 'checked' : '';
        html += `
        <div class="custom-control custom-checkbox mr-3 mb-2">
            <input type="checkbox" class="custom-control-input honor-check" id="h_${t}" value="${t}" ${checked}>
            <label class="custom-control-label" for="h_${t}">${t}</label>
        </div>`;
    });
    $('#u_honors_container').html(html);
}

function openUserModal() { 
    $('#modalUser').modal('show'); $('#user_id_old').val(''); $('#pass_area').show(); $('#u_name').val(getNextId(globalUsersData, 'username', 'user')); $('#u_pass, #u_role, #u_group, #u_fullname, #u_avatar, #u_email').val(''); 
    $('#u_vip_level').val(''); renderHonorCheckboxes();
}
function openGroupModal() { $('#modalGroup').modal('show'); $('#group_id_old').val(''); $('#g_id').val(getNextId(globalGroupsData, 'group_id', '')); $('#g_name').val(''); }
function openNotiModal() { 
    $('#modalNoti').modal('show'); 
    $('#noti_id_old').val(''); 
    $('#n_id').val(getNextId(globalNotisData, 'id', 'NOTI')); 
    $('#n_title, #n_content, #n_datetime, #n_location, #n_file, #n_attachment_base64, #n_file_name').val(''); 
    $('#n_type').val('normal');
    toggleLocationInput();
}

function toggleLocationInput() {
    const type = $('#n_type').val();
    if (type === 'normal') {
        $('#grp_location').addClass('d-none');
    } else {
        $('#grp_location').removeClass('d-none');
        $('#lbl_location').text(type === 'online' ? 'Link cuộc họp (Google Meet/Zoom)' : 'Địa điểm tổ chức');
        $('#n_location').attr('placeholder', type === 'online' ? 'https://meet.google.com/...' : 'Phòng họp số 1, Tầng 2...');
    }
}

// Xử lý file đính kèm (Chuyển sang Base64)
$('#n_file').change(function() {
    const file = this.files[0];
    if (file) {
        $('#n_file_name').val(file.name); // Lưu tên file
        const isWord = file.name.match(/\.(doc|docx|pdf)$/i);
        const limit = isWord ? 50 * 1024 * 1024 : 100 * 1024 * 1024;

        if (file.size > limit) {
            toastr.warning(`File quá lớn! Giới hạn: ${isWord ? '50MB (Word/PDF)' : '100MB (Khác)'}`);
            this.value = ''; // Reset input
            $('#n_attachment_base64').val('');
            $('#n_file_name').val('');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) { $('#n_attachment_base64').val(e.target.result); };
        reader.readAsDataURL(file);
    }
});

// EDIT FUNCTIONS
function editStudent(studentId) {
    const s = globalStudentsData.find(st => String(st.id) === String(studentId));
    if (!s) {
        return toastr.error("Không tìm thấy học sinh để sửa!");
    }
    $('#student_id_old').val(s.id);
    $('#st_id').val(s.id).prop('readonly', true);
    $('#st_name').val(s.fullname);
    $('#st_dob').val(s.dob);
    $('#st_class').val(s.class_name);
    $('#st_address').val(s.address);
    $('#st_phone').val(s.phone);
    $('#st_group').val(s.group_id);
    $('#st_school').val(s.school);
    $('#st_reg_time').val(s.reg_time);
    $('#st_reg_loc').val(s.reg_loc);
    $('#st_reg_act').val(s.reg_act);
    $('#modalStudent').modal('show');
}

function editUser(username) {
    const u = globalUsersData.find(user => String(user.username) === String(username));
    if (!u) {
        return toastr.error("Không tìm thấy tài khoản để sửa!");
    }
    $('#user_id_old').val(u.username);
    $('#u_name').val(u.username);
    $('#u_role').val(u.role);
    $('#u_group').val(u.group_id);
    $('#u_fullname').val(u.fullname);
    $('#u_email').val(u.email || '');
    $('#u_phone').val(u.phone || '');
    $('#u_avatar').val(u.avatar);
    
    // Load Honors
    let honors = { level: '', titles: [] };
    try { honors = JSON.parse(u.honors || '{}'); } catch(e){}
    $('#u_vip_level').val(honors.level || '');
    renderHonorCheckboxes(honors.titles || []);

    $('#pass_area').hide();
    $('#modalUser').modal('show');
}

function showVipConfigHelp() {
    Swal.fire({
        title: 'Cấu hình Vinh danh',
        html: 'Để cấu hình VIP và Danh hiệu cho một quản lý:<br>1. Nhấn nút <b><i class="fas fa-edit text-info"></i> Sửa</b> tại dòng của quản lý đó.<br>2. Kéo xuống phần <b>Hệ thống Vinh danh (VIP)</b>.<br>3. Chọn cấp độ VIP và các danh hiệu mong muốn.<br>4. Nhấn Lưu.',
        icon: 'info'
    });
}

function editGroup(idx) {
    const g = globalGroupsData[idx];
    $('#group_id_old').val(g.group_id);
    $('#g_id').val(g.group_id);
    $('#g_name').val(g.group_name);
    $('#modalGroup').modal('show');
}

function openReply(id) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#reply_id').val(id);
    $('#reply_content').val('');
    $('#reply_responder').val(user ? user.fullname : '');
    $('#reply_phone').val('');
    $('#modalReply').modal('show');
}

async function submitReply() {
    const id = $('#reply_id').val();
    const content = $('#reply_content').val();
    const responder = $('#reply_responder').val();
    const phone = $('#reply_phone').val();

    if(!content || !responder) return toastr.warning("Vui lòng nhập nội dung và tên người trả lời!");
    
    const fullReply = `${content}<br><br>----------------<br><b>Người trả lời:</b> ${responder}<br><b>SĐT hỗ trợ:</b> ${phone || 'Không có'}`;
    
    Swal.fire({ title: 'Đang gửi...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'REPLY_FEEDBACK', payload: { id: id, reply: fullReply } }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Thành công', 'Đã gửi phản hồi', 'success'); $('#modalReply').modal('hide'); loadFeedbacks(); }
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function resetPassword(username) {
    const user = globalUsersData.find(u => String(u.username) === String(username));
    if (!user) return;
    
    const result = await Swal.fire({
        title: 'Xác nhận reset?',
        text: `Mật khẩu của ${username} sẽ về mặc định: Abc@123`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Reset ngay',
        cancelButtonText: 'Hủy'
    });
    
    if (result.isConfirmed) {
        Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'RESET_PASSWORD', payload: { username: username, admin_user: JSON.parse(sessionStorage.getItem('user')).username } }) });
            const res = await response.json();
            if (res.status === 'success') Swal.fire('Thành công!', res.message, 'success');
            else Swal.fire('Lỗi', res.message, 'error');
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    }
}

// SAVE & DELETE DATA
async function saveData(type) {
    let action = 'ADD_DATA', idOld = "", dataArr = [];
    if (type === 'students') {
        idOld = $('#student_id_old').val();
        dataArr = [
            $('#st_id').val(), $('#st_name').val(), $('#st_dob').val(), $('#st_class').val(), $('#st_school').val(), 
            $('#st_address').val(), $('#st_phone').val(), $('#st_group').val(), 
            $('#st_reg_time').val(), $('#st_reg_loc').val(), $('#st_reg_act').val()
        ];
    } else if (type === 'users') {
        idOld = $('#user_id_old').val();
        // Get Honors
        const titles = [];
        $('.honor-check:checked').each(function() { titles.push($(this).val()); });
        const honorsJson = JSON.stringify({ level: $('#u_vip_level').val(), titles: titles });

        // Check VIP exclusivity
        const role = $('#u_role').val();
        const vip = $('#u_vip_level').val();
        if ((vip === 'vip4' || vip === 'vip5') && role !== 'supervisor') {
            return Swal.fire('Lỗi', 'VIP 4 và VIP 5 chỉ dành cho Cấp quản lý (Supervisor)!', 'error');
        }

        // Special handling for Users to preserve timestamps in backend
        const payload = {
            action: 'SAVE_USER_ADMIN',
            payload: {
                is_add: !idOld,
                id: idOld || $('#u_name').val(),
                data: [$('#u_name').val(), $('#u_pass').val(), $('#u_role').val(), $('#u_group').val(), $('#u_fullname').val(), $('#u_avatar').val(), $('#u_email').val(), honorsJson, $('#u_phone').val()],
                admin_user: JSON.parse(sessionStorage.getItem('user')).username
            }
        };
        // Bypass generic call
        callApiAndRefresh(payload);
        return;
    } else if (type === 'groups') {
        idOld = $('#group_id_old').val();
        dataArr = [$('#g_id').val(), $('#g_name').val()];
    } else if (type === 'notifications') {
        idOld = $('#noti_id_old').val();
        let dt = $('#n_datetime').val().replace('T', ' '); // Format lại: bỏ chữ T ở giữa
        // Cấu trúc: ID, Title, Content, DateTime, Early, CreatedAt, Readers(Auto), Type, Location, Attachment, AttachmentName
        dataArr = [$('#n_id').val(), $('#n_title').val(), $('#n_content').val(), dt, $('#n_early').val(), new Date().toLocaleString(), "", $('#n_type').val(), $('#n_location').val(), $('#n_attachment_base64').val(), $('#n_file_name').val()];
    }

    if (idOld) action = 'UPDATE_DATA';
    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    callApiAndRefresh({ action: action, payload: { type: type, id: idOld, data: dataArr } });
}

async function callApiAndRefresh(bodyData) {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify(bodyData) });
        const res = await response.json();
        if (res.status === 'success') {
            $('.modal').modal('hide');
            Swal.fire('Thành công!', res.message, 'success');
            refreshAll();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Không thể kết nối Server', 'error'); }
}

function printStudents() {
    const table = $('#studentTable').DataTable();
    const pageLength = table.page.len();
    
    const afterPrint = () => {
        table.page.len(pageLength).draw();
        window.removeEventListener('afterprint', afterPrint);
    };
    window.addEventListener('afterprint', afterPrint);

    // Show all entries for printing
    table.page.len(-1).draw();

    // Use a timeout to allow the table to redraw before printing
    setTimeout(() => {
        window.print();
    }, 300);
}

function deleteData(type, id) {
    Swal.fire({ title: 'Xóa dữ liệu?', text: "Hành động này không thể hoàn tác!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Xóa' }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: type, id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { Swal.fire('Đã xóa!', res.message, 'success'); refreshAll(); }
            } catch (e) { toastr.error("Lỗi xóa dữ liệu"); }
        }
    });
}

// EXPORT FUNCTIONS
function exportExcelHistory() {
    if (currentHistoryView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");
    const data = currentHistoryView.map(item => {
        let st = "Vắng không phép";
        if (item.status === 'present') st = "Có mặt";
        else if (item.status === 'absent_perm') st = "Vắng có phép";
        
        return { "Thời Gian": item.timestamp, "Học Sinh": item.student_name, "Nhóm": item.group_id, "Trạng Thái": st, "Lý do": item.reason || "", "Người Thực Hiện": item.recorded_by };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Lịch Sử");
    XLSX.writeFile(wb, `Lich_Su_Diem_Danh.xlsx`);
}

function exportExcelStudents() {
    if (currentStudentView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");
    
    const data = currentStudentView.map(st => {
        let dateAdded = "";
        const ts = parseInt(st.id.replace('ST', ''));
        if (!isNaN(ts)) {
            dateAdded = new Date(ts).toLocaleDateString('vi-VN');
        }
        return { "Họ Và Tên": st.fullname, "Ngày Sinh": st.dob, "Lớp": st.class_name, "Nhóm": st.group_display, "Trường": st.school, "SĐT": st.phone, "Địa chỉ": st.address, "Ngày thêm": dateAdded };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DSHS");
    XLSX.writeFile(wb, `Danh_Sach_Hoc_Sinh.xlsx`);
}

function exportExcelEvaluations() {
    if (currentEvaluationView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");
    
    const data = currentEvaluationView.map(e => ({
        "Họ và Tên": e.name,
        "Nhóm": e.group,
        "Ý thức tổ chức kỷ luật": e.disc,
        "Mức độ tích cực": e.pos,
        "Hoạt động tình nguyện": e.vol,
        "Xếp loại": e.class
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DanhGia");
    XLSX.writeFile(wb, `Tong_Hop_Danh_Gia_SHH.xlsx`);
}

async function backupSystem() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    Swal.fire({ title: 'Đang tạo bản sao lưu...', text: 'Vui lòng chờ, quá trình này có thể mất vài giây.', didOpen: () => Swal.showLoading() });
    
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "BACKUP_SYSTEM", 
                payload: { admin_user: user.username } 
            }) 
        });
        const res = await response.json();
        
        if (res.status === 'success') {
            const wb = XLSX.utils.book_new();
            const data = res.data;
            
            for (const [sheetName, sheetData] of Object.entries(data)) {
                if (sheetData && sheetData.length > 0) {
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            }
            
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
            XLSX.writeFile(wb, `FULL_BACKUP_SHH_${timestamp}.xlsx`);
            
            Swal.fire('Thành công', 'Đã tải xuống file sao lưu toàn bộ hệ thống!', 'success');
        } else {
            Swal.fire('Lỗi', res.message, 'error');
        }
    } catch (e) {
        console.error(e);
        Swal.fire('Lỗi', 'Lỗi kết nối Server khi backup', 'error');
    }
}

function downloadTemplateAdmin() {
    const data = [
        { "Họ và Tên": "Nguyễn Văn A", "Ngày sinh": "20/10/2010", "Nhóm": "1", "Trường học": "THCS A", "SĐT": "0909123456", "Địa chỉ": "123 Đường ABC" },
        { "Họ và Tên": "Trần Thị B", "Ngày sinh": "01/01/2011", "Nhóm": "2", "Trường học": "THCS B", "SĐT": "0909654321", "Địa chỉ": "456 Đường XYZ" }
    ];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
    XLSX.writeFile(wb, `Mau_Nhap_Lieu_Admin_Full.xlsx`);
}
 
async function uploadFileGeneric(source) {
    const fileInput = document.getElementById(source === 'admin' ? 'file_upload_generic' : 'file_upload_generic');
    const file = fileInput.files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");
    
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File quá lớn! Giới hạn: ${globalMaxUploadSize}MB`);
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64 = e.target.result;
        const user = JSON.parse(sessionStorage.getItem('user'));
        
        Swal.fire({ title: 'Đang tải lên...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { 
                method: "POST", 
                body: JSON.stringify({ 
                    action: "UPLOAD_FILE", 
                    payload: { 
                        uploader: user.username, 
                        group_id: 'ADMIN', 
                        filename: file.name, 
                        size: (file.size / 1024 / 1024).toFixed(2) + ' MB', 
                        data: base64,
                        type: 'FILE'
                    } 
                }) 
            });
            const res = await response.json();
            if (res.status === 'success') {
                Swal.fire('Thành công', 'File đã được tải lên!', 'success');
                fileInput.value = '';
                loadUploadedFiles();
            } else Swal.fire('Lỗi', res.message, 'error');
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    };
    reader.readAsDataURL(file);
}

async function loadUploadedFiles() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_UPLOADS" }) });
        const res = await response.json();
        if (res.status === 'success') {
            let html = '';
            res.data.forEach(f => {
                const isLink = f.type === 'LINK';
                const icon = isLink ? '<i class="fab fa-google-drive text-success fa-lg"></i>' : '<i class="fas fa-file-alt text-primary fa-lg"></i>';
                const content = isLink 
                    ? `<a href="${f.data}" target="_blank" class="font-weight-bold text-success">${f.data}</a>` 
                    : `<a href="${f.data}" download="${f.filename}" class="font-weight-bold">${f.filename}</a> <small class="text-muted">(${f.size})</small>`;

                html += `<tr>
                    <td><small>${f.timestamp}</small></td>
                    <td class="font-weight-bold text-primary">${f.uploader}</td>
                    <td><span class="badge badge-secondary">${f.group_id}</span></td>
                    <td class="text-center">${icon}</td>
                    <td>${content}</td>
                    <td><button class="btn btn-xs btn-danger" onclick="deleteData('uploads', '${f.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            $('#uploadedFilesList').html(html || '<tr><td colspan="6" class="text-center">Chưa có dữ liệu</td></tr>');
        }
    } catch (e) { console.error(e); }
}

// Add loadUploadedFiles to refreshAll
const originalRefreshAll = refreshAll;
refreshAll = async function() {
    await originalRefreshAll();
    loadUploadedFiles();
};

function processImportAdminTab() {
    const file = document.getElementById('file_import').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");
    
    // Check size limit
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File quá lớn! Giới hạn cho phép là ${globalMaxUploadSize}MB.`);
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if (jsonData.length === 0) return toastr.warning("File rỗng!");

        // Map data to standard format
        const mappedData = jsonData.map(row => ({
            fullname: row["Họ và Tên"] || "",
            dob: row["Ngày sinh"] || "",
            class_name: row["Lớp"] || "",
            group_id: String(row["Nhóm"] || "").trim(),
            school: row["Trường học"] || "",
            phone: row["SĐT"] || "",
            address: row["Địa chỉ"] || "",
            reg_time: row["Thời gian"] || "",
            reg_loc: row["Địa điểm"] || "",
            reg_act: row["Hoạt động"] || ""
        })).filter(item => item.fullname && item.group_id); // Filter invalid rows

        if (mappedData.length === 0) return toastr.warning("Không tìm thấy dữ liệu hợp lệ (Cần có Tên và Nhóm)!");

        Swal.fire({ title: 'Đang nhập liệu...', didOpen: () => Swal.showLoading() });
        const user = JSON.parse(sessionStorage.getItem('user'));
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ 
                action: "IMPORT_STUDENTS", 
                payload: { students: mappedData, admin_user: user.username } 
            })
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                Swal.fire('Thành công', res.message, 'success');
                $('#modalImport').modal('hide');
                loadStudents();
            } else Swal.fire('Lỗi', res.message, 'error');
        })
        .catch(() => Swal.fire('Lỗi', 'Lỗi kết nối', 'error'));
    };
    reader.readAsArrayBuffer(file);
}

function openImportModal(context) {
    if (context === 'admin') {
        $('#btnDownloadTemplate').attr('onclick', 'downloadTemplateAdmin()');
        $('#btnProcessImport').attr('onclick', 'processImportAdminTab()');
    }
    $('#modalImport').modal('show');
    $('#file_import').val('');
}

function openRestoreModal() {
    $('#modalRestore').modal('show');
    $('#file_restore').val('');
}

function processRestore() {
    const file = document.getElementById('file_restore').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file backup!");

    Swal.fire({
        title: 'Bạn có chắc chắn?',
        text: "Toàn bộ dữ liệu hiện tại sẽ bị ghi đè. Hành động này không thể hoàn tác!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Vâng, phục hồi ngay!',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const restoreData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (sheetData.length > 0) {
                            restoreData[sheetName] = sheetData;
                        }
                    });

                    if (Object.keys(restoreData).length === 0) {
                        return Swal.fire('Lỗi', 'File backup rỗng hoặc không hợp lệ.', 'error');
                    }

                    Swal.fire({ title: 'Đang phục hồi...', text: 'Vui lòng không đóng trang.', didOpen: () => Swal.showLoading() });

                    const user = JSON.parse(sessionStorage.getItem('user'));
                    fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify({ 
                            action: "RESTORE_SYSTEM", 
                            payload: { data: restoreData, admin_user: user.username } 
                        })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'success') {
                            Swal.fire('Thành công!', 'Hệ thống đã được phục hồi. Trang sẽ được tải lại.', 'success').then(() => window.location.reload());
                            $('#modalRestore').modal('hide');
                        } else Swal.fire('Lỗi', res.message, 'error');
                    })
                    .catch(() => Swal.fire('Lỗi', 'Lỗi kết nối khi phục hồi.', 'error'));
                } catch (err) { Swal.fire('Lỗi', 'Đã xảy ra lỗi khi đọc file backup. File có thể bị hỏng.', 'error'); console.error(err); }
            };
            reader.readAsArrayBuffer(file);
        }
    });
}

function openPollModal() {
    $('#modalPoll').modal('show');
    $('#poll_question, #poll_options, #poll_deadline').val('');
}

function openEvalConfigModal() {
    $('#modalEvalConfig').modal('show');
}

async function createPoll() {
    const question = $('#poll_question').val().trim();
    const optionsStr = $('#poll_options').val().trim();
    const deadline = $('#poll_deadline').val();

    if (!question || !optionsStr || !deadline) return toastr.warning("Vui lòng nhập đầy đủ thông tin!");

    const options = optionsStr.split(',').map(s => s.trim()).filter(s => s);
    if (options.length < 2) return toastr.warning("Cần ít nhất 2 lựa chọn!");

    const pollContent = JSON.stringify({ question: question, options: options, deadline: deadline });
    const pollId = 'POLL' + new Date().getTime();
    
    // Save as Notification with type 'poll'
    // ID, Title, Content, DateTime, Early, CreatedAt, Readers, Type, Location, Attachment, AttachmentName
    const dataArr = [pollId, question, pollContent, deadline, 'FALSE', new Date().toLocaleString(), "", 'poll', '', '', ''];

    Swal.fire({ title: 'Đang tạo bình chọn...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "ADD_DATA", payload: { type: 'notifications', data: dataArr } }) });
        const res = await response.json();
        if (res.status === 'success') {
            $('#modalPoll').modal('hide');
            Swal.fire('Thành công', 'Đã tạo bình chọn!', 'success');
            refreshAll();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function viewPollResults(pollId) {
    Swal.fire({ title: 'Đang tải kết quả...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_POLL_RESULTS", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const counts = res.data;
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let html = `<div class="text-left">`;
            for (const [opt, count] of Object.entries(counts)) {
                const percent = total === 0 ? 0 : Math.round((count / total) * 100);
                html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between small"><span>${opt}</span><span>${count} phiếu (${percent}%)</span></div>
                    <div class="progress" style="height: 10px;"><div class="progress-bar bg-success" style="width: ${percent}%"></div></div>
                </div>`;
            }
            html += `</div>`;
            Swal.fire({ title: `Kết quả (${total} phiếu)`, html: html });
        } else Swal.fire('Lỗi', 'Không thể tải kết quả', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function exportPollExcel(pollId, title) {
    Swal.fire({ title: 'Đang xuất Excel...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_POLL_VOTES", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const data = res.data.map(v => ({
                "Thời gian": v.timestamp,
                "Quản lý": v.manager,
                "Nhóm": v.group_id,
                "Học sinh": v.student_name,
                "Lựa chọn": v.option
            }));
            
            if (data.length === 0) return Swal.fire('Thông báo', 'Chưa có dữ liệu bình chọn nào.', 'info');
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQua");
            XLSX.writeFile(wb, `Binh_Chon_${title.replace(/\s+/g, '_')}.xlsx`);
            Swal.close();
        } else Swal.fire('Lỗi', 'Không thể tải dữ liệu', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}
</script>
</body>
</html>     XLSX.writeFile(wb, `Binh_Chon_${title.replace(/\s+/g, '_')}.xlsx`);
            Swal.close();
        } else Swal.fire('Lỗi', 'Không thể tải dữ liệu', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}
</script>

<!-- Modal Eval Config -->
<div class="modal fade" id="modalEvalConfig" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-cogs mr-2"></i>Cấu hình Đợt đánh giá</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Trạng thái đánh giá</label>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="conf_eval_enabled">
                        <label class="custom-control-label font-weight-bold" for="conf_eval_enabled">Cho phép đánh giá</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Hạn chót (Deadline)</label>
                    <input type="date" id="conf_eval_deadline" class="form-control">
                </div>
                <hr>
                <div class="form-group">
                    <label class="text-danger font-weight-bold">Khu vực nguy hiểm</label>
                    <button class="btn btn-warning btn-block font-weight-bold" onclick="resetEvaluations()">
                        <i class="fas fa-redo-alt mr-2"></i>Reset Đợt Mới (Xóa hết đánh giá)
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" onclick="saveEvalConfig()">Lưu cấu hình</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>