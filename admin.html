<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản trị - Hệ thống Quản lý SHH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <style>
        /* New styles for menu boxes */
        .small-box {
            border-radius: 12px; /* A bit more modern */
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .small-box:hover {
            transform: translateY(-7px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .small-box .icon {
            transition: transform 0.3s ease;
        }
        .small-box:hover .icon {
            transform: scale(1.1) rotate(-5deg);
        }
        /* New styles for section titles */
        .dashboard-section-title {
            font-size: 1.1rem; font-weight: 500; color: #495057;
            border-bottom: 1px solid #e9ecef; padding-bottom: 0.5rem;
            margin-top: 1.5rem; margin-bottom: 1.25rem;
        }
        .info-box { transition: transform 0.3s; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .info-box:hover { transform: translateY(-5px); }
        .text-dob { color: #007bff; font-weight: bold; }
        .badge-group { font-size: 0.85rem; padding: 4px 8px; }
        .table-history { font-size: 0.9rem; }
        .history-card-body { max-height: 600px; overflow-y: auto; }
        .img-manager { width: 35px; height: 35px; object-fit: cover; border-radius: 50%; }
        .btn-action { padding: 2px 5px; font-size: 0.8rem; }
        .nav-link p { font-weight: 500; }
        .sidebar-dark-primary { background-color: #343a40; }
        /* Youth Union Theme */
        .navbar-primary { background-color: #1e88e5 !important; }
        body.dark-mode .dashboard-section-title {
            color: #c2c7d0;
            border-bottom-color: #454d55;
        }
        .brand-link.bg-primary { background-color: #1e88e5 !important; }
        .sidebar-light-primary .nav-sidebar>.nav-item>.nav-link.active { background-color: #1e88e5; color: #fff; border-radius: 10px; box-shadow: 0 4px 6px rgba(30, 136, 229, 0.4); }
        .btn-primary { background-color: #1e88e5; border-color: #1976d2; border-radius: 50px; }
        .btn-primary:hover { background-color: #1565c0; border-color: #0d47a1; }
        /* Dark Mode Full Coverage */
        body { color: #212529; }
        body.dark-mode { background-color: #454d55 !important; color: #fff !important; }
        body.dark-mode .content-wrapper { background-color: #343a40; color: #fff; }
        body.dark-mode .modal-content { background-color: #343a40; color: #fff; }
        body.dark-mode .card { background: linear-gradient(135deg, #343a40, #2b3035); color: #fff; }
        body.dark-mode .modal-header { border-bottom-color: #454d55; }
        body.dark-mode .modal-footer { border-top-color: #454d55; }
        body.dark-mode .close { color: #fff; text-shadow: none; }
        body.dark-mode .form-control { background-color: #454d55; color: #fff; border-color: #6c757d; }
        body.dark-mode .form-control:focus { background-color: #454d55; color: #fff; }
        body.dark-mode .custom-file-label { background-color: #454d55; color: #fff; }
        body.dark-mode .custom-file-label::after { background-color: #56606a; color: #fff; }

        @media print {
            /* Hide all UI chrome */
            .main-sidebar, .main-header, .btn, .modal, .nav-tabs, .card-outline, .content-header, .nav-header, .small-box, .modal-backdrop {
                display: none !important;
            }
            /* Hide non-active tabs */
            .tab-pane:not(.active) {
                display: none !important;
            }
            /* Reset layout for printing */
            .content-wrapper {
                margin-left: 0 !important;
                padding-top: 0 !important;
                background: #fff !important;
            }
            .tab-pane.active {
                display: block !important;
                opacity: 1 !important;
            }
            .card {
                box-shadow: none !important;
                border: 1px solid #ddd;
            }
            /* Hide datatable controls for cleaner print */
            .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
                display: none !important;
            }
            .table-responsive {
                overflow-x: visible !important;
            }
        }
        /* Poll Tabs */
        .poll-tab-content { max-height: 400px; overflow-y: auto; }
        .poll-group-header { background: #f4f6f9; padding: 10px; font-weight: bold; border-bottom: 2px solid #ddd; }
        
        /* Hacker Title Effect */
        .hacker-gold {
            background: linear-gradient(90deg, #ffd700, #fff, #ffd700);
            background-size: 200% auto;
            color: #000;
            font-weight: bold;
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px #ffd700;
            animation: shineText 2s linear infinite;
            padding: 5px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            display: inline-block;
            margin: 2px;
        }
        @keyframes shineText { to { background-position: 200% center; } }
        
        /* Mobile Optimization */
        @media (max-width: 768px) {
            .table td, .table th { padding: 0.5rem; font-size: 0.85rem; }
            .btn-action { padding: 0.2rem 0.4rem; font-size: 0.75rem; }
            .card-title { font-size: 1.1rem; }
            .info-box { min-height: 80px; }
            .info-box-icon { font-size: 1.5rem; width: 60px; }
        }
        /* Mobile Optimization */
        @media (max-width: 576px) {
            .table td, .table th { font-size: 0.8rem; } /* Remove nowrap to prevent overflow */
            .modal-dialog { margin: 0.5rem; }
            .content-header h1 { font-size: 1.2rem; }
        }
        /* Chart Wrapper for Responsiveness */
        .chart-wrapper { position: relative; height: 250px; width: 100%; margin-bottom: 1rem; }
        
        /* Modern Rounded UI Overrides */
        /* Click/Focus Effect - Rounded Border */
        .btn:focus, .btn:active, .form-control:focus, .custom-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 136, 229, 0.25) !important;
            border-color: #1e88e5 !important;
            outline: none;
        }
        /* Streamlined Interface */
        .content-header { padding: 10px 0.5rem; }
        .card-header { padding: 0.75rem 1.25rem; background-color: transparent; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .card-body { padding: 1rem; }
        .card { border-radius: 20px; border: none; box-shadow: 0 0 20px rgba(0,0,0,0.05); background: linear-gradient(135deg, #ffffff 0%, #f4f6f9 100%); }
        .card-header { border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .btn { border-radius: 50px; }
        .form-control { border-radius: 15px; }
        .modal-content { border-radius: 25px; border: none; }
        .nav-pills .nav-link { border-radius: 50px; }
        .nav-sidebar .nav-link { border-radius: 10px; }
        .custom-select { border-radius: 15px; }

        /* Table Row Hover Effect */
        #studentTable tbody tr { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #studentTable tbody tr:hover {
            transform: scale(1.005);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10;
            position: relative;
            background-color: #fff !important;
        }
        /* Fix 1 Page Scroll */
        @media (min-width: 992px) { /* Apply fixed scroll only on desktop */
            html, body { height: 100vh; overflow: hidden; }
            .content-wrapper { height: calc(100vh - 57px - 40px) !important; overflow-y: auto; }
            .main-footer { height: 40px; line-height: 20px; }
        }
        .info-box { min-height: 90px; } /* Keep for all sizes */
        
        /* Smooth Tab Transition */
        .tab-pane.fade { transition: opacity 0.3s linear, transform 0.3s ease-out; transform: translateY(10px); }
        .tab-pane.fade.show { transform: translateY(0); }
        
        /* Connection Status */
        .connection-status {
            position: fixed; bottom: 10px; left: 10px; z-index: 10000;
            background: rgba(0, 0, 0, 0.7); color: #fff; padding: 6px 12px;
            border-radius: 30px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1); user-select: none;
        }
        .connection-status i { margin-right: 6px; }
    </style>
</head>

<body class="hold-transition layout-top-nav layout-navbar-fixed layout-footer-fixed">
<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user || user.role.toLowerCase() !== 'admin') {
            window.location.replace('login.html');
        }
    })();

    function logout() {
        sessionStorage.clear();
        window.location.replace('login.html');
    }
</script>

<!-- Connection Status Widget -->
<div id="connection-status" class="connection-status" style="display:none;">
    <i class="fas fa-wifi" id="conn-icon"></i>
    <span id="conn-text">Kết nối</span>
    <span id="conn-ms" class="ml-2 badge badge-dark">--ms</span>
</div>

<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item d-none d-sm-inline-block">
                <a href="javascript:void(0)" onclick="showMainMenu()" class="nav-link font-weight-bold"><i class="fas fa-home mr-1"></i> TRANG CHỦ</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block" id="installPwaNav" style="display:none;">
                <a href="javascript:void(0)" onclick="installPwa()" class="nav-link font-weight-bold text-warning"><i class="fas fa-download mr-1"></i> CÀI ĐẶT APP</a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
            <li class="nav-item d-flex align-items-center">
                <span class="nav-link">Xin chào, <b id="adminNameDisplay" class="text-primary">Admin</b></span>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript:void(0)" onclick="openSettingsModal()" title="Cài đặt hệ thống">
                    <i class="fas fa-cog"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-danger" href="javascript:void(0)" onclick="logout()">
                    <i class="fas fa-power-off"></i> Thoát
                </a>
            </li>
        </ul>
    </nav>

    <div class="content-wrapper">
        <!-- MAIN MENU GRID -->
        <div id="main-menu-section" class="content pt-4">
            <div class="container">
                <div class="text-center mb-4">
                    <h2 class="font-weight-bold text-primary">HỆ THỐNG QUẢN TRỊ VIÊN</h2>
                    <p class="text-muted">Chọn chức năng để bắt đầu làm việc</p>
                </div>

                <!-- Section 1: Tổng quan -->
                <h5 class="dashboard-section-title"><i class="fas fa-tachometer-alt mr-2"></i>Tổng quan</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info shadow" onclick="showTab('tab-dashboard')" style="cursor:pointer">
                            <div class="inner"><h3>Dashboard</h3><p>Thống kê & Lịch sử</p></div>
                            <div class="icon"><i class="fas fa-chart-pie"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Quản lý Dữ liệu -->
                <h5 class="dashboard-section-title"><i class="fas fa-database mr-2"></i>Quản lý Dữ liệu</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-primary shadow" onclick="showTab('tab-students-list')" style="cursor:pointer">
                            <div class="inner"><h3>Học sinh</h3><p>Danh sách & Đăng ký</p></div>
                            <div class="icon"><i class="fas fa-id-card"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning shadow" onclick="showTab('tab-managers-list')" style="cursor:pointer">
                            <div class="inner text-white"><h3>Tài khoản</h3><p>Quản lý & Phân quyền</p></div>
                            <div class="icon"><i class="fas fa-user-shield"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success shadow" onclick="showTab('tab-groups-list')" style="cursor:pointer">
                            <div class="inner"><h3>Nhóm SHH</h3><p>Danh sách nhóm</p></div>
                            <div class="icon"><i class="fas fa-users-cog"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Chức năng -->
                <h5 class="dashboard-section-title"><i class="fas fa-cubes mr-2"></i>Chức năng & Tiện ích</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-purple shadow" onclick="showTab('tab-upload')" style="cursor:pointer">
                            <div class="inner"><h3>File</h3><p>Quản lý tài nguyên</p></div>
                            <div class="icon"><i class="fas fa-folder-open"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-orange shadow" onclick="showTab('tab-notifications')" style="cursor:pointer">
                            <div class="inner text-white"><h3>Thông báo</h3><p>Tạo thông báo & Poll</p></div>
                            <div class="icon"><i class="fas fa-bell"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-teal shadow" onclick="showTab('tab-feedbacks')" style="cursor:pointer">
                            <div class="inner"><h3>Phản ánh</h3><p>Kiến nghị từ User</p></div>
                            <div class="icon"><i class="fas fa-comments"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-indigo shadow" onclick="showTab('tab-evaluations')" style="cursor:pointer">
                            <div class="inner"><h3>Đánh giá</h3><p>Xếp loại học sinh</p></div>
                            <div class="icon"><i class="fas fa-star"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Hệ thống -->
                <h5 class="dashboard-section-title"><i class="fas fa-cogs mr-2"></i>Hệ thống</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-secondary shadow" onclick="showTab('tab-system-logs')" style="cursor:pointer">
                            <div class="inner"><h3>Logs</h3><p>Nhật ký hoạt động</p></div>
                            <div class="icon"><i class="fas fa-history"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-light shadow" onclick="window.open('about.html', '_blank')" style="cursor:pointer">
                            <div class="inner"><h3>Hướng dẫn</h3><p>Tài liệu sử dụng</p></div>
                            <div class="icon"><i class="fas fa-question-circle"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FUNCTIONAL VIEWS (Hidden by default) -->
        <div id="functional-section" style="display:none;">
            <div class="content-header">
                <div class="container-fluid">
                    <button class="btn btn-outline-secondary mb-2 font-weight-bold" onclick="showMainMenu()">
                        <i class="fas fa-arrow-left mr-2"></i>Trở về Menu chính
                    </button>
                </div>
            </div>
            <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-dashboard">
                <section class="content-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1>Thống kê & Toàn bộ lịch sử</h1>
                            <div>
                                <button onclick="exportPdfHistory()" class="btn btn-danger"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                                <button onclick="refreshAll()" class="btn btn-primary ml-2"><i class="fas fa-sync"></i> Làm mới</button>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row">
                            <!-- Students -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-info shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('students', 'Thống kê Học sinh', 'countHS')">
                                    <span class="info-box-icon"><i class="fas fa-users"></i></span>
                                    <div class="info-box-content"><span class="info-box-text">Học sinh</span><span class="info-box-number" id="countHS">0</span></div>
                                </div>
                            </div>
                            <!-- Present -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-success shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('attendance', 'Thống kê Có mặt', 'countPresent')">
                                    <span class="info-box-icon"><i class="fas fa-check"></i></span>
                                    <div class="info-box-content"><span class="info-box-text">Có mặt</span><span class="info-box-number" id="countPresent">0</span></div>
                                </div>
                            </div>
                            <!-- Absent P -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-warning shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('attendance', 'Thống kê Vắng (P)', 'countAbsentP')">
                                    <span class="info-box-icon text-white"><i class="fas fa-envelope"></i></span>
                                    <div class="info-box-content text-white"><span class="info-box-text">Vắng (P)</span><span class="info-box-number" id="countAbsentP">0</span></div>
                                </div>
                            </div>
                            <!-- Absent K -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-danger shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('attendance', 'Thống kê Vắng (K)', 'countAbsent')">
                                    <span class="info-box-icon"><i class="fas fa-times"></i></span>
                                    <div class="info-box-content"><span class="info-box-text">Vắng (K)</span><span class="info-box-number" id="countAbsent">0</span></div>
                                </div>
                            </div>
                            <!-- Managers -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-purple shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('managers', 'Thống kê Quản lý', 'countManagers')">
                                    <span class="info-box-icon"><i class="fas fa-user-shield"></i></span>
                                    <div class="info-box-content"><span class="info-box-text">Quản lý</span><span class="info-box-number" id="countManagers">0</span></div>
                                </div>
                            </div>
                            <!-- Groups -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-indigo shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('groups', 'Thống kê Nhóm', 'countGroups')">
                                    <span class="info-box-icon"><i class="fas fa-layer-group"></i></span>
                                    <div class="info-box-content"><span class="info-box-text">Nhóm SHH</span><span class="info-box-number" id="countGroups">0</span></div>
                                </div>
                            </div>
                            <!-- Notifications -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-orange shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('notifications', 'Thống kê Thông báo', 'countNotis')">
                                    <span class="info-box-icon text-white"><i class="fas fa-bell"></i></span>
                                    <div class="info-box-content text-white"><span class="info-box-text">Thông báo</span><span class="info-box-number" id="countNotis">0</span></div>
                                </div>
                            </div>
                            <!-- Feedbacks -->
                            <div class="col-12 col-sm-6 col-md-3">
                                <div class="info-box bg-teal shadow-sm mb-3" style="cursor: pointer;" onclick="showChartsFor('feedbacks', 'Thống kê Phản ánh', 'countFeedbacks')">
                                    <span class="info-box-icon"><i class="fas fa-comments"></i></span>
                                    <div class="info-box-content"><span class="info-box-text">Phản ánh</span><span class="info-box-number" id="countFeedbacks">0</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="card card-outline card-success shadow">
                                    <div class="card-header d-flex flex-wrap p-2 align-items-center">
                                        <h3 class="card-title font-weight-bold pl-2 mr-auto mb-2 mb-md-0">Nhật ký điểm danh</h3>
                                        <div class="d-flex flex-wrap justify-content-end">
                                            <select id="filter_status" class="form-control form-control-sm m-1" style="width: auto;" onchange="filterHistory()">
                                                <option value="">Tất cả trạng thái</option>
                                                <option value="present">Có mặt</option>
                                                <option value="absent_perm">Vắng có phép</option>
                                                <option value="absent">Vắng không phép</option>
                                            </select>
                                            <input type="text" id="filter_history_name" class="form-control form-control-sm m-1" style="width: auto;" placeholder="Tên học sinh..." onkeyup="filterHistory()">
                                            <input type="date" id="filter_from" class="form-control form-control-sm m-1" style="width: auto;" title="Từ ngày" onchange="filterHistory()">
                                            <input type="date" id="filter_to" class="form-control form-control-sm m-1" style="width: auto;" title="Đến ngày" onchange="filterHistory()">
                                            <button class="btn btn-sm btn-secondary m-1" onclick="resetFilter()" title="Xóa lọc"><i class="fas fa-undo"></i></button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0 table-responsive history-card-body">
                                        <table class="table table-head-fixed table-hover table-history text-nowrap">
                                            <thead>
                                                <tr>
                                                    <th>Thời gian</th>
                                                    <th>Học sinh</th>
                                                    <th class="d-none d-md-table-cell">Nhóm</th>
                                                    <th>Trạng thái</th>
                                                    <th class="d-none d-md-table-cell">Người thực hiện</th>
                                                </tr>
                                            </thead>
                                            <tbody id="historyAttendanceData">
                                                <!-- Data loaded by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-students-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Quản lý Dữ liệu Học sinh</h1>
                        <div>
                            <button class="btn btn-danger" onclick="exportPdfStudents()"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                            <button class="btn btn-default ml-2" onclick="printStudents()"><i class="fas fa-print"></i> In</button>
                            <button class="btn btn-info ml-2" onclick="openImportModal('admin')"><i class="fas fa-file-import"></i> Nhập từ Excel</button>
                            <button class="btn btn-success ml-2" onclick="openStudentModal()"><i class="fas fa-plus"></i> Thêm Học Sinh</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <ul class="nav nav-tabs mb-3" role="tablist">
                            <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#subtab-official">Học sinh Chính thức</a></li>
                            <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#subtab-pending" onclick="loadRegistrations()">Đăng ký Chờ duyệt</a></li>
                        </ul>
                        
                        <div class="tab-content">
                        <!-- Subtab Official -->
                        <div class="tab-pane fade show active" id="subtab-official">
                        <div class="row">
                            <div class="col-md-6"><div class="card" data-save-key="adm_st_group"><div class="card-header py-1"><h3 class="card-title">Học sinh theo Nhóm</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartStGroup"></canvas></div></div></div></div>
                            <div class="col-md-6"><div class="card" data-save-key="adm_st_school"><div class="card-header py-1"><h3 class="card-title">Học sinh theo Trường</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartStSchool"></canvas></div></div></div></div>
                        </div>
                        <div class="card card-outline card-info shadow mb-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-filter mr-2"></i>Bộ lọc tìm kiếm</h3></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" id="st_filter_name" class="form-control" placeholder="Họ tên..." onkeyup="filterStudents()">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="st_filter_group" class="form-control" onchange="filterStudents()"><option value="">-- Tất cả Nhóm --</option></select>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <select id="st_filter_school" class="form-control" onchange="filterStudents()"><option value="">-- Tất cả Trường --</option></select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" id="st_filter_from" class="form-control" title="Ngày thêm (Từ)" onchange="filterStudents()">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <input type="date" id="st_filter_to" class="form-control" title="Ngày thêm (Đến)" onchange="filterStudents()">
                                    </div>
                                    <div class="col-12 text-right">
                                        <button class="btn btn-secondary" onclick="resetStudentFilter()"><i class="fas fa-undo mr-2"></i>Đặt lại</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="studentTable" class="table table-striped table-bordered w-100">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Họ tên</th>
                                            <th>Giới tính</th>
                                            <th class="d-none d-md-table-cell">Ngày sinh</th>
                                            <th>Lớp</th>
                                            <th class="d-none d-md-table-cell">Nhóm</th>
                                            <th class="d-none d-md-table-cell">Trường học</th>
                                            <th class="d-none d-md-table-cell">SĐT học sinh</th>
                                            <th class="d-none d-md-table-cell">Địa chỉ</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Subtab Pending -->
                        <div class="tab-pane fade" id="subtab-pending">
                            <div class="card shadow">
                                <div class="card-header bg-warning"><h3 class="card-title">Danh sách đăng ký tạm (Chưa vào nhóm)</h3></div>
                                <div class="card-body table-responsive">
                                    <table id="regTable" class="table table-bordered w-100">
                                        <thead>
                                            <tr>
                                                <th>ID Tạm</th>
                                                <th>Mật khẩu</th>
                                                <th>Họ tên</th>
                                                <th class="d-none d-md-table-cell">Lớp</th>
                                                <th class="d-none d-md-table-cell">Trường</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="regData"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-managers-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh sách tài khoản quản lý</h1>
                        <div>
                            <button class="btn btn-danger" onclick="exportPdfManagers()"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                            <button class="btn btn-warning ml-2" onclick="showVipConfigHelp()"><i class="fas fa-crown"></i> Cấu hình Vinh danh</button>
                            <button class="btn btn-success ml-2" onclick="openUserModal()"><i class="fas fa-plus"></i> Thêm Tài Khoản</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-md-6"><div class="card" data-save-key="adm_mgr_role"><div class="card-header py-1"><h3 class="card-title">Phân quyền</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartMgrRole"></canvas></div></div></div></div>
                            <div class="col-md-6"><div class="card" data-save-key="adm_mgr_group"><div class="card-header py-1"><h3 class="card-title">Phụ trách Nhóm</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartMgrGroup"></canvas></div></div></div></div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="managerTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-primary text-white">
                                        <tr>
                                            <th>Avatar</th>
                                            <th>Username</th>
                                            <th class="d-none d-md-table-cell">Họ tên Quản lý</th>
                                            <th class="d-none d-md-table-cell">Nhóm phụ trách</th>
                                            <th>Quyền hạn</th>
                                            <th class="d-none d-md-table-cell">Email</th>
                                            <th class="d-none d-md-table-cell">SĐT</th>
                                            <th class="d-none d-md-table-cell">Lần đăng nhập cuối</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="managerData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-groups-list">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh sách các nhóm sinh hoạt</h1>
                        <div>
                            <button class="btn btn-danger" onclick="exportPdfGroups()"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                            <button class="btn btn-success ml-2" onclick="openGroupModal()"><i class="fas fa-plus"></i> Thêm Nhóm</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row" id="groupCardsContainer"></div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-upload">
                <section class="content-header">
                    <div class="container-fluid">
                        <h1>Quản lý trình duyệt file</h1>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="card shadow">
                            <div class="card-header bg-primary"><h3 class="card-title"><i class="fas fa-cloud-download-alt mr-2"></i>Quản lý Tài nguyên & Tệp tin</h3></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <p class="mb-0 text-muted"><i class="fas fa-info-circle mr-1"></i>Danh sách file từ Quản lý và Admin.</p>
                                    <button class="btn btn-sm btn-success" onclick="loadUploadedFiles()"><i class="fas fa-sync mr-1"></i>Làm mới danh sách</button>
                                </div>
                                
                                <div class="form-group bg-light p-3 border rounded">
                                    <label class="text-info"><i class="fas fa-upload mr-2"></i>Admin Upload (Tài nguyên chung cho các nhóm)</label>
                                    <input type="file" id="file_upload_generic" class="form-control-file border p-2 bg-white">
                                    <button type="button" class="btn btn-info mt-2" onclick="uploadFileGeneric('admin')"><i class="fas fa-upload mr-2"></i>Tải lên ngay</button>
                                </div>

                                <div class="table-responsive mt-2" style="max-height: 500px;">
                                    <table class="table table-bordered table-hover">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="d-none d-md-table-cell">Thời gian</th>
                                                <th>Người gửi (Quản lý)</th>
                                                <th class="d-none d-md-table-cell">Nhóm</th>
                                                <th class="d-none d-md-table-cell">Loại</th>
                                                <th>Nội dung / Tên file</th>
                                                <th>Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="uploadedFilesList"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-notifications">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Thông báo chung hệ thống</h1>
                        <div>
                            <button class="btn btn-danger" onclick="exportPdfNotifications()"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                            <button class="btn btn-warning ml-2" onclick="openPollModal()"><i class="fas fa-poll"></i> Tạo Bình chọn</button>
                            <button class="btn btn-success ml-2" onclick="openNotiModal()"><i class="fas fa-paper-plane"></i> Tạo thông báo</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-md-6"><div class="card" data-save-key="adm_noti_type"><div class="card-header py-1"><h3 class="card-title">Loại Thông báo</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartNotiType"></canvas></div></div></div></div>
                            <div class="col-md-6"><div class="card" data-save-key="adm_noti_read"><div class="card-header py-1"><h3 class="card-title">Tương tác (Lượt xem)</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartNotiRead"></canvas></div></div></div></div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="notiTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-warning">
                                        <tr>
                                            <th class="d-none d-md-table-cell">ID</th>
                                            <th>Tiêu đề</th>
                                            <th class="d-none d-md-table-cell">Nội dung</th>
                                            <th>Thời gian diễn ra</th>
                                            <th class="d-none d-md-table-cell">Điểm danh sớm</th>
                                            <th class="d-none d-md-table-cell">Hình thức</th>
                                            <th class="d-none d-md-table-cell">Người đã xem</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="notiData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-feedbacks">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Danh sách Phản ánh & Kiến nghị</h1>
                        <div>
                            <button class="btn btn-danger" onclick="exportPdfFeedbacks()"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                            <button class="btn btn-primary ml-2" onclick="loadFeedbacks()"><i class="fas fa-sync"></i> Tải lại</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-md-6"><div class="card" data-save-key="adm_fb_status"><div class="card-header py-1"><h3 class="card-title">Trạng thái Phản hồi</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartFbStatus"></canvas></div></div></div></div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="feedbackTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-info">
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Người gửi</th>
                                            <th>Nội dung Phản ánh</th>
                                            <th class="d-none d-md-table-cell">Phản hồi của Admin</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody id="feedbackData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-evaluations">
                <section class="content-header">
                    <div class="container-fluid d-flex justify-content-between">
                        <h1>Tổng hợp Đánh giá & Xếp loại</h1>
                        <div>
                            <button class="btn btn-danger" onclick="exportPdfEvaluations()"><i class="fas fa-file-pdf"></i> Xuất PDF</button>
                            <button class="btn btn-warning ml-2" onclick="openEvalConfigModal()"><i class="fas fa-cogs"></i> Cấu hình</button>
                            <button class="btn btn-primary ml-2" onclick="loadEvaluations()"><i class="fas fa-sync"></i> Tải lại</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-12"><div class="card" data-save-key="adm_eval_class"><div class="card-header py-1"><h3 class="card-title">Thống kê Xếp loại</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div><div class="card-body p-2"><div class="chart-wrapper"><canvas id="chartEvalClass"></canvas></div></div></div></div>
                        </div>
                        <!-- Cấu hình đánh giá -->
                        <div class="card card-outline card-purple shadow mb-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-filter mr-2"></i>Bộ lọc Đánh giá</h3></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <input type="text" id="eval_filter_name" class="form-control" placeholder="Tên học sinh..." onkeyup="filterEvaluations()">
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_group" class="form-control" onchange="filterEvaluations()"><option value="">-- Tất cả Nhóm --</option></select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_status" class="form-control" onchange="filterEvaluations()">
                                            <option value="">-- Trạng thái --</option>
                                            <option value="evaluated">Đã đánh giá</option>
                                            <option value="not_evaluated">Chưa đánh giá</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <select id="eval_filter_class" class="form-control" onchange="filterEvaluations()">
                                            <option value="">-- Xếp loại --</option>
                                            <option value="Xuất sắc">Xuất sắc</option>
                                            <option value="Tốt">Tốt</option>
                                            <option value="Trung bình">Trung bình</option>
                                            <option value="Yếu">Yếu</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-2 text-right">
                                        <button class="btn btn-secondary" onclick="resetEvaluationFilter()"><i class="fas fa-undo"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="evalTable" class="table table-hover table-bordered w-100">
                                    <thead class="bg-purple text-white">
                                        <tr>
                                            <th>Học sinh</th>
                                            <th class="d-none d-md-table-cell">Nhóm</th>
                                            <th class="d-none d-md-table-cell">Ý thức kỷ luật</th>
                                            <th class="d-none d-md-table-cell">Mức độ tích cực</th>
                                            <th class="d-none d-md-table-cell">Hoạt động tình nguyện</th>
                                            <th>Xếp loại</th>
                                        </tr>
                                    </thead>
                                    <tbody id="evalData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="tab-pane fade" id="tab-system-logs">
                <section class="content-header">
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1>Nhật ký hoạt động (Logs)</h1>
                            <button class="btn btn-danger" onclick="exportPdfLogs()"><i class="fas fa-file-pdf mr-2"></i>Xuất PDF</button>
                        </div>
                    </div>
                </section>
                <section class="content">
                    <div class="container-fluid">
                        <div class="row mb-2">
                            <div class="col-md-3"><input type="text" id="log_filter_user" class="form-control form-control-sm" placeholder="Tìm theo User..." onkeyup="filterLogs()"></div>
                            <div class="col-md-3"><input type="text" id="log_filter_action" class="form-control form-control-sm" placeholder="Tìm theo Hành động..." onkeyup="filterLogs()"></div>
                            <div class="col-md-3"><input type="date" id="log_filter_date" class="form-control form-control-sm" onchange="filterLogs()"></div>
                        </div>
                        <div class="card shadow">
                            <div class="card-body table-responsive">
                                <table id="logTable" class="table table-sm table-striped w-100">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Tài khoản</th>
                                            <th>Hành động</th>
                                            <th class="d-none d-md-table-cell">Chi tiết</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logData">
                                        <!-- Data loaded by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        </div>
    </div>
    <footer class="main-footer text-center text-sm">
        <strong>Copyright &copy; 2025 Tổ công nghệ phường Phan Rang.</strong> All rights reserved.
    </footer>
</div>

<!-- Modal Student -->
<div class="modal fade" id="modalStudent" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title">Thông tin Học sinh</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="student_id_old">
                <div class="form-group"><label>Mã Học sinh (ID)</label><input type="text" id="st_id" class="form-control" placeholder="Nhập mã HS..."></div>
                <div class="form-group"><label>Họ và Tên</label><input type="text" id="st_name" class="form-control" placeholder="Nguyễn Văn A"></div>
                <div class="form-group"><label>Giới tính</label>
                    <select id="st_gender" class="form-control">
                        <option value="">-- Chọn --</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="form-group"><label>Ngày sinh</label><input type="text" id="st_dob" class="form-control" placeholder="dd/mm/yyyy"></div>
                <div class="form-group"><label>Lớp</label><input type="text" id="st_class" class="form-control"></div>
                <div class="form-group"><label>Địa chỉ</label><input type="text" id="st_address" class="form-control"></div>
                <div class="form-group"><label>Số điện thoại học sinh</label><input type="text" id="st_phone" class="form-control"></div>
                <div class="form-group"><label>Mã Nhóm</label><input type="text" id="st_group" class="form-control" placeholder="VD: 1, 2, 3..."></div>
                <div class="form-group">
                    <label>Trường học</label>
                    <select id="st_school_select" class="form-control" onchange="toggleOtherSchool('st_school_select', 'st_school_other_div')">
                        <!-- Options loaded by JS -->
                    </select>
                </div>
                <div class="form-group" id="st_school_other_div" style="display:none;">
                    <label>Tên trường khác</label>
                    <input type="text" id="st_school_other" class="form-control" placeholder="Nhập tên trường...">
                </div>
                <h6 class="text-info border-top pt-2 mt-2">Thông tin đăng ký</h6>
                <div class="form-group"><label>Thời gian</label><input type="text" id="st_reg_time" class="form-control"></div>
                <div class="form-group"><label>Địa điểm</label><input type="text" id="st_reg_loc" class="form-control"></div>
                <div class="form-group"><label>Hoạt động</label><textarea id="st_reg_act" class="form-control" rows="2"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('students')">Lưu dữ liệu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Students -->
<div class="modal fade" id="modalImport" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-file-import mr-2"></i>Nhập danh sách học sinh từ Excel</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Vui lòng sử dụng file Excel theo đúng định dạng mẫu. Hệ thống sẽ tự động bỏ qua các học sinh đã tồn tại (trùng Tên và Nhóm).</p>
                <div class="form-group">
                    <label>1. Tải file mẫu</label><br>
                    <button class="btn btn-success" id="btnDownloadTemplate"><i class="fas fa-download mr-2"></i>Tải mẫu Excel</button>
                </div>
                <div class="form-group">
                    <label>2. Chọn file Excel của bạn</label>
                    <input type="file" id="file_import" class="form-control-file border p-2" accept=".xlsx, .xls">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-info" id="btnProcessImport">Bắt đầu Nhập</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal User -->
<div class="modal fade" id="modalUser" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title">Thông tin Tài khoản</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user_id_old">
                <div class="form-group"><label>Tên đăng nhập</label><input type="text" id="u_name" class="form-control"></div>
                <div class="form-group" id="pass_area"><label>Mật khẩu</label><input type="text" id="u_pass" class="form-control"></div>
                <div class="form-group"><label>Họ tên hiển thị</label><input type="text" id="u_fullname" class="form-control"></div>
                <div class="form-group"><label>Phân quyền</label>
                    <select id="u_role" class="form-control">
                        <option value="manager">Quản lý (Manager)</option>
                        <option value="supervisor">Cấp quản lý (Supervisor)</option>
                        <option value="admin">Quản trị (Admin)</option>
                    </select>
                </div>
                <div class="form-group"><label>Nhóm phụ trách</label><input type="text" id="u_group" class="form-control" placeholder="Để trống nếu là Admin"></div>
                <div class="form-group"><label>Email</label><input type="email" id="u_email" class="form-control" placeholder="example@email.com"></div>
                <div class="form-group"><label>Số điện thoại</label><input type="text" id="u_phone" class="form-control"></div>
                <div class="form-group"><label>Link Avatar</label><input type="text" id="u_avatar" class="form-control"></div>
                
                <hr>
                <h6 class="text-warning font-weight-bold"><i class="fas fa-crown mr-2"></i>Hệ thống Vinh danh (VIP)</h6>
                <div class="form-group">
                    <label>Cấp độ VIP</label>
                    <select id="u_vip_level" class="form-control">
                        <option value="">-- Không --</option>
                        <option value="vip1">VIP 1 (Khung Bạc)</option>
                        <option value="vip2">VIP 2 (Khung Vàng + Vương miện)</option>
                        <option value="vip3">VIP 3 (Khung Kim Cương + Hiệu ứng)</option>
                        <option value="vip4">VIP 4 (Bạch Kim - Supervisor)</option>
                        <option value="vip5">VIP 5 (Hoàng Kim - Supervisor)</option>
                        <option value="vip10">VIP 10 (Cấp Quản Lý Xịn Sò)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Danh hiệu (Chọn nhiều)</label>
                    <div class="d-flex flex-wrap" id="u_honors_container">
                        <!-- Checkboxes generated by JS -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('users')">Lưu tài khoản</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Group -->
<div class="modal fade" id="modalGroup" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title">Thông tin Nhóm</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="group_id_old">
                <div class="form-group"><label>Mã Nhóm</label><input type="text" id="g_id" class="form-control"></div>
                <div class="form-group"><label>Tên Nhóm</label><input type="text" id="g_name" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('groups')">Lưu nhóm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNoti" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title font-weight-bold">Thông tin thông báo</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="noti_id_old">
                <div class="form-group"><label>Mã TB (ID)</label><input type="text" id="n_id" class="form-control" placeholder="NOTI01..."></div>
                <div class="form-group"><label>Tiêu đề</label><input type="text" id="n_title" class="form-control"></div>
                <div class="form-group"><label>Nội dung</label><textarea id="n_content" class="form-control" rows="3"></textarea></div>
                <div class="form-group"><label>Thời gian sinh hoạt</label><input type="datetime-local" id="n_datetime" class="form-control"></div>
                <div class="form-group"><label>Link liên kết (Tùy chọn)</label><input type="text" id="n_link" class="form-control" placeholder="https://..."></div>
                <div class="form-group">
                    <label>Gửi tới (Đối tượng)</label>
                    <select id="n_target_group" class="form-control"><option value="ALL">Tất cả mọi người</option></select>
                </div>
                <div class="form-group"><button class="btn btn-sm btn-info" onclick="previewNotification()"><i class="fas fa-eye mr-1"></i>Xem trước hiển thị</button></div>
                <div class="form-group"><label>Cho phép điểm danh sớm?</label>
                    <select id="n_early" class="form-control">
                        <option value="TRUE">Cho phép (Mở mọi lúc)</option>
                        <option value="FALSE">Không (Chỉ mở khi đến giờ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Hình thức thông báo</label>
                    <select id="n_type" class="form-control" onchange="toggleLocationInput()">
                        <option value="normal">Thông báo thường</option>
                        <option value="online">Họp Online (Google Meet/Zoom)</option>
                        <option value="offline">Họp Trực tiếp (Tại địa điểm)</option>
                    </select>
                </div>
                <div class="form-group d-none" id="grp_location"><label id="lbl_location">Địa điểm / Link họp</label><input type="text" id="n_location" class="form-control"></div>
                <div class="form-group">
                    <label>Đính kèm tệp tin</label>
                    <input type="file" id="n_file" class="form-control-file border p-1">
                    <small class="text-muted">Giới hạn: Word/PDF < 50MB, File khác < 100MB</small>
                    <input type="hidden" id="n_attachment_base64">
                    <input type="hidden" id="n_file_name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveData('notifications')">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Create Poll -->
<div class="modal fade" id="modalPoll" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-poll mr-2"></i>Tạo Bình chọn Mới</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>Câu hỏi / Chủ đề</label><input type="text" id="poll_question" class="form-control" placeholder="VD: Chọn trò chơi sinh hoạt..."></div>
                <div class="form-group"><label>Các lựa chọn (Ngăn cách bằng dấu phẩy)</label><textarea id="poll_options" class="form-control" rows="3" placeholder="Kéo co, Nhảy bao bố, Đố vui..."></textarea></div>
                <div class="form-group"><label>Hạn chót bình chọn</label><input type="datetime-local" id="poll_deadline" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="createPoll()">Phát hành Bình chọn</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Poll Results Detail -->
<div class="modal fade" id="modalPollDetail" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title"><i class="fas fa-chart-pie mr-2"></i>Kết quả Bình chọn Chi tiết</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6"><h5 id="pollDetailTitle" class="font-weight-bold text-primary"></h5></div>
                    <div class="col-md-6"><input type="text" id="pollSearch" class="form-control" placeholder="🔍 Tìm tên học sinh hoặc lựa chọn..." onkeyup="filterPollResults()"></div>
                </div>
                <ul class="nav nav-tabs" id="pollGroupTabs" role="tablist"></ul>
                <div class="tab-content border border-top-0 p-3 poll-tab-content" id="pollGroupContent"></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button></div>
        </div>
    </div>
</div>

<!-- Modal Reply Feedback -->
<div class="modal fade" id="modalReply" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title">Phản hồi Góp ý</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reply_id">
                <div class="form-group"><label>Nội dung phản hồi:</label><textarea id="reply_content" class="form-control" rows="4"></textarea></div>
                <div class="form-group"><label>Người trả lời:</label><input type="text" id="reply_responder" class="form-control"></div>
                <div class="form-group"><label>SĐT liên hệ (nếu thắc mắc):</label><input type="text" id="reply_phone" class="form-control" placeholder="Nhập SĐT..."></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="submitReply()">Gửi phản hồi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Settings -->
<div class="modal fade" id="modalSettings" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-cogs mr-2"></i>Cài đặt hệ thống</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                <ul class="nav nav-tabs mb-3 flex-nowrap" id="settingTabs" role="tablist" style="overflow-x: auto;">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#tab-interface">Giao diện</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-troll">Thông báo Khẩn</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-features">Tính năng & Chữ chạy</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#tab-backup">Dữ liệu & Sao lưu</a></li>
                </ul>
                <div class="tab-content">
                    <!-- Tab Giao diện -->
                    <div class="tab-pane fade show active" id="tab-interface">
                        <div class="form-group d-flex justify-content-between align-items-center">
                            <label class="mb-0">Chế độ Tối (Dark Mode)</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="darkModeSwitch" onchange="toggleDarkMode()">
                                <label class="custom-control-label" for="darkModeSwitch"></label>
                            </div>
                        </div>
                        
                        <!-- Cấu hình Bảo trì Nâng cao -->
                        <div class="card card-danger card-outline mt-3 shadow-sm">
                            <div class="card-header"><h6 class="card-title font-weight-bold mb-0"><i class="fas fa-tools mr-2"></i>Cấu hình Bảo trì Hệ thống</h6></div>
                            <div class="card-body">
                                <div class="form-group d-flex justify-content-between align-items-center border-bottom pb-3">
                                    <div><label class="mb-0 text-danger">Bảo trì Thủ công (Ngay lập tức)</label><br><small class="text-muted">Gạt nút để bật bảo trì ngay, bất kể lịch trình.</small></div>
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="maintenanceSwitch" onchange="toggleMaintenance()">
                                        <label class="custom-control-label" for="maintenanceSwitch"></label>
                                    </div>
                                </div>
                                <label class="mt-2 text-primary"><i class="fas fa-calendar-alt mr-2"></i>Lên lịch Bảo trì Tự động</label>
                                <div class="row">
                                    <div class="col-6"><div class="form-group"><label class="small text-muted">Bắt đầu</label><input type="datetime-local" id="maint_start_input" class="form-control form-control-sm"></div></div>
                                    <div class="col-6"><div class="form-group"><label class="small text-muted">Kết thúc (Reset)</label><input type="datetime-local" id="maint_end_input" class="form-control form-control-sm"></div></div>
                                </div>
                                <button class="btn btn-sm btn-primary btn-block" onclick="saveMaintenanceSchedule()"><i class="fas fa-save mr-2"></i>Lưu Lịch Bảo Trì</button>
                            </div>
                        </div>
                        
                        <p class="text-muted small">Chuyển đổi giao diện sáng/tối để dễ nhìn hơn.</p>
                    </div>
                    <!-- Tab Thông báo Khẩn -->
                    <div class="tab-pane fade" id="tab-troll">
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <label class="mb-0 text-danger font-weight-bold">Kích hoạt Thông báo Khẩn</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="troll_enabled">
                                <label class="custom-control-label" for="troll_enabled"></label>
                            </div>
                        </div>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded mt-2">
                            <label class="mb-0 text-primary"><i class="fas fa-mobile-alt mr-2"></i>Hiển thị dạng Thông báo điện thoại (Banner)</label>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="troll_mode">
                                <label class="custom-control-label" for="troll_mode"></label>
                            </div>
                        </div>
                        <div class="form-group"><label>Tiêu đề Thông báo</label><input type="text" id="troll_title" class="form-control" placeholder="VD: THÔNG BÁO KHẨN..."></div>
                        <div class="form-group"><label>Nội dung</label><textarea id="troll_content" class="form-control" rows="3" placeholder="Nội dung hiển thị..."></textarea></div>
                        <div class="form-group"><label>Link liên kết (Nút bấm)</label><input type="text" id="troll_link" class="form-control" placeholder="https://..."></div>
                        <div class="form-group"><label>Link YouTube (Tùy chọn)</label><input type="text" id="troll_youtube" class="form-control" placeholder="https://youtu.be/..."></div>
                        <div class="form-group">
                            <label>File đính kèm (Ảnh/Word/Excel/Zip...)</label>
                            <input type="file" id="troll_file" class="form-control-file border p-1">
                            <small class="text-muted">Giới hạn: Word/PDF < 50MB, File khác < 100MB</small>
                            <input type="hidden" id="troll_image_base64">
                            <input type="hidden" id="troll_file_name">
                        </div>
                        <div class="d-flex">
                            <button class="btn btn-secondary flex-grow-1 mr-2" onclick="resetPushNotification()"><i class="fas fa-undo mr-2"></i>Reset & Tắt</button>
                            <button class="btn btn-primary flex-grow-1" onclick="saveTrollConfig()"><i class="fas fa-save mr-2"></i>Lưu Cấu hình</button>
                        </div>
                    </div>
                    <!-- Tab Tính năng & Chữ chạy -->
                    <div class="tab-pane fade" id="tab-features">
                        <h6 class="text-primary font-weight-bold"><i class="fas fa-scroll mr-2"></i>Cấu hình Chữ chạy (Marquee)</h6>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded">
                            <label class="mb-0">Bật chữ chạy</label>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_marquee_enabled"><label class="custom-control-label" for="conf_marquee_enabled"></label></div>
                        </div>
                        <div class="form-group"><label>Nội dung hiển thị</label><input type="text" id="conf_marquee_text" class="form-control" placeholder="VD: Chúc mừng năm mới..."></div>
                        <div class="form-group mt-2">
                            <label><i class="fas fa-palette mr-2"></i>Màu nền Chữ chạy (Marquee)</label>
                            <input type="text" id="conf_theme_color" class="form-control" placeholder="VD: #ff0000 hoặc linear-gradient(...)">
                        </div>
                        <div class="form-group"><label>Chiều chạy chữ</label>
                            <select id="conf_marquee_direction" class="form-control">
                                <option value="right">Từ Trái sang Phải (Mặc định)</option>
                                <option value="left">Từ Phải sang Trái</option>
                            </select>
                        </div>
                        <hr>
                        <h6 class="text-danger font-weight-bold"><i class="fas fa-tools mr-2"></i>Bảo trì từng tính năng (Manager)</h6>
                        <p class="small text-muted">Bật switch để ĐÓNG (Bảo trì) tính năng đó.</p>
                        <div class="row">
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_attendance"><label class="custom-control-label" for="maint_attendance">Điểm danh</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_students"><label class="custom-control-label" for="maint_students">DS Học sinh</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_funds"><label class="custom-control-label" for="maint_funds">Quỹ nhóm</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_notis"><label class="custom-control-label" for="maint_notis">Thông báo</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_eval"><label class="custom-control-label" for="maint_eval">Đánh giá</label></div></div>
                            <div class="col-6"><div class="custom-control custom-switch mb-2"><input type="checkbox" class="custom-control-input" id="maint_feedback"><label class="custom-control-label" for="maint_feedback">Phản ánh kiến nghị</label></div></div>
                        </div>
                        <hr>
                        <h6 class="text-success font-weight-bold"><i class="fas fa-clock mr-2"></i>Cấu hình Giờ Điểm danh Tự động</h6>
                        <div class="row">
                            <div class="col-6"><label>Giờ mở (HH:MM)</label><input type="time" id="conf_att_start" class="form-control"></div>
                            <div class="col-6"><label>Giờ đóng (HH:MM)</label><input type="time" id="conf_att_end" class="form-control"></div>
                        </div>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded mt-2 border">
                            <div><label class="mb-0 text-danger">CHẶN ĐIỂM DANH (Thủ công)</label><br><small class="text-muted">Khóa toàn bộ điểm danh, bất kể giờ giấc.</small></div>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_att_blocked"><label class="custom-control-label" for="conf_att_blocked"></label></div>
                        </div>
                        <div class="form-group d-flex justify-content-between align-items-center bg-light p-2 rounded mt-1 border">
                            <div><label class="mb-0 text-success">Ưu tiên mở theo Thông báo</label><br><small class="text-muted">Nếu có thông báo họp/SH, tự động mở khóa vào giờ đó (dù đang Chặn).</small></div>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_noti_override"><label class="custom-control-label" for="conf_noti_override"></label></div>
                        </div>
                        <small class="text-muted">Ngoài khung giờ này, hệ thống sẽ khóa điểm danh (trừ khi có thông báo cho phép sớm).</small>
                        
                        <hr>
                        <h6 class="text-warning font-weight-bold"><i class="fas fa-user-lock mr-2"></i>Khóa nhập liệu Học sinh</h6>
                        <div class="form-group d-flex justify-content-between align-items-center">
                            <label class="mb-0">Khóa nhập/thêm học sinh mới</label>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="conf_student_import_locked"><label class="custom-control-label" for="conf_student_import_locked"></label></div>
                        </div>
                        <div class="form-group"><label>Hạn chót nhập liệu (Tự động khóa sau ngày này)</label><input type="date" id="conf_student_import_deadline" class="form-control"></div>

                        <div class="form-group mt-2 border-top pt-2">
                            <label>Giới hạn dung lượng file Upload (MB)</label>
                            <input type="number" id="conf_max_upload_size" class="form-control" placeholder="Mặc định: 200" value="200">
                        </div>
                        <button class="btn btn-primary btn-block mt-3" onclick="saveFeatureConfig()"><i class="fas fa-save mr-2"></i>Lưu Cấu hình Tính năng</button>
                    </div>
                    <!-- Tab Backup/Restore -->
                    <div class="tab-pane fade" id="tab-backup">
                        <div class="alert alert-info"><i class="fas fa-shield-alt mr-2"></i>Khu vực yêu cầu xác thực an toàn.</div>
                        
                        <div class="card card-warning card-outline">
                            <div class="card-header"><h6 class="card-title font-weight-bold">Sao lưu dữ liệu (Backup)</h6></div>
                            <div class="card-body">
                                <p class="small">Tải xuống toàn bộ dữ liệu hệ thống dưới dạng file Excel.</p>
                                <div class="d-flex align-items-center mb-2"><span id="captcha_code_backup" class="bg-light border px-2 py-1 font-weight-bold mr-2" style="letter-spacing: 2px;"></span><button class="btn btn-xs btn-outline-secondary" onclick="generateCaptcha('captcha_code_backup')"><i class="fas fa-sync"></i></button></div>
                                <input type="text" id="captcha_input_backup" class="form-control mb-2" placeholder="Nhập mã xác nhận trên">
                                <button class="btn btn-warning btn-block" onclick="backupSystem()"><i class="fas fa-download mr-2"></i>Tải file Backup</button>
                            </div>
                        </div>

                        <div class="card card-danger card-outline">
                            <div class="card-header"><h6 class="card-title font-weight-bold">Phục hồi dữ liệu (Restore)</h6></div>
                            <div class="card-body">
                                <p class="small text-danger font-weight-bold">CẢNH BÁO: Dữ liệu hiện tại sẽ bị xóa và thay thế!</p>
                                <div class="form-group">
                                    <label>Chọn file Backup (.xlsx)</label>
                                    <input type="file" id="file_restore" class="form-control-file border p-1" accept=".xlsx">
                                </div>
                                <div class="d-flex align-items-center mb-2"><span id="captcha_code_restore" class="bg-light border px-2 py-1 font-weight-bold mr-2" style="letter-spacing: 2px;"></span><button class="btn btn-xs btn-outline-secondary" onclick="generateCaptcha('captcha_code_restore')"><i class="fas fa-sync"></i></button></div>
                                <input type="text" id="captcha_input_restore" class="form-control mb-2" placeholder="Nhập mã xác nhận trên">
                                <button class="btn btn-danger btn-block" onclick="processRestore()"><i class="fas fa-upload mr-2"></i>Tiến hành Phục hồi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Charts -->
<div class="modal fade" id="modalCharts" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content border-0">
            <div class="modal-header border-bottom-0 pb-0">
                <h4 class="modal-title font-weight-bold text-dark" id="chartModalTitle">Thống kê chi tiết</h4>
                <div class="d-flex align-items-center ml-auto">
                    <div id="chartFilterContainer" class="mr-2" style="display:none;">
                        <select id="chartGroupFilter" class="form-control form-control-sm" onchange="updateModalCharts()">
                            <option value="">-- Tất cả Nhóm --</option>
                        </select>
                    </div>
                    <button type="button" class="close ml-2" data-dismiss="modal"><span>&times;</span></button>
                </div>
            </div>
            <div class="modal-body pt-2">
                <div class="text-center mb-4" id="modalTotalDisplay"></div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card shadow-none border"><div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom-0"><h3 class="card-title font-weight-bold text-secondary" id="chartTitle1">Phân bố</h3><button class="btn btn-xs btn-light" onclick="downloadChartImage('modalChart1', 'Bieu_do_phan_bo.png')"><i class="fas fa-download"></i></button></div><div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="modalChart1"></canvas></div></div></div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-none border"><div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom-0"><h3 class="card-title font-weight-bold text-secondary" id="chartTitle2">Biến động</h3><button class="btn btn-xs btn-light" onclick="downloadChartImage('modalChart2', 'Bieu_do_bien_dong.png')"><i class="fas fa-download"></i></button></div><div class="card-body"><div class="chart-container" style="height: 300px;"><canvas id="modalChart2"></canvas></div></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Eval Config -->
<div class="modal fade" id="modalEvalConfig" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-cogs mr-2"></i>Cấu hình Đợt đánh giá</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Trạng thái đánh giá</label>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="conf_eval_enabled">
                        <label class="custom-control-label font-weight-bold" for="conf_eval_enabled">Cho phép đánh giá</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Hạn chót (Deadline)</label>
                    <input type="date" id="conf_eval_deadline" class="form-control">
                </div>
                <hr>
                <div class="form-group">
                    <label class="text-danger font-weight-bold">Khu vực nguy hiểm</label>
                    <button class="btn btn-warning btn-block font-weight-bold" onclick="resetEvaluations()">
                        <i class="fas fa-redo-alt mr-2"></i>Reset Đợt Mới (Xóa hết đánh giá)
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger" onclick="saveEvalConfig()">Lưu cấu hình</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="modalUploadProgress" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-cloud-upload-alt mr-2"></i>Tiến trình tải lên</h5>
            </div>
            <div class="modal-body text-center p-4">
                <h5 class="font-weight-bold mb-3 text-truncate" id="uploadFileName">Filename</h5>
                <div class="progress mb-2" style="height: 25px; border-radius: 15px;">
                    <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                </div>
                <p class="text-muted mb-0" id="uploadProgressText">Đang chuẩn bị...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";
let globalHistoryData = [], globalStudentsData = [], globalUsersData = [], globalGroupsData = [], globalNotisData = [], globalLogsData = [];
let chartEval, chartStGroup, chartStTrend;
let modalChart1, modalChart2, currentChartCategory = '';
let currentHistoryView = []; // Dữ liệu lịch sử đang hiển thị (đã lọc)
let currentStudentView = []; // Dữ liệu học sinh đang hiển thị
let currentEvaluationView = []; // Dữ liệu đánh giá đang hiển thị
let globalMaxUploadSize = 200; // Default 200MB

function getLoadingRowHtml(colspan) {
    return `<tr><td colspan="${colspan}" class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Đang tải dữ liệu...</p></td></tr>`;
}

function getErrorRowHtml(colspan, message = "Không thể tải dữ liệu.") {
    return `<tr><td colspan="${colspan}" class="text-center text-danger p-5"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></td></tr>`;
}

function generateCaptcha(elementId) {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < 5; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById(elementId).innerText = result;
}

$(document).ready(function() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    if(user) $('#adminNameDisplay').text(user.fullname);
    
    // Load Dark Mode setting
    if (localStorage.getItem('darkMode') === 'true') {
        $('body').addClass('dark-mode');
    }
    generateCaptcha('captcha_code_backup');
    generateCaptcha('captcha_code_restore');
    refreshAll();
    showMainMenu(); // Ensure main menu is shown on load
    initCardCollapseState();
});

// Helper: Render Chart
let charts = {};
function renderChart(id, type, labels, data, label, colors) {
    const ctx = document.getElementById(id);
    if(!ctx) return;
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{ label: label, data: data, backgroundColor: colors || ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#fd7e14', '#e83e8c'], borderWidth: 1 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
    });
}


async function refreshAll() {
    // Tối ưu load dữ liệu song song (Parallel)
    const p1 = loadStudents();
    const p2 = updateAttendanceStats();
    const p3 = loadExtraData();
    const p4 = loadLogs();
    const p5 = loadFeedbacks();
    const p6 = loadEvaluations();
    const p7 = loadEvalConfig(); // Load config (Eval + Troll + Features)
    const p8 = loadUploadedFiles();

    await Promise.all([p1, p2, p3, p4, p5, p6, p7, p8]);
    
    renderDashboardStats();
    toastr.success("Dữ liệu đã được cập nhật!");
}

// --- NAVIGATION FUNCTIONS ---
function showTab(tabId) {
    $('#main-menu-section').hide();
    $('#functional-section').fadeIn();
    $('.tab-pane').removeClass('show active');
    $('#' + tabId).addClass('show active');
    window.scrollTo(0, 0);
}

function showMainMenu() {
    $('#functional-section').hide();
    $('#main-menu-section').fadeIn();
}

async function loadStudents() {
    $('#studentData').html(getLoadingRowHtml(7));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_USERS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalStudentsData = res.data.students;
            $('#countHS').text(res.data.totalStudents);
            
            // Populate Filters
            populateStudentFilters();
            
            // Render Table
            currentStudentView = globalStudentsData;
            renderStudentTable(currentStudentView);

            // Render Charts
            const groupCounts = {};
            const schoolCounts = {};
            globalStudentsData.forEach(s => { groupCounts[s.group_display] = (groupCounts[s.group_display]||0)+1; schoolCounts[s.school] = (schoolCounts[s.school]||0)+1; });
            
            renderChart('chartStGroup', 'pie', Object.keys(groupCounts), Object.values(groupCounts), 'Học sinh');
            renderChart('chartStSchool', 'bar', Object.keys(schoolCounts), Object.values(schoolCounts), 'Học sinh');
        }
    } catch (e) { 
        toastr.error("Lỗi tải danh sách học sinh."); 
        $('#studentData').html(getErrorRowHtml(7));
    }
}

function populateStudentFilters() {
    const groups = [...new Set(globalStudentsData.map(s => s.group_display))].sort();
    const schools = [...new Set(globalStudentsData.map(s => s.school).filter(s => s))].sort();
    
    let gHtml = '<option value="">-- Tất cả Nhóm --</option>';
    groups.forEach(g => gHtml += `<option value="${g}">${g}</option>`);
    $('#st_filter_group').html(gHtml);

    let sHtml = '<option value="">-- Tất cả Trường --</option>';
    schools.forEach(s => sHtml += `<option value="${s}">${s}</option>`);
    $('#st_filter_school').html(sHtml);
}

function renderStudentTable(data) {
    let html = '';
    data.forEach((st, index) => {
        html += `<tr>
            <td class="font-weight-bold">${st.fullname}</td>
            <td>${st.gender || ''}</td>
            <td class="text-dob d-none d-md-table-cell">${st.dob}</td>
            <td>${st.class_name || '-'}</td>
            <td class="d-none d-md-table-cell"><span class="badge badge-info badge-group">${st.group_display}</span></td>
            <td class="d-none d-md-table-cell"><small>${st.school}</small></td>
            <td class="d-none d-md-table-cell"><a href="tel:${st.phone}">${st.phone || '-'}</a></td>
            <td class="d-none d-md-table-cell"><small>${st.address || '-'}</small></td>
            <td>
                <button class="btn btn-info btn-action" onclick="editStudent('${st.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger btn-action" onclick="deleteData('students', '${st.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
    
    if ($.fn.DataTable.isDataTable('#studentTable')) {
        $('#studentTable').DataTable().destroy();
    }
    $('#studentData').html(html);
    $('#studentTable').DataTable({ 
        "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Tất cả"]]
    });
}

function filterStudents() {
    const name = $('#st_filter_name').val().toLowerCase();
    const group = $('#st_filter_group').val();
    const school = $('#st_filter_school').val();
    const from = $('#st_filter_from').val();
    const to = $('#st_filter_to').val();

    let d1, d2;
    if (from) { d1 = new Date(from); d1.setHours(0,0,0,0); } // Start of day
    if (to) { d2 = new Date(to); d2.setHours(23,59,59,999); } // End of day

    currentStudentView = globalStudentsData.filter(st => {
        const matchName = !name || (st.fullname && st.fullname.toLowerCase().includes(name));
        const matchGroup = !group || (st.group_display && st.group_display === group);
        const matchSchool = !school || (st.school && st.school === school);
        
        let matchDate = true;
        if (d1 || d2) {
            // Extract timestamp from ID (ST + timestamp)
            const ts = parseInt(st.id.replace('ST', ''));
            if (!isNaN(ts)) {
                const dateAdded = new Date(ts);
                if (d1 && dateAdded.getTime() < d1.getTime()) matchDate = false;
                if (d2 && dateAdded.getTime() > d2.getTime()) matchDate = false;
            }
        }

        return matchName && matchGroup && matchSchool && matchDate;
    });

    renderStudentTable(currentStudentView);
    toastr.success(`Tìm thấy ${currentStudentView.length} học sinh`);
}

function resetStudentFilter() {
    $('#st_filter_name, #st_filter_group, #st_filter_school, #st_filter_from, #st_filter_to').val('');
    currentStudentView = globalStudentsData;
    renderStudentTable(currentStudentView);
}

async function loadRegistrations() {
    $('#regData').html(getLoadingRowHtml(6));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_REGISTRATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            res.data.forEach(r => {
                html += `<tr>
                    <td><code>${r.id}</code></td>
                    <td class="font-weight-bold text-danger">${r.pass}</td>
                    <td>${r.fullname}</td>
                    <td class="d-none d-md-table-cell">${r.class_name}</td>
                    <td class="d-none d-md-table-cell">${r.school}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="regeneratePass('${r.id}')"><i class="fas fa-sync mr-1"></i>Đổi Pass</button>
                    </td>
                </tr>`;
            });
            $('#regData').html(html || '<tr><td colspan="6" class="text-center">Không có đăng ký chờ duyệt.</td></tr>');
        }
    } catch (e) { $('#regData').html(getErrorRowHtml(6)); }
}

async function regeneratePass(id) {
    if(!confirm('Tạo lại mật khẩu ngẫu nhiên cho ID này?')) return;
    const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "REGENERATE_PASS", payload: { id } }) });
    const res = await response.json();
    if(res.status === 'success') { toastr.success('Mật khẩu mới: ' + res.new_pass); loadRegistrations(); }
}

async function loadExtraData() {
    $('#managerData').html(getLoadingRowHtml(8));
    $('#notiData').html(getLoadingRowHtml(8));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalUsersData = res.data.managers;
            globalGroupsData = res.data.groups;
            globalNotisData = res.data.notifications || [];
            
            // Managers Table
            let mHtml = '';
            res.data.managers.forEach((m, idx) => {
                let honorBadge = '';
                try {
                    const h = JSON.parse(m.honors || '{}');
                    if(h.level) honorBadge = `<span class="badge badge-warning ml-1">${h.level.toUpperCase()}</span>`;
                } catch(e){}
                
                let roleBadge = `<span class="badge badge-secondary">${m.role}</span>`;
                if (m.role === 'admin') roleBadge = `<span class="badge badge-danger">ADMIN</span>`;
                if (m.role === 'supervisor') roleBadge = `<span class="badge badge-primary">SUPERVISOR</span>`;

                mHtml += `<tr>
                    <td class="text-center"><img src="${m.avatar || 'https://via.placeholder.com/50'}" class="img-manager shadow-sm"></td>
                    <td><code>${m.username}</code></td>
                    <td class="font-weight-bold d-none d-md-table-cell">${m.fullname}</td>
                    <td class="d-none d-md-table-cell"><span class="badge badge-warning">${m.group_id}</span></td>
                    <td>${roleBadge}</td>
                    <td class="d-none d-md-table-cell"><small>${m.email || '-'}</small></td>
                    <td class="d-none d-md-table-cell"><small>${m.phone || '-'}</small></td>
                    <td class="d-none d-md-table-cell"><small>${m.last_login || '-'}</small></td>
                    <td>
                        <button class="btn btn-info btn-action" onclick="editUser('${m.username}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-warning btn-action" onclick="resetPassword('${m.username}')" title="Reset Pass"><i class="fas fa-key"></i></button>
                        <button class="btn btn-danger btn-action" onclick="deleteData('users', '${m.username}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            if ($.fn.DataTable.isDataTable('#managerTable')) {
                $('#managerTable').DataTable().destroy();
            }
            $('#managerData').html(mHtml);
            $('#managerTable').DataTable({ "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }});

            // Manager Charts
            const roleCounts = {};
            const mgrGroupCounts = {};
            res.data.managers.forEach(m => { roleCounts[m.role] = (roleCounts[m.role]||0)+1; mgrGroupCounts[m.group_id] = (mgrGroupCounts[m.group_id]||0)+1; });
            renderChart('chartMgrRole', 'doughnut', Object.keys(roleCounts), Object.values(roleCounts), 'Số lượng');
            renderChart('chartMgrGroup', 'bar', Object.keys(mgrGroupCounts), Object.values(mgrGroupCounts), 'Số lượng');
 
            // Groups View
            let gHtml = '';
            res.data.groups.forEach((g, idx) => {
                gHtml += `<div class="col-md-3">
                    <div class="info-box shadow-sm position-relative">
                        <span class="info-box-icon bg-info elevation-1"><i class="fas fa-layer-group"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text text-bold">${g.group_name}</span>
                            <span class="info-box-number">Mã: ${g.group_id}</span>
                        </div>
                        <div style="position:absolute; right:5px; top:5px;">
                             <button class="btn btn-xs btn-outline-info" onclick="editGroup(${idx})"><i class="fas fa-edit"></i></button>
                             <button class="btn btn-xs btn-outline-danger" onclick="deleteData('groups', '${g.group_id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            $('#groupCardsContainer').html(gHtml || '<div class="col-12 text-center">Không có dữ liệu nhóm</div>');

            // Notifications Table
            let nHtml = '';
            globalNotisData.forEach((n, idx) => {
                let readers = n.read_by || [];
                if (typeof readers === 'string') readers = readers.split(',').filter(x => x);
                let readersHtml = readers.length > 0
                    ? `<span class="badge badge-info">${readers.length}</span> <small class="d-block" style="max-height:60px;overflow-y:auto;">${readers.join(', ')}</small>` 
                    : '<small class="text-muted">Chưa có</small>';

                let typeBadge = '<span class="badge badge-secondary">Thường</span>';
                let pollActions = '';
                
                if (n.type === 'online') typeBadge = '<span class="badge badge-primary"><i class="fas fa-video mr-1"></i>Online</span>';
                if (n.type === 'offline') typeBadge = '<span class="badge badge-success"><i class="fas fa-map-marker-alt mr-1"></i>Trực tiếp</span>';
                if (n.type === 'poll') {
                    typeBadge = '<span class="badge badge-warning"><i class="fas fa-poll mr-1"></i>Bình chọn</span>';
                    pollActions = `
                        <div class="mt-1">
                            <button class="btn btn-xs btn-outline-primary" onclick="viewPollDetail('${n.id}', '${n.title}')" title="Xem chi tiết"><i class="fas fa-list-ol"></i></button>
                            <button class="btn btn-xs btn-outline-danger" onclick="exportPollPdf('${n.id}', '${n.title}')" title="Xuất PDF"><i class="fas fa-file-pdf"></i></button>
                        </div>`;
                }
                
                let locationInfo = n.location ? `<br><small class="text-muted">${n.type === 'online' ? 'Link: ' : 'ĐĐ: '}${n.location}</small>` : '';
                let attachIcon = n.attachment ? `<br><span class="badge badge-warning"><i class="fas fa-paperclip"></i> Có file</span>` : '';

                let targetInfo = (n.target_group && n.target_group !== 'ALL') 
                    ? `<br><span class="badge badge-info mt-1"><i class="fas fa-users mr-1"></i>Nhóm ${n.target_group}</span>` 
                    : `<br><span class="badge badge-light border mt-1">Tất cả</span>`;

                nHtml += `<tr>
                    <td class="d-none d-md-table-cell">${n.id}</td>
                    <td class="font-weight-bold">${n.title}</td>
                    <td class="d-none d-md-table-cell"><small>${n.content}</small></td>
                    <td><code>${n.datetime}</code></td>
                    <td class="d-none d-md-table-cell"><span class="badge badge-${n.early === 'TRUE' ? 'success' : 'secondary'}">${n.early}</span></td>
                    <td class="d-none d-md-table-cell">${typeBadge}${locationInfo}${attachIcon}${targetInfo}</td>
                    <td class="d-none d-md-table-cell">${readersHtml}${pollActions}</td>
                    <td>
                        <button class="btn btn-info btn-action" onclick="editNotification('${n.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-action" onclick="deleteData('notifications', '${n.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            $('#notiData').html(nHtml);

            // Notification Charts
            const notiTypes = {};
            let totalReads = 0;
            globalNotisData.forEach(n => { notiTypes[n.type] = (notiTypes[n.type]||0)+1; totalReads += (n.read_by && Array.isArray(n.read_by) ? n.read_by.length : 0); });
            renderChart('chartNotiType', 'pie', Object.keys(notiTypes), Object.values(notiTypes), 'Số lượng');
            renderChart('chartNotiRead', 'bar', ['Tổng lượt xem'], [totalReads], 'Lượt xem', ['#17a2b8']);
        }
    } catch (e) { 
        console.error("Error loading extra data", e); 
        $('#managerData').html(getErrorRowHtml(6));
        $('#notiData').html(getErrorRowHtml(8));
    }
}

async function loadLogs() {
    $('#logData').html(getLoadingRowHtml(4));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_LOGS" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalLogsData = res.data;
            filterLogs();
        }
    } catch (e) { console.log("Logs error"); $('#logData').html(getErrorRowHtml(4)); }
}

function filterLogs() {
    const user = $('#log_filter_user').val().toLowerCase();
    const action = $('#log_filter_action').val().toLowerCase();
    const date = $('#log_filter_date').val();

    const filtered = globalLogsData.filter(log => {
        const matchUser = !user || log.username.toLowerCase().includes(user);
        const matchAction = !action || log.action.toLowerCase().includes(action);
        const matchDate = !date || log.timestamp.startsWith(date.split('-').reverse().join('/')); // Convert YYYY-MM-DD to DD/MM/YYYY check
        return matchUser && matchAction && matchDate;
    });

    let html = '';
    filtered.forEach(log => {
        html += `<tr>
            <td><small>${log.timestamp}</small></td>
            <td><code>${log.username}</code></td>
            <td><span class="badge badge-light border">${log.action}</span></td>
            <td class="d-none d-md-table-cell"><small>${log.details}</small></td>
        </tr>`;
    });
    $('#logData').html(html || '<tr><td colspan="4" class="text-center">Không tìm thấy log phù hợp</td></tr>');
}

let globalFeedbacksData = [];
async function loadFeedbacks() {
    $('#feedbackData').html(getLoadingRowHtml(5));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_FEEDBACKS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            globalFeedbacksData = res.data || [];
            renderFeedbacks(globalFeedbacksData);
            
            // Feedback Chart
            const fbStatus = { 'Đã trả lời': 0, 'Chờ xử lý': 0 };
            globalFeedbacksData.forEach(f => { f.reply ? fbStatus['Đã trả lời']++ : fbStatus['Chờ xử lý']++; });
            renderChart('chartFbStatus', 'doughnut', Object.keys(fbStatus), Object.values(fbStatus), 'Số lượng', ['#28a745', '#ffc107']);
        }
    } catch (e) { console.error("Feedback error", e); $('#feedbackData').html(getErrorRowHtml(5)); }
}

function renderFeedbacks(data) {
    let html = '';
    if (data.length === 0) {
        html = '<tr><td colspan="5" class="text-center">Không có phản ánh nào.</td></tr>';
    } else {
        data.forEach(fb => {
            const contentAndAttachments = `
                <b>${fb.title || '(Không có tiêu đề)'}</b><br>
                <small>
                    <span class="text-danger">Nội dung:</span> ${fb.difficulty || 'Không'}<br>
                    <span class="text-info">Kiến nghị:</span> ${fb.suggestion || 'Không'}
                </small>
                <div class="mt-2">
                    ${fb.drive_link ? `<a href="${fb.drive_link}" target="_blank" class="btn btn-xs btn-info mb-1"><i class="fab fa-google-drive mr-1"></i>Link Drive</a> ` : ''}
                    ${fb.attachment ? `<a href="${fb.attachment}" download="${fb.attachment_name || 'file'}" class="btn btn-xs btn-secondary"><i class="fas fa-download mr-1"></i>Tải File</a>` : ''}
                </div>
            `;

            html += `<tr>
                <td><small>${fb.timestamp}</small></td>
                <td>
                    <b>${fb.fullname || 'Vô danh'}</b><br>
                    <small>SĐT: ${fb.phone}</small><br>
                    <span class="badge badge-secondary">Nhóm ${fb.group_id}</span>
                </td>
                <td>
                    ${contentAndAttachments}
                </td>
                <td class="d-none d-md-table-cell">
                    ${fb.reply ? `<div class="alert alert-light border">${fb.reply}</div>` : '<i class="text-muted">Chưa có phản hồi</i>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openReply('${fb.id}')"><i class="fas fa-reply"></i> Trả lời</button>
                </td>
            </tr>`;
        });
    }
    
    // Re-init DataTable if needed, or just rely on manual filter
    if ($.fn.DataTable.isDataTable('#feedbackTable')) {
        $('#feedbackTable').DataTable().destroy();
    }
    $('#feedbackData').html(html);
    $('#feedbackTable').DataTable({ 
        "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }, 
        "order": [[ 0, "desc" ]],
        "searching": true
    });
}

// Load config cho cả Eval và Troll
async function loadEvalConfig() {
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_CONFIG" }) });
        const res = await response.json();
        if (res.status === "success") {
            $('#conf_eval_enabled').prop('checked', String(res.data.evaluation_enabled).toUpperCase() === 'TRUE');
            // Format date for input type=date (YYYY-MM-DD)
            if (res.data.evaluation_deadline) {
                const d = new Date(res.data.evaluation_deadline);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                $('#conf_eval_deadline').val(`${yyyy}-${mm}-${dd}`);
            }
            
            // Load Troll Config
            $('#troll_enabled').prop('checked', String(res.data.troll_enabled).toUpperCase() === 'TRUE');
            $('#troll_mode').prop('checked', String(res.data.troll_mode).toUpperCase() === 'TRUE');
            $('#troll_title').val(res.data.troll_title || '');
            $('#troll_content').val(res.data.troll_content || '');
            $('#troll_youtube').val(res.data.troll_youtube || '');
            $('#troll_file_name').val(res.data.troll_file_name || '');

            // Load Maintenance Config
            $('#maintenanceSwitch').prop('checked', String(res.data.maintenance_mode).toUpperCase() === 'TRUE');
            
            // Helper format datetime-local
            const fmtDate = (iso) => {
                if(!iso) return '';
                const d = new Date(iso);
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };
            $('#maint_start_input').val(fmtDate(res.data.maintenance_start));
            $('#maint_end_input').val(fmtDate(res.data.maintenance_end));

            // Load Marquee Config
            $('#conf_marquee_enabled').prop('checked', String(res.data.marquee_enabled).toUpperCase() === 'TRUE');
            $('#conf_marquee_text').val(res.data.marquee_text || '');
            $('#conf_marquee_direction').val(res.data.marquee_direction || 'right');
            $('#conf_theme_color').val(res.data.theme_color || '');

            // Load Feature Maintenance Config
            $('#maint_attendance').prop('checked', String(res.data.maint_attendance).toUpperCase() === 'TRUE');
            $('#maint_students').prop('checked', String(res.data.maint_students).toUpperCase() === 'TRUE');
            $('#maint_funds').prop('checked', String(res.data.maint_funds).toUpperCase() === 'TRUE');
            $('#maint_notis').prop('checked', String(res.data.maint_notis).toUpperCase() === 'TRUE');
            $('#maint_eval').prop('checked', String(res.data.maint_eval).toUpperCase() === 'TRUE');
            $('#maint_feedback').prop('checked', String(res.data.maint_feedback).toUpperCase() === 'TRUE');
            
            // Attendance Time
            $('#conf_att_start').val(res.data.attendance_start_time || '');
            $('#conf_att_end').val(res.data.attendance_end_time || '');
            $('#conf_att_blocked').prop('checked', String(res.data.att_blocked).toUpperCase() === 'TRUE');
            $('#conf_noti_override').prop('checked', String(res.data.noti_override).toUpperCase() === 'TRUE');

            // Student Import Lock
            $('#conf_student_import_locked').prop('checked', String(res.data.student_import_locked).toUpperCase() === 'TRUE');
            if(res.data.student_import_deadline) $('#conf_student_import_deadline').val(res.data.student_import_deadline.split('T')[0]);
            
            // Load Max Upload Size
            globalMaxUploadSize = parseInt(res.data.max_upload_size) || 200;
            $('#conf_max_upload_size').val(globalMaxUploadSize);
        }
    } catch (e) { console.error("Config error", e); }
}

async function saveEvalConfig() {
    const enabled = $('#conf_eval_enabled').is(':checked') ? 'TRUE' : 'FALSE';
    const deadline = $('#conf_eval_deadline').val();
    
    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { evaluation_enabled: enabled, evaluation_deadline: deadline } }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu cấu hình đánh giá!', 'success');
            $('#modalEvalConfig').modal('hide');
        }
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- SETTINGS & TROLL FUNCTIONS ---
function openSettingsModal() {
    $('#modalSettings').modal('show'); 
    $('#darkModeSwitch').prop('checked', $('body').hasClass('dark-mode'));
    loadEvalConfig(); // Reload config để lấy dữ liệu mới nhất
}

function toggleDarkMode() {
    if ($('#darkModeSwitch').is(':checked')) {
        $('body').addClass('dark-mode');
        localStorage.setItem('darkMode', 'true');
    } else {
        $('body').removeClass('dark-mode');
        localStorage.setItem('darkMode', 'false');
    }
}

async function toggleMaintenance() {
    const enabled = $('#maintenanceSwitch').is(':checked') ? 'TRUE' : 'FALSE';
    const msg = enabled === 'TRUE' ? 'BẬT chế độ bảo trì? Tất cả Quản lý sẽ bị đăng xuất.' : 'TẮT chế độ bảo trì?';
    
    if(!confirm(msg)) {
        $('#maintenanceSwitch').prop('checked', !$('#maintenanceSwitch').is(':checked')); // Revert
        return;
    }

    try {
        await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { maintenance_mode: enabled } }) });
        toastr.success("Đã cập nhật trạng thái bảo trì!");
    } catch (e) { toastr.error("Lỗi kết nối"); }
}

async function saveMaintenanceSchedule() {
    const start = $('#maint_start_input').val();
    const end = $('#maint_end_input').val();
    
    if (start && end && new Date(start) >= new Date(end)) {
        return Swal.fire('Lỗi', 'Thời gian kết thúc phải sau thời gian bắt đầu!', 'error');
    }

    Swal.fire({ title: 'Đang lưu lịch...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_CONFIG", payload: { maintenance_start: start, maintenance_end: end } }) });
        const res = await response.json();
        if (res.status === 'success') Swal.fire('Thành công', 'Đã lưu lịch bảo trì!', 'success');
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// Xử lý ảnh Troll
$('#troll_file').change(function() {
    const file = this.files[0];
    if (file) {
        const isWord = file.name.match(/\.(doc|docx|pdf)$/i);
        const limit = isWord ? 50 * 1024 * 1024 : 100 * 1024 * 1024;
        
        if (file.size > limit) {
            toastr.warning(`File quá lớn! Giới hạn: ${isWord ? '50MB (Word/PDF)' : '100MB (Khác)'}`);
            this.value = ''; $('#troll_image_base64').val(''); $('#troll_file_name').val('');
            return;
        }
        $('#troll_file_name').val(file.name);
        const reader = new FileReader();
        reader.onload = function(e) { $('#troll_image_base64').val(e.target.result); };
        reader.readAsDataURL(file);
    }
});

async function saveTrollConfig() {
    const enabled = $('#troll_enabled').is(':checked') ? 'TRUE' : 'FALSE';
    const payload = {
        troll_enabled: enabled,
        troll_mode: $('#troll_mode').is(':checked') ? 'TRUE' : 'FALSE',
        troll_title: $('#troll_title').val(),
        troll_content: $('#troll_content').val(),
        troll_link: $('#troll_link').val(),
        troll_youtube: $('#troll_youtube').val(),
        troll_file_name: $('#troll_file_name').val()
    };
    
    // Chỉ gửi ảnh nếu có chọn ảnh mới (để tránh xóa ảnh cũ nếu không chọn)
    const imgBase64 = $('#troll_image_base64').val();
    if (imgBase64) payload.troll_image = imgBase64;
    else if (!enabled) payload.troll_image = ''; // Nếu tắt thì có thể xóa ảnh

    Swal.fire({ title: 'Đang lưu cấu hình...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') Swal.fire('Thành công', 'Đã cập nhật cấu hình Thông báo Khẩn!', 'success');
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function saveFeatureConfig() {
    const payload = {
        marquee_enabled: $('#conf_marquee_enabled').is(':checked') ? 'TRUE' : 'FALSE',
        marquee_text: $('#conf_marquee_text').val(),
        marquee_direction: $('#conf_marquee_direction').val(),
        theme_color: $('#conf_theme_color').val(),
        maint_attendance: $('#maint_attendance').is(':checked') ? 'TRUE' : 'FALSE',
        maint_students: $('#maint_students').is(':checked') ? 'TRUE' : 'FALSE',
        maint_funds: $('#maint_funds').is(':checked') ? 'TRUE' : 'FALSE',
        maint_notis: $('#maint_notis').is(':checked') ? 'TRUE' : 'FALSE',
        maint_eval: $('#maint_eval').is(':checked') ? 'TRUE' : 'FALSE',
        maint_feedback: $('#maint_feedback').is(':checked') ? 'TRUE' : 'FALSE',
        attendance_start_time: $('#conf_att_start').val(),
        attendance_end_time: $('#conf_att_end').val(),
        att_blocked: $('#conf_att_blocked').is(':checked') ? 'TRUE' : 'FALSE',
        noti_override: $('#conf_noti_override').is(':checked') ? 'TRUE' : 'FALSE',
        maint_music: 'music/bao_tri.mp3',
        student_import_locked: $('#conf_student_import_locked').is(':checked') ? 'TRUE' : 'FALSE',
        student_import_deadline: $('#conf_student_import_deadline').val(),
        max_upload_size: $('#conf_max_upload_size').val() || '200'
    };
    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Thành công', 'Đã lưu cấu hình tính năng!', 'success'); loadEvalConfig(); }
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function resetPushNotification() {
    Swal.fire({
        title: 'Reset Thông báo Khẩn?',
        text: "Toàn bộ nội dung thông báo sẽ bị xóa và tắt kích hoạt. Bạn có chắc không?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Vâng, Reset!',
        cancelButtonText: 'Hủy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            $('#troll_enabled').prop('checked', false);
            $('#troll_title, #troll_content, #troll_link, #troll_youtube, #troll_file, #troll_image_base64, #troll_file_name').val(''); $('#troll_mode').prop('checked', false);

            const payload = { troll_enabled: 'FALSE', troll_title: '', troll_content: '', troll_youtube: '', troll_image: '', troll_file_name: '' };

            Swal.fire({ title: 'Đang reset...', didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_CONFIG", payload: payload }) });
                const res = await response.json();
                if (res.status === 'success') Swal.fire('Đã Reset', 'Thông báo khẩn đã được xóa và tắt.', 'success');
                else Swal.fire('Lỗi', res.message, 'error');
            } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối khi reset.', 'error'); }
        }
    });
}

function resetEvaluations() {
    Swal.fire({
        title: 'Bắt đầu đợt đánh giá mới?',
        text: "Hành động này sẽ XÓA TOÀN BỘ dữ liệu đánh giá hiện tại của tất cả học sinh để bắt đầu đợt mới. Bạn có chắc chắn không?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Xóa & Reset',
        cancelButtonText: 'Hủy'
    }).then(async (result) => {
        if (result.isConfirmed) {
            const user = JSON.parse(sessionStorage.getItem('user'));
            Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
            try {
                const response = await fetch(API_URL, { 
                    method: "POST", 
                    redirect: "follow",
                    body: JSON.stringify({ 
                        action: "RESET_EVALUATIONS", 
                        payload: { admin_user: user.username } 
                    }) 
                });
                const res = await response.json();
                if (res.status === 'success') {
                    Swal.fire('Thành công', res.message, 'success');
                    loadEvaluations();
                } else Swal.fire('Lỗi', res.message, 'error');
            } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
        }
    });
}

let globalEvaluationsData = [];
async function loadEvaluations() {
    $('#evalData').html(getLoadingRowHtml(6));
    $('#eval_filter_group').html('<option value="">-- Tất cả Nhóm --</option>'); // Reset filter nhóm
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_EVALUATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            const rawEvaluations = res.data; // [ID, Name, Group, Disc, Pos, Vol, Class, By, Time]
            
            const mergedList = globalStudentsData.map(st => {
                const evalItem = rawEvaluations.find(e => String(e[0]) === String(st.id));
                if (evalItem) {
                    return {
                        name: st.fullname,
                        group: st.group_display,
                        disc: evalItem[3],
                        pos: evalItem[4],
                        vol: evalItem[5],
                        class: evalItem[6]
                    };
                } else {
                    return {
                        name: st.fullname,
                        group: st.group_display,
                        disc: '',
                        pos: '',
                        vol: '',
                        class: 'Chưa đánh giá'
                    };
                }
            });
            
            globalEvaluationsData = mergedList; // Lưu dữ liệu đã ghép để xuất Excel
            
            // Populate Group Filter
            const groups = [...new Set(globalEvaluationsData.map(e => e.group))].sort();
            let gHtml = '<option value="">-- Tất cả Nhóm --</option>';
            groups.forEach(g => gHtml += `<option value="${g}">${g}</option>`);
            $('#eval_filter_group').html(gHtml);

            // Render Default
            filterEvaluations();

            // Evaluation Chart
            const evalCounts = { 'Xuất sắc': 0, 'Tốt': 0, 'Trung bình': 0, 'Yếu': 0, 'Chưa đánh giá': 0 };
            mergedList.forEach(e => { evalCounts[e.class] = (evalCounts[e.class]||0)+1; });
            renderChart('chartEvalClass', 'bar', Object.keys(evalCounts), Object.values(evalCounts), 'Số lượng', ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6c757d']);
        }
    } catch (e) { console.error("Eval error", e); $('#evalData').html(getErrorRowHtml(6)); }
}

function filterEvaluations() {
    const name = $('#eval_filter_name').val().toLowerCase();
    const group = $('#eval_filter_group').val();
    const status = $('#eval_filter_status').val();
    const classification = $('#eval_filter_class').val();

    currentEvaluationView = globalEvaluationsData.filter(e => {
        const matchName = !name || (e.name && e.name.toLowerCase().includes(name));
        const matchGroup = !group || e.group === group;
        
        let matchStatus = true;
        if (status === 'evaluated') matchStatus = e.class !== 'Chưa đánh giá';
        if (status === 'not_evaluated') matchStatus = e.class === 'Chưa đánh giá';

        let matchClass = true;
        if (classification) matchClass = e.class === classification;

        return matchName && matchGroup && matchStatus && matchClass;
    });

    renderEvaluationTable(currentEvaluationView);
}

function renderEvaluationTable(data) {
    let html = '';
    if (data.length === 0) {
        html = '<tr><td colspan="6" class="text-center">Không tìm thấy kết quả</td></tr>';
    } else {
        data.forEach(e => {
            let badgeClass = 'secondary';
            if (e.class === 'Xuất sắc') badgeClass = 'success';
            else if (e.class === 'Tốt') badgeClass = 'primary';
            else if (e.class === 'Trung bình') badgeClass = 'warning';
            else if (e.class === 'Yếu') badgeClass = 'danger';
            else badgeClass = 'light border'; // Chưa đánh giá

            html += `<tr>
                <td class="font-weight-bold">${e.name}</td>
                <td class="d-none d-md-table-cell"><span class="badge badge-light border">${e.group}</span></td>
                <td class="d-none d-md-table-cell"><small>${e.disc || '-'}</small></td>
                <td class="d-none d-md-table-cell"><small>${e.pos || '-'}</small></td>
                <td class="d-none d-md-table-cell"><small>${e.vol || '-'}</small></td>
                <td><span class="badge badge-${badgeClass}">${e.class}</span></td>
            </tr>`;
        });
    }
    if ($.fn.DataTable.isDataTable('#evalTable')) {
        $('#evalTable').DataTable().destroy();
    }
    $('#evalData').html(html);
    $('#evalTable').DataTable({ "language": { "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Vietnamese.json" }, "searching": false });
}

function resetEvaluationFilter() {
    $('#eval_filter_name, #eval_filter_group, #eval_filter_status, #eval_filter_class').val('');
    filterEvaluations();
}

async function updateAttendanceStats() {
    $('#historyAttendanceData').html(getLoadingRowHtml(5));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_ADMIN_STATS" }) });
        const res = await response.json();
        if (res.status === "success") {
            const s = res.data;
            $('#countPresent').text(s.present);
            $('#countAbsentP').text(s.absent_perm);
            $('#countAbsent').text(s.absent);
            globalHistoryData = s.history || [];
            
            // Giữ lại bộ lọc nếu đang có
            if ($('#filter_from').val() || $('#filter_to').val() || $('#filter_status').val() || $('#filter_history_name').val()) {
                filterHistory(true);
            } else {
                currentHistoryView = globalHistoryData;
                renderHistoryTable(currentHistoryView);
            }
            renderCharts(s);
        } else {
            if (globalHistoryData.length > 0) {
                toastr.warning("Lỗi tải mới. Đang hiển thị dữ liệu cũ.");
                filterHistory(true);
            } else {
                $('#historyAttendanceData').html(getErrorRowHtml(5, res.message || "Lỗi tải dữ liệu từ Server."));
            }
        }
    } catch (e) { 
        toastr.error("Không thể kết nối Server."); 
        if (globalHistoryData.length > 0) {
            filterHistory(true);
        } else {
            $('#historyAttendanceData').html(getErrorRowHtml(5));
        }
    }
}

function renderDashboardStats() {
    $('#countManagers').text(globalUsersData.length);
    $('#countGroups').text(globalGroupsData.length);
    $('#countNotis').text(globalNotisData.length);
    $('#countFeedbacks').text(globalFeedbacksData.length);
}

function showChartsFor(category, title, countId) {
    currentChartCategory = category;
    $('#modalCharts').modal('show');
    
    // Update Title & Total
    $('#chartModalTitle').text(title || 'Thống kê chi tiết');
    const count = countId ? $('#' + countId).text() : 0;
    $('#modalTotalDisplay').html(`Tổng số: <span class="text-primary font-weight-bold" style="font-size: 1.5rem;">${count}</span>`);

    // Populate Group Filter
    const groupSelect = $('#chartGroupFilter');
    groupSelect.empty().append('<option value="">-- Tất cả Nhóm --</option>');
    
    if (['students', 'attendance', 'feedbacks'].includes(category)) {
        $('#chartFilterContainer').show();
        if(globalGroupsData) {
            globalGroupsData.forEach(g => {
                groupSelect.append(`<option value="${g.group_name}">${g.group_name}</option>`);
            });
        }
    } else {
        $('#chartFilterContainer').hide();
    }
    
    updateModalCharts();
}

function updateModalCharts() {
    const groupFilter = $('#chartGroupFilter').val();
    const ctx1 = document.getElementById('modalChart1').getContext('2d');
    const ctx2 = document.getElementById('modalChart2').getContext('2d');
    
    if (modalChart1) modalChart1.destroy();
    if (modalChart2) modalChart2.destroy();
    
    let data1 = {}, data2 = {};
    let type1 = 'pie', type2 = 'line';
    let title1 = 'Phân bố', title2 = 'Biến động';

    if (currentChartCategory === 'students') {
        title1 = 'Phân bố Học sinh'; title2 = 'Tăng trưởng Học sinh';
        let filtered = globalStudentsData;
        if (groupFilter) filtered = filtered.filter(s => s.group_display === groupFilter);
        
        // Chart 1: Group Distribution (or Class if filtered)
        const counts = {};
        filtered.forEach(s => { 
            const key = groupFilter ? (s.class_name || 'Khác') : s.group_display;
            counts[key] = (counts[key] || 0) + 1; 
        });
        data1 = { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de'] }] };
        
        // Chart 2: Growth
        const growth = {};
        filtered.forEach(s => {
            const ts = parseInt(s.id.replace('ST', ''));
            if(!isNaN(ts)) {
                const d = new Date(ts);
                const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                growth[key] = (growth[key] || 0) + 1;
            }
        });
        const keys = Object.keys(growth).sort();
        let acc = 0;
        const vals = keys.map(k => { acc += growth[k]; return acc; });
        data2 = { labels: keys, datasets: [{ label: 'Tổng HS', data: vals, borderColor: '#17a2b8', fill: true }] };

    } else if (currentChartCategory === 'attendance') {
        title1 = 'Tỉ lệ Điểm danh'; title2 = 'Xu hướng 7 ngày';
        let filtered = globalHistoryData;
        if (groupFilter) filtered = filtered.filter(h => h.group_id === groupFilter);
        
        // Chart 1
        let p=0, ap=0, a=0;
        filtered.forEach(h => { if(h.status==='present') p++; else if(h.status==='absent_perm') ap++; else a++; });
        data1 = { labels: [`Có mặt (${p})`, `Vắng P (${ap})`, `Vắng K (${a})`], datasets: [{ data: [p, ap, a], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }] };
        type1 = 'doughnut';

        // Chart 2
        const trend = {};
        filtered.forEach(h => {
            const d = h.timestamp.split(' ')[0];
            if(!trend[d]) trend[d] = {p:0, ap:0, a:0};
            if(h.status==='present') trend[d].p++; else if(h.status==='absent_perm') trend[d].ap++; else trend[d].a++;
        });
        const dates = Object.keys(trend).sort((a,b) => { const [d1,m1,y1]=a.split('/'); const [d2,m2,y2]=b.split('/'); return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`); }).slice(-7);
        data2 = {
            labels: dates,
            datasets: [
                { label: 'Có mặt', data: dates.map(d=>trend[d].p), borderColor: '#28a745', fill: false },
                { label: 'Vắng P', data: dates.map(d=>trend[d].ap), borderColor: '#ffc107', fill: false },
                { label: 'Vắng K', data: dates.map(d=>trend[d].a), borderColor: '#dc3545', fill: false }
            ]
        };

    } else if (currentChartCategory === 'managers') {
        title1 = 'Phân bố Quyền hạn'; title2 = 'Quản lý theo Nhóm';
        // Chart 1
        const roles = {};
        globalUsersData.forEach(u => { roles[u.role] = (roles[u.role]||0)+1; });
        data1 = { labels: Object.keys(roles), datasets: [{ data: Object.values(roles), backgroundColor: ['#dc3545', '#ffc107', '#007bff'] }] };
        
        // Chart 2
        const groups = {};
        globalUsersData.forEach(u => { groups[u.group_id] = (groups[u.group_id]||0)+1; });
        data2 = { labels: Object.keys(groups), datasets: [{ label: 'Số lượng', data: Object.values(groups), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de', '#605ca8', '#ff851b'] }] };
        type2 = 'pie';

    } else if (currentChartCategory === 'groups') {
        title1 = 'Học sinh theo Nhóm'; title2 = 'Số lượng Quản lý';
        // Chart 1 (Same as Students Dist)
        const counts = {};
        globalStudentsData.forEach(s => { counts[s.group_display] = (counts[s.group_display] || 0) + 1; });
        data1 = { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc'] }] };
        
        // Chart 2
        const mgrs = {};
        globalUsersData.forEach(u => { mgrs[u.group_id] = (mgrs[u.group_id]||0)+1; });
        data2 = { labels: Object.keys(mgrs), datasets: [{ label: 'Quản lý', data: Object.values(mgrs), backgroundColor: ['#17a2b8', '#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de'] }] };
        type2 = 'pie';

    } else if (currentChartCategory === 'notifications') {
        title1 = 'Loại Thông báo'; title2 = 'Lịch sử tạo';
        const types = {};
        globalNotisData.forEach(n => { types[n.type] = (types[n.type]||0)+1; });
        data1 = { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: ['#6c757d', '#007bff', '#28a745', '#ffc107'] }] };
        
        const dates = {};
        globalNotisData.forEach(n => { const d = n.datetime.split(' ')[0]; dates[d] = (dates[d]||0)+1; });
        const sorted = Object.keys(dates).sort();
        data2 = { labels: sorted, datasets: [{ label: 'Số TB', data: sorted.map(d=>dates[d]), borderColor: '#fd7e14', fill: false }] };

    } else if (currentChartCategory === 'feedbacks') {
        title1 = 'Trạng thái Phản hồi'; title2 = 'Lịch sử Gửi';
        let filtered = globalFeedbacksData;
        if (groupFilter) filtered = filtered.filter(f => f.group_id == groupFilter); // Loose equality for ID vs Name match attempt
        
        const status = { 'Đã trả lời': 0, 'Chờ xử lý': 0 };
        filtered.forEach(f => { f.reply ? status['Đã trả lời']++ : status['Chờ xử lý']++; });
        data1 = { labels: Object.keys(status), datasets: [{ data: Object.values(status), backgroundColor: ['#28a745', '#ffc107'] }] };
        
        const dates = {};
        filtered.forEach(f => { const d = f.timestamp.split(' ')[0]; dates[d] = (dates[d]||0)+1; });
        const sorted = Object.keys(dates).sort((a,b) => { const [d1,m1,y1]=a.split('/'); const [d2,m2,y2]=b.split('/'); return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`); });
        data2 = { labels: sorted, datasets: [{ label: 'Số phản ánh', data: sorted.map(d=>dates[d]), backgroundColor: '#17a2b8' }] };
        type2 = 'bar';
    }

    $('#chartTitle1').text(title1);
    $('#chartTitle2').text(title2);
    
    modalChart1 = new Chart(ctx1, { type: type1, data: data1, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    modalChart2 = new Chart(ctx2, { type: type2, data: data2, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
}

function downloadChartImage(canvasId, filename) {
    const canvas = document.getElementById(canvasId);
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function renderCharts(data) {
    // 1. Attendance Ratio (Doughnut)
    const ctxAttRatio = document.getElementById('chartAttendanceRatio').getContext('2d');
    if (chartAttRatio) chartAttRatio.destroy();
    chartAttRatio = new Chart(ctxAttRatio, {
        type: 'doughnut',
        data: {
            labels: [`Có mặt (${data.present})`, `Vắng P (${data.absent_perm})`, `Vắng K (${data.absent})`],
            datasets: [{ data: [data.present, data.absent_perm, data.absent], backgroundColor: ['#28a745', '#ffc107', '#dc3545'] }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // 2. Attendance Trend (Line) - Process History Data
    const historyByDate = {};
    (data.history || []).forEach(h => {
        const date = h.timestamp.split(' ')[0]; // dd/mm/yyyy
        if (!historyByDate[date]) historyByDate[date] = { p: 0, ap: 0, a: 0 };
        if (h.status === 'present') historyByDate[date].p++;
        else if (h.status === 'absent_perm') historyByDate[date].ap++;
        else historyByDate[date].a++;
    });
    // Sort dates
    const sortedDates = Object.keys(historyByDate).sort((a,b) => {
        const [d1,m1,y1] = a.split('/'); const [d2,m2,y2] = b.split('/');
        return new Date(`${y1}-${m1}-${d1}`) - new Date(`${y2}-${m2}-${d2}`);
    }).slice(-7); // Last 7 days

    const ctxAttTrend = document.getElementById('chartAttendanceTrend').getContext('2d');
    if (chartAttTrend) chartAttTrend.destroy();
    chartAttTrend = new Chart(ctxAttTrend, {
        type: 'line',
        data: {
            labels: sortedDates,
            datasets: [
                { label: 'Có mặt', data: sortedDates.map(d => historyByDate[d].p), borderColor: '#28a745', fill: false, tension: 0.1 },
                { label: 'Vắng (P)', data: sortedDates.map(d => historyByDate[d].ap), borderColor: '#ffc107', fill: false, tension: 0.1 },
                { label: 'Vắng (K)', data: sortedDates.map(d => historyByDate[d].a), borderColor: '#dc3545', fill: false, tension: 0.1 }
            ]
        },
        options: { maintainAspectRatio: false }
    });

    // 3. Evaluation Chart (Bar)
    if(globalEvaluationsData.length > 0) {
        const counts = { 'Xuất sắc': 0, 'Tốt': 0, 'Trung bình': 0, 'Yếu': 0, 'Chưa đánh giá': 0 };
        globalEvaluationsData.forEach(e => { counts[e.class] = (counts[e.class] || 0) + 1; });
        const ctxEval = document.getElementById('chartEvaluation').getContext('2d');
        if (chartEval) chartEval.destroy();
        chartEval = new Chart(ctxEval, {
            type: 'bar',
            data: { labels: Object.keys(counts), datasets: [{ label: 'Số lượng', data: Object.values(counts), backgroundColor: '#007bff' }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // 4. Student Charts (Group & Trend)
    if(globalStudentsData.length > 0) {
        // Group Distribution
        const groupCounts = {};
        globalStudentsData.forEach(s => { groupCounts[s.group_display] = (groupCounts[s.group_display] || 0) + 1; });
        
        const ctxStGroup = document.getElementById('chartStGroup').getContext('2d');
        if (chartStGroup) chartStGroup.destroy();
        chartStGroup = new Chart(ctxStGroup, {
            type: 'pie',
            data: {
                labels: Object.keys(groupCounts),
                datasets: [{ data: Object.values(groupCounts), backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc', '#d2d6de', '#605ca8', '#ff851b'] }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        // Student Growth Trend (Based on ID timestamp)
        const growth = {};
        globalStudentsData.forEach(s => {
            const ts = parseInt(s.id.replace('ST', ''));
            if(!isNaN(ts)) {
                const d = new Date(ts);
                const key = `${d.getDate()}/${d.getMonth()+1}`;
                growth[key] = (growth[key] || 0) + 1;
            }
        });
        // Sort keys roughly (simple sort for dd/mm might fail across years but ok for demo)
        const growthKeys = Object.keys(growth).sort((a,b) => a.localeCompare(b)); // Simple sort
        let cumulative = 0;
        const growthData = growthKeys.map(k => { cumulative += growth[k]; return cumulative; });

        const ctxStTrend = document.getElementById('chartStTrend').getContext('2d');
        if (chartStTrend) chartStTrend.destroy();
        chartStTrend = new Chart(ctxStTrend, {
            type: 'line',
            data: { labels: growthKeys, datasets: [{ label: 'Tổng học sinh', data: growthData, borderColor: '#17a2b8', backgroundColor: 'rgba(23, 162, 184, 0.2)', fill: true }] },
            options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }
}

function renderHistoryTable(history) {
    let html = '';
    history.forEach(row => {
        let statusBadge = row.status === 'present' ? '<span class="badge badge-success">Có mặt</span>' : 
                          (row.status === 'absent_perm' ? '<span class="badge badge-warning">Vắng (P)</span>' : '<span class="badge badge-danger">Vắng</span>');
        let reasonHtml = row.reason ? `<div class="small text-danger font-italic border-top mt-1 pt-1">Lý do: ${row.reason}</div>` : '';
        html += `<tr>
            <td><small class="text-muted">${row.timestamp}</small></td>
            <td><b>${row.student_name}</b></td>
            <td class="d-none d-md-table-cell"><span class="badge badge-light border">${row.group_id}</span></td>
            <td>${statusBadge}${reasonHtml}</td>
            <td class="d-none d-md-table-cell"><small>${row.recorded_by}</small></td>
        </tr>`;
    });
    $('#historyAttendanceData').html(html || '<tr><td colspan="5" class="text-center">Trống</td></tr>');
}

function filterHistory(silent = false) {
    const from = $('#filter_from').val();
    const to = $('#filter_to').val();
    const status = $('#filter_status').val();
    const name = $('#filter_history_name').val().toLowerCase();

    let d1, d2;
    if (from && to) {
        d1 = new Date(from); d1.setHours(0,0,0,0);
        d2 = new Date(to); d2.setHours(23,59,59,999);
    }
    
    currentHistoryView = globalHistoryData.filter(h => {
        let dateMatch = true;
        if (d1 && d2) {
            const parts = h.timestamp.split(' ')[0].split('/'); // dd/mm/yyyy
            const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`); // yyyy-mm-dd
            dateMatch = d >= d1 && d <= d2;
        }
        
        let statusMatch = true;
        if (status) {
            statusMatch = h.status === status;
        }

        let nameMatch = true;
        if (name) {
            nameMatch = h.student_name.toLowerCase().includes(name);
        }
        return dateMatch && statusMatch && nameMatch;
    });
    renderHistoryTable(currentHistoryView);
    if (!silent) toastr.success(`Đã lọc: ${currentHistoryView.length} bản ghi`);
}

function resetFilter() {
    $('#filter_from, #filter_to, #filter_status, #filter_history_name').val('');
    currentHistoryView = globalHistoryData;
    renderHistoryTable(currentHistoryView);
}

// AUTO GENERATE ID FUNCTION
function getNextId(list, prop, prefix = '') {
    if (!list || list.length === 0) return prefix + '1';
    let max = 0;
    list.forEach(item => {
        let val = String(item[prop]);
        // Lấy số ở cuối chuỗi ID hiện tại
        const match = val.match(/(\d+)$/);
        if (match) {
            const num = parseInt(match[1]);
            if (num > max) max = num;
        }
    });
    // Trả về prefix + số tiếp theo
    return prefix + (max + 1);
}

// OPEN MODAL FUNCTIONS
async function openStudentModal() { 
    $('#modalStudent').modal('show'); 
    $('#student_id_old').val(''); 
    $('#st_id').prop('readonly', false).val(getNextId(globalStudentsData, 'id', '')); 
    $('#st_name, #st_gender, #st_dob, #st_class, #st_address, #st_phone, #st_group, #st_reg_time, #st_reg_loc, #st_reg_act').val(''); 
    
    // New school logic
    $('#st_school_other').val('');
    await loadSchoolList();
    populateSchoolDropdown('st_school_select');
    $('#st_school_select').val('');
    toggleOtherSchool('st_school_select', 'st_school_other_div');
}

const HONOR_TITLES = ["Năng nổ nhất", "Siêng năng nhất", "Chăm chỉ nhất", "Ý tưởng sáng tạo", "Lầy lội nhất", "Văn nghệ tuyệt nhất", "Đoàn kết nhất"];

let schoolList = [];
async function loadSchoolList() {
    if (schoolList.length > 0) return;
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_SCHOOL_LIST" }) });
        const res = await response.json();
        if (res.status === 'success') schoolList = res.data;
    } catch(e) { console.error("Failed to load school list", e); }
}

function populateSchoolDropdown(selectId) {
    const select = document.getElementById(selectId);
    if (!select || schoolList.length === 0) return;
    let html = '<option value="">-- Vui lòng chọn trường --</option>';
    schoolList.forEach(school => { html += `<option value="${school}">${school}</option>`; });
    html += '<option value="other">Trường khác...</option>';
    select.innerHTML = html;
}

function toggleOtherSchool(selectId, otherDivId) {
    const otherDiv = document.getElementById(otherDivId);
    otherDiv.style.display = (document.getElementById(selectId).value === 'other') ? 'block' : 'none';
}

function getSelectedSchool(selectId, otherInputId) {
    const select = document.getElementById(selectId);
    return (select.value === 'other') ? document.getElementById(otherInputId).value.trim() : select.value;
}

function renderHonorCheckboxes(selected = []) {
    let html = '';
    HONOR_TITLES.forEach(t => {
        const checked = selected.includes(t) ? 'checked' : '';
        html += `
        <div class="custom-control custom-checkbox mr-3 mb-2">
            <input type="checkbox" class="custom-control-input honor-check" id="h_${t}" value="${t}" ${checked}>
            <label class="custom-control-label" for="h_${t}">${t}</label>
        </div>`;
    });
    $('#u_honors_container').html(html);
}

function openUserModal() { 
    $('#modalUser').modal('show'); $('#user_id_old').val(''); $('#pass_area').show(); $('#u_name').val(getNextId(globalUsersData, 'username', 'user')); $('#u_pass, #u_role, #u_group, #u_fullname, #u_avatar, #u_email').val(''); 
    $('#u_vip_level').val(''); renderHonorCheckboxes();
}
function openGroupModal() { $('#modalGroup').modal('show'); $('#group_id_old').val(''); $('#g_id').val(getNextId(globalGroupsData, 'group_id', '')); $('#g_name').val(''); }
function openNotiModal() { 
    $('#modalNoti').modal('show'); 
    $('#noti_id_old').val(''); 
    $('#n_id').val(getNextId(globalNotisData, 'id', 'NOTI')); 
    $('#n_title, #n_content, #n_datetime, #n_link, #n_location, #n_file, #n_attachment_base64, #n_file_name').val(''); 
    $('#n_type').val('normal');
    
    let groupHtml = '<option value="ALL">Tất cả mọi người</option>';
    if(globalGroupsData) {
        globalGroupsData.forEach(g => {
            groupHtml += `<option value="${g.group_id}">Nhóm ${g.group_name} (${g.group_id})</option>`;
        });
    }
    $('#n_target_group').html(groupHtml).val('ALL');
    
    toggleLocationInput();
}

function editNotification(id) {
    const n = globalNotisData.find(x => String(x.id) === String(id));
    if (!n) return;
    $('#noti_id_old').val(n.id);
    $('#n_id').val(n.id).prop('readonly', true);
    $('#n_title').val(n.title);
    $('#n_content').val(n.content);
    $('#n_datetime').val(n.datetime.replace(' ', 'T'));
    $('#n_early').val(n.early);
    $('#n_type').val(n.type || 'normal');
    $('#n_location').val(n.location);
    $('#n_link').val(n.link);
    $('#n_file_name').val(n.attachment_name);
    // Giữ nguyên base64 cũ nếu không chọn file mới (xử lý trong saveData)
    
    let groupHtml = '<option value="ALL">Tất cả mọi người</option>';
    if(globalGroupsData) {
        globalGroupsData.forEach(g => {
            groupHtml += `<option value="${g.group_id}">Nhóm ${g.group_name} (${g.group_id})</option>`;
        });
    }
    $('#n_target_group').html(groupHtml);
    $('#n_target_group').val(n.target_group || 'ALL');
    
    toggleLocationInput();
    $('#modalNoti').modal('show');
}

function previewNotification() {
    const title = $('#n_title').val();
    const content = $('#n_content').val();
    const target = $('#n_target_group option:selected').text();
    
    Swal.fire({
        title: 'Xem trước hiển thị',
        html: `<div class="text-left">
            <h5 class="text-primary font-weight-bold">${title}</h5>
            <p class="text-muted small">Gửi tới: ${target}</p>
            <p>${content.replace(/\n/g, '<br>')}</p>
        </div>`,
        icon: 'info'
    });
}

function toggleLocationInput() {
    const type = $('#n_type').val();
    if (type === 'normal') {
        $('#grp_location').addClass('d-none');
    } else {
        $('#grp_location').removeClass('d-none');
        $('#lbl_location').text(type === 'online' ? 'Link cuộc họp (Google Meet/Zoom)' : 'Địa điểm tổ chức');
        $('#n_location').attr('placeholder', type === 'online' ? 'https://meet.google.com/...' : 'Phòng họp số 1, Tầng 2...');
    }
}

// Xử lý file đính kèm (Chuyển sang Base64)
$('#n_file').change(function() {
    const file = this.files[0];
    if (file) {
        $('#n_file_name').val(file.name); // Lưu tên file
        const isWord = file.name.match(/\.(doc|docx|pdf)$/i);
        const limit = isWord ? 50 * 1024 * 1024 : 100 * 1024 * 1024;

        if (file.size > limit) {
            toastr.warning(`File quá lớn! Giới hạn: ${isWord ? '50MB (Word/PDF)' : '100MB (Khác)'}`);
            this.value = ''; // Reset input
            $('#n_attachment_base64').val('');
            $('#n_file_name').val('');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) { $('#n_attachment_base64').val(e.target.result); };
        reader.readAsDataURL(file);
    }
});

// EDIT FUNCTIONS
async function editStudent(studentId) {
    const s = globalStudentsData.find(st => String(st.id) === String(studentId));
    if (!s) {
        return toastr.error("Không tìm thấy học sinh để sửa!");
    }
    $('#student_id_old').val(s.id);
    $('#st_id').val(s.id).prop('readonly', true);
    $('#st_name').val(s.fullname);
    $('#st_gender').val(s.gender);
    $('#st_dob').val(s.dob);
    $('#st_class').val(s.class_name);
    $('#st_address').val(s.address);
    $('#st_phone').val(s.phone);
    $('#st_group').val(s.group_id);
    $('#st_reg_time').val(s.reg_time);
    $('#st_reg_loc').val(s.reg_loc);
    $('#st_reg_act').val(s.reg_act);

    // New school logic
    await loadSchoolList();
    populateSchoolDropdown('st_school_select');
    if (schoolList.includes(s.school)) {
        $('#st_school_select').val(s.school);
    } else if (s.school) {
        $('#st_school_select').val('other');
        $('#st_school_other').val(s.school);
    } else {
        $('#st_school_select').val('');
    }
    toggleOtherSchool('st_school_select', 'st_school_other_div');

    $('#modalStudent').modal('show');
}

function editUser(username) {
    const u = globalUsersData.find(user => String(user.username) === String(username));
    if (!u) {
        return toastr.error("Không tìm thấy tài khoản để sửa!");
    }
    $('#user_id_old').val(u.username);
    $('#u_name').val(u.username);
    $('#u_role').val(u.role);
    $('#u_group').val(u.group_id);
    $('#u_fullname').val(u.fullname);
    $('#u_email').val(u.email || '');
    $('#u_phone').val(u.phone || '');
    $('#u_avatar').val(u.avatar);
    
    // Load Honors
    let honors = { level: '', titles: [] };
    try { honors = JSON.parse(u.honors || '{}'); } catch(e){}
    $('#u_vip_level').val(honors.level || '');
    renderHonorCheckboxes(honors.titles || []);

    $('#pass_area').hide();
    $('#modalUser').modal('show');
}

function showVipConfigHelp() {
    Swal.fire({
        title: 'Cấu hình Vinh danh',
        html: 'Để cấu hình VIP và Danh hiệu cho một quản lý:<br>1. Nhấn nút <b><i class="fas fa-edit text-info"></i> Sửa</b> tại dòng của quản lý đó.<br>2. Kéo xuống phần <b>Hệ thống Vinh danh (VIP)</b>.<br>3. Chọn cấp độ VIP và các danh hiệu mong muốn.<br>4. Nhấn Lưu.',
        icon: 'info'
    });
}

function editGroup(idx) {
    const g = globalGroupsData[idx];
    $('#group_id_old').val(g.group_id);
    $('#g_id').val(g.group_id);
    $('#g_name').val(g.group_name);
    $('#modalGroup').modal('show');
}

function openReply(id) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#reply_id').val(id);
    $('#reply_content').val('');
    $('#reply_responder').val(user ? user.fullname : '');
    $('#reply_phone').val('');
    $('#modalReply').modal('show');
}

async function submitReply() {
    const id = $('#reply_id').val();
    const content = $('#reply_content').val();
    const responder = $('#reply_responder').val();
    const phone = $('#reply_phone').val();

    if(!content || !responder) return toastr.warning("Vui lòng nhập nội dung và tên người trả lời!");
    
    const fullReply = `${content}<br><br>----------------<br><b>Người trả lời:</b> ${responder}<br><b>SĐT hỗ trợ:</b> ${phone || 'Không có'}`;
    
    Swal.fire({ title: 'Đang gửi...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: 'REPLY_FEEDBACK', payload: { id: id, reply: fullReply } }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Thành công', 'Đã gửi phản hồi', 'success'); $('#modalReply').modal('hide'); loadFeedbacks(); }
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function resetPassword(username) {
    const user = globalUsersData.find(u => String(u.username) === String(username));
    if (!user) return;
    
    const result = await Swal.fire({
        title: 'Xác nhận reset?',
        text: `Mật khẩu của ${username} sẽ về mặc định: Abc@123`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Reset ngay',
        cancelButtonText: 'Hủy'
    });
    
    if (result.isConfirmed) {
        Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: 'RESET_PASSWORD', payload: { username: username, admin_user: JSON.parse(sessionStorage.getItem('user')).username } }) });
            const res = await response.json();
            if (res.status === 'success') Swal.fire('Thành công!', res.message, 'success');
            else Swal.fire('Lỗi', res.message, 'error');
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    }
}

// SAVE & DELETE DATA
async function saveData(type) {
    let action = 'ADD_DATA', idOld = "", dataArr = [];
    if (type === 'students') {
        idOld = $('#student_id_old').val();
        const schoolName = getSelectedSchool('st_school_select', 'st_school_other');
        if (!schoolName) return toastr.warning("Vui lòng chọn hoặc nhập trường học!");

        dataArr = [
            $('#st_id').val(), $('#st_name').val(), $('#st_gender').val(), $('#st_dob').val(), $('#st_class').val(), schoolName, 
            $('#st_address').val(), $('#st_phone').val(), $('#st_group').val(), 
            $('#st_reg_time').val(), $('#st_reg_loc').val(), $('#st_reg_act').val()
        ];
    } else if (type === 'users') {
        idOld = $('#user_id_old').val();
        // Get Honors
        const titles = [];
        $('.honor-check:checked').each(function() { titles.push($(this).val()); });
        const honorsJson = JSON.stringify({ level: $('#u_vip_level').val(), titles: titles });

        // Check VIP exclusivity
        const role = $('#u_role').val();
        const vip = $('#u_vip_level').val();
        if ((vip === 'vip4' || vip === 'vip5') && role !== 'supervisor') {
            return Swal.fire('Lỗi', 'VIP 4 và VIP 5 chỉ dành cho Cấp quản lý (Supervisor)!', 'error');
        }
        
        // Auto add Title for VIP 10
        if (vip === 'vip10') {
            if (!titles.includes("CẤP QUẢN LÝ XỊN SÒ")) titles.push("CẤP QUẢN LÝ XỊN SÒ");
        }

        // Special handling for Users to preserve timestamps in backend
        const payload = {
            action: 'SAVE_USER_ADMIN',
            payload: {
                is_add: !idOld,
                id: idOld || $('#u_name').val(),
                data: [$('#u_name').val(), $('#u_pass').val(), $('#u_role').val(), $('#u_group').val(), $('#u_fullname').val(), $('#u_avatar').val(), $('#u_email').val(), honorsJson, $('#u_phone').val()],
                admin_user: JSON.parse(sessionStorage.getItem('user')).username
            }
        };
        // Bypass generic call
        callApiAndRefresh(payload);
        return;
    } else if (type === 'groups') {
        idOld = $('#group_id_old').val();
        dataArr = [$('#g_id').val(), $('#g_name').val()];
    } else if (type === 'notifications') {
        idOld = $('#noti_id_old').val();
        let dt = $('#n_datetime').val().replace('T', ' '); // Format lại: bỏ chữ T ở giữa
        
        // Giữ lại danh sách người đã xem và file đính kèm nếu đang sửa
        let readers = "";
        let attach = $('#n_attachment_base64').val();
        let attachName = $('#n_file_name').val();
        
        if (idOld) {
            const oldN = globalNotisData.find(x => String(x.id) === String(idOld));
            if (oldN) {
                readers = oldN.read_by || "";
                if (!attach && oldN.attachment) {
                    attach = oldN.attachment;
                    attachName = oldN.attachment_name;
                }
            }
        }

        // Cấu trúc: ID, Title, Content, DateTime, Early, CreatedAt, Readers(Auto), Type, Location, Attachment, AttachmentName, Link, TargetGroup
        dataArr = [$('#n_id').val(), $('#n_title').val(), $('#n_content').val(), dt, $('#n_early').val(), new Date().toLocaleString(), readers, $('#n_type').val(), $('#n_location').val(), attach, attachName, $('#n_link').val(), $('#n_target_group').val()];
    }

    if (idOld) action = 'UPDATE_DATA';
    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    callApiAndRefresh({ action: action, payload: { type: type, id: idOld, data: dataArr } }); // Note: callApiAndRefresh needs update too
}

async function callApiAndRefresh(bodyData) {
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify(bodyData) });
        const res = await response.json();
        if (res.status === 'success') {
            $('.modal').modal('hide');
            Swal.fire('Thành công!', res.message, 'success');
            refreshAll();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Không thể kết nối Server', 'error'); }
}

function printStudents() {
    const table = $('#studentTable').DataTable();
    const pageLength = table.page.len();
    
    const afterPrint = () => {
        table.page.len(pageLength).draw();
        window.removeEventListener('afterprint', afterPrint);
    };
    window.addEventListener('afterprint', afterPrint);

    // Show all entries for printing
    table.page.len(-1).draw();

    // Use a timeout to allow the table to redraw before printing
    setTimeout(() => {
        window.print();
    }, 300);
}

function deleteData(type, id) {
    Swal.fire({ title: 'Xóa dữ liệu?', text: "Hành động này không thể hoàn tác!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Xóa' }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: type, id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { Swal.fire('Đã xóa!', res.message, 'success'); refreshAll(); }
            } catch (e) { toastr.error("Lỗi xóa dữ liệu"); }
        }
    });
}

// EXPORT FUNCTIONS
function exportExcelHistory() {
    if (currentHistoryView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");
    const data = currentHistoryView.map(item => {
        let st = "Vắng không phép";
        if (item.status === 'present') st = "Có mặt";
        else if (item.status === 'absent_perm') st = "Vắng có phép";
        
        return { "Thời Gian": item.timestamp, "Học Sinh": item.student_name, "Nhóm": item.group_id, "Trạng Thái": st, "Lý do": item.reason || "Không có", "Người Thực Hiện": item.recorded_by };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Lịch Sử");
    XLSX.writeFile(wb, `Lich_Su_Diem_Danh.xlsx`);
}

function exportPdfHistory() {
    if (currentHistoryView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");

    const body = [
        [
            { text: 'Thời gian', bold: true, style: 'tableHeader' },
            { text: 'Học sinh', bold: true, style: 'tableHeader' },
            { text: 'Nhóm', bold: true, style: 'tableHeader' },
            { text: 'Trạng thái', bold: true, style: 'tableHeader' },
            { text: 'Lý do', bold: true, style: 'tableHeader' },
            { text: 'Người thực hiện', bold: true, style: 'tableHeader' }
        ]
    ];

    currentHistoryView.forEach(item => {
        let st = "Vắng KP";
        if (item.status === 'present') st = "Có mặt";
        else if (item.status === 'absent_perm') st = "Vắng CP";

        body.push([
            { text: item.timestamp, fontSize: 9 },
            { text: item.student_name, fontSize: 9 },
            { text: item.group_id, fontSize: 9, alignment: 'center' },
            { text: st, fontSize: 9 },
            { text: item.reason || "", fontSize: 9 },
            { text: item.recorded_by, fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'BÁO CÁO LỊCH SỬ ĐIỂM DANH', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto', '*', 'auto'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Lich_Su_Diem_Danh_${new Date().getTime()}.pdf`);
}

function exportPdfStudents() {
    if (currentStudentView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");
    
    const body = [
        [
            { text: 'Họ và Tên', bold: true, style: 'tableHeader' },
            { text: 'Giới tính', bold: true, style: 'tableHeader' },
            { text: 'Ngày sinh', bold: true, style: 'tableHeader' },
            { text: 'Lớp', bold: true, style: 'tableHeader' },
            { text: 'Nhóm', bold: true, style: 'tableHeader' },
            { text: 'Trường', bold: true, style: 'tableHeader' },
            { text: 'SĐT', bold: true, style: 'tableHeader' }
        ]
    ];

    currentStudentView.forEach(st => {
        body.push([
            { text: st.fullname || "", fontSize: 9 },
            { text: st.gender || "", fontSize: 9 },
            { text: st.dob || "", fontSize: 9 },
            { text: st.class_name || "", fontSize: 9 },
            { text: st.group_display || "", fontSize: 9 },
            { text: st.school || "", fontSize: 9 },
            { text: st.phone || "", fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'DANH SÁCH HỌC SINH', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['*', 'auto', 'auto', 'auto', 'auto', '*', 'auto'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Danh_Sach_Hoc_Sinh_${new Date().getTime()}.pdf`);
}

function exportPdfEvaluations() {
    if (currentEvaluationView.length === 0) return toastr.warning("Không có dữ liệu để xuất!");
    
    const body = [
        [
            { text: 'Họ và Tên', bold: true, style: 'tableHeader' },
            { text: 'Nhóm', bold: true, style: 'tableHeader' },
            { text: 'Kỷ luật', bold: true, style: 'tableHeader' },
            { text: 'Tích cực', bold: true, style: 'tableHeader' },
            { text: 'Tình nguyện', bold: true, style: 'tableHeader' },
            { text: 'Xếp loại', bold: true, style: 'tableHeader' }
        ]
    ];

    currentEvaluationView.forEach(e => {
        body.push([
            { text: e.name || "", fontSize: 9 },
            { text: e.group || "", fontSize: 9 },
            { text: e.disc || "", fontSize: 9 },
            { text: e.pos || "", fontSize: 9 },
            { text: e.vol || "", fontSize: 9 },
            { text: e.class || "", fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'TỔNG HỢP ĐÁNH GIÁ', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['*', 'auto', '*', '*', '*', 'auto'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Tong_Hop_Danh_Gia_${new Date().getTime()}.pdf`);
}

function exportPdfManagers() {
    if (globalUsersData.length === 0) return toastr.warning("Không có dữ liệu tài khoản!");
    
    const body = [
        [
            { text: 'Username', bold: true, style: 'tableHeader' },
            { text: 'Họ tên', bold: true, style: 'tableHeader' },
            { text: 'Nhóm', bold: true, style: 'tableHeader' },
            { text: 'Quyền', bold: true, style: 'tableHeader' },
            { text: 'Email', bold: true, style: 'tableHeader' },
            { text: 'SĐT', bold: true, style: 'tableHeader' }
        ]
    ];

    globalUsersData.forEach(m => {
        body.push([
            { text: m.username || "", fontSize: 9 },
            { text: m.fullname || "", fontSize: 9 },
            { text: m.group_id || "N/A", fontSize: 9 },
            { text: m.role || "", fontSize: 9 },
            { text: m.email || "", fontSize: 9 },
            { text: m.phone || "", fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'DANH SÁCH TÀI KHOẢN QUẢN LÝ', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto', '*', 'auto'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Danh_Sach_Tai_Khoan_${new Date().getTime()}.pdf`);
}

function exportPdfGroups() {
    if (globalGroupsData.length === 0) return toastr.warning("Không có dữ liệu nhóm!");
    
    const body = [
        [
            { text: 'Mã Nhóm', bold: true, style: 'tableHeader' },
            { text: 'Tên Nhóm', bold: true, style: 'tableHeader' }
        ]
    ];

    globalGroupsData.forEach(g => {
        body.push([
            { text: g.group_id || "", fontSize: 10, alignment: 'center' },
            { text: g.group_name || "", fontSize: 10 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'DANH SÁCH NHÓM SINH HOẠT', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['auto', '*'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Danh_Sach_Nhom_${new Date().getTime()}.pdf`);
}

function exportPdfNotifications() {
    if (globalNotisData.length === 0) return toastr.warning("Không có dữ liệu thông báo!");
    
    const body = [
        [
            { text: 'ID', bold: true, style: 'tableHeader' },
            { text: 'Tiêu đề', bold: true, style: 'tableHeader' },
            { text: 'Thời gian', bold: true, style: 'tableHeader' },
            { text: 'Hình thức', bold: true, style: 'tableHeader' },
            { text: 'Gửi tới', bold: true, style: 'tableHeader' }
        ]
    ];

    globalNotisData.forEach(n => {
        let target = "Tất cả";
        if (n.target_group && n.target_group !== 'ALL') {
            const group = globalGroupsData.find(g => g.group_id === n.target_group);
            target = group ? `Nhóm ${group.group_name}` : `Nhóm ${n.target_group}`;
        }
        body.push([
            { text: n.id || "", fontSize: 9 },
            { text: n.title || "", fontSize: 9 },
            { text: n.datetime || "", fontSize: 9 },
            { text: n.type || "Thường", fontSize: 9 },
            { text: target, fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'DANH SÁCH THÔNG BÁO', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['auto', '*', 'auto', 'auto', 'auto'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Danh_Sach_Thong_Bao_${new Date().getTime()}.pdf`);
}

function exportPdfFeedbacks() {
    if (globalFeedbacksData.length === 0) return toastr.warning("Không có dữ liệu phản ánh!");
    
    const body = [
        [
            { text: 'Thời gian', bold: true, style: 'tableHeader' },
            { text: 'Người gửi', bold: true, style: 'tableHeader' },
            { text: 'Nội dung', bold: true, style: 'tableHeader' },
            { text: 'Phản hồi', bold: true, style: 'tableHeader' }
        ]
    ];

    globalFeedbacksData.forEach(fb => {
        const content = `Tiêu đề: ${fb.title}\nKhó khăn: ${fb.difficulty || 'Không'}\nKiến nghị: ${fb.suggestion || 'Không'}`;
        const reply = fb.reply ? fb.reply.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '') : 'Chưa có'; // Clean HTML
        body.push([
            { text: fb.timestamp || "", fontSize: 9 },
            { text: `${fb.fullname || 'Vô danh'} (Nhóm ${fb.group_id})`, fontSize: 9 },
            { text: content, fontSize: 9 },
            { text: reply, fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'DANH SÁCH PHẢN ÁNH & KIẾN NGHỊ', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['auto', 'auto', '*', '*'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`Danh_Sach_Phan_Anh_${new Date().getTime()}.pdf`);
}

function exportPdfLogs() {
    if (globalLogsData.length === 0) return toastr.warning("Không có dữ liệu logs!");
    
    const body = [
        [
            { text: 'Thời gian', bold: true, style: 'tableHeader' },
            { text: 'Tài khoản', bold: true, style: 'tableHeader' },
            { text: 'Hành động', bold: true, style: 'tableHeader' },
            { text: 'Chi tiết', bold: true, style: 'tableHeader' }
        ]
    ];

    globalLogsData.forEach(log => {
        body.push([
            { text: log.timestamp || "", fontSize: 9 },
            { text: log.username || "", fontSize: 9 },
            { text: log.action || "", fontSize: 9 },
            { text: log.details || "", fontSize: 9 }
        ]);
    });

    const docDefinition = {
        content: [
            { text: 'NHẬT KÝ HỆ THỐNG', style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
            { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
            { table: { headerRows: 1, widths: ['auto', 'auto', 'auto', '*'], body: body } }
        ],
        styles: { header: { fontSize: 16, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
    };
    pdfMake.createPdf(docDefinition).download(`System_Logs_${new Date().getTime()}.pdf`);
}

async function backupSystem() {
    const captchaInput = $('#captcha_input_backup').val().trim();
    const captchaCode = $('#captcha_code_backup').text().trim();
    if (captchaInput.toUpperCase() !== captchaCode) {
        return toastr.error("Mã xác nhận không đúng!");
    }

    const user = JSON.parse(sessionStorage.getItem('user'));
    Swal.fire({ title: 'Đang tạo bản sao lưu...', text: 'Vui lòng chờ, quá trình này có thể mất vài giây.', didOpen: () => Swal.showLoading() });
    
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            redirect: "follow",
            body: JSON.stringify({ 
                action: "BACKUP_SYSTEM", 
                payload: { admin_user: user.username } 
            }) 
        });
        const res = await response.json();
        
        if (res.status === 'success') {
            const wb = XLSX.utils.book_new();
            const data = res.data;
            
            for (const [sheetName, sheetData] of Object.entries(data)) {
                if (sheetData && sheetData.length > 0) {
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                }
            }
            
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
            XLSX.writeFile(wb, `FULL_BACKUP_SHH_${timestamp}.xlsx`);
            
            Swal.fire('Thành công', 'Đã tải xuống file sao lưu toàn bộ hệ thống!', 'success');
        } else {
            Swal.fire('Lỗi', res.message, 'error');
        }
    } catch (e) {
        console.error(e);
        Swal.fire('Lỗi', 'Lỗi kết nối Server khi backup', 'error');
    }
}

function downloadTemplateAdmin() {
    const data = [
        { "Họ và Tên": "Nguyễn Văn A", "Giới tính": "Nam", "Ngày sinh": "20/10/2010", "Nhóm": "1", "Trường học": "THCS A", "SĐT": "0909123456", "Địa chỉ": "123 Đường ABC" },
        { "Họ và Tên": "Trần Thị B", "Giới tính": "Nữ", "Ngày sinh": "01/01/2011", "Nhóm": "2", "Trường học": "THCS B", "SĐT": "0909654321", "Địa chỉ": "456 Đường XYZ" }
    ];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
    XLSX.writeFile(wb, `Mau_Nhap_Lieu_Admin_Full.xlsx`);
}
 
function uploadFileGeneric(source) {
    const fileInput = document.getElementById('file_upload_generic');
    const file = fileInput.files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");
    
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File quá lớn! Giới hạn: ${globalMaxUploadSize}MB`);
    }

    // Show Modal
    $('#uploadFileName').text(file.name);
    $('#uploadProgressBar').css('width', '0%').text('0%');
    $('#uploadProgressText').text('Đang đọc file...');
    $('#modalUploadProgress').modal('show');

    const reader = new FileReader();
    
    reader.onprogress = function(e) {
        if (e.lengthComputable) {
            updateUploadModal((e.loaded / e.total) * 100, e.loaded, e.total, 'Đang đọc dữ liệu...');
        }
    };

    reader.onload = function(e) {
        const base64 = e.target.result;
        const user = JSON.parse(sessionStorage.getItem('user'));
        
        const payload = { 
            action: "UPLOAD_FILE", 
            payload: { 
                uploader: user.username, 
                group_id: 'ADMIN', 
                filename: file.name, 
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB', 
                data: base64,
                type: 'FILE'
            } 
        };

        uploadFileWithProgress(payload, (res) => {
            $('#modalUploadProgress').modal('hide');
            if (res.status === 'success') {
                Swal.fire('Thành công', 'File đã được tải lên!', 'success');
                fileInput.value = '';
                loadUploadedFiles();
            } else Swal.fire('Lỗi', res.message, 'error');
        }, (err) => {
            $('#modalUploadProgress').modal('hide');
            Swal.fire('Lỗi', err, 'error');
        });
    };
    reader.readAsDataURL(file);
}

function uploadFileWithProgress(payload, onSuccess, onError) {
    // Sử dụng fetch thay vì XMLHttpRequest để tránh lỗi Network Error/CORS với Google Apps Script
    // Giả lập progress bar vì fetch không hỗ trợ upload progress
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        if (progress > 90) progress = 90;
        updateUploadModal(progress, 0, 0, 'Đang tải lên server...');
    }, 500);

    fetch(API_URL, {
        method: "POST",
        redirect: "follow",
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(res => {
        clearInterval(interval);
        updateUploadModal(100, 0, 0, 'Hoàn tất!');
        onSuccess(res);
    })
    .catch(err => {
        clearInterval(interval);
        onError("Lỗi kết nối mạng hoặc file quá lớn.");
    });
}

function updateUploadModal(percent, loaded, total, statusText) {
    const p = Math.round(percent);
    $('#uploadProgressBar').css('width', p + '%').text(p + '%');
    const loadedMB = (loaded / 1024 / 1024).toFixed(2);
    const totalMB = (total / 1024 / 1024).toFixed(2);
    $('#uploadProgressText').html(`${statusText}<br><b>${loadedMB} MB</b> / <b>${totalMB} MB</b>`);
}

async function loadUploadedFiles() {
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_UPLOADS" }) });
        const res = await response.json();
        if (res.status === 'success') {
            let html = '';
            res.data.forEach(f => {
                const isLink = f.type === 'LINK';
                const icon = isLink ? '<i class="fab fa-google-drive text-success fa-lg"></i>' : '<i class="fas fa-file-alt text-primary fa-lg"></i>';
                const content = isLink 
                    ? `<a href="${f.data}" target="_blank" class="font-weight-bold text-success">${f.data}</a>` 
                    : `<a href="${f.data}" download="${f.filename}" class="font-weight-bold">${f.filename}</a> <small class="text-muted">(${f.size})</small>`;

                html += `<tr>
                    <td class="d-none d-md-table-cell"><small>${f.timestamp}</small></td>
                    <td class="font-weight-bold text-primary">${f.uploader}</td>
                    <td class="d-none d-md-table-cell"><span class="badge badge-secondary">${f.group_id}</span></td>
                    <td class="text-center d-none d-md-table-cell">${icon}</td>
                    <td>${content}</td>
                    <td><button class="btn btn-xs btn-danger" onclick="deleteData('uploads', '${f.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            $('#uploadedFilesList').html(html || '<tr><td colspan="6" class="text-center">Chưa có dữ liệu</td></tr>');
        }
    } catch (e) { console.error(e); }
}

function processImportAdminTab() {
    const file = document.getElementById('file_import').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");
    
    // Check size limit
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File quá lớn! Giới hạn cho phép là ${globalMaxUploadSize}MB.`);
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if (jsonData.length === 0) return toastr.warning("File rỗng!");

        // Map data to standard format
        const mappedData = jsonData.map(row => ({
            fullname: row["Họ và Tên"] || "",
            gender: row["Giới tính"] || "",
            dob: row["Ngày sinh"] || "",
            class_name: row["Lớp"] || "",
            group_id: String(row["Nhóm"] || "").trim(),
            school: row["Trường học"] || "",
            phone: row["SĐT"] || "",
            address: row["Địa chỉ"] || "",
            reg_time: row["Thời gian"] || "",
            reg_loc: row["Địa điểm"] || "",
            reg_act: row["Hoạt động"] || ""
        })).filter(item => item.fullname && item.group_id); // Filter invalid rows

        if (mappedData.length === 0) return toastr.warning("Không tìm thấy dữ liệu hợp lệ (Cần có Tên và Nhóm)!");

        Swal.fire({ title: 'Đang nhập liệu...', didOpen: () => Swal.showLoading() });
        const user = JSON.parse(sessionStorage.getItem('user'));
        fetch(API_URL, {
            method: "POST",
            redirect: "follow",
            body: JSON.stringify({ 
                action: "IMPORT_STUDENTS", 
                payload: { students: mappedData, admin_user: user.username } 
            })
        })
        .then(r => r.json())
        .then(res => {
            if (res.status === 'success') {
                Swal.fire('Thành công', res.message, 'success');
                $('#modalImport').modal('hide');
                loadStudents();
            } else Swal.fire('Lỗi', res.message, 'error');
        })
        .catch(() => Swal.fire('Lỗi', 'Lỗi kết nối', 'error'));
    };
    reader.readAsArrayBuffer(file);
}

function openImportModal(context) {
    if (context === 'admin') {
        $('#btnDownloadTemplate').attr('onclick', 'downloadTemplateAdmin()');
        $('#btnProcessImport').attr('onclick', 'processImportAdminTab()');
    }
    $('#modalImport').modal('show');
    $('#file_import').val('');
}

function processRestore() {
    const captchaInput = $('#captcha_input_restore').val().trim();
    const captchaCode = $('#captcha_code_restore').text().trim();
    if (captchaInput.toUpperCase() !== captchaCode) {
        return toastr.error("Mã xác nhận không đúng!");
    }

    const file = document.getElementById('file_restore').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file backup!");

    Swal.fire({
        title: 'Bạn có chắc chắn?',
        text: "Toàn bộ dữ liệu hiện tại sẽ bị ghi đè. Hành động này không thể hoàn tác!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Vâng, phục hồi ngay!',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const restoreData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (sheetData.length > 0) {
                            restoreData[sheetName] = sheetData;
                        }
                    });

                    if (Object.keys(restoreData).length === 0) {
                        return Swal.fire('Lỗi', 'File backup rỗng hoặc không hợp lệ.', 'error');
                    }

                    Swal.fire({ title: 'Đang phục hồi...', text: 'Vui lòng không đóng trang.', didOpen: () => Swal.showLoading() });

                    const user = JSON.parse(sessionStorage.getItem('user'));
                    fetch(API_URL, {
                        method: "POST",
                        redirect: "follow",
                        body: JSON.stringify({ 
                            action: "RESTORE_SYSTEM", 
                            payload: { data: restoreData, admin_user: user.username } 
                        })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'success') {
                            Swal.fire('Thành công!', 'Hệ thống đã được phục hồi. Trang sẽ được tải lại.', 'success').then(() => window.location.reload());
                            $('#modalRestore').modal('hide');
                        } else Swal.fire('Lỗi', res.message, 'error');
                    })
                    .catch(() => Swal.fire('Lỗi', 'Lỗi kết nối khi phục hồi.', 'error'));
                } catch (err) { Swal.fire('Lỗi', 'Đã xảy ra lỗi khi đọc file backup. File có thể bị hỏng.', 'error'); console.error(err); }
            };
            reader.readAsArrayBuffer(file);
        }
    });
}

function openPollModal() {
    $('#modalPoll').modal('show');
    $('#poll_question, #poll_options, #poll_deadline').val('');
}

function openEvalConfigModal() {
    $('#modalEvalConfig').modal('show');
}

async function createPoll() {
    const question = $('#poll_question').val().trim();
    const optionsStr = $('#poll_options').val().trim();
    const deadline = $('#poll_deadline').val();

    if (!question || !optionsStr || !deadline) return toastr.warning("Vui lòng nhập đầy đủ thông tin!");

    const options = optionsStr.split(',').map(s => s.trim()).filter(s => s);
    if (options.length < 2) return toastr.warning("Cần ít nhất 2 lựa chọn!");

    const pollContent = JSON.stringify({ question: question, options: options, deadline: deadline });
    const pollId = 'POLL' + new Date().getTime();
    
    // Save as Notification with type 'poll'
    // ID, Title, Content, DateTime, Early, CreatedAt, Readers, Type, Location, Attachment, AttachmentName
    const dataArr = [pollId, question, pollContent, deadline, 'FALSE', new Date().toLocaleString(), "", 'poll', '', '', ''];

    Swal.fire({ title: 'Đang tạo bình chọn...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "ADD_DATA", payload: { type: 'notifications', data: dataArr } }) });
        const res = await response.json();
        if (res.status === 'success') {
            $('#modalPoll').modal('hide');
            Swal.fire('Thành công', 'Đã tạo bình chọn!', 'success');
            refreshAll();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function viewPollResults(pollId) {
    Swal.fire({ title: 'Đang tải kết quả...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_POLL_RESULTS", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const counts = res.data;
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let html = `<div class="text-left">`;
            for (const [opt, count] of Object.entries(counts)) {
                const percent = total === 0 ? 0 : Math.round((count / total) * 100);
                html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between small"><span>${opt}</span><span>${count} phiếu (${percent}%)</span></div>
                    <div class="progress" style="height: 10px;"><div class="progress-bar bg-success" style="width: ${percent}%"></div></div>
                </div>`;
            }
            html += `</div>`;
            Swal.fire({ title: `Kết quả (${total} phiếu)`, html: html });
        } else Swal.fire('Lỗi', 'Không thể tải kết quả', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function exportPollPdf(pollId, title) {
    Swal.fire({ title: 'Đang xuất PDF...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_POLL_VOTES", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const data = res.data;
            if (data.length === 0) return Swal.fire('Thông báo', 'Chưa có dữ liệu bình chọn nào.', 'info');
            
            const body = [
                [
                    { text: 'Thời gian', bold: true, style: 'tableHeader' },
                    { text: 'Quản lý', bold: true, style: 'tableHeader' },
                    { text: 'Nhóm', bold: true, style: 'tableHeader' },
                    { text: 'Học sinh', bold: true, style: 'tableHeader' },
                    { text: 'Lựa chọn', bold: true, style: 'tableHeader' }
                ]
            ];

            data.forEach(v => {
                body.push([
                    { text: v.timestamp || "", fontSize: 9 },
                    { text: v.manager || "", fontSize: 9 },
                    { text: v.group_id || "", fontSize: 9 },
                    { text: v.student_name || "", fontSize: 9 },
                    { text: v.option || "", fontSize: 9 }
                ]);
            });

            const docDefinition = {
                content: [
                    { text: `KẾT QUẢ BÌNH CHỌN: ${title}`, style: 'header', alignment: 'center', margin: [0, 0, 0, 10] },
                    { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, alignment: 'right', fontSize: 9, margin: [0, 0, 0, 10] },
                    { table: { headerRows: 1, widths: ['auto', 'auto', 'auto', '*', '*'], body: body } }
                ],
                styles: { header: { fontSize: 14, bold: true }, tableHeader: { fontSize: 10, fillColor: '#eeeeee' } }
            };
            pdfMake.createPdf(docDefinition).download(`Binh_Chon_${title.replace(/\s+/g, '_')}.pdf`);
            Swal.close();
        } else Swal.fire('Lỗi', 'Không thể tải dữ liệu', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// PWA Install Logic
let deferredPrompt;
const installNav = document.getElementById('installPwaNav');
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if(installNav) installNav.style.display = 'block';
});

async function installPwa() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        if(installNav) installNav.style.display = 'none';
    }
}
window.addEventListener('appinstalled', () => {
    if(installNav) installNav.style.display = 'none';
});

// --- CONNECTION STATUS LOGIC ---
function updateConnectionStatus() {
    const statusEl = document.getElementById('connection-status');
    const iconEl = document.getElementById('conn-icon');
    const textEl = document.getElementById('conn-text');
    const msEl = document.getElementById('conn-ms');
    
    if(!statusEl) return;
    if (!navigator.onLine) { setConnStatus('offline', 'Mất kết nối', '--'); return; }

    const start = Date.now();
    fetch('manifest.json?t=' + start, { method: 'HEAD', cache: 'no-store' })
    .then(() => {
        const latency = Date.now() - start;
        if (latency < 300) setConnStatus('online', 'Tốt', latency + 'ms');
        else if (latency < 1000) setConnStatus('slow', 'Trung bình', latency + 'ms');
        else setConnStatus('offline', 'Yếu', latency + 'ms');
    })
    .catch(() => setConnStatus('offline', 'Lỗi mạng', '--'));
}

function setConnStatus(type, text, ms) {
    const el = document.getElementById('connection-status');
    const icon = document.getElementById('conn-icon');
    const txt = document.getElementById('conn-text');
    const badge = document.getElementById('conn-ms');
    
    // Create Blocking Overlay if not exists
    let blockOverlay = document.getElementById('connection-block-overlay');
    if (!blockOverlay) {
        blockOverlay = document.createElement('div');
        blockOverlay.id = 'connection-block-overlay';
        blockOverlay.style.cssText = 'display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; backdrop-filter: blur(5px);';
        blockOverlay.innerHTML = '<i class="fas fa-wifi fa-4x mb-4 text-danger" style="animation: pulse 2s infinite"></i><h3 class="font-weight-bold">KẾT NỐI KHÔNG ỔN ĐỊNH</h3><p class="lead">Hệ thống yêu cầu mạng ổn định để đảm bảo dữ liệu.</p><button class="btn btn-danger font-weight-bold mt-3" onclick="updateConnectionStatus()"><i class="fas fa-sync mr-2"></i>Thử lại kết nối</button>';
        document.body.appendChild(blockOverlay);
    }

    el.style.display = 'flex';
    txt.innerText = text; badge.innerText = ms;
    el.style.border = '1px solid rgba(255,255,255,0.1)'; el.style.background = 'rgba(0, 0, 0, 0.7)';
    
    if(type === 'online') { 
        icon.className = 'fas fa-wifi'; badge.className = 'ml-2 badge badge-success'; el.style.borderColor = '#28a745'; icon.style.color = '#28a745';
        blockOverlay.style.display = 'none';
    } else if(type === 'slow') { 
        icon.className = 'fas fa-network-wired'; badge.className = 'ml-2 badge badge-warning'; el.style.borderColor = '#ffc107'; icon.style.color = '#ffc107';
        blockOverlay.style.display = 'none';
    } else { 
        icon.className = 'fas fa-exclamation-triangle'; badge.className = 'ml-2 badge badge-danger'; el.style.borderColor = '#dc3545'; el.style.background = 'rgba(50, 0, 0, 0.8)'; icon.style.color = '#dc3545';
        blockOverlay.style.display = 'flex';
    }
}

setInterval(updateConnectionStatus, 5000);
window.addEventListener('load', updateConnectionStatus);
window.addEventListener('online', updateConnectionStatus);
window.addEventListener('offline', () => setConnStatus('offline', 'Mất kết nối', '--'));
</script>
</body>
</html>