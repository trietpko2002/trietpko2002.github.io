<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gemini AI Music Assistant Pro</title>
    <style>
        body { background: #121212; color: white; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .player-box { background: #1e1e1e; padding: 40px; border-radius: 25px; width: 400px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #visualizer { width: 100%; height: 60px; background: #282828; margin: 20px 0; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .bar { width: 6px; height: 15px; background: #1DB954; margin: 2px; border-radius: 5px; transition: 0.3s; }
        .btn-mic { background: #1DB954; border: none; padding: 20px; border-radius: 50%; cursor: pointer; font-size: 28px; color: white; transition: 0.3s; box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3); }
        .btn-mic:hover { transform: scale(1.1); background: #1ed760; }
        .btn-mic:disabled { background: #555; cursor: not-allowed; }
        #song-info { margin: 15px 0; font-weight: bold; font-size: 1.1em; color: #1DB954; min-height: 1.5em; }
        #hidden-player { position: absolute; visibility: hidden; width: 0; height: 0; }
        .hint { color: #888; font-size: 0.85em; margin-top: 15px; line-height: 1.6; }
    </style>
</head>
<body>

    <div class="player-box">
        <h2>Gemini Music</h2>
        <div id="visualizer">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div id="song-info">Sáºµn sÃ ng...</div>
        <button class="btn-mic" id="micBtn" onclick="startVoice()">ðŸŽ¤</button>
        <div class="hint">
            NÃ³i: "Báº­t bÃ i [TÃªn bÃ i hÃ¡t]"<br>
            Hoáº·c: "Dá»«ng nháº¡c", "Tiáº¿p tá»¥c"
        </div>
    </div>

    <div id="hidden-player"></div>

    <script>
        const GEMINI_KEY = "AIzaSyA64SQxPU_c3RPTnxC7hLFVoSPl26UV-G8";
        const YOUTUBE_KEY = "AIzaSyC4vRYZrUOC3mFZUVSSsIJxGZNxY1E0JY8";
        let player;

        // Load YouTube API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('hidden-player', {
                height: '0', width: '0',
                events: { 'onStateChange': onPlayerStateChange }
            });
        }

        function onPlayerStateChange(e) {
            animateBars(e.data === YT.PlayerState.PLAYING);
        }

        async function startVoice() {
            const micBtn = document.getElementById('micBtn');
            const info = document.getElementById('song-info');
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ nháº­n diá»‡n giá»ng nÃ³i.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'vi-VN';
            
            recognition.onstart = () => {
                micBtn.disabled = true;
                info.innerText = "Äang nghe...";
            };

            recognition.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                info.innerText = `Äang xá»­ lÃ½: "${text}"`;
                
                try {
                    // 1. DÃ¹ng Gemini Ä‘á»ƒ phÃ¢n tÃ­ch hÃ nh Ä‘á»™ng
                    const aiResponse = await askGemini(text);
                    console.log("AI Response:", aiResponse);

                    if (aiResponse.includes("ACTION_STOP")) {
                        player.pauseVideo();
                        info.innerText = "ÄÃ£ dá»«ng nháº¡c.";
                    } else if (aiResponse.includes("ACTION_RESUME")) {
                        player.playVideo();
                        info.innerText = "Tiáº¿p tá»¥c phÃ¡t.";
                    } else if (aiResponse !== "None") {
                        // 2. TÃ¬m vÃ  phÃ¡t nháº¡c
                        const videoId = await searchYouTube(aiResponse);
                        if (videoId) {
                            player.loadVideoById(videoId);
                            info.innerText = "Äang phÃ¡t: " + aiResponse;
                        } else {
                            info.innerText = "KhÃ´ng tÃ¬m tháº¥y bÃ i hÃ¡t nÃ y.";
                        }
                    } else {
                        info.innerText = "KhÃ´ng hiá»ƒu yÃªu cáº§u.";
                    }
                } catch (err) {
                    info.innerText = "Lá»—i káº¿t ná»‘i API.";
                    console.error(err);
                }
            };

            recognition.onend = () => { micBtn.disabled = false; };
            recognition.start();
        }

        async function askGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
            const instruction = `Báº¡n lÃ  trá»£ lÃ½ Ä‘iá»u khiá»ƒn nháº¡c. HÃ£y phÃ¢n tÃ­ch cÃ¢u: "${prompt}".
                - Náº¿u lÃ  yÃªu cáº§u phÃ¡t nháº¡c: Tráº£ vá» duy nháº¥t "TÃªn bÃ i hÃ¡t - Ca sÄ©".
                - Náº¿u yÃªu cáº§u dá»«ng/ngá»«ng: Tráº£ vá» "ACTION_STOP".
                - Náº¿u yÃªu cáº§u tiáº¿p tá»¥c/phÃ¡t láº¡i: Tráº£ vá» "ACTION_RESUME".
                - KhÃ¡c: Tráº£ vá» "None".
                Chá»‰ tráº£ vá» text ngáº¯n gá»n, khÃ´ng giáº£i thÃ­ch.`;

            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: instruction }] }] })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text.trim();
        }

        async function searchYouTube(query) {
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=1&key=${YOUTUBE_KEY}`;
            const res = await fetch(url);
            const data = await res.json();
            return data.items?.[0]?.id?.videoId || null;
        }

        function animateBars(play) {
            const bars = document.querySelectorAll('.bar');
            bars.forEach(bar => {
                bar.style.animation = play ? `wave ${0.4 + Math.random()}s infinite alternate` : 'none';
            });
        }
    </script>

    <style>
        @keyframes wave { from { height: 10px; } to { height: 50px; } }
    </style>
</body>
</html>