<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sinh hoạt hè - Nhóm</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .info-box-content { justify-content: center; }
        .table thead th { background-color: #f4f6f9; color: #333; border-top: none; text-align: center; }
        .table td, .table th { vertical-align: middle; padding: 12px 8px; }
        .btn-group-toggle .btn { padding: 0.35rem 0.5rem; font-size: 0.8rem; }
        .card-title { font-weight: bold; }
        @media (max-width: 576px) {
            .btn-group-toggle { display: flex; width: 100%; }
            .btn-group-toggle .btn { flex: 1; }
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">

<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user) { window.location.replace('login.html'); }
    })();
    function logout() { sessionStorage.clear(); window.location.replace('login.html'); }
</script>

<div class="wrapper">
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown user-menu">
                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
                    <img src="" class="user-image img-circle elevation-2" id="userAvatar" alt="User">
                    <span class="d-none d-md-inline" id="managerDisplayName">Quản lý</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <li class="user-header bg-primary">
                        <img src="" class="img-circle elevation-2" id="userAvatarInner">
                        <p id="managerFullName">Quản lý SHH</p>
                        <small id="userGroupDisplay">Nhóm: ...</small>
                    </li>
                    <li class="user-footer">
                        <a href="javascript:void(0)" onclick="logout()" class="btn btn-default btn-flat float-right text-danger">Đăng xuất</a>
                    </li>
                </ul>
            </li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <div class="sidebar">
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="info text-white">HỆ THỐNG QUẢN LÝ</div>
            </div>
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                    <li class="nav-item">
                        <a href="#tab-attendance" class="nav-link active" data-toggle="pill">
                            <i class="nav-icon fas fa-check-square"></i> <p>Điểm danh</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-students" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-user-friends"></i> <p>HS của nhóm</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <div class="content-wrapper text-sm">
        <div class="tab-content p-3">
            <div class="tab-pane fade show active" id="tab-attendance">
                <div class="callout callout-info mb-3 shadow-sm">
                    <h5><i class="fas fa-calendar-alt mr-2"></i>Hôm nay: <span id="currentDateDisplay"></span></h5>
                    <p class="text-muted mb-0">Chọn trạng thái cho từng học sinh và nhấn "Lưu kết quả".</p>
                </div>
                <div id="attendanceList" class="row">
                    <div class="col-12 text-center p-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
                </div>
                <button class="btn btn-success btn-block mt-4 shadow py-3" onclick="submitAttendance()">
                    <i class="fas fa-paper-plane mr-2"></i><b>LƯU KẾT QUẢ ĐIỂM DANH</b>
                </button>
            </div>

            <div class="tab-pane fade" id="tab-students">
                <div class="card card-outline card-primary shadow">
                    <div class="card-header d-flex align-items-center">
                        <h3 class="card-title text-uppercase flex-grow-1">
                            <i class="fas fa-table mr-2"></i>Danh sách học sinh <span class="text-primary" id="groupBadge">...</span>
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-success btn-sm shadow-sm" onclick="exportExcel()">
                                <i class="fas fa-file-excel mr-1"></i> Xuất Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-bordered table-hover text-nowrap mb-0" id="excelTable">
                            <thead>
                                <tr class="text-center">
                                    <th width="50">STT</th>
                                    <th>Họ và Tên</th>
                                    <th>Ngày sinh</th>
                                    <th>Trường học</th>
                                    <th>Địa chỉ liên hệ</th>
                                    <th>Số điện thoại PH</th>
                                </tr>
                            </thead>
                            <tbody id="groupStudentList">
                                <tr><td colspan="6" class="text-center p-4">Đang tải dữ liệu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";

// Hàm hỗ trợ định dạng ngày tháng dd/mm/yyyy
function formatDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; // Trả về gốc nếu không phải định dạng ngày
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    } catch (e) {
        return dateStr;
    }
}

document.addEventListener("DOMContentLoaded", function() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const avatarUrl = user.avatar || 'https://via.placeholder.com/150';
    
    document.getElementById('managerDisplayName').innerText = user.fullname;
    document.getElementById('managerFullName').innerText = user.fullname;
    document.getElementById('userAvatar').src = avatarUrl;
    document.getElementById('userAvatarInner').src = avatarUrl;
    
    const displayGroupName = user.group_name || user.group_id;
    document.getElementById('userGroupDisplay').innerText = `Nhóm: ${displayGroupName}`;
    document.getElementById('groupBadge').innerText = displayGroupName;
    
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
    
    fetchStudentsByGroup(user.group_id);
});

async function fetchStudentsByGroup(groupId) {
    const attContainer = document.getElementById('attendanceList');
    const tableBody = document.getElementById('groupStudentList');

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "GET_STUDENTS_BY_GROUP",
                payload: { group_id: groupId }
            })
        });
        const res = await response.json();

        if (res.status === "success") {
            let attHtml = '';
            let tableHtml = '';

            res.data.forEach((student, index) => {
                // Định dạng ngày sinh sang dd/mm/yyyy
                const formattedDob = formatDate(student.dob);

                attHtml += `
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="info-box shadow-sm border">
                            <div class="info-box-content">
                                <span class="info-box-text font-weight-bold" style="font-size:1.1rem">${student.fullname}</span>
                                <div class="btn-group btn-group-toggle mt-2" data-toggle="buttons">
                                    <label class="btn btn-outline-success active"><input type="radio" name="st_${student.id}" value="present" checked> Có mặt</label>
                                    <label class="btn btn-outline-warning"><input type="radio" name="st_${student.id}" value="absent_perm"> Vắng (P)</label>
                                    <label class="btn btn-outline-danger"><input type="radio" name="st_${student.id}" value="absent"> Vắng</label>
                                </div>
                            </div>
                        </div>
                    </div>`;

                tableHtml += `
                    <tr>
                        <td class="text-center font-weight-bold">${index + 1}</td>
                        <td class="font-weight-bold">${student.fullname}</td>
                        <td class="text-center text-primary font-weight-bold">${formattedDob}</td>
                        <td>${student.school || '-'}</td>
                        <td style="white-space: normal;">${student.address || '-'}</td>
                        <td class="text-center">
                            ${student.phone ? `<a href="tel:${student.phone}" class="btn btn-xs btn-link"><i class="fas fa-phone mr-1"></i>${student.phone}</a>` : '-'}
                        </td>
                    </tr>`;
            });

            attContainer.innerHTML = attHtml || '<div class="col-12 text-center">Không có dữ liệu.</div>';
            tableBody.innerHTML = tableHtml || '<tr><td colspan="6" class="text-center">Không có dữ liệu.</td></tr>';
        }
    } catch (error) {
        toastr.error("Lỗi kết nối máy chủ.");
    }
}

// Giữ nguyên hàm submitAttendance...
async function submitAttendance() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const attendanceData = [];
    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
        attendanceData.push({ student_id: input.name.replace('st_', ''), status: input.value });
    });
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "SAVE_ATTENDANCE",
                payload: { group_id: user.group_id, recorded_by: user.fullname, attendance: attendanceData }
            })
        });
        const res = await response.json();
        if (res.status === "success") toastr.success('Lưu thành công!');
    } catch (error) { toastr.error("Lỗi lưu dữ liệu."); }
}

// XUẤT EXCEL (Dữ liệu đã được định dạng dd/mm/yyyy trong bảng HTML)
function exportExcel() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const groupName = user.group_name || user.group_id;
    const table = document.getElementById("excelTable");
    
    // Tạo workbook từ table (Nó sẽ lấy đúng nội dung dd/mm/yyyy hiển thị trên bảng)
    const wb = XLSX.utils.table_to_book(table, {sheet: "Danh sách"});
    
    XLSX.writeFile(wb, `Danh_sach_HS_${groupName.replace(/\s+/g, '_')}.xlsx`);
    toastr.info("Đang tải file Excel...");
}
</script>
</body>
</html>