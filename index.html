<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Máy bán hàng Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Public Sans', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        :root {
            --kiot-blue: #0088ff;
            --kiot-green: #00b873;
            --kiot-red: #ff4d4f;
            --kiot-yellow: #ffc107;
        }
        .bg-kiot-blue { background-color: var(--kiot-blue); }
        .bg-kiot-green { background-color: var(--kiot-green); }
        .text-kiot-blue { color: var(--kiot-blue); }
        .border-kiot-blue { border-color: var(--kiot-blue); }
        .hover\:bg-kiot-blue-dark:hover { background-color: #0073d1; }
        .hover\:bg-kiot-red-dark:hover { background-color: #d63c3e; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideInUp { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(30px) scale(0.95); opacity: 0; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-fade-out { animation: fadeOut 0.3s ease-in forwards; }
        .animate-slide-in-up { animation: slideInUp 0.3s ease-out forwards; }
        .animate-slide-out-down { animation: slideOutDown 0.3s ease-in forwards; }
        
        #barcode-scanner-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center; z-index: 9999;
        }
        #scanner-box { position: relative; width: 80%; max-width: 600px; padding-top: 50%; overflow: hidden; border-radius: 12px; }
        #barcode-scanner-video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #scanner-line { position: absolute; left: 0; top: 50%; width: 100%; height: 2px; background: red; box-shadow: 0 0 10px red; animation: scanning 2s infinite ease-in-out; }
        #close-scanner-btn { position: absolute; top: 16px; right: 16px; width: 40px; height: 40px; border-radius: 50%; background-color: rgba(0,0,0,0.5); color: white; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        @keyframes scanning { 0%, 100% { transform: translateY(-80px); } 50% { transform: translateY(80px); } }

        .modal-container { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background-color: white; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; }

        @media print {
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Courier New', Courier, monospace; font-size: 10pt; color: #000; }
            h2, h3 { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 10px; }
            p { margin: 2px 0; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { text-align: left; padding: 2px; }
            .text-right { text-align: right; }
            hr { border: none; border-top: 1px dashed #000; margin: 5px 0; }
            .total { font-weight: bold; }
            .footer { text-align: center; margin-top: 15px; border-top: 1px dashed #000; padding-top: 5px; }
        }
    </style>
</head>
<body class="bg-slate-100">

    <div id="login-screen" class="flex items-center justify-center h-screen animate-fade-in">
        <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-sm">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">Xin chào!</h1>
                <p class="text-slate-500">Đăng nhập để bắt đầu phiên làm việc</p>
            </div>
            <input type="text" id="username" value="admin" class="mt-1 block w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-kiot-blue focus:border-kiot-blue mb-4" placeholder="Tài khoản">
            <input type="password" id="password" class="mt-1 block w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-kiot-blue focus:border-kiot-blue mb-6" placeholder="Mật khẩu">
            <button id="login-button" class="w-full bg-kiot-blue text-white py-3 px-4 rounded-lg font-bold text-lg hover:bg-kiot-blue-dark transition-all duration-300 shadow-lg shadow-blue-500/30">
                Đăng Nhập <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
            <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden">Tài khoản hoặc mật khẩu không đúng!</p>
        </div>
    </div>

    <main id="main-screen" class="h-screen w-screen flex-col hidden">
        <div class="flex flex-grow h-full overflow-hidden">
            <div class="w-3/5 h-full flex flex-col bg-slate-100 p-4">
                <div class="flex items-center justify-between mb-4 flex-shrink-0">
                    <h1 class="text-2xl font-bold text-slate-800">Tạp Hóa Nguyễn A</h1>
                    <div>
                         <button id="stats-access-btn" class="text-slate-600 hover:text-kiot-blue px-3 py-1 rounded-md text-sm transition-colors">
                            <i class="fa-solid fa-chart-line mr-1"></i> Báo Cáo
                        </button>
                         <button id="admin-access-btn" class="ml-2 text-slate-600 hover:text-kiot-blue px-3 py-1 rounded-md text-sm transition-colors">
                            <i class="fa-solid fa-cogs mr-1"></i> Quản Lý
                        </button>
                        <button id="logout-button" class="ml-2 text-slate-600 hover:text-kiot-red px-3 py-1 rounded-md text-sm transition-colors">
                           <i class="fa-solid fa-sign-out-alt mr-1"></i> Đăng xuất
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-3 mb-4 flex-shrink-0">
                    <div class="relative flex-grow">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-4"><i class="fas fa-search text-slate-400"></i></span>
                        <input type="text" id="search-input" placeholder="Tìm sản phẩm (Tên hoặc Mã vạch)..." class="w-full pl-12 pr-4 py-3 border border-slate-300 rounded-lg shadow-sm bg-white focus:ring-2 focus:ring-kiot-blue focus:border-kiot-blue transition">
                    </div>
                    <button id="camera-scan-btn" class="bg-white border border-slate-300 text-slate-700 px-4 py-3 rounded-lg hover:bg-slate-50 hover:border-kiot-blue hover:text-kiot-blue transition-all duration-300 shadow-sm"><i class="fas fa-camera fa-lg"></i></button>
                </div>
                <div class="flex-grow overflow-hidden bg-white rounded-lg shadow-sm border">
                    <table class="w-full">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider w-2/4">Tên sản phẩm</th>
                                <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Tồn kho</th>
                                <th class="p-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Giá bán</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="overflow-y-auto h-[calc(100%-41px)] no-scrollbar">
                        <table class="w-full">
                            <tbody id="product-list" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="w-2/5 h-full flex flex-col bg-white p-4 shadow-[-5px_0_15px_-5px_rgba(0,0,0,0.1)]">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex-shrink-0 border-b pb-3">Hóa Đơn</h2>
                <div id="cart-items" class="flex-grow overflow-y-auto p-1 no-scrollbar">
                    <div id="empty-cart-message" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i class="fa-solid fa-cart-plus fa-3x mb-4"></i>
                        <p class="font-medium">Chưa có sản phẩm nào</p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-3 text-lg">
                        <span class="font-medium text-slate-700">Tổng cộng:</span>
                        <span id="total-price" class="text-2xl font-bold text-kiot-blue">0đ</span>
                    </div>
                    <div class="mb-3">
                        <label for="customer-cash" class="block text-sm font-medium text-slate-600 mb-1">Tiền khách đưa:</label>
                        <input type="number" id="customer-cash" placeholder="0" class="w-full text-right px-3 py-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-kiot-blue focus:border-kiot-blue text-lg font-bold">
                    </div>
                    <div class="flex justify-between items-center mb-4 text-lg">
                        <span class="font-medium text-slate-700">Tiền thối:</span>
                        <span id="change-amount" class="text-xl font-bold text-kiot-green">0đ</span>
                    </div>
                    <button id="checkout-button" class="w-full bg-kiot-green text-white py-3.5 rounded-lg font-bold text-lg hover:bg-kiot-green-dark disabled:bg-slate-400 disabled:cursor-not-allowed transition-all duration-300 shadow-lg shadow-green-500/30">
                        <i class="fas fa-cash-register mr-2"></i>Thanh Toán
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <div id="admin-screen" class="modal-container hidden">
        <div id="admin-panel-content" class="modal-content w-full max-w-4xl h-5/6">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Quản Lý Sản Phẩm</h2>
                <button id="close-admin-btn" class="text-slate-500 hover:text-slate-800 transition-colors"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="flex flex-grow overflow-hidden">
                <div class="w-1/3 p-4 border-r bg-slate-50">
                    <h3 id="admin-form-title" class="text-lg font-semibold mb-3 text-slate-700">Thêm sản phẩm mới</h3>
                    <form id="admin-product-form" class="space-y-3">
                        <input type="hidden" id="form-mode" value="add">
                        <div>
                            <label for="product-barcode" class="block text-sm font-medium text-gray-700">Mã vạch (Barcode)</label>
                            <input type="text" id="product-barcode" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-kiot-blue focus:border-kiot-blue">
                        </div>
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700">Tên sản phẩm</label>
                            <input type="text" id="product-name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-kiot-blue focus:border-kiot-blue">
                        </div>
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700">Giá bán</label>
                            <input type="number" id="product-price" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-kiot-blue focus:border-kiot-blue">
                        </div>
                        <div>
                            <label for="product-stock" class="block text-sm font-medium text-gray-700">Tồn kho</label>
                            <input type="number" id="product-stock" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-kiot-blue focus:border-kiot-blue">
                        </div>
                        <div class="pt-2 space-y-2">
                             <button type="submit" id="admin-submit-btn" class="w-full bg-kiot-blue text-white py-2 rounded-md hover:bg-kiot-blue-dark transition-colors font-semibold">
                                <i class="fas fa-plus mr-2"></i>Thêm Sản Phẩm
                            </button>
                            <button type="button" id="admin-cancel-btn" class="w-full bg-slate-300 py-2 rounded-md hover:bg-slate-400 transition-colors hidden">Hủy</button>
                        </div>
                    </form>
                </div>
                <div class="w-2/3 p-4 flex flex-col">
                    <div class="flex-grow overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-slate-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Sản phẩm</th>
                                    <th class="px-2 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Giá</th>
                                    <th class="px-2 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Kho</th>
                                    <th class="px-2 py-3"></th>
                                </tr>
                            </thead>
                            <tbody id="admin-product-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stats-screen" class="modal-container hidden">
        <div id="stats-panel-content" class="modal-content w-full max-w-6xl h-5/6">
            <div class="p-4 border-b flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold text-slate-800">Báo Cáo Bán Hàng</h2>
                <button id="close-stats-btn" class="text-slate-500 hover:text-slate-800 transition-colors"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="flex flex-col md:flex-row flex-grow overflow-hidden">
                <div class="w-full md:w-1/3 p-4 border-r bg-slate-50 space-y-4 flex-shrink-0">
                    <h3 class="text-lg font-semibold text-slate-700">Tổng Quan</h3>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600"><i class="fa-solid fa-sack-dollar fa-lg"></i></div>
                            <div class="ml-4">
                                <p class="text-sm text-slate-500">Doanh Thu Hôm Nay</p>
                                <p id="stats-today-revenue" class="text-xl font-bold text-slate-800">0đ</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                         <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600"><i class="fa-solid fa-file-invoice-dollar fa-lg"></i></div>
                            <div class="ml-4">
                                <p class="text-sm text-slate-500">Đơn Hàng Hôm Nay</p>
                                <p id="stats-today-orders" class="text-xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                         <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600"><i class="fa-solid fa-star fa-lg"></i></div>
                            <div class="ml-4">
                                <p class="text-sm text-slate-500">Sản Phẩm Bán Chạy Nhất</p>
                                <p id="stats-best-seller" class="text-lg font-bold text-slate-800 truncate">Chưa có</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-2/3 p-4 flex flex-col">
                    <h3 class="text-lg font-semibold text-slate-700 mb-3">Lịch Sử Đơn Hàng</h3>
                    <div id="order-history-list" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="order-detail-modal" class="modal-container hidden">
        <div class="modal-content w-full max-w-lg">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="order-detail-title" class="text-lg font-bold">Chi Tiết Đơn Hàng</h3>
                <button id="close-order-detail-btn" class="text-slate-500 hover:text-slate-800"><i class="fas fa-times"></i></button>
            </div>
            <div id="order-detail-content" class="p-4 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>


    <div id="barcode-scanner-container">
        <div id="scanner-box">
             <video id="barcode-scanner-video"></video>
             <div id="scanner-line"></div>
        </div>
        <button id="close-scanner-btn" title="Đóng camera"><i class="fas fa-times"></i></button>
    </div>
    <div id="receipt-print-area" class="hidden"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-[9999] flex items-center justify-center hidden">
        <i class="fas fa-spinner fa-spin text-white text-5xl"></i>
    </div>

    <div id="custom-modal" class="modal-container hidden">
        <div id="custom-modal-content" class="modal-content w-full max-w-md">
            <div class="p-5">
                <div class="text-center">
                    <div id="custom-modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"></div>
                    <h3 id="custom-modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-4"></h3>
                    <div class="mt-2">
                        <p id="custom-modal-message" class="text-sm text-gray-500"></p>
                    </div>
                </div>
            </div>
            <div id="custom-modal-buttons" class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg"></div>
        </div>
    </div>


    <script src="https://unpkg.com/@zxing/library@latest/umd/zxing.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ### API CỦA BẠN ###
        const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycby6XG-clnIv6FUE658f28wBV6aHfhZqIfgT0CMPFrTHKzczyViDwGx7zI9SgD9zsHQ/exec';
        
        const credentials = { username: 'admin', password: 'Maybanhang27!', adminCode: 'Quanly@123.!' };
        let products = [], cart = [], allOrders = [], zxingCodeReader = null;
        
        const getEl = (id) => document.getElementById(id);
        
        const loginScreen = getEl('login-screen'), mainScreen = getEl('main-screen'), adminScreen = getEl('admin-screen'), statsScreen = getEl('stats-screen'), orderDetailModal = getEl('order-detail-modal');
        const adminPanelContent = getEl('admin-panel-content'), statsPanelContent = getEl('stats-panel-content');
        const loginButton = getEl('login-button'), passwordInput = getEl('password'), loginError = getEl('login-error');
        const logoutButton = getEl('logout-button'), adminAccessBtn = getEl('admin-access-btn'), statsAccessBtn = getEl('stats-access-btn');
        const searchInput = getEl('search-input'), productList = getEl('product-list');
        const customModal = getEl('custom-modal'), customModalContent = getEl('custom-modal-content'), customModalTitle = getEl('custom-modal-title'), customModalMessage = getEl('custom-modal-message'), customModalButtons = getEl('custom-modal-buttons'), customModalIcon = getEl('custom-modal-icon');
        const cartItems = getEl('cart-items'), totalPriceEl = getEl('total-price'), emptyCartMessage = getEl('empty-cart-message'), customerCashInput = getEl('customer-cash'), changeAmountEl = getEl('change-amount'), checkoutButton = getEl('checkout-button');
        const cameraScanBtn = getEl('camera-scan-btn'), scannerContainer = getEl('barcode-scanner-container'), closeScannerBtn = getEl('close-scanner-btn');
        const closeAdminBtn = getEl('close-admin-btn'), adminProductList = getEl('admin-product-list'), adminProductForm = getEl('admin-product-form'), adminFormTitle = getEl('admin-form-title'), adminSubmitBtn = getEl('admin-submit-btn'), adminCancelBtn = getEl('admin-cancel-btn');
        const productBarcode = getEl('product-barcode'), productName = getEl('product-name'), productPrice = getEl('product-price'), productStock = getEl('product-stock'), formMode = getEl('form-mode');
        const closeStatsBtn = getEl('close-stats-btn'), statsTodayRevenue = getEl('stats-today-revenue'), statsTodayOrders = getEl('stats-today-orders'), statsBestSeller = getEl('stats-best-seller'), orderHistoryList = getEl('order-history-list');
        const closeOrderDetailBtn = getEl('close-order-detail-btn'), orderDetailTitle = getEl('order-detail-title'), orderDetailContent = getEl('order-detail-content');
        const receiptPrintArea = getEl('receipt-print-area'), loadingOverlay = getEl('loading-overlay');
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const showLoading = (show) => loadingOverlay.classList.toggle('hidden', !show);
        
        // =========================================================================
        //  CUSTOM MODAL DIALOG SYSTEM
        // =========================================================================
        function showCustomModal({ title, message, type = 'info', buttons }) {
            return new Promise(resolve => {
                customModalTitle.textContent = title;
                customModalMessage.innerHTML = message;

                const iconMap = { success: { class: 'bg-green-100 text-green-600', icon: 'fa-check' }, error: { class: 'bg-red-100 text-red-600', icon: 'fa-times' }, warning: { class: 'bg-yellow-100 text-yellow-600', icon: 'fa-exclamation' }, confirm: { class: 'bg-blue-100 text-blue-600', icon: 'fa-question' }, info: { class: 'bg-blue-100 text-blue-600', icon: 'fa-info' }, };
                const theme = iconMap[type];
                customModalIcon.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${theme.class}`;
                customModalIcon.innerHTML = `<i class="fas ${theme.icon} fa-xl"></i>`;
                
                customModalButtons.innerHTML = '';
                if (!buttons) buttons = [{ text: 'OK', value: 'ok', class: 'bg-kiot-blue hover:bg-kiot-blue-dark' }];
                
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = btnInfo.text;
                    button.className = `w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm transition-colors ${btnInfo.class || ''}`;
                    button.onclick = () => { hideModal(customModal, customModalContent); resolve(btnInfo.value); };
                    customModalButtons.appendChild(button);
                });
                
                showModal(customModal, customModalContent);
            });
        }
        
        function showModal(modalElement, contentElement) {
            modalElement.classList.remove('hidden');
            modalElement.classList.add('animate-fade-in');
            if(contentElement) contentElement.classList.add('animate-slide-in-up');
        }

        function hideModal(modalElement, contentElement) {
            if (contentElement) contentElement.classList.add('animate-slide-out-down');
            modalElement.classList.add('animate-fade-out');
            modalElement.addEventListener('animationend', () => {
                modalElement.classList.add('hidden');
                modalElement.classList.remove('animate-fade-in', 'animate-fade-out');
                if(contentElement) contentElement.classList.remove('animate-slide-in-up', 'animate-slide-out-down');
            }, { once: true });
        }
        
        // =========================================================================
        //  AUTHENTICATION & CORE LOGIC
        // =========================================================================
        function handleLogin() {
            if (getEl('username').value === credentials.username && passwordInput.value === credentials.password) {
                loginError.classList.add('hidden');
                loginScreen.classList.add('animate-fade-out');
                loginScreen.addEventListener('animationend', () => {
                    loginScreen.classList.add('hidden');
                    mainScreen.classList.remove('hidden');
                    mainScreen.classList.add('flex', 'animate-fade-in');
                    fetchProducts();
                }, { once: true });
            } else {
                loginError.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            const choice = await showCustomModal({ title: 'Xác nhận Đăng xuất', message: 'Bạn có chắc chắn muốn kết thúc phiên làm việc này không?', type: 'confirm', buttons: [{ text: 'Ở lại', value: 'cancel', class: 'bg-slate-600 hover:bg-slate-700' },{ text: 'Đăng xuất', value: 'confirm', class: 'bg-kiot-red hover:bg-kiot-red-dark' }] });
            if (choice === 'confirm') {
                mainScreen.classList.add('animate-fade-out');
                mainScreen.addEventListener('animationend', () => location.reload(), { once: true });
            }
        }
        
        async function fetchProducts() {
            showLoading(true);
            productList.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-500">Đang tải sản phẩm...</td></tr>`;
            try {
                const response = await fetch(GOOGLE_SHEET_API_URL);
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
                const result = await response.json();
                if (result.status === "success") {
                    products = result.data.sort((a,b) => a.name.localeCompare(b.name));
                    renderProductList(products);
                } else { throw new Error(result.message); }
            } catch (error) {
                productList.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-red-500">Lỗi tải sản phẩm: ${error.message}.</td></tr>`;
                showCustomModal({title: 'Lỗi Tải Sản Phẩm', message: error.message, type: 'error'});
            } finally {
                showLoading(false);
            }
        }

        async function fetchOrders() {
            showLoading(true);
            orderHistoryList.innerHTML = `<p class="text-center text-slate-400 mt-8">Đang tải lịch sử...</p>`;
            try {
                const response = await fetch(`${GOOGLE_SHEET_API_URL}?action=GET_ORDERS`);
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
                const result = await response.json();
                if (result.status === "success") {
                    allOrders = result.data;
                    calculateAndRenderStatistics(allOrders);
                    renderOrderHistory(allOrders);
                } else { throw new Error(result.message); }
            } catch(error) {
                 orderHistoryList.innerHTML = `<p class="text-center text-red-500 mt-8">Lỗi tải lịch sử đơn hàng: ${error.message}.</p>`;
                 showCustomModal({title: 'Lỗi Tải Lịch Sử Đơn Hàng', message: error.message, type: 'error'});
            } finally {
                showLoading(false);
            }
        }
        
        async function postDataToAPI(payload) {
            const response = await fetch(GOOGLE_SHEET_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);
            return result;
        }

        function calculateAndRenderStatistics(orders) {
            const today = new Date().toISOString().slice(0, 10);
            const todayOrders = orders.filter(o => o.timestamp.slice(0, 10) === today);
            const todayRevenue = todayOrders.reduce((sum, order) => sum + order.totalAmount, 0);
            statsTodayRevenue.textContent = formatCurrency(todayRevenue);
            statsTodayOrders.textContent = todayOrders.length;
            statsBestSeller.textContent = "Sắp ra mắt";
        }
        
        function renderOrderHistory(orders) {
            orderHistoryList.innerHTML = '';
            if (orders.length === 0) {
                orderHistoryList.innerHTML = `<p class="text-center text-slate-400 mt-8">Chưa có đơn hàng nào.</p>`;
                return;
            }
            orders.forEach(order => {
                const el = document.createElement('div');
                el.className = 'p-3 bg-white rounded-lg shadow-sm flex items-center justify-between cursor-pointer hover:bg-slate-50';
                el.onclick = () => showOrderDetail(order.orderId);
                el.innerHTML = `<div><p class="font-bold text-slate-800">${order.orderId}</p><p class="text-sm text-slate-500">${new Date(order.timestamp).toLocaleString('vi-VN')}</p></div><div class="text-right"><p class="font-bold text-lg text-kiot-blue">${formatCurrency(order.totalAmount)}</p></div>`;
                orderHistoryList.appendChild(el);
            });
        }

        async function showOrderDetail(orderId) {
            showLoading(true);
            orderDetailContent.innerHTML = `<p class="text-center text-slate-500">Đang tải chi tiết...</p>`;
            orderDetailTitle.textContent = `Chi Tiết Đơn Hàng ${orderId}`;
            showModal(orderDetailModal);
            try {
                const response = await fetch(`${GOOGLE_SHEET_API_URL}?action=GET_ORDER_DETAILS&orderId=${orderId}`);
                if (!response.ok) throw new Error("Lỗi mạng khi tải chi tiết đơn hàng.");
                const result = await response.json();
                if (result.status === "success") {
                    const items = result.data;
                    const orderSummary = allOrders.find(o => o.orderId === orderId);
                    let contentHtml = `<table class="w-full text-sm"><thead><tr class="border-b"><th class="py-2 text-left font-semibold">Sản phẩm</th><th class="py-2 text-center font-semibold">SL</th><th class="py-2 text-right font-semibold">Thành tiền</th></tr></thead><tbody>`;
                    items.forEach(item => {
                        contentHtml += `<tr class="border-b border-dashed"><td class="py-2"><p class="font-medium">${item.name}</p><p class="text-xs text-slate-500">${formatCurrency(item.price)}</p></td><td class="py-2 text-center">${item.quantity}</td><td class="py-2 text-right font-medium">${formatCurrency(item.quantity * item.price)}</td></tr>`;
                    });
                    contentHtml += '</tbody></table>';
                    if (orderSummary) {
                        contentHtml += `<div class="mt-4 pt-3 border-t-2 border-slate-300 space-y-1 font-medium"><div class="flex justify-between"><span>Tổng cộng:</span><span class="font-bold text-lg text-kiot-blue">${formatCurrency(orderSummary.totalAmount)}</span></div><div class="flex justify-between text-slate-600"><span>Khách đưa:</span><span>${formatCurrency(orderSummary.customerCash)}</span></div><div class="flex justify-between text-slate-600"><span>Tiền thối:</span><span>${formatCurrency(orderSummary.change)}</span></div></div>`;
                    }
                    orderDetailContent.innerHTML = contentHtml;
                } else { throw new Error(result.message); }
            } catch (error) {
                orderDetailContent.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        function renderProductList(productsToRender) {
            productList.innerHTML = '';
            if (!productsToRender || productsToRender.length === 0) {
                productList.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-500">Không tìm thấy sản phẩm nào.</td></tr>`;
                return;
            }
            productsToRender.forEach(p => {
                const isOutOfStock = p.stock <= 0;
                const row = document.createElement('tr');
                row.className = `transition-colors ${isOutOfStock ? 'opacity-50 cursor-not-allowed bg-slate-50' : 'hover:bg-blue-50 cursor-pointer'}`;
                if (!isOutOfStock) row.onclick = () => addToCart(p.barcode);
                row.innerHTML = `<td class="p-3 text-sm font-semibold text-slate-700 w-2/4">${p.name}</td><td class="p-3 text-sm text-slate-600">${p.stock}</td><td class="p-3 text-sm font-bold text-kiot-blue">${formatCurrency(p.price)}</td>`;
                productList.appendChild(row);
            });
        }
        
        function updateCartUI() {
            emptyCartMessage.style.display = cart.length === 0 ? 'flex' : 'none';
            if (cart.length > 0) {
                cartItems.innerHTML = '';
                cart.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-2 mb-2 bg-slate-50 rounded-lg';
                    el.innerHTML = `<div class="flex-grow w-1/2"><p class="font-semibold text-sm truncate" title="${item.name}">${item.name}</p><p class="text-xs text-slate-500">${formatCurrency(item.price)}</p></div><div class="flex items-center space-x-2.5"><button class="bg-slate-200 w-6 h-6 rounded-md text-slate-700 text-sm hover:bg-slate-300" onclick="window.changeQuantity('${item.barcode}', -1)">-</button><span class="w-5 text-center font-bold text-sm">${item.quantity}</span><button class="bg-slate-200 w-6 h-6 rounded-md text-slate-700 text-sm hover:bg-slate-300" onclick="window.changeQuantity('${item.barcode}', 1)">+</button></div><p class="w-1/4 text-right font-bold text-sm text-slate-700">${formatCurrency(item.price * item.quantity)}</p>`;
                    cartItems.appendChild(el);
                });
            } else {
                cartItems.innerHTML = '';
                cartItems.appendChild(emptyCartMessage);
            }
            updateTotals();
        }

        function handleSearchAndScan(event) {
            const searchTerm = event.target.value.trim();
            if (event.key === 'Enter' && searchTerm) {
                const foundProduct = products.find(p => p.barcode.toLowerCase() === searchTerm.toLowerCase());
                if (foundProduct) {
                    addToCart(foundProduct.barcode);
                    event.target.value = '';
                    renderProductList(products);
                } else { 
                    showCustomModal({title: 'Không tìm thấy', message: `Không tìm thấy sản phẩm với mã vạch hoặc tên <strong>${searchTerm}</strong>.`, type: 'warning'});
                }
                return;
            }
            const filtered = products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.barcode.toLowerCase().includes(searchTerm.toLowerCase()));
            renderProductList(filtered);
        }

        function addToCart(barcode) {
            const product = products.find(p => p.barcode === barcode);
            if (!product || product.stock <= 0) return;
            const cartItem = cart.find(item => item.barcode === barcode);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    showCustomModal({title: 'Hết hàng trong kho', message: `Tồn kho của sản phẩm <strong>${product.name}</strong> không đủ.`, type: 'warning'});
                }
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            updateCartUI();
        }

        window.changeQuantity = function(barcode, change) {
            const cartItemIndex = cart.findIndex(item => item.barcode === barcode);
            if (cartItemIndex === -1) return;
            const cartItem = cart[cartItemIndex];
            const newQuantity = cartItem.quantity + change;
            if (newQuantity <= 0) {
                cart.splice(cartItemIndex, 1);
            } else {
                const product = products.find(p => p.barcode === barcode);
                if (newQuantity > product.stock) {
                    showCustomModal({title: 'Hết hàng trong kho', message: `Tồn kho của <strong>${product.name}</strong> không đủ.`, type: 'warning'});
                    cartItem.quantity = product.stock;
                } else {
                    cartItem.quantity = newQuantity;
                }
            }
            updateCartUI();
        }

        function updateTotals() {
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            totalPriceEl.textContent = formatCurrency(total);
            const customerCash = parseFloat(customerCashInput.value.replace(/,/g, '')) || 0;
            const change = customerCash - total;
            changeAmountEl.textContent = formatCurrency(change >= 0 ? change : 0);
            checkoutButton.disabled = cart.length === 0 || total <= 0;
        }
        
        function resetOrder() {
            cart = [];
            customerCashInput.value = '';
            searchInput.value = '';
            updateCartUI();
        }
        
        async function handleCheckout() {
            showLoading(true);
            const totalAmount = cart.reduce((s, i) => s + i.price * i.quantity, 0);
            const customerCash = parseFloat(customerCashInput.value.replace(/,/g, '')) || 0;
            const orderData = { items: cart.map(item => ({ barcode: item.barcode, name: item.name, quantity: item.quantity, price: item.price })), totalAmount, customerCash, change: customerCash - totalAmount };
            try {
                const result = await postDataToAPI({ action: 'CREATE_ORDER', data: orderData });
                generateReceipt(orderData, result.orderId);
                window.print();
                resetOrder();
                setTimeout(fetchProducts, 1500);
            } catch (error) {
                showCustomModal({ title: 'Lỗi Thanh Toán', message: error.message, type: 'error'});
            } finally {
                showLoading(false);
            }
        }
        
        function generateReceipt(orderData, orderId) {
            const now = new Date();
            receiptPrintArea.innerHTML = `<h2>HÓA ĐƠN BÁN LẺ</h2><p><strong>Cửa hàng ABC</strong></p><p>Mã HĐ: ${orderId}</p><p>Ngày: ${now.toLocaleString('vi-VN')}</p><hr><table><thead><tr><th>Tên Hàng</th><th>SL</th><th class="text-right">Thành Tiền</th></tr></thead><tbody>${orderData.items.map(item => `<tr><td>${item.name}</td><td>${item.quantity}</td><td class="text-right">${formatCurrency(item.price * item.quantity)}</td></tr>`).join('')}</tbody></table><hr><p class="total"><strong>Tổng cộng:</strong> <strong style="float:right;">${formatCurrency(orderData.totalAmount)}</strong></p><p>Tiền khách đưa: <span style="float:right;">${formatCurrency(orderData.customerCash)}</span></p><p>Tiền thối: <span style="float:right;">${formatCurrency(orderData.change > 0 ? orderData.change : 0)}</span></p><div class="footer"><p>Cảm ơn quý khách!</p></div>`;
        }
        
        function startCameraScanner() {
            if (!zxingCodeReader) zxingCodeReader = new ZXing.BrowserMultiFormatReader();
            showModal(scannerContainer);
            zxingCodeReader.listVideoInputDevices()
                .then(videoInputDevices => {
                    if (videoInputDevices.length <= 0) throw new Error("Không tìm thấy camera.");
                    const selectedDeviceId = videoInputDevices[0].deviceId;
                    zxingCodeReader.decodeFromVideoDevice(selectedDeviceId, 'barcode-scanner-video', (result, err) => {
                        if (result) {
                            stopCameraScanner();
                            searchInput.value = result.getText();
                            const enterEvent = new KeyboardEvent('keyup', { 'key': 'Enter' });
                            searchInput.dispatchEvent(enterEvent);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            stopCameraScanner();
                            showCustomModal({ title: 'Lỗi Camera', message: err.message, type: 'error'});
                        }
                    });
                })
                .catch(err => {
                    showCustomModal({ title: 'Không thể mở Camera', message: "Vui lòng cấp quyền truy cập camera và đảm bảo trang web đang chạy trên localhost hoặc HTTPS.", type: 'error'});
                    stopCameraScanner();
                });
        }

        function stopCameraScanner() {
            if (zxingCodeReader) zxingCodeReader.reset();
            hideModal(scannerContainer);
        }

        function renderAdminProductList() {
            adminProductList.innerHTML = '';
            products.forEach(p => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                row.innerHTML = `<td class="px-4 py-3"><div class="text-sm font-medium text-gray-900">${p.name}</div><div class="text-xs text-gray-500">${p.barcode}</div></td><td class="px-2 py-3 text-sm text-gray-700">${formatCurrency(p.price)}</td><td class="px-2 py-3 text-sm text-gray-700 font-semibold">${p.stock}</td><td class="px-2 py-3 text-right text-sm font-medium space-x-3"><button onclick="window.editProduct('${p.barcode}')" class="text-indigo-600 hover:text-indigo-900" title="Sửa"><i class="fas fa-edit"></i></button><button onclick="window.deleteProduct('${p.barcode}')" class="text-red-600 hover:text-red-900" title="Xóa"><i class="fas fa-trash"></i></button></td>`;
                adminProductList.appendChild(row);
            });
        }
        
        async function handleAdminFormSubmit(e) {
            e.preventDefault();
            const productData = { barcode: productBarcode.value.trim(), name: productName.value.trim(), price: parseFloat(productPrice.value), stock: parseInt(productStock.value) };
            if(!productData.barcode || !productData.name || isNaN(productData.price) || isNaN(productData.stock)) {
                showCustomModal({title: 'Thiếu thông tin', message: 'Vui lòng điền đầy đủ và chính xác thông tin sản phẩm.', type: 'warning'});
                return;
            }
            const mode = formMode.value;
            const action = mode === 'add' ? 'ADD_PRODUCT' : 'UPDATE_PRODUCT';
            showLoading(true);
            try {
                const result = await postDataToAPI({ action, data: productData });
                showCustomModal({title: 'Thành công', message: result.message, type: 'success'});
                resetAdminForm();
                await fetchProducts();
                renderAdminProductList();
            } catch (error) {
                showCustomModal({title: 'Thao tác thất bại', message: error.message, type: 'error'});
            } finally {
                showLoading(false);
            }
        }

        window.editProduct = function(barcode) {
            const p = products.find(prod => prod.barcode === barcode);
            if (!p) return;
            formMode.value = 'edit';
            productBarcode.value = p.barcode;
            productBarcode.readOnly = true;
            productName.value = p.name;
            productPrice.value = p.price;
            productStock.value = p.stock;
            adminFormTitle.textContent = "Sửa sản phẩm";
            adminSubmitBtn.innerHTML = `<i class="fas fa-save mr-2"></i>Cập nhật`;
            adminSubmitBtn.classList.replace('bg-kiot-blue', 'bg-kiot-green');
            adminCancelBtn.classList.remove('hidden');
        }
        
        window.deleteProduct = async function(barcode) {
            const p = products.find(prod => prod.barcode === barcode);
            if (!p) return;
            const choice = await showCustomModal({ title: 'Xác nhận Xóa', message: `Bạn có chắc muốn xóa sản phẩm <strong>${p.name}</strong> không?`, type: 'warning', buttons: [{ text: 'Hủy', value: 'cancel', class: 'bg-slate-600 hover:bg-slate-700' },{ text: 'Xóa', value: 'confirm', class: 'bg-kiot-red hover:bg-kiot-red-dark' }] });
            if (choice === 'confirm') {
                showLoading(true);
                try {
                    const result = await postDataToAPI({ action: 'DELETE_PRODUCT', data: { barcode } });
                    showCustomModal({title: 'Thành công', message: result.message, type: 'success'});
                    await fetchProducts();
                    renderAdminProductList();
                } catch (error) {
                    showCustomModal({title: 'Xóa thất bại', message: error.message, type: 'error'});
                } finally {
                    showLoading(false);
                }
            }
        }
        
        function resetAdminForm() {
            adminProductForm.reset();
            formMode.value = 'add';
            productBarcode.readOnly = false;
            adminFormTitle.textContent = "Thêm sản phẩm mới";
            adminSubmitBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Thêm Sản Phẩm`;
            adminSubmitBtn.classList.replace('bg-green-600', 'bg-kiot-blue');
            adminCancelBtn.classList.add('hidden');
        }

        // EVENT LISTENERS
        loginButton.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
        logoutButton.addEventListener('click', handleLogout);
        searchInput.addEventListener('keyup', handleSearchAndScan);
        customerCashInput.addEventListener('input', updateTotals);
        checkoutButton.addEventListener('click', handleCheckout);
        cameraScanBtn.addEventListener('click', startCameraScanner);
        scannerContainer.addEventListener('click', (e) => { if (e.target === scannerContainer) stopCameraScanner(); });
        closeScannerBtn.addEventListener('click', stopCameraScanner);
        
        adminAccessBtn.addEventListener('click', async () => {
             const result = await showCustomModal({ title: 'Truy cập Quản lý', message: '<input type="password" id="admin-code-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="Nhập mã truy cập...">', type: 'confirm', buttons: [{ text: 'Hủy', value: 'cancel', class: 'bg-slate-600 hover:bg-slate-700' },{ text: 'Xác nhận', value: 'confirm', class: 'bg-kiot-blue hover:bg-kiot-blue-dark' }] });
             const input = document.getElementById('admin-code-input');
             if (result === 'confirm' && input && input.value === credentials.adminCode) {
                renderAdminProductList();
                showModal(adminScreen, adminPanelContent);
             } else if (result === 'confirm') {
                showCustomModal({title: 'Sai mã', message: 'Mã truy cập không đúng.', type: 'error'});
             }
        });
        closeAdminBtn.addEventListener('click', () => hideModal(adminScreen, adminPanelContent));
        adminProductForm.addEventListener('submit', handleAdminFormSubmit);
        adminCancelBtn.addEventListener('click', resetAdminForm);
        statsAccessBtn.addEventListener('click', () => { fetchOrders(); showModal(statsScreen, statsPanelContent); });
        closeStatsBtn.addEventListener('click', () => hideModal(statsScreen, statsPanelContent));
        closeOrderDetailBtn.addEventListener('click', () => hideModal(orderDetailModal));
    });
    </script>
</body>
</html>