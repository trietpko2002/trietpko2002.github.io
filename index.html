<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sinh hoạt hè - Nhóm</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SHH App">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921222.png">
    
    <link rel="manifest" href="manifest.json">

    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* New styles for menu boxes */
        .small-box {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        .small-box:hover {
            transform: translateY(-7px);
            box-shadow: 0 8px 25px rgba(0,123,255,0.15);
        }
        .small-box .icon {
            transition: transform 0.3s ease;
        }
        .small-box:hover .icon {
            transform: scale(1.1) rotate(-5deg);
        }
        /* New styles for section titles */
        .dashboard-section-title {
            font-size: 1.1rem; font-weight: 500; color: #495057;
            border-bottom: 1px solid #e9ecef; padding-bottom: 0.5rem;
            margin-top: 1.5rem; margin-bottom: 1.25rem;
        }
        .info-box-content { justify-content: center; }
        .table thead th { background-color: #f4f6f9; color: #333; border-top: none; text-align: center; }
        .table td, .table th { vertical-align: middle; padding: 12px 8px; }
        .btn-group-toggle .btn { padding: 0.35rem 0.5rem; font-size: 0.8rem; }
        .card-title { font-weight: bold; }
        .content-wrapper { background-color: #f4f6f9; }
        /* Youth Union Theme - Blue & White */
        .navbar-primary { background-color: #0069d9 !important; }
        .brand-link.bg-primary { background-color: #0069d9 !important; border-bottom: 1px solid #0056b3; }
        .sidebar-light-primary .nav-sidebar>.nav-item>.nav-link.active { background-color: #0069d9; color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .btn-primary { background-color: #0069d9; border-color: #0062cc; }
        .btn-primary:hover { background-color: #0056b3; border-color: #004085; }
        /* Poll Styles */
        .student-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 5px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; border-radius: 4px; margin-bottom: 10px; }
        /* Maintenance Overlay */
        #maintenance-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #topMarquee { background: #d81b60; color: #fff; padding: 5px; font-weight: bold; display: none; z-index: 1040; position: relative; }
        
        /* Dark Mode Full Coverage */
        body { color: #212529; }
        body.dark-mode { background-color: #454d55 !important; color: #fff; }
        body.dark-mode .content-wrapper { background-color: #343a40; color: #fff; }
        body.dark-mode .card { background-color: #343a40; color: #fff; }
        body.dark-mode .card-header { border-bottom-color: #454d55; }
        body.dark-mode .dashboard-section-title {
            color: #c2c7d0;
            border-bottom-color: #454d55;
        }
        body.dark-mode .table { color: #fff; }
        body.dark-mode .table thead th { background-color: #3f474e; color: #fff; border-color: #454d55; }
        body.dark-mode .table td, body.dark-mode .table th { border-color: #454d55; }
        body.dark-mode .modal-content { background-color: #343a40; color: #fff; }
        body.dark-mode .close { color: #fff; }
        body.dark-mode .form-control { background-color: #454d55; color: #fff; border-color: #6c757d; }
        body.dark-mode .form-control:focus { background-color: #454d55; color: #fff; }
        body.dark-mode .list-group-item { background-color: #343a40; border-color: #454d55; }
        body.dark-mode .callout { background-color: #3f474e; border-color: #454d55; }

        /* Phone Notification Style */
        #phone-notification { position: fixed; top: -150px; left: 0; width: 100%; background: rgba(255, 255, 255, 0.98); color: #333; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1060; transition: top 0.5s ease; border-bottom: 3px solid #007bff; display: flex; align-items: center; backdrop-filter: blur(10px); }
        body.dark-mode #phone-notification { background: rgba(52, 58, 64, 0.98); color: #fff; border-bottom: 3px solid #17a2b8; }
        #phone-notification.show { top: 0; }
        #phone-notification img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; margin-right: 15px; }
        #phone-notification .content { flex-grow: 1; }
        #phone-notification .title { font-weight: bold; font-size: 1.1rem; margin-bottom: 2px; }
        #phone-notification .body { font-size: 0.95rem; opacity: 0.9; }
        #phone-notification .close-btn { background: none; border: none; font-size: 1.5rem; color: inherit; cursor: pointer; padding: 0 10px; }
        
        /* Hiệu ứng nút mới */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); transform: scale(1); }
        }
        .btn-new-highlight {
            animation: pulse-glow 2s infinite;
            border: 2px solid #ffc107 !important;
        }

        /* PRINT STYLES */
        @media print {
            .main-sidebar, .main-header, .btn, .no-print, .card-tools, .nav-pills, #phone-notification, #topMarquee { display: none !important; }
            .content-wrapper { margin-left: 0 !important; background: white !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        }
        
        /* VIP Styles from Profile */
        .vip-frame-container { position: relative; display: inline-block; }
        .vip-crown {
            position: absolute; top: -20px; right: -10px; 
            font-size: 1.5rem; color: #ffd700; 
            transform: rotate(15deg); 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            animation: floatCrown 2s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes floatCrown { 0%, 100% { transform: rotate(15deg) translateY(0); } 50% { transform: rotate(15deg) translateY(-3px); } }
        
        .vip-border-1 { border: 3px solid #c0c0c0 !important; box-shadow: 0 0 10px #c0c0c0; }
        .vip-border-2 { border: 3px solid #ffd700 !important; box-shadow: 0 0 15px #ffd700; animation: shineBorder 3s infinite linear; }
        @keyframes shineBorder { 0% { border-color: #ffd700; } 50% { border-color: #fff; } 100% { border-color: #ffd700; } }
        
        /* VIP 3 Styles */
        .vip-border-3 { border: 3px solid #00ffff !important; box-shadow: 0 0 15px #00ffff, 0 0 5px #fff inset; animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 0% { border-color: #00ffff; box-shadow: 0 0 15px #00ffff; } 50% { border-color: #fff; box-shadow: 0 0 25px #00ffff; } 100% { border-color: #00ffff; box-shadow: 0 0 15px #00ffff; } }
        
        .vip-border-4 { border: 3px solid #e5e4e2 !important; box-shadow: 0 0 15px #e5e4e2; animation: shineBorder 3s infinite linear; }
        .vip-border-5 { border: 3px solid #ffd700 !important; box-shadow: 0 0 20px #ffd700, 0 0 5px #fff inset; animation: pulseBorder 2s infinite; }
        
        .vip-diamond {
            position: absolute; top: -25px; right: -10px; 
            font-size: 1.8rem; color: #00ffff; 
            filter: drop-shadow(0 0 5px #00ffff);
            animation: floatDiamond 3s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes floatDiamond { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        /* VIP 10 Styles */
        .vip-border-10 { border: 4px solid #ffd700 !important; box-shadow: 0 0 25px #ffd700, 0 0 10px #fff inset; animation: pulseBorder 1s infinite; }
        .vip-wing { position: absolute; top: -10px; font-size: 1.8rem; color: #ffd700; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); z-index: 10; }
        .vip-wing-left { left: -25px; transform: rotate(-20deg); }
        .vip-wing-right { right: -25px; transform: rotate(20deg); }
        .vip-crown-10 { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); font-size: 2rem; color: #ffd700; filter: drop-shadow(0 0 10px #ffd700); animation: floatCrown 2s ease-in-out infinite; z-index: 11; }
        
        /* Hacker Title Effect */
        .hacker-gold {
            background: linear-gradient(90deg, #ffd700, #fff, #ffd700);
            background-size: 200% auto;
            color: #000;
            font-weight: bold;
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px #ffd700;
            animation: shineText 2s linear infinite;
            padding: 5px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            display: inline-block;
            margin: 2px;
        }
        /* Default Theme Animation */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body.default-theme {
            background: linear-gradient(-45deg, #007bff, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite;
        }
        @keyframes shineText { to { background-position: 200% center; } }

        /* Weather Effects */
        .weather-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }
        
        /* Youtube Banner Ratio */
        #img-cover {
            width: 100%;
            aspect-ratio: 6/1; /* Tỉ lệ Banner Youtube TV/Desktop */
            object-fit: cover;
            border-radius: 4px;
        }

        /* Fireflies */
        .firefly { position: fixed; width: 6px; height: 6px; background: #ffff00; border-radius: 50%; box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00; animation: fly 10s infinite alternate; pointer-events: none; z-index: 9998; }
        @keyframes fly { 
            0% { transform: translate(0, 0); opacity: 0; } 
            10% { opacity: 1; } 
            90% { opacity: 1; } 
            100% { transform: translate(100vw, -50vh); opacity: 0; } 
        }

        
        /* Settings Btn */
        .settings-btn { position: fixed; bottom: 20px; right: 20px; z-index: 9999; width: 50px; height: 50px; border-radius: 50%; background: #007bff; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        .settings-btn:hover { transform: rotate(90deg); background: #0056b3; }
        /* Guide Btn */
        .guide-btn { position: fixed; bottom: 80px; right: 20px; z-index: 9999; width: 50px; height: 50px; border-radius: 50%; background: #17a2b8; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        .guide-btn:hover { transform: scale(1.1); background: #138496; }

        /* Jack J97 Troll Mode */
        body.jack-mode {
            background-color: #000 !important;
            color: #fff !important;
        }

        /* Modern Rounded UI Overrides */
        .card { border-radius: 20px; border: none; box-shadow: 0 0 20px rgba(0,0,0,0.05); background: linear-gradient(135deg, #ffffff 0%, #f4f6f9 100%); }
        .card-header { border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .btn { border-radius: 50px; }
        .form-control { border-radius: 15px; }
        .modal-content { border-radius: 25px; border: none; }
        .nav-pills .nav-link { border-radius: 50px; }
        .nav-sidebar .nav-link { border-radius: 10px; }
        .custom-select { border-radius: 15px; }
        .info-box { border-radius: 20px; }

        /* Dark Mode Card Gradient */
        body.dark-mode .card { background: linear-gradient(135deg, #343a40, #2b3035); color: #fff; }
        
        /* Table Row Hover Effect */
        .table-hover tbody tr { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .table-hover tbody tr:hover {
            transform: scale(1.005);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10;
            position: relative;
            background-color: #fff !important;
        }
        body.dark-mode .table-hover tbody tr:hover {
            background-color: #3f474e !important;
        }
        
        /* Matrix Theme */
        body.theme-matrix #matrix-canvas { position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; }
        body.theme-matrix .content-wrapper { background: rgba(0, 0, 0, 0.85) !important; position: relative; z-index: 1; }
        body.theme-matrix .main-header, body.theme-matrix .main-sidebar, body.theme-matrix .main-footer { background-color: #000 !important; border-color: #0f0 !important; }
        body.theme-matrix .card { background: rgba(0, 20, 0, 0.8) !important; border: 1px solid #0f0 !important; box-shadow: 0 0 5px #0f0; }
        body.theme-matrix, body.theme-matrix .nav-link, body.theme-matrix .card-title { color: #0f0 !important; }
        body.theme-matrix .btn-primary { background: #000; border: 1px solid #0f0; color: #0f0; }
        body.theme-matrix .btn-primary:hover { background: #0f0; color: #000; }
        
        /* Neon Theme */
        body.theme-neon .content-wrapper { background: #050505 !important; }
        body.theme-neon .main-header { background: #111 !important; border-bottom: 2px solid #ff00de !important; }
        body.theme-neon .main-sidebar { background: #0a0a0a !important; border-right: 1px solid #00ffff !important; }
        body.theme-neon .card { background: #111 !important; border: 1px solid transparent; box-shadow: 0 0 10px #ff00de, inset 0 0 5px #00ffff; }
        body.theme-neon .btn-primary { background: linear-gradient(45deg, #ff00de, #00ffff); border: none; color: #fff; font-weight: bold; }
        body.theme-neon .nav-pills .nav-link.active { background: #ff00de; box-shadow: 0 0 10px #ff00de; }

        /* Music Visualizer */
        .music-visualizer { display: flex; justify-content: center; align-items: flex-end; height: 60px; gap: 6px; margin: 20px 0; }
        .music-bar { width: 8px; background: linear-gradient(to top, #007bff, #00d2ff); border-radius: 5px; animation: bounce 1s infinite ease-in-out; opacity: 0.8; }
        @keyframes bounce { 0%, 100% { height: 10%; } 50% { height: 100%; } }
        .music-bar:nth-child(odd) { animation-duration: 0.8s; } .music-bar:nth-child(even) { animation-duration: 1.1s; } .music-bar:nth-child(3n) { animation-duration: 1.3s; } .music-bar:nth-child(4n) { animation-duration: 0.9s; } .music-bar:nth-child(5n) { animation-duration: 1.2s; }
        
        /* Fix 1 Page Scroll */
        html, body { height: 100vh; overflow: hidden; }
        .content-wrapper { height: calc(100vh - 57px - 40px) !important; overflow-y: auto; }
        .main-footer { height: 40px; line-height: 20px; }
        body { transition: opacity 0.5s ease-out; } /* Page transition */

        /* Welcome Screen Styles */
        #welcome-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1e88e5; color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 99999; transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        #welcome-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }
        .welcome-logo { width: 100px; height: 100px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* Connection Status */
        .connection-status {
            position: fixed; bottom: 10px; left: 10px; z-index: 10000;
            background: rgba(0, 0, 0, 0.7); color: #fff; padding: 6px 12px;
            border-radius: 30px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1); user-select: none;
        }
        .connection-status i { margin-right: 6px; }
    </style>
</head>
<body class="hold-transition layout-top-nav layout-navbar-fixed layout-footer-fixed">

<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user) { window.location.replace('login.html'); }
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker Registered', reg))
            .catch(err => console.log('Service Worker Failed', err));
        }
        
        // Request Notification Permission
        if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }
    })();
    function logout() { 
        Swal.fire({
            title: 'Đăng xuất?',
            text: "Bạn có chắc chắn muốn thoát phiên làm việc?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Đăng xuất',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                const logoutOverlay = document.getElementById('logout-overlay');
                if (logoutOverlay) {
                    logoutOverlay.style.display = 'flex';
                    setTimeout(() => { logoutOverlay.style.opacity = '1'; }, 10);
                }
                setTimeout(() => {
                    sessionStorage.clear();
                    window.location.replace('login.html');
                }, 800);
            }
        });
    }
</script>

<!-- Welcome Screen -->
<div id="welcome-screen">
    <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" class="welcome-logo">
    <h3 class="font-weight-bold">Hệ thống Quản lý SHH</h3>
    <div class="w-75 mt-4" style="max-width: 300px;">
        <div class="progress" style="height: 6px; background-color: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden;">
            <div id="welcome-progress-bar" class="progress-bar bg-white" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="d-flex justify-content-between mt-2 text-white small">
            <span id="welcome-status-text">Đang kết nối...</span>
            <span id="welcome-percent">0%</span>
        </div>
    </div>
</div>

<!-- Logout Loading Overlay -->
<div id="logout-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e88e5; color: white; z-index: 999999; flex-direction: column; justify-content: center; align-items: center; text-align: center; opacity: 0; transition: opacity 0.3s ease;">
    <div class="spinner-border text-white" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 font-weight-bold">Đang đăng xuất...</h4>
</div>

<!-- Connection Status Widget -->
<div id="connection-status" class="connection-status" style="display:none;">
    <i class="fas fa-wifi" id="conn-icon"></i>
    <span id="conn-text">Kết nối</span>
    <span id="conn-ms" class="ml-2 badge badge-dark">--ms</span>
</div>

<div class="wrapper">
    <div class="settings-btn" onclick="openUserSettings()" title="Cài đặt giao diện"><i class="fas fa-cog"></i></div>
    <div class="guide-btn" onclick="$('#modalGuide').modal('show')" title="Hướng dẫn sử dụng"><i class="fas fa-question"></i></div>
    <button id="installPwaBtn" class="btn btn-success rounded-pill shadow-lg font-weight-bold" style="display: none; position: fixed; bottom: 20px; left: 20px; z-index: 9999; padding: 10px 20px;">
        <i class="fas fa-download mr-2"></i> Cài App
    </button>
    
    <!-- Modal iOS Install Guide -->
    <div class="modal fade" id="modalIOSInstall" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content bg-dark text-white" style="border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header border-0">
                    <h5 class="modal-title font-weight-bold"><i class="fab fa-apple mr-2"></i>Cài đặt trên iOS</h5>
                    <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-3">Safari trên iOS không hỗ trợ cài đặt tự động. Vui lòng làm theo thủ công:</p>
                    <div class="text-left d-inline-block p-3 rounded" style="background: rgba(255,255,255,0.1); width: 100%;">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge badge-light mr-2">1</span>
                            <span>Nhấn nút <b>Chia sẻ</b> <i class="fas fa-share-square"></i> trên thanh công cụ Safari.</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge badge-light mr-2">2</span>
                            <span>Kéo xuống tìm và chọn <b>"Thêm vào MH chính"</b> (Add to Home Screen).</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge badge-light mr-2">3</span>
                            <span>Nhấn <b>"Thêm"</b> (Add) ở góc trên cùng bên phải.</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-primary rounded-pill px-4" data-dismiss="modal">Đã hiểu</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="matrix-canvas" style="display:none;"></canvas>
    <div id="phone-notification">
        <img id="pn-img" src="" style="display:none;">
        <div class="content">
            <div id="pn-title" class="title"></div>
            <div id="pn-body" class="body"></div>
            <div id="pn-link" class="mt-1"></div>
        </div>
        <button class="close-btn" onclick="closePhoneNotification()">&times;</button>
    </div>
    <nav class="main-header navbar navbar-expand navbar-primary navbar-dark border-bottom-0">
        <ul class="navbar-nav">
            <li class="nav-item d-none d-sm-inline-block">
                <a href="javascript:void(0)" onclick="showMainMenu()" class="nav-link font-weight-bold"><i class="fas fa-home mr-1"></i> TRANG CHỦ</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block" id="installPwaNav" style="display:none;">
                <a href="javascript:void(0)" onclick="installPwa()" class="nav-link font-weight-bold text-warning"><i class="fas fa-download mr-1"></i> CÀI ĐẶT APP</a>
            </li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item d-flex align-items-center">
                <a href="javascript:void(0)" class="nav-link" onclick="openNotificationModal()"><i class="fas fa-bell"></i><span class="badge badge-warning navbar-badge" id="notiBadge"></span></a>
            </li>
            <li class="nav-item d-flex align-items-center">
                <a href="profile.html" class="user-panel d-flex align-items-center mr-3" style="text-decoration: none;" title="Hồ sơ cá nhân">
                    <div class="vip-frame-container mr-2">
                        <img src="" class="img-circle elevation-2" id="userAvatar" alt="User" style="width: 35px; height: 35px; object-fit: cover;">
                        <div id="vipCrownArea"></div>
                    </div>
                    <span class="d-none d-md-inline font-weight-bold text-white" id="managerDisplayName">Quản lý</span>
                </a>
            </li>
            <li class="nav-item d-flex align-items-center">
                <a href="javascript:void(0)" onclick="logout()" class="btn btn-sm btn-danger font-weight-bold">
                    <i class="fas fa-sign-out-alt"></i> <span class="d-none d-md-inline">Thoát</span>
                </a>
            </li>
        </ul>
    </nav>

    <div class="content-wrapper text-sm">
        <div id="topMarquee"><marquee id="marqueeText" behavior="scroll" direction="left"></marquee></div>
        <!-- MAIN MENU GRID -->
        <div id="main-menu-section" class="content pt-4">
            <div class="container">
                <div class="text-center mb-4">
                    <h2 class="font-weight-bold text-primary">BẢNG ĐIỀU KHIỂN</h2>
                    <p class="text-muted">Xin chào, <b id="managerMenuDisplayName" class="text-primary"></b>! Chọn một chức năng để bắt đầu.</p>
                </div>

                <!-- Section 1: Chức năng chính -->
                <h5 class="dashboard-section-title"><i class="fas fa-tasks mr-2"></i>Chức năng chính</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-primary shadow" onclick="showTab('tab-attendance')">
                            <div class="inner"><h3>Điểm danh</h3><p>Quản lý có mặt/vắng</p></div>
                            <div class="icon"><i class="fas fa-check-square"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info shadow" onclick="showTab('tab-students')">
                            <div class="inner"><h3>Học sinh</h3><p>Danh sách nhóm</p></div>
                            <div class="icon"><i class="fas fa-user-friends"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Công cụ & Tiện ích -->
                <h5 class="dashboard-section-title"><i class="fas fa-tools mr-2"></i>Công cụ & Tiện ích</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success shadow" onclick="showTab('tab-funds'); loadFundTab();">
                            <div class="inner"><h3>Quỹ nhóm</h3><p>Thu/chi & Báo cáo</p></div>
                            <div class="icon"><i class="fas fa-hand-holding-usd"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-purple shadow" onclick="showTab('tab-evaluation')">
                            <div class="inner"><h3>Đánh giá</h3><p>Xếp loại học sinh</p></div>
                            <div class="icon"><i class="fas fa-star"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-teal shadow" onclick="showTab('tab-feedback')">
                            <div class="inner"><h3>Phản ánh</h3><p>Gửi kiến nghị</p></div>
                            <div class="icon"><i class="fas fa-comments"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Tài nguyên & Hỗ trợ -->
                <h5 class="dashboard-section-title"><i class="fas fa-archive mr-2"></i>Tài nguyên & Hỗ trợ</h5>
                <div class="row">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-secondary shadow" onclick="showTab('tab-upload')">
                            <div class="inner"><h3>Tài liệu</h3><p>Tệp tin & Tài nguyên</p></div>
                            <div class="icon"><i class="fas fa-folder-open"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger shadow" onclick="window.location.href='profile.html'">
                            <div class="inner"><h3>Hồ sơ</h3><p>Thông tin cá nhân</p></div>
                            <div class="icon"><i class="fas fa-id-card"></i></div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-light shadow" onclick="$('#modalGuide').modal('show')">
                            <div class="inner"><h3>Hướng dẫn</h3><p>Tài liệu sử dụng</p></div>
                            <div class="icon"><i class="fas fa-question-circle"></i></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FUNCTIONAL VIEWS (Hidden by default) -->
        <div id="functional-section" style="display:none;">
            <div class="content-header">
                <div class="container-fluid">
                    <button class="btn btn-outline-secondary mb-2 font-weight-bold" onclick="showMainMenu()">
                        <i class="fas fa-arrow-left mr-2"></i>Trở về Menu chính
                    </button>
                </div>
            </div>
            <div class="content">
                <div class="container-fluid">
                <div class="tab-content">
            <div class="tab-pane fade" id="tab-attendance">
                <div id="attendance-cover" class="mb-3 shadow-sm rounded overflow-hidden" style="display:none;"><img id="img-cover" src=""></div>
                <div class="callout callout-info mb-3 shadow-sm">
                    <h5><i class="fas fa-calendar-alt mr-2"></i>Hôm nay: <span id="currentDateDisplay"></span></h5>
                    <p class="text-muted mb-0">Chọn trạng thái cho từng học sinh và nhấn "Lưu kết quả".</p>
                </div>
                <div class="text-right mb-2"><button class="btn btn-sm btn-default" onclick="window.print()"><i class="fas fa-print"></i> In Phiếu Điểm Danh</button></div>
                <div class="text-right mb-2"><button class="btn btn-sm btn-info" onclick="openImportAttendanceModal()"><i class="fas fa-file-import"></i> Nhập Điểm Danh (Excel)</button></div>
                <div id="attendanceList" class="row">
                    <!-- Data loaded by JS -->
                </div>
                <button class="btn btn-success btn-block mt-4 shadow py-3" onclick="submitAttendance()">
                    <i class="fas fa-paper-plane mr-2"></i><b>LƯU KẾT QUẢ ĐIỂM DANH</b>
                </button>
            </div>

            <div class="tab-pane fade" id="tab-students">
                <div class="card card-outline card-primary shadow" data-save-key="idx_student_list">
                    <div class="card-header d-flex align-items-center">
                        <h3 class="card-title text-uppercase flex-grow-1">
                            <i class="fas fa-table mr-2"></i>Danh sách học sinh <span class="text-primary" id="groupBadge">...</span>
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-default btn-sm shadow-sm mr-2" onclick="window.print()"><i class="fas fa-print"></i> In</button>
                            <button class="btn btn-info btn-sm shadow-sm mr-2 btn-manager-only" onclick="openImportModal('manager')"><i class="fas fa-file-import"></i> Nhập từ Excel</button>
                            <button class="btn btn-primary btn-sm shadow-sm mr-2 btn-manager-only" onclick="openStudentModal()">
                                <i class="fas fa-plus mr-1"></i> Thêm HS
                            </button>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-bordered table-hover text-nowrap mb-0" id="excelTable">
                            <thead>
                                <tr class="text-center">
                                    <th width="50">STT</th>
                                    <th>Họ và Tên</th>
                                    <th>Giới tính</th>
                                    <th>Ngày sinh</th>
                                    <th>Lớp</th>
                                    <th>Trường học</th>
                                    <th>Địa chỉ liên hệ</th>
                                    <th>Số điện thoại học sinh</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="groupStudentList">
                                <!-- Data loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-upload">
                <div class="card card-outline card-primary shadow" data-save-key="idx_upload_center">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-folder-open mr-2"></i>Tài liệu sinh hoạt, hướng dẫn, kế hoạch chương trình và các file liên quan tới sinh hoạt hè</h3>
                        <div class="card-tools">
                            <button class="btn btn-tool" onclick="loadResources()"><i class="fas fa-sync"></i></button><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- File Manager Interface -->
                        <div class="row">
                            <div class="col-md-3 border-right">
                                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                    <a class="nav-link active" id="filter-all" data-toggle="pill" href="#" onclick="filterResources('all')"><i class="fas fa-layer-group mr-2"></i>Tất cả</a>
                                    <a class="nav-link" id="filter-docs" data-toggle="pill" href="#" onclick="filterResources('docs')"><i class="fas fa-file-word mr-2"></i>Tài liệu (Word/PDF)</a>
                                    <a class="nav-link" id="filter-media" data-toggle="pill" href="#" onclick="filterResources('media')"><i class="fas fa-photo-video mr-2"></i>Media (Nhạc/Video)</a>
                                    <a class="nav-link" id="filter-other" data-toggle="pill" href="#" onclick="filterResources('other')"><i class="fas fa-archive mr-2"></i>Khác</a>
                                </div>
                                <hr>
                                <div class="alert alert-info p-2">
                                    <small><i class="fas fa-info-circle"></i> Dung lượng tối đa: <b id="limit_display">200</b>MB</small>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="input-group mb-3">
                                    <input type="text" id="resource_search" class="form-control" placeholder="Tìm kiếm tệp tin..." onkeyup="searchResources()">
                                    <div class="input-group-append"><span class="input-group-text"><i class="fas fa-search"></i></span></div>
                                </div>
                                <div id="resource_list" class="row" style="max-height: 600px; overflow-y: auto;">
                                    <!-- Files loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <hr class="mt-4">
                        <h5 class="text-primary font-weight-bold"><i class="fas fa-cloud-upload-alt mr-2"></i>Gửi file cho Admin</h5>
                        <div class="form-group">
                            <label>Chọn file (Tối đa 200MB)</label>
                            <input type="file" id="file_upload_index" class="form-control-file border p-2">
                            <button class="btn btn-primary mt-2" onclick="uploadFileIndex()">Tải lên</button>
                        </div>
                        <div class="input-group">
                            <input type="text" id="drive_link_submission" class="form-control" placeholder="https://drive.google.com/...">
                            <div class="input-group-append">
                                <button class="btn btn-success" type="button" onclick="submitDriveLink()"><i class="fas fa-paper-plane mr-2"></i>Gửi Link</button>
                            </div>
                        </div>
                        <div class="mt-2 text-right">
                             <a href="https://j2team.dev/links" target="_blank" class="btn btn-xs btn-outline-secondary"><i class="fas fa-link mr-1"></i>Rút gọn link (J2Team)</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-funds">
                <div class="row">
                    <div class="col-md-4">
                        <div class="small-box bg-success shadow-sm">
                            <div class="inner"><h3><span id="current_fund_balance">0</span> <sup style="font-size: 20px">đ</sup></h3><p>Số dư quỹ hiện tại</p></div>
                            <div class="icon"><i class="fas fa-wallet"></i></div>
                        </div>
                        <div class="card card-primary card-outline shadow" data-save-key="idx_fund_tool">
                            <div class="card-header"><h3 class="card-title font-weight-bold"><i class="fas fa-calculator mr-2"></i>Công cụ tính quỹ</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div></div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Số tiền thu / người (VNĐ)</label>
                                    <input type="number" id="fund_amount" class="form-control font-weight-bold text-success" value="20000" onchange="calculateFund()">
                                </div>
                                <div class="row text-center mb-3">
                                    <div class="col-6 border-right">
                                        <h5 class="text-muted">Đã đóng</h5>
                                        <h3 class="font-weight-bold text-primary" id="fund_count">0</h3>
                                    </div>
                                    <div class="col-6">
                                        <h5 class="text-muted">Tổng tiền</h5>
                                        <h3 class="font-weight-bold text-success" id="fund_total">0</h3>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-block font-weight-bold mb-2" onclick="saveFundLog()">
                                    <i class="fas fa-save mr-2"></i>LƯU VÀO SỔ QUỸ (THU)
                                </button>
                                <button class="btn btn-warning btn-block font-weight-bold mb-2" data-toggle="modal" data-target="#modalChiQuy">
                                    <i class="fas fa-file-invoice-dollar mr-2"></i>CHI QUỸ (RÚT TIỀN)
                                </button>
                                <button class="btn btn-info btn-block font-weight-bold mb-2" data-toggle="modal" data-target="#modalContribution">
                                    <i class="fas fa-hand-holding-heart mr-2"></i>QUẢN LÝ ĐÓNG GÓP
                                </button>
                                <button class="btn btn-secondary btn-block font-weight-bold mb-2" onclick="showUnpaidModal()">
                                    <i class="fas fa-list-alt mr-2"></i>XEM DANH SÁCH CHƯA ĐÓNG
                                </button>
                                <button class="btn btn-outline-danger btn-block" onclick="resetFundCheckboxes()">
                                    <i class="fas fa-redo mr-2"></i>Reset (Tính đợt mới)
                                </button>
                            </div>
                        </div>
                        
                        <div class="card card-info card-outline shadow mt-3" data-save-key="idx_fund_history">
                            <div class="card-header d-flex p-2 align-items-center">
                                <h3 class="card-title font-weight-bold pl-2"><i class="fas fa-history mr-2"></i>Lịch sử Thu/Chi</h3>
                                <div class="ml-auto">
                                    <button class="btn btn-xs btn-danger mr-1" onclick="exportFundHistoryPdf()"><i class="fas fa-file-pdf"></i> PDF</button>
                                    <button class="btn btn-xs btn-success" onclick="exportFundHistoryExcel()"><i class="fas fa-file-excel"></i> Xuất Excel</button>
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <div class="card-body p-0 table-responsive" style="max-height: 300px;">
                                <table class="table table-sm table-striped">
                                    <thead><tr><th>Thời gian</th><th>Số tiền</th><th>Chi tiết</th></tr></thead>
                                    <tbody id="fundHistoryData"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card shadow" data-save-key="idx_fund_list">
                            <div class="card-header bg-light">
                                <h3 class="card-title font-weight-bold">Danh sách đóng tiền</h3>
                                <div class="card-tools">
                                    <div class="input-group input-group-sm" style="width: 200px;">
                                        <input type="text" id="fund_search" class="form-control float-right" placeholder="Tìm tên..." onkeyup="filterFundList()">
                                        <div class="input-group-append"><button type="submit" class="btn btn-default"><i class="fas fa-search"></i></button></div>
                                        <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0 table-responsive" style="height: 600px;">
                                <table class="table table-hover table-head-fixed text-nowrap">
                                    <thead><tr><th width="50">#</th><th>Họ và Tên</th><th class="text-center">Trạng thái</th><th>Ghi Chú</th></tr></thead>
                                    <tbody id="fundStudentList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                        
            <!-- Modal Quản lý Đóng góp -->
            <div class="modal fade" id="modalContribution" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-info"><h5 class="modal-title"><i class="fas fa-hand-holding-heart mr-2"></i>Quản lý tự đóng góp</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
                        <div class="modal-body">
                            <div class="form-group"><label>Số tiền đóng góp (VNĐ)</label><input type="number" id="contrib_amount" class="form-control" placeholder="Nhập số tiền..."></div>
                            <div class="form-group"><label>Lời nhắn / Ghi chú</label><textarea id="contrib_notes" class="form-control" rows="2" placeholder="VD: Ủng hộ nước uống..."></textarea></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-info" onclick="saveManagerContribution()">Xác nhận Đóng góp</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Unpaid Details -->
            <div class="modal fade" id="modalUnpaid" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-secondary"><h5 class="modal-title">Danh sách chưa đóng tiền</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
                        <div class="modal-body">
                            <div id="unpaidListContent" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary" onclick="copyUnpaidList()"><i class="fas fa-copy mr-1"></i>Sao chép tên</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Chi Quỹ -->
            <div class="modal fade" id="modalChiQuy" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-warning"><h5 class="modal-title"><i class="fas fa-donate mr-2"></i>Chi quỹ nhóm</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
                        <div class="modal-body">
                            <div class="form-group"><label>Mục đích chi</label><input type="text" id="expense_reason" class="form-control" placeholder="Mua đồ dùng, tổ chức..."></div>
                            <div class="form-group"><label>Số tiền chi (VNĐ)</label><input type="number" id="expense_amount" class="form-control" placeholder="Nhập số tiền..."></div>
                            <div class="form-group"><label>Ghi chú thêm</label><textarea id="expense_notes" class="form-control" rows="3"></textarea></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-warning" onclick="saveExpenseLog()">Lưu Khoản Chi</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-evaluation">
                <div class="card card-outline card-purple shadow" data-save-key="idx_eval_list">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-star mr-2"></i>Đánh giá & Xếp loại Học sinh</h3>
                        <div class="card-tools">
                            <button class="btn btn-tool" onclick="loadEvaluationUI()"><i class="fas fa-sync"></i></button><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                        </div>
                    </div>
                    <div id="evalAlertContainer" class="p-3"></div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr class="bg-light">
                                    <th>Học sinh</th>
                                    <th>Xếp loại hiện tại</th>
                                    <th class="text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="evaluationList">
                                <!-- Data loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-feedback">
                <div class="row">
                    <!-- Cột trái: Form gửi -->
                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow-sm" data-save-key="idx_fb_form">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold"><i class="fas fa-pen-alt mr-2"></i>Tạo phản ánh kiến nghị mới</h3><div class="card-tools"><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button></div>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Số điện thoại liên hệ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-phone"></i></span></div>
                                        <input type="text" id="fb_phone" class="form-control" placeholder="Nhập SĐT...">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Tiêu đề <span class="text-danger">*</span></label>
                                    <input type="text" id="fb_title" class="form-control" placeholder="VD: Lỗi điểm danh...">
                                </div>
                                <div class="form-group">
                                    <div class="d-flex align-items-center justify-content-between bg-white border rounded p-2 mb-2">
                                        <span id="captcha_code_fb" class="font-weight-bold h5 mb-0 text-primary" style="letter-spacing: 5px; user-select: none;"></span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="generateCaptcha('captcha_code_fb')"><i class="fas fa-sync"></i></button>
                                    </div>
                                    <input type="text" id="captcha_input_fb" class="form-control text-center" placeholder="Nhập mã xác nhận">
                                </div>
                                <div class="form-group">
                                    <label>Nội dung / Khó khăn</label>
                                    <textarea id="fb_difficulty" class="form-control" rows="4" placeholder="Mô tả chi tiết vấn đề, phản ánh..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Đề xuất (nếu có)</label>
                                    <textarea id="fb_suggestion" class="form-control" rows="2" placeholder="Kiến nghị giải pháp..."></textarea>
                                </div>
                                <div class="form-group bg-light p-2 rounded border">
                                    <label class="text-primary"><i class="fas fa-paperclip mr-2"></i>Đính kèm Ảnh/File (Max 20MB)</label>
                                    <input type="file" id="fb_file" class="form-control-file mb-2" accept="image/*,.doc,.docx,.pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                                    <input type="text" id="fb_drive_link" class="form-control form-control-sm" placeholder="Hoặc dán Link Google Drive...">
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle"></i> Chỉ chấp nhận file ảnh, doc, pdf. File sẽ tự động xóa sau 7 ngày.
                                    </small>
                                </div>
                                <button class="btn btn-primary btn-block font-weight-bold" onclick="sendFeedback()">
                                    <i class="fas fa-paper-plane mr-2"></i> GỬI YÊU CẦU
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cột phải: Lịch sử -->
                    <div class="col-md-8">
                        <div class="card card-outline card-info shadow-sm h-100" data-save-key="idx_fb_history">
                            <div class="card-header border-0 bg-white">
                                <h3 class="card-title font-weight-bold text-info"><i class="fas fa-history mr-2"></i>Lịch sử phản ánh</h3>
                                <div class="card-tools">
                                    <button class="btn btn-tool" onclick="loadFeedbackHistory()"><i class="fas fa-sync"></i></button><button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
                                </div>
                            </div>
                            <div class="card-body bg-light p-3" style="max-height: 700px; overflow-y: auto;">
                                <div id="feedbackHistoryList">
                                    <!-- Data loaded by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
            </div>
            </div>
        </div>
    </div>
    
    <footer class="main-footer text-center text-sm">
        <strong>Bản quyền và coding bởi Triết Võ.</strong><br>
        <small>Sản phẩm có sự hỗ trợ từ AI Gemini.</small>
    </footer>
</div>

<!-- Modal Student -->
<div class="modal fade" id="modalStudent" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title">Thông tin Học sinh</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="student_id_old">
                <div class="form-group" style="display:none"><label>Mã Học sinh (ID)</label><input type="text" id="st_id" class="form-control" placeholder="Nhập mã HS..."></div>
                <div class="form-group"><label>Họ và Tên</label><input type="text" id="st_name" class="form-control" placeholder="Nguyễn Văn A"></div>
                <div class="form-group"><label>Giới tính</label>
                    <select id="st_gender" class="form-control">
                        <option value="">-- Chọn --</option>
                        <option value="Nam">Nam</option>
                        <option value="Nữ">Nữ</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                <div class="form-group"><label>Ngày sinh</label><input type="text" id="st_dob" class="form-control" placeholder="dd/mm/yyyy"></div>
                <div class="form-group"><label>Lớp</label><input type="text" id="st_class" class="form-control"></div>
                <div class="form-group"><label>Địa chỉ</label><input type="text" id="st_address" class="form-control"></div>
                <div class="form-group"><label>Số điện thoại học sinh</label><input type="text" id="st_phone" class="form-control"></div>
                <div class="form-group">
                    <label>Trường học</label>
                    <select id="st_school_select" class="form-control" onchange="toggleOtherSchool('st_school_select', 'st_school_other_div')">
                        <!-- Options loaded by JS -->
                    </select>
                </div>
                <div class="form-group" id="st_school_other_div" style="display:none;">
                    <label>Tên trường khác</label>
                    <input type="text" id="st_school_other" class="form-control" placeholder="Nhập tên trường...">
                </div>
                <div class="form-group bg-light p-2 border rounded">
                    <label class="text-primary"><i class="fas fa-exchange-alt mr-1"></i>Chuyển Nhóm (Nếu cần)</label>
                    <select id="st_group_select" class="form-control">
                        <!-- Options loaded via JS -->
                    </select>
                </div>
                <h6 class="text-info border-top pt-2 mt-2">Thông tin đăng ký</h6>
                <div class="form-group"><label>Thời gian</label><input type="text" id="st_reg_time" class="form-control"></div>
                <div class="form-group"><label>Địa điểm</label><input type="text" id="st_reg_loc" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveStudent()">Lưu dữ liệu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Evaluate Student -->
<div class="modal fade" id="modalEvaluate" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title"><i class="fas fa-user-graduate mr-2"></i>Phiếu Đánh Giá Sinh Hoạt Hè</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="eval_st_id">
                <input type="hidden" id="eval_st_name">
                <h5 class="text-center font-weight-bold text-primary mb-3" id="eval_st_display_name"></h5>
                
                <div class="form-group">
                    <label class="font-weight-bold">1. Ý thức tổ chức kỷ luật:</label>
                    <textarea id="eval_discipline" class="form-control" rows="2" placeholder="Nhận xét về việc chấp hành giờ giấc, nội quy..."></textarea>
                </div>
                <div class="form-group">
                    <label class="font-weight-bold">2. Mức độ tích cực:</label>
                    <textarea id="eval_positivity" class="form-control" rows="2" placeholder="Nhận xét về sự hăng hái tham gia phong trào..."></textarea>
                </div>
                <div class="form-group">
                    <label class="font-weight-bold">3. Hoạt động tình nguyện:</label>
                    <textarea id="eval_volunteering" class="form-control" rows="2" placeholder="Nhận xét về tham gia vệ sinh môi trường, hỗ trợ..."></textarea>
                </div>
                <div class="form-group">
                    <label class="font-weight-bold text-danger">4. Xếp loại chung:</label>
                    <select id="eval_classification" class="form-control font-weight-bold">
                        <option value="">-- Chọn mức xếp loại --</option>
                        <option value="Xuất sắc">Xuất sắc (100% buổi, tích cực)</option>
                        <option value="Tốt">Tốt/Khá (Đều đặn, ý thức tốt)</option>
                        <option value="Trung bình">Trung bình (Không đầy đủ/Chưa tích cực)</option>
                        <option value="Yếu">Yếu (Không tham gia/Vi phạm)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-purple" style="background-color: #6f42c1; color: white;" onclick="submitEvaluation()">Lưu đánh giá</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Students -->
<div class="modal fade" id="modalImport" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-file-import mr-2"></i>Nhập danh sách học sinh từ Excel</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Vui lòng sử dụng file Excel theo đúng định dạng mẫu. Hệ thống sẽ tự động bỏ qua các học sinh đã tồn tại (trùng Tên trong nhóm của bạn).</p>
                <div class="form-group">
                    <label>1. Tải file mẫu</label><br>
                    <button class="btn btn-success" id="btnDownloadTemplate" onclick="downloadTemplateIndex()"><i class="fas fa-download mr-2"></i>Tải mẫu Excel</button>
                </div>
                <div class="form-group">
                    <label>2. Chọn file Excel của bạn</label>
                    <input type="file" id="file_import" class="form-control-file border p-2" accept=".xlsx, .xls">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-info" id="btnProcessImport">Bắt đầu Nhập</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Attendance -->
<div class="modal fade" id="modalImportAttendance" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-excel mr-2"></i>Nhập Điểm Danh từ Excel</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Tải file mẫu, điền trạng thái (C: Có mặt, P: Vắng phép, K: Vắng không phép) và tải lên.</p>
                <button class="btn btn-outline-success btn-sm mb-3" onclick="downloadAttendanceTemplate()"><i class="fas fa-download mr-1"></i>Tải file mẫu</button>
                <input type="file" id="file_att_import" class="form-control-file border p-2" accept=".xlsx">
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-success" onclick="processAttendanceImport()">Xử lý</button></div>
        </div>
    </div>
</div>

<!-- Modal Notifications -->
<div class="modal fade" id="modalNotifications" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-bell mr-2"></i>Thông báo từ Admin</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; overflow-y: auto;">
                <ul class="products-list product-list-in-card pl-2 pr-2" id="notificationListModal"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal Change Password -->
<div class="modal fade" id="modalChangePass" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-key mr-2"></i>Đổi mật khẩu</h5>
                <button type="button" class="close" data-dismiss="modal" id="btnClosePassModal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="passAlert">Bạn đang sử dụng mật khẩu mặc định. Vui lòng đổi mật khẩu để tiếp tục!</div>
                <div class="form-group"><label>Mật khẩu cũ</label><input type="password" id="old_pass" class="form-control"></div>
                <div class="form-group"><label>Mật khẩu mới</label><input type="password" id="new_pass" class="form-control"></div>
                <div class="form-group"><label>Nhập lại mật khẩu</label><input type="password" id="confirm_pass" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-block" onclick="submitChangePass()">Xác nhận đổi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Change PIN -->
<div class="modal fade" id="modalChangePin" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-key mr-2"></i>Đổi mã PIN</h5>
                <button type="button" class="close text-white" data-dismiss="modal" id="btnClosePinModal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="pinAlert">Bạn đang sử dụng mã PIN mặc định. Vui lòng đổi mã PIN để tăng cường bảo mật!</div>
                <div class="form-group"><label>Mã PIN hiện tại</label><input type="password" id="current_pin" class="form-control" maxlength="4" inputmode="numeric" autocomplete="one-time-code"></div>
                <div class="form-group"><label>Mã PIN mới (4 số)</label><input type="password" id="new_pin" class="form-control" maxlength="4" inputmode="numeric" autocomplete="one-time-code"></div>
                <div class="form-group"><label>Nhập lại PIN mới</label><input type="password" id="confirm_pin" class="form-control" maxlength="4" inputmode="numeric" autocomplete="one-time-code"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-block" style="background-color: #6f42c1; color: white;" onclick="submitChangePin()">Xác nhận đổi PIN</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview File -->
<div class="modal fade" id="modalPreview" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document" style="height: 90%;">
        <div class="modal-content" style="height: 100%;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="previewTitle">Xem trước</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0 d-flex justify-content-center align-items-center bg-light" id="previewBody" style="height: 100%; overflow: hidden;">
                <!-- Content loaded via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Change Avatar -->
<div class="modal fade" id="modalAvatar" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-image mr-2"></i>Đổi Ảnh đại diện</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body text-center">
                <div class="form-group"><label>Chọn ảnh từ thiết bị</label><input type="file" id="avatarFile" class="form-control-file border p-2" accept="image/*"></div>
                <div class="mt-3"><img id="previewAvatar" src="" style="max-width: 150px; max-height: 150px; border-radius: 50%; display: none;" class="shadow"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-block" onclick="submitAvatar()">Lưu ảnh đại diện</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal User Settings -->
<div class="modal fade" id="modalUserSettings" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-magic mr-2"></i>Cài đặt Giao diện & Hiệu ứng</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group d-flex justify-content-between align-items-center">
                    <label class="mb-0">Chế độ Tối (Dark Mode)</label>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="user_dark_mode" onchange="toggleUserDarkMode()">
                        <label class="custom-control-label" for="user_dark_mode"></label>
                    </div>
                </div>
                <hr>
                <div class="form-group">
                    <label><i class="fas fa-cloud-sun mr-2"></i>Chọn Hiệu ứng nền</label>
                    <select id="user_effect" class="form-control" onchange="previewUserEffect()">
                        <option value="">-- Mặc định (Theo Admin) --</option>
                        <option value="jack97">Đom đóm + Chân mèo (Jack J97)</option>
                        <option value="matrix">Hacker Matrix (Xanh lá)</option>
                        <option value="neon">Neon Cyberpunk (Hồng & Xanh)</option>
                    </select>
                    <small class="text-muted mt-2 d-block" id="effect_desc"></small>
                </div>
                <hr>
                <h6 class="text-primary font-weight-bold"><i class="fas fa-tachometer-alt mr-2"></i>Kiểm tra mạng (Speedtest)</h6>
                <div id="speedtest-area" class="p-3 rounded mb-2" style="background: rgba(0,0,0,0.05); border: 1px dashed #ccc;">
                    <div class="progress d-none mb-2" id="speed-progress" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
                    </div>
                    <div id="speed-result" class="font-weight-bold small text-center">Nhấn nút để kiểm tra</div>
                </div>
                <button class="btn btn-outline-primary btn-block btn-sm" onclick="runSpeedTest()" id="btn-speedtest">
                    <i class="fas fa-play mr-2"></i> Bắt đầu Test
                </button>
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle"></i> Cài đặt này sẽ được lưu riêng cho tài khoản của bạn.
                    <br>Tự động đăng xuất sau 5 phút không hoạt động.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveUserSettings()">Lưu Cài đặt</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal User Guide -->
<div class="modal fade" id="modalGuide" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-book-reader mr-2"></i>Hướng dẫn sử dụng</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="guideTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#guide-overview">Tổng quan</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#guide-attendance">Điểm danh</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#guide-students">Học sinh</a></li>
                    <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#guide-funds">Quỹ & Khác</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="guide-overview">
                        <p><b>Dashboard (Bảng điều khiển):</b> Màn hình chính hiển thị toàn bộ các chức năng quản lý.</p>
                        <ul>
                            <li><b>Menu chính:</b> Các ô chức năng lớn giúp truy cập nhanh vào Điểm danh, Quản lý HS, Quỹ...</li>
                            <li><b>Thông báo:</b> Nhấn vào biểu tượng chuông <i class="fas fa-bell text-warning"></i> trên thanh menu để xem thông báo từ Admin.</li>
                            <li><b>Cài đặt:</b> Nút <i class="fas fa-cog text-primary"></i> ở góc dưới bên phải dùng để chỉnh giao diện (Chế độ tối, Hiệu ứng nền).</li>
                        </ul>
                    </div>
                    <div class="tab-pane fade" id="guide-attendance">
                        <p><b>Quy trình điểm danh:</b></p>
                        <ol>
                            <li>Chọn tab <b>Điểm danh</b> từ màn hình chính.</li>
                            <li>Danh sách học sinh sẽ hiện ra với 3 tùy chọn:
                                <ul>
                                    <li><span class="text-success">Có mặt</span>: Học sinh đi học đầy đủ.</li>
                                    <li><span class="text-warning">Vắng (P)</span>: Vắng có phép (Hệ thống sẽ hiện ô nhập lý do).</li>
                                    <li><span class="text-danger">Vắng</span>: Vắng không phép.</li>
                                </ul>
                            </li>
                            <li>Sau khi chọn xong, nhấn nút <b>LƯU KẾT QUẢ ĐIỂM DANH</b> ở cuối trang.</li>
                        </ol>
                        <div class="alert alert-warning small">
                            <i class="fas fa-clock mr-1"></i> <b>Lưu ý:</b> Hệ thống tự động khóa điểm danh sau 20:00 hàng ngày. Nếu có lịch sinh hoạt đặc biệt, hệ thống sẽ mở khóa theo giờ quy định trong thông báo.
                        </div>
                    </div>
                    <div class="tab-pane fade" id="guide-students">
                        <p><b>Quản lý danh sách nhóm:</b></p>
                        <ul>
                            <li><b>Thêm HS:</b> Nhấn nút "Thêm HS" để nhập thủ công thông tin một học sinh mới.</li>
                            <li><b>Nhập Excel:</b> Dùng file mẫu của hệ thống để thêm nhanh danh sách lớn.</li>
                            <li><b>Sửa/Xóa:</b> Sử dụng các nút <i class="fas fa-edit text-info"></i> (Sửa) hoặc <i class="fas fa-trash text-danger"></i> (Xóa) tương ứng với từng học sinh.</li>
                            <li><b>In ấn:</b> Nhấn nút "In" để xuất danh sách ra giấy hoặc lưu PDF.</li>
                        </ul>
                    </div>
                    <div class="tab-pane fade" id="guide-funds">
                        <p><b>Quản lý Quỹ nhóm:</b></p>
                        <ul>
                            <li><b>Thu quỹ:</b> Nhập số tiền thu/người -> Tích chọn vào tên các học sinh đã đóng -> Nhấn "Lưu vào sổ quỹ".</li>
                            <li><b>Chi quỹ:</b> Nhấn nút "Chi quỹ" -> Nhập lý do chi và số tiền -> Lưu lại.</li>
                            <li><b>Lịch sử:</b> Xem lại bảng kê chi tiết các khoản thu/chi ở phía dưới. Có thể xuất báo cáo ra file Excel/PDF.</li>
                        </ul>
                        <hr>
                        <p><b>Các tiện ích khác:</b></p>
                        <ul>
                            <li><b>Đánh giá:</b> Xếp loại học sinh (Xuất sắc, Tốt, Khá...) vào cuối đợt sinh hoạt.</li>
                            <li><b>Phản ánh:</b> Gửi ý kiến, báo lỗi hoặc kiến nghị lên Admin. Có thể đính kèm ảnh minh họa.</li>
                            <li><b>Tài liệu:</b> Tải lên và chia sẻ file với nhóm hoặc gửi file cho Admin.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button></div>
        </div>
    </div>
</div>

<!-- Modal Upload Progress -->
<div class="modal fade" id="modalUploadProgress" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-cloud-upload-alt mr-2"></i>Tiến trình tải lên</h5>
            </div>
            <div class="modal-body text-center p-4">
                <h5 class="font-weight-bold mb-3 text-truncate" id="uploadFileName">Filename</h5>
                <div class="progress mb-2" style="height: 25px; border-radius: 15px;">
                    <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%; font-weight: bold;">0%</div>
                </div>
                <p class="text-muted mb-0" id="uploadProgressText">Đang chuẩn bị...</p>
            </div>
        </div>
    </div>
</div>

<!-- Jack J97 Audio -->
<audio id="jackAudio">
    <!-- Placeholder link for Dom Dom - Jack J97. Replace with actual file if available -->
    <source src="music/jack_j97_dom_dom.mp3" type="audio/mpeg">
    <source src="https://github.com/trietpko2002/trietpko2002.github.io/raw/main/music/dom_dom.mp3" type="audio/mpeg">
</audio>

<!-- Modal Easter Egg -->
<div class="modal fade" id="modalCredits" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-dark text-white text-center" style="border: 2px solid #ffd700;">
            <div class="modal-header border-0"><h5 class="modal-title font-weight-bold text-warning"><i class="fas fa-crown mr-2"></i>CREDITS</h5><button type="button" class="close text-white" onclick="stopEasterEgg()"><span>&times;</span></button></div>
            <div class="modal-body">
                <h4 class="text-primary font-weight-bold">Sản phẩm bởi Tổ Công nghệ Đoàn phường Phan Rang</h4>
                <p class="lead mb-1">Code by <span class="text-warning font-weight-bold">Triết Võ</span></p>
                <p class="mb-1">Sử dụng AI là Gemini Code Assist by Google</p>
                <p class="mb-1">Phần mềm Visual Studio Code</p>
                <p class="mb-3"><a href="https://github.com/trietpko2002" target="_blank" class="text-info">https://github.com/trietpko2002</a></p>
                <hr class="bg-secondary">
                <p class="mb-1"><i class="fas fa-envelope mr-2"></i>phanranggaming@gmail.com</p>
                <p class="mb-0"><i class="fas fa-phone mr-2"></i>0396385579</p>
            </div>
        </div>
    </div>
</div>
<audio id="eggAudio" loop><source src="music/easter_egg.mp3" type="audio/mpeg"></audio>
<audio id="startupAudio" preload="auto"><source src="music/startup.mp3" type="audio/mpeg"></audio>

<!-- Modal Update Available -->
<div class="modal fade" id="modalUpdateAvailable" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-sync-alt mr-2"></i>Cập nhật hệ thống</h5>
            </div>
            <div class="modal-body text-center">
                <p class="lead mb-2">Đã có phiên bản mới!</p>
                <p class="text-muted">Hệ thống vừa được cập nhật trên máy chủ. Vui lòng tải lại để áp dụng thay đổi.</p>
                <div class="alert alert-light border text-left small mb-3" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">
                    <strong>Nội dung cập nhật:</strong><br>
                    <span id="updateChangelog">...</span>
                </div>
                <button type="button" class="btn btn-success btn-lg font-weight-bold rounded-pill px-4 mt-2" onclick="window.location.reload(true)">
                    <i class="fas fa-redo mr-2"></i> Tải lại ngay
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";
let globalGroupStudents = [];
let globalNotifications = [];
let schoolList = [];
let globalFundLogs = [];
let globalMaxUploadSize = 200; // Default 200MB
let globalDriveLink = "";
let globalResources = [];
let autoLogoutTimer;

// --- LAZY LOAD LIBRARIES ---
const LIBS = {
    XLSX: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
    confetti: 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js',
    pdfMake: ['https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js']
};
const _loadedScripts = {};
function loadScript(url) {
    if (_loadedScripts[url]) return _loadedScripts[url];
    return _loadedScripts[url] = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
async function loadLib(name) {
    if (name === 'pdfMake' && !window.pdfMake) { await loadScript(LIBS.pdfMake[0]); await loadScript(LIBS.pdfMake[1]); return; }
    if (name === 'XLSX' && !window.XLSX) await loadScript(LIBS.XLSX);
    if (name === 'confetti' && !window.confetti) await loadScript(LIBS.confetti);
}

function generateCaptcha(elementId) {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < 5; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    const el = document.getElementById(elementId);
    if(el) el.innerText = result;
}

// --- HELPER FUNCTIONS FOR LOADING/ERROR STATES ---
function getLoadingRowHtml(colspan) {
    return `<tr><td colspan="${colspan}" class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Đang tải dữ liệu...</p></td></tr>`;
}
function getErrorRowHtml(colspan, message = "Không thể tải dữ liệu.") {
    return `<tr><td colspan="${colspan}" class="text-center text-danger p-5"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></td></tr>`;
}
const loadingSpinner = `<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Đang tải dữ liệu...</p></div>`;
const errorAlert = (message = "Không thể tải dữ liệu.") => `<div class="text-center p-5 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></div>`;

async function loadSchoolList() {
    if (schoolList.length > 0) return;
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_SCHOOL_LIST" }) });
        const res = await response.json();
        if (res.status === 'success') {
            schoolList = res.data;
        }
    } catch(e) { console.error("Failed to load school list", e); }
}

function populateSchoolDropdown(selectId) {
    const select = document.getElementById(selectId);
    if (!select || schoolList.length === 0) return;
    
    let html = '<option value="">-- Vui lòng chọn trường --</option>';
    schoolList.forEach(school => {
        html += `<option value="${school}">${school}</option>`;
    });
    html += '<option value="other">Trường khác...</option>';
    select.innerHTML = html;
}

function toggleOtherSchool(selectId, otherDivId) {
    const otherDiv = document.getElementById(otherDivId);
    otherDiv.style.display = (document.getElementById(selectId).value === 'other') ? 'block' : 'none';
}

function getSelectedSchool(selectId, otherInputId) {
    const select = document.getElementById(selectId);
    return (select.value === 'other') ? document.getElementById(otherInputId).value.trim() : select.value;
}


// Hàm hỗ trợ định dạng ngày tháng dd/mm/yyyy
function formatDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; // Trả về gốc nếu không phải định dạng ngày
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    } catch (e) {
        return dateStr;
    }
}

document.addEventListener("DOMContentLoaded", function() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const avatarUrl = user.avatar || 'https://via.placeholder.com/150';
    
    document.getElementById('managerDisplayName').innerText = user.fullname;
    document.getElementById('userAvatar').src = avatarUrl;
    
    const displayGroupName = user.group_name || user.group_id;
    if(document.getElementById('groupBadge')) document.getElementById('groupBadge').innerText = displayGroupName;
    
    
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
    
    // Load User Settings (Dark Mode & Effects)
    showMainMenu();
    loadUserSettings();
    
    // Init Auto Logout
    initAutoLogout();
    
    // Real-time GitHub Update Detection
    let currentCommitSha = null;
    async function checkGitHubUpdate() {
        try {
            const response = await fetch('https://api.github.com/repos/trietpko2002/trietpko2002.github.io/commits?per_page=1');
            if (response.ok) {
                const data = await response.json();
                const latestSha = data[0].sha;
                const message = data[0].commit.message;
                if (!currentCommitSha) {
                    currentCommitSha = latestSha;
                } else if (currentCommitSha !== latestSha) {
                    $('#updateChangelog').text(message);
                    $('#modalUpdateAvailable').modal('show');
                }
            }
        } catch (e) { console.log('Update check skipped'); }
    }
    checkGitHubUpdate();
    setInterval(checkGitHubUpdate, 120000); // Check every 2 minutes

    
    // Render VIP Honors
    $('#managerMenuDisplayName').text(user.fullname);
    
    // Render VIP Honors
    try {
        const honors = JSON.parse(user.honors || '{}');
        const avatarNav = $('#userAvatar');
        
        if (honors.level === 'vip1') {
            avatarNav.addClass('vip-border-1');
        } else if (honors.level === 'vip2') {
            avatarNav.addClass('vip-border-2');
            $('#vipCrownArea').html('<i class="fas fa-crown vip-crown"></i>');
        } else if (honors.level === 'vip3') {
            avatarNav.addClass('vip-border-3');
            $('#vipCrownArea').html('<i class="fas fa-gem vip-diamond"></i>');
        }
        else if (honors.level === 'vip4') {
            avatarNav.addClass('vip-border-4');
            $('#vipCrownArea').html('<i class="fas fa-crown vip-crown" style="color: #e5e4e2;"></i>');
        } else if (honors.level === 'vip5') {
            avatarNav.addClass('vip-border-5');
            $('#vipCrownArea').html('<i class="fas fa-crown vip-crown"></i>');
        } else if (honors.level === 'vip10') {
            avatarNav.addClass('vip-border-10');
            $('#vipCrownArea').html(`
                <i class="fas fa-crown vip-crown-10"></i>
                <i class="fas fa-dove vip-wing vip-wing-left"></i>
                <i class="fas fa-dove vip-wing vip-wing-right"></i>
            `);
            $('#managerDisplayName').html(user.fullname + ' <span class="badge badge-warning ml-1" style="font-size: 0.7rem; vertical-align: top;">VIP MEMBER</span>');
        }
    } catch(e) {}

    fetchStudentsByGroup(user.group_id);
    
    // Delay background tasks to prioritize attendance loading
    setTimeout(() => {
        loadGlobalConfig(); // Tải cấu hình hệ thống (Bảo trì, Marquee...)
        loadNotifications();
        loadGroupsForSelect(); // Tải danh sách nhóm để dùng khi chuyển nhóm
        loadResources(); // Tải tài nguyên
        loadFeedbackHistory();
        generateCaptcha('captcha_code_fb'); // Tạo captcha cho form feedback
    }, 800);
    initCardCollapseState();
    
    // Role specific UI
    if (user.role === 'supervisor') {
        $('#menu-registrations').removeClass('d-none');
    }
    
    // Start Polling for Notifications (Push Simulation)
    setInterval(pollForNotifications, 60000); // Check every 60s
    
    // Simulate Update Loading
    const statusText = document.getElementById('welcome-status-text');
    const percentText = document.getElementById('welcome-percent');
    const progressBar = document.getElementById('welcome-progress-bar');
    const welcomeScreen = document.getElementById('welcome-screen');
    
    if (statusText && progressBar && welcomeScreen) {
        let progress = 0;
        const messages = ["Đang kết nối máy chủ...", "Kiểm tra phiên bản...", "Tải xuống giao diện mới...", "Cập nhật tính năng...", "Hoàn tất!"];
        
        const interval = setInterval(() => {
            progress += Math.floor(Math.random() * 5) + 2;
            if (progress > 100) progress = 100;
            
            progressBar.style.width = `${progress}%`;
            if(percentText) percentText.innerText = `${progress}%`;
            
            const step = Math.min(Math.floor((progress / 100) * messages.length), messages.length - 1);
            statusText.innerText = messages[step];

            if (progress === 100) {
                clearInterval(interval);
                document.getElementById('startupAudio')?.play().catch(e => {});
                setTimeout(() => { welcomeScreen.classList.add('hidden'); }, 800);
            }
        }, 50); // Speed of loading
    } else {
        setTimeout(() => { $('#welcome-screen').addClass('hidden'); }, 1500);
    }

    // Kiểm tra mã PIN mặc định
    if (user.is_default_pin) {
        $('#modalChangePin').modal('show');
        $('#pinAlert').removeClass('d-none');
        $('#btnClosePinModal').hide();
    }

    // Kiểm tra mật khẩu mặc định
    if (user.is_default_pass) {
        $('#modalChangePass').modal('show');
        $('#passAlert').removeClass('d-none');
        $('#btnClosePassModal').hide(); // Ẩn nút đóng để bắt buộc đổi
    }
});

// --- USER SETTINGS & AUTO LOGOUT ---

function initAutoLogout() {
    const resetTimer = () => {
        clearTimeout(autoLogoutTimer);
        autoLogoutTimer = setTimeout(() => {
            Swal.fire({
                title: 'Hết phiên làm việc',
                text: 'Bạn đã không hoạt động trong 5 phút. Hệ thống sẽ tự động đăng xuất.',
                icon: 'warning',
                timer: 5000,
                timerProgressBar: true,
                willClose: () => logout()
            });
        }, 5 * 60 * 1000); // 5 minutes
    };

    window.onload = resetTimer;
    document.onmousemove = resetTimer;
    document.onkeypress = resetTimer;
    document.onclick = resetTimer;
    document.onscroll = resetTimer;
}

function openUserSettings() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const settings = JSON.parse(localStorage.getItem(`userSettings_${user.username}`) || '{}');
    
    $('#user_dark_mode').prop('checked', settings.darkMode === true);
    $('#user_effect').val(settings.effect || '');
    $('#modalUserSettings').modal('show');
}

function toggleUserDarkMode() {
    // Preview only
    if ($('#user_dark_mode').is(':checked')) $('body').addClass('dark-mode');
    else $('body').removeClass('dark-mode');
}

function previewUserEffect() {
    const effect = $('#user_effect').val();
    const desc = $('#effect_desc');
    if (effect === 'jack97') desc.text('Chế độ Fan Jack: Nhạc Đom Đóm + Chân mèo + Dark Mode.');
    else if (effect === 'matrix') desc.text('Giao diện Hacker với mưa code xanh lá.');
    else if (effect === 'neon') desc.text('Giao diện đèn Neon rực rỡ.');
    else desc.text('');
}

function saveUserSettings() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const settings = {
        darkMode: $('#user_dark_mode').is(':checked'),
        effect: $('#user_effect').val()
    };
    
    localStorage.setItem(`userSettings_${user.username}`, JSON.stringify(settings));
    applyUserSettings(settings);
    $('#modalUserSettings').modal('hide');
    toastr.success('Đã lưu cài đặt cá nhân!');
}

function loadUserSettings() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (!user) return;
    
    const settings = JSON.parse(localStorage.getItem(`userSettings_${user.username}`) || '{}');
    applyUserSettings(settings);
}

function applyUserSettings(settings) {
    // 1. Dark Mode
    if (settings.darkMode) $('body').addClass('dark-mode');
    else $('body').removeClass('dark-mode');

    // 2. Effects
    $('.weather-overlay').remove();
    $('.firefly').remove();
    $('.star').remove();
    $('body').removeClass('jack-mode theme-matrix theme-neon');
    $('#matrix-canvas').hide();
    
    const audio = document.getElementById('jackAudio');
    if(audio) { audio.pause(); audio.currentTime = 0; }
    
    // Stop Matrix Interval if exists
    if (window.matrixInterval) clearInterval(window.matrixInterval);

    const effect = settings.effect;
    if (!effect) return; // Use default (Admin config will take over in loadGlobalConfig if no user effect)

    if (effect === 'jack97') {
        $('body').addClass('jack-mode');
        // Fireflies - Optimize for mobile
        const count = (window.innerWidth < 768) ? 5 : 15; // Tối ưu số lượng đom đóm
        for(let i=0; i<count; i++) {
            const f = document.createElement('div');
            f.className = 'firefly';
            f.style.top = Math.random() * 100 + 'vh';
            f.style.left = Math.random() * 100 + 'vw';
            f.style.animationDuration = (Math.random() * 5 + 5) + 's';
            f.style.animationDelay = Math.random() * 5 + 's';
            document.body.appendChild(f);
        }
        // Play Music
        if(audio && !sessionStorage.getItem('jack_music_played')) {
            audio.play().catch(e => console.log("Autoplay blocked", e));
            sessionStorage.setItem('jack_music_played', 'true');
        }
    }
}

// --- NEW NAVIGATION ---
function showTab(tabId) {
    $('#main-menu-section').hide();
    $('#functional-section').fadeIn();
    $('.tab-pane').removeClass('show active');
    $('#' + tabId).addClass('show active');
    window.scrollTo(0, 0);
}

function showMainMenu() {
    $('#functional-section').hide();
    $('#main-menu-section').fadeIn();
}

// --- PUSH NOTIFICATION LOGIC (POLLING) ---
async function pollForNotifications() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (!user) return;
    
    try {
        // Fetch latest notifications (lightweight check if possible, here reusing existing API)
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS", payload: { username: user.username } }) });
        const res = await response.json();
        
        if (res.status === "success" && res.data.notifications && res.data.notifications.length > 0) {
            const latestNoti = res.data.notifications[0]; // Assuming sorted by newest
            const lastSeenId = localStorage.getItem('last_noti_id');
            
            if (latestNoti.id !== lastSeenId) {
                // New notification found!
                localStorage.setItem('last_noti_id', latestNoti.id);
                
                // Trigger Browser Notification
                if (Notification.permission === 'granted') {
                    new Notification("Thông báo mới từ SHH", {
                        body: latestNoti.title,
                        icon: 'https://via.placeholder.com/128?text=SHH' // Replace with app icon
                    });
                } else {
                    toastr.info("Có thông báo mới: " + latestNoti.title);
                }
                // Reload list in UI
                loadNotifications();
            }
        }
    } catch(e) { console.log("Polling error", e); }
}


// --- MAINTENANCE CHECK ---
async function loadGlobalConfig() {
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_CONFIG" }) });
        const res = await response.json();
        if (res.status === "success") {
            const conf = res.data;
            sessionStorage.setItem('globalConfig', JSON.stringify(conf)); // Lưu config để dùng cho check Lock
            
            // 1. Global Maintenance (Bảo trì toàn bộ)
            // 1. Global Maintenance (Bảo trì toàn bộ - Manual & Auto)
            const now = new Date();
            const start = conf.maintenance_start ? new Date(conf.maintenance_start) : null;
            const end = conf.maintenance_end ? new Date(conf.maintenance_end) : null;
            let isMaintenance = false;
            let showTimer = false;

            // Check Manual
            if (String(conf.maintenance_mode).toUpperCase() === 'TRUE') {
                showMaintenanceOverlay(null, null, 'https://github.com/trietpko2002/trietpko2002.github.io/raw/main/music/bao_tri.mp3');
                return;
            } 
            // Check Schedule
            else if (start && end && now >= start && now <= end) {
                isMaintenance = true;
                showTimer = true;
            }

            if (isMaintenance) {
                showMaintenanceOverlay(showTimer ? start : null, showTimer ? end : null, 'https://github.com/trietpko2002/trietpko2002.github.io/raw/main/music/bao_tri.mp3');
                return;
            }

            // 2. Marquee (Chữ chạy)
            if (String(conf.marquee_enabled).toUpperCase() === 'TRUE' && conf.marquee_text) {
                $('#marqueeText').text(conf.marquee_text);
                // Set direction (default right: left-to-right)
                $('#marqueeText').parent().attr('direction', conf.marquee_direction || 'right');
                $('#topMarquee').show();
                
                // Apply Theme Color to Marquee Background
                if (conf.theme_color) {
                    $('#topMarquee').css('background', conf.theme_color);
                }
            } else {
                $('#topMarquee').hide();
            }
            
            // Cover Image
            if (conf.cover_image) {
                $('#img-cover').attr('src', conf.cover_image);
                $('#attendance-cover').show();
            }

            // Weather Effect (Global) - Only if user hasn't set custom
            const user = JSON.parse(sessionStorage.getItem('user'));
            const userSettings = JSON.parse(localStorage.getItem(`userSettings_${user.username}`) || '{}');
            
            if (!userSettings.effect) {
                $('.weather-overlay').remove(); // Clear old
                if (conf.weather_effect) {
                    const weatherDiv = document.createElement('div');
                    weatherDiv.className = `weather-overlay weather-${conf.weather_effect}`;
                    document.body.appendChild(weatherDiv);
                }
            }

            // Load Max Upload Size
            globalMaxUploadSize = parseInt(conf.max_upload_size) || 200;
            $('#limit_display').text(globalMaxUploadSize);
            globalDriveLink = conf.upload_drive_link || "";

            // Check Upload Maintenance
            if (String(conf.maint_upload).toUpperCase() === 'TRUE') {
                $('#upload_feature_area').hide();
                $('#upload_blocked_msg').removeClass('d-none');
                if (conf.upload_drive_link) {
                    $('#upload_drive_link_display').html(`Tính năng tải file trực tiếp đang tắt.`);
                } else {
                    $('#upload_drive_link_display').text("Vui lòng liên hệ Admin để biết thêm chi tiết.");
                }
            }

            // 3. Feature Maintenance (Bảo trì từng phần)
            const features = {
                'maint_attendance': 'tab-attendance',
                'maint_students': 'tab-students',
                'maint_funds': 'tab-funds',
                'maint_eval': 'tab-evaluation',
                'maint_feedback': 'tab-feedback',
                // 'maint_upload': 'tab-upload' // Handled separately above
            };

            for (const [key, tabId] of Object.entries(features)) {
                if (String(conf[key]).toUpperCase() === 'TRUE') {
                    $(`#${tabId}`).html('<div class="text-center p-5 text-muted"><i class="fas fa-tools fa-3x mb-3 text-warning"></i><h4>Tính năng đang bảo trì</h4><p>Vui lòng quay lại sau.</p></div>');
                }
            }
            checkUrgentNotification(conf);
        }
    } catch(e) {}
}

function showMaintenanceOverlay(startTime, endTime, musicUrl) {
    const overlay = document.createElement('div');
    overlay.id = 'maintenance-overlay';
    
    let timeHtml = '';
    if (endTime) {
        timeHtml = `
            <div class="w-75 mt-4" style="max-width: 500px;">
                <h4 id="maint-timer" class="font-weight-bold mb-3 text-warning" style="font-family: monospace; font-size: 2.5rem; text-shadow: 0 0 10px rgba(0,0,0,0.5);">00:00:00</h4>
                <div class="progress" style="height: 25px; background-color: rgba(255,255,255,0.2);">
                    <div id="maint-progress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%; font-weight: bold; color: #fff; background-color: #00d2ff;">0%</div>
                </div>
                <p class="mt-2 text-light"><small>Hệ thống sẽ tự động mở lại vào: ${endTime.toLocaleString('vi-VN')}</small></p>
            </div>`;
    }
    
    let visualizerHtml = '';
    let audioHtml = '';
    if (musicUrl) {
        visualizerHtml = `<div class="music-visualizer">
            <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
            <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
            <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
        </div>`;
        
        audioHtml = `<audio autoplay loop id="maint-audio"><source src="${musicUrl}" type="audio/mpeg"></audio>
        <button class="btn btn-sm btn-outline-light mt-3 rounded-pill px-4" onclick="const a=document.getElementById('maint-audio'); if(a.paused){a.play(); $('.music-visualizer').css('opacity','1');}else{a.pause(); $('.music-visualizer').css('opacity','0.2');}"><i class="fas fa-music mr-2"></i>Bật/Tắt Nhạc</button>`;
    }

    overlay.innerHTML = `
        <i class="fas fa-tools fa-4x mb-3 text-warning"></i>
        <h1 class="font-weight-bold">HỆ THỐNG ĐANG BẢO TRÌ</h1>
        <p class="lead">Chúng tôi đang nâng cấp hệ thống để phục vụ tốt hơn.</p>
        ${timeHtml}
        ${visualizerHtml}
        ${audioHtml}
        <button class="btn btn-outline-light mt-4 font-weight-bold" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất</button>
    `;
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    if (endTime) {
        const updateTimer = () => {
            const now = new Date();
            const distance = endTime - now;
            if (distance < 0) { location.reload(); return; }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            document.getElementById('maint-timer').innerText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (startTime) {
                let percent = ((now - startTime) / (endTime - startTime)) * 100;
                percent = Math.min(100, Math.max(0, percent));
                const bar = document.getElementById('maint-progress');
                bar.style.width = `${percent}%`;
                bar.innerText = `${Math.round(percent)}%`;
            }
        };
        updateTimer(); setInterval(updateTimer, 1000);
    }
}

// --- LOGIC ĐỔI MẬT KHẨU ---
function openChangePassModal() {
    $('#modalChangePass').modal('show');
    $('#passAlert').addClass('d-none');
    $('#btnClosePassModal').show();
    $('#old_pass, #new_pass, #confirm_pass').val('');
}

async function submitChangePass() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const oldPass = $('#old_pass').val().trim();
    const newPass = $('#new_pass').val().trim();
    const confirmPass = $('#confirm_pass').val().trim();

    if (!oldPass) return toastr.warning("Vui lòng nhập mật khẩu cũ!");
    if (newPass.length < 6) return toastr.warning("Mật khẩu phải từ 6 ký tự trở lên!");
    if (newPass !== confirmPass) return toastr.error("Mật khẩu nhập lại không khớp!");

    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "CHANGE_PASSWORD", payload: { username: user.username, old_pass: oldPass, new_pass: newPass } }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Vui lòng đăng nhập lại!', 'success').then(() => logout());
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- LOGIC ĐỔI MÃ PIN ---
function openChangePinModal() {
    $('#modalChangePin').modal('show');
    $('#pinAlert').addClass('d-none');
    $('#btnClosePinModal').show();
    $('#current_pin, #new_pin, #confirm_pin').val('');
}

async function submitChangePin() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const currentPin = $('#current_pin').val().trim();
    const newPin = $('#new_pin').val().trim();
    const confirmPin = $('#confirm_pin').val().trim();

    if (newPin.length !== 4) return toastr.warning("Mã PIN mới phải có 4 số!");
    if (newPin !== confirmPin) return toastr.error("Mã PIN nhập lại không khớp!");
    if (currentPin === newPin) return toastr.warning("Mã PIN mới phải khác mã PIN hiện tại!");

    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            redirect: "follow",
            body: JSON.stringify({ 
                action: "CHANGE_PIN", 
                payload: { username: user.username, current_pin: currentPin, new_pin: newPin } 
            }) 
        });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã đổi mã PIN thành công!', 'success');
            $('#modalChangePin').modal('hide');
            user.is_default_pin = false; // Cập nhật trạng thái trong session
            sessionStorage.setItem('user', JSON.stringify(user));
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- LOGIC ĐỔI AVATAR (FILE -> LINK BASE64) ---
function openAvatarModal() {
    $('#modalAvatar').modal('show');
    $('#avatarFile').val('');
    $('#previewAvatar').hide();
}

$('#avatarFile').change(function() {
    const file = this.files[0];
    if (file) {
        resizeImage(file, 300, 300, function(base64) {
            $('#previewAvatar').attr('src', base64).show();
        });
    }
});

function resizeImage(file, maxWidth, maxHeight, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } 
            else { if (h > maxHeight) { w *= maxHeight / h; h = maxHeight; } }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', 0.7)); // Nén ảnh JPEG 70%
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

async function submitAvatar() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const avatarBase64 = $('#previewAvatar').attr('src');
    if (!avatarBase64) return toastr.warning("Vui lòng chọn ảnh!");
    Swal.fire({ title: 'Đang tải lên...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "UPDATE_AVATAR", payload: { username: user.username, avatar: avatarBase64 } }) });
        const res = await response.json();
        if (res.status === 'success') {
            user.avatar = avatarBase64;
            sessionStorage.setItem('user', JSON.stringify(user));
            $('#userAvatar, #userAvatarInner').attr('src', avatarBase64);
            // Force refresh images in profile if open
            $('#modalAvatar').modal('hide');
            Swal.fire('Thành công', 'Đã cập nhật ảnh đại diện!', 'success');
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

let globalGroupsList = [];
async function loadGroupsForSelect() {
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_GROUPS_PUBLIC" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalGroupsList = res.data;
            let html = '<option value="">-- Chọn nhóm --</option>';
            res.data.forEach(g => { html += `<option value="${g.id}">${g.name}</option>`; });
            $('#st_group_select').html(html);
        }
    } catch (e) { console.error(e); }
}

async function fetchStudentsByGroup(groupId, retry = 0) {
    const attContainer = document.getElementById('attendanceList');
    const tableBody = document.getElementById('groupStudentList');
    
    if (retry === 0) {
        attContainer.innerHTML = loadingSpinner;
        tableBody.innerHTML = getLoadingRowHtml(7);
    }

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            redirect: "follow",
            body: JSON.stringify({
                action: "GET_STUDENTS_BY_GROUP",
                payload: { group_id: groupId }
            })
        });
        const res = await response.json();

        if (res.status === "success") {
            globalGroupStudents = res.data;
            let attHtml = '';
            let tableHtml = '';

            res.data.forEach((student, index) => {
                const user = JSON.parse(sessionStorage.getItem('user'));
                // Định dạng ngày sinh sang dd/mm/yyyy
                const formattedDob = formatDate(student.dob);

                attHtml += `
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="info-box shadow-sm border">
                            <div class="info-box-content">
                                <span class="info-box-text font-weight-bold" style="font-size:1.1rem">${student.fullname}</span>
                                <div class="btn-group btn-group-toggle mt-2 w-100" data-toggle="buttons">
                                    <label class="btn btn-outline-success active" onclick="$('#reason_box_${student.id}').addClass('d-none')">
                                        <input type="radio" name="st_${student.id}" value="present" checked> Có mặt
                                    </label>
                                    <label class="btn btn-outline-warning" onclick="$('#reason_box_${student.id}').removeClass('d-none'); $('#reason_${student.id}').focus()">
                                        <input type="radio" name="st_${student.id}" value="absent_perm"> Vắng (P)
                                    </label>
                                    <label class="btn btn-outline-danger" onclick="$('#reason_box_${student.id}').addClass('d-none')">
                                        <input type="radio" name="st_${student.id}" value="absent"> Vắng
                                    </label>
                                </div>
                                <div id="reason_box_${student.id}" class="mt-2 d-none">
                                    <input type="text" id="reason_${student.id}" class="form-control form-control-sm" placeholder="Nhập lý do vắng...">
                                </div>
                            </div>
                        </div>
                    </div>`;

                tableHtml += `
                    <tr>
                        <td class="text-center font-weight-bold">${index + 1}</td>
                        <td class="font-weight-bold">${student.fullname}</td>
                        <td class="text-center">${student.gender || ''}</td>
                        <td class="text-center text-primary font-weight-bold">${formattedDob}</td>
                        <td>${student.class_name || '-'}</td>
                        <td>${student.school || '-'}</td>
                        <td style="white-space: normal;">${student.address || '-'}</td>
                        <td class="text-center">
                            ${student.phone ? `<a href="tel:${student.phone}" class="btn btn-xs btn-link"><i class="fas fa-phone mr-1"></i>${student.phone}</a>` : '-'}
                        </td>
                        <td class="text-center">${user.role !== 'supervisor' ? `
                            <button class="btn btn-xs btn-info" onclick="editStudent(${index})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-xs btn-danger" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i></button>
                        ` : '<span class="badge badge-secondary">Chỉ xem</span>'}</td>
                    </tr>`;
            });

            attContainer.innerHTML = attHtml || '<div class="col-12 text-center">Không có dữ liệu.</div>';
            tableBody.innerHTML = tableHtml || '<tr><td colspan="6" class="text-center">Không có dữ liệu.</td></tr>';
            checkAttendanceLock(); // Kiểm tra khóa sau khi render xong
            loadEvaluationUI(); // Tải đánh giá sau khi đã có danh sách học sinh
        }
    } catch (error) {
        if (retry < 2) {
            console.warn("Retrying fetchStudentsByGroup...", retry);
            setTimeout(() => fetchStudentsByGroup(groupId, retry + 1), 1500);
        } else {
            toastr.error("Lỗi kết nối máy chủ.");
            attContainer.innerHTML = errorAlert(`
                <div>Không thể tải dữ liệu.</div>
                <button class="btn btn-primary mt-2" onclick="fetchStudentsByGroup('${groupId}')"><i class="fas fa-sync"></i> Thử lại</button>
            `);
            tableBody.innerHTML = getErrorRowHtml(7, `Lỗi kết nối. <a href="javascript:void(0)" onclick="fetchStudentsByGroup('${groupId}')">Thử lại</a>`);
        }
    }
}

function openNotificationModal() {
    $('#modalNotifications').modal('show');
}

async function loadNotifications() {
    const notiList = $('#notificationListModal');
    notiList.html(loadingSpinner);
    try {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS", payload: { username: user.username } }) });
        const res = await response.json();
        
        if (res.status === "success" && res.data.notifications) {
            globalNotifications = res.data.notifications; // Lưu vào biến toàn cục để check lock
            let html = '';
            const notis = res.data.notifications;
            const readIds = res.data.read_ids || [];

            let unreadCount = 0;
            if(notis.length === 0) {
                html = '<li class="item text-center p-3 text-muted">Không có thông báo nào.</li>';
            } else {
                notis.forEach(n => {
                    const isRead = readIds.includes(n.id);
                    const btnHtml = isRead 
                        ? '<span class="badge badge-secondary float-right ml-2"><i class="fas fa-check mr-1"></i>Đã xem</span>' 
                        : `<button class="btn btn-xs btn-outline-primary float-right ml-2" onclick="markRead('${n.id}')">Đã xem</button>`;
                    
                    if (!isRead) unreadCount++;

                    // --- XỬ LÝ BÌNH CHỌN (POLL) ---
                    let pollHtml = '';
                    if (n.type === 'poll') {
                        try {
                            const pollData = JSON.parse(n.content); // {question, options:[], deadline}
                            const isExpired = new Date() > new Date(pollData.deadline);
                            
                            if (isExpired) {
                                pollHtml = `<div class="mt-2 p-2 bg-light border rounded border-danger text-center"><span class="text-danger font-weight-bold">Bình chọn đã kết thúc</span></div>`;
                            } else {
                                let optionsHtml = '';
                                pollData.options.forEach((opt, idx) => {
                                    optionsHtml += `
                                        <div class="custom-control custom-radio mb-1">
                                            <input class="custom-control-input" type="radio" id="poll_${n.id}_${idx}" name="poll_opt_${n.id}" value="${opt}">
                                            <label for="poll_${n.id}_${idx}" class="custom-control-label font-weight-normal">${opt}</label>
                                        </div>`;
                                });

                                // Checkbox chọn nhiều học sinh
                                let studentListHtml = '<div class="student-checkbox-grid">';
                                globalGroupStudents.forEach((st, sIdx) => {
                                    studentListHtml += `
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input poll-student-check-${n.id}" id="ps_${n.id}_${sIdx}" value="${st.fullname}">
                                            <label class="custom-control-label small" for="ps_${n.id}_${sIdx}">${st.fullname}</label>
                                        </div>`;
                                });
                                studentListHtml += '</div>';

                                pollHtml = `
                                    <div class="mt-3 p-3 bg-white border rounded shadow-sm">
                                        <h6 class="font-weight-bold text-primary border-bottom pb-2 mb-2"><i class="fas fa-poll mr-2"></i>Bình chọn: ${pollData.question}</h6>
                                        <div class="mb-2 font-weight-bold text-dark small">1. Chọn học sinh tham gia:</div>
                                        ${studentListHtml}
                                        <div class="mb-2 font-weight-bold text-dark small">2. Chọn phương án (1 lựa chọn):</div>
                                        ${optionsHtml}
                                        <button class="btn btn-primary btn-sm btn-block mt-3" onclick="submitVote('${n.id}')"><i class="fas fa-paper-plane mr-2"></i>Gửi bình chọn</button>
                                        <button class="btn btn-info btn-sm btn-block mt-2" onclick="viewPollResults('${n.id}')"><i class="fas fa-chart-pie mr-2"></i>Xem kết quả</button>
                                        <small class="text-muted d-block mt-2 text-right">Hạn chót: ${formatDate(pollData.deadline)}</small>
                                    </div>`;
                            }
                            // Ẩn nội dung gốc vì đã hiển thị trong Poll Card
                            n.content = ''; 
                        } catch(e) { pollHtml = `<div class="text-danger">Lỗi hiển thị bình chọn</div>`; }
                    }

                    let meetingInfo = '';
                    if (n.type === 'online' && n.location) {
                        meetingInfo = `
                            <div class="mt-2 p-2 bg-light border rounded border-primary">
                                <i class="fas fa-video text-primary mr-2"></i><strong>Họp Online:</strong> 
                                <a href="${n.location}" target="_blank" class="btn btn-sm btn-primary ml-2"><i class="fas fa-external-link-alt mr-1"></i>Tham gia ngay</a>
                            </div>`;
                    } else if (n.type === 'offline' && n.location) {
                        meetingInfo = `
                            <div class="mt-2 p-2 bg-light border rounded border-success">
                                <i class="fas fa-map-marker-alt text-success mr-2"></i><strong>Địa điểm:</strong> <span class="text-dark">${n.location}</span>
                            </div>`;
                    }

                    let linkHtml = '';
                    if (n.link) {
                        linkHtml = `<div class="mt-2"><a href="${n.link}" target="_blank" class="btn btn-sm btn-info"><i class="fas fa-link mr-1"></i>Truy cập liên kết</a></div>`;
                    }

                    let attachHtml = '';
                    if (n.attachment) {
                        // Kiểm tra loại file để hiển thị icon/text phù hợp
                        let isPdf = n.attachment.indexOf('application/pdf') !== -1;
                        let btnIcon = isPdf ? 'fa-file-pdf' : 'fa-file-word';
                        let fileName = n.attachment_name || (isPdf ? 'Tai_lieu.pdf' : 'Tai_lieu.docx');
                        
                        attachHtml = `
                            <div class="mt-2">
                                <a href="${n.attachment}" download="${fileName}" class="btn btn-sm btn-outline-dark text-truncate" style="max-width: 100%;"><i class="fas ${btnIcon} mr-1"></i> ${fileName}</a>
                            </div>`;
                    }

                    html += `
                    <li class="item">
                        <div class="product-info ml-2 mr-2">
                            <span class="product-title font-weight-bold text-primary">${n.title}
                                ${btnHtml}
                                <span class="badge badge-warning float-right ml-2">${n.datetime}</span>
                            </span>
                            <span class="product-description" style="white-space: pre-line; display: ${n.content ? 'block' : 'none'}">
                                ${n.content}
                            </span>
                            ${pollHtml}
                            ${attachHtml}
                            ${linkHtml}
                            ${meetingInfo}
                            ${n.early === 'TRUE' ? '<span class="badge badge-success mt-1">Điểm danh sớm</span>' : ''}
                        </div>
                    </li>`;
                });
            }
            notiList.html(html);
            $('#notiBadge').text(unreadCount > 0 ? unreadCount : '');
            checkAttendanceLock(); // Kiểm tra khóa sau khi có dữ liệu thông báo
        }
    } catch (e) {
        console.error(e);
        notiList.html(`<li class="item">${errorAlert('Lỗi tải thông báo.')}</li>`);
    }
}

// --- HÀM KIỂM TRA KHÓA ĐIỂM DANH ---
function checkAttendanceLock() {
    const now = new Date();
    const currentHour = now.getHours();
    const submitBtn = document.querySelector('button[onclick="submitAttendance()"]');
    const inputs = document.querySelectorAll('input[name^="st_"]');
    const conf = JSON.parse(sessionStorage.getItem('globalConfig') || '{}');
    
    // VIP Member Bypass
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (user && user.role === 'vip_member') {
        // Explicitly enable to be sure
        if(submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i><b>LƯU KẾT QUẢ ĐIỂM DANH</b>`;
            submitBtn.classList.add('btn-success');
            submitBtn.classList.remove('btn-secondary');
        }
        inputs.forEach(inp => inp.disabled = false);
        $('.attendance-alert').remove();
        return; 
    }
    
    // Xóa thông báo cũ nếu có
    $('.attendance-alert').remove();
    
    // Xóa cảnh báo sắp khóa cũ
    $('.attendance-warning-timer').remove();

    let isLocked = false;
    let message = "";

    // 1. Khóa nếu sau 20:00 (8h tối)
    if (currentHour >= 20) {
        isLocked = true;
        message = "Đã quá thời gian điểm danh trong ngày (Sau 20:00).";
    } else {
        // 2. Khóa nếu có lịch họp hôm nay mà chưa đến giờ (và không cho điểm danh sớm)
        // Format ngày hiện tại yyyy-MM-dd để so sánh
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        
        // Tìm thông báo có ngày trùng hôm nay
        const todayNoti = globalNotifications.find(n => n.datetime.startsWith(todayStr));
        
        if (todayNoti) {
            const meetingTime = new Date(todayNoti.datetime.replace(" ", "T")); // Chuyển đổi format cho Safari/Mobile
            const isEarlyAllowed = todayNoti.early === 'TRUE';
            
            if (now < meetingTime && !isEarlyAllowed) {
                isLocked = true;
                message = `Chưa đến giờ điểm danh (${todayNoti.datetime.split(' ')[1]}). Không cho phép điểm danh sớm.`;
            }
        }
    }

    if (isLocked) {
        if(submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i class="fas fa-lock mr-2"></i> ${message}`;
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
        inputs.forEach(inp => inp.disabled = true);
        $('#attendanceList').prepend(`<div class="col-12 attendance-alert"><div class="alert alert-warning font-weight-bold"><i class="fas fa-exclamation-triangle mr-2"></i>${message}</div></div>`);
    } else {
        // Logic cảnh báo sắp khóa (Trước 1 tiếng)
        let closingTime = null;
        // Xác định giờ đóng
        if (String(conf.noti_override).toUpperCase() === 'TRUE' && todayNoti) {
             const meetingTime = new Date(todayNoti.datetime.replace(" ", "T"));
             
             const closeHour = conf.attendance_end_time ? parseInt(conf.attendance_end_time.split(':')[0]) : 24;
             const closeMinute = conf.attendance_end_time ? parseInt(conf.attendance_end_time.split(':')[1]) : 0;
             const endOfDay = new Date(now);
             endOfDay.setHours(closeHour, closeMinute, 0, 0);
             if (closeHour === 24) endOfDay.setHours(23, 59, 59, 999);
             
             const finalEndTime = meetingTime > endOfDay ? new Date(now.setHours(23,59,59,999)) : endOfDay;
             if (now <= finalEndTime) closingTime = finalEndTime;
        }
        if (!closingTime) {
             const closeHour = conf.attendance_end_time ? parseInt(conf.attendance_end_time.split(':')[0]) : 20;
             closingTime = new Date(); closingTime.setHours(closeHour, 0, 0, 0);
        }

        if (closingTime && closingTime > now) {
            const diffMins = (closingTime - now) / 60000;
            if (diffMins <= 60) {
                $('#attendanceList').prepend(`<div class="col-12 attendance-warning-timer"><div class="alert alert-warning text-center font-weight-bold"><i class="fas fa-clock mr-2"></i>Hệ thống sẽ khóa điểm danh trong ${Math.ceil(diffMins)} phút nữa!</div></div>`);
            }
        }

        // Mở khóa nếu hợp lệ
        if(submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i><b>LƯU KẾT QUẢ ĐIỂM DANH</b>`;
            submitBtn.classList.add('btn-success');
            submitBtn.classList.remove('btn-secondary');
        }
        inputs.forEach(inp => inp.disabled = false);
    }
}

async function markRead(id) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "MARK_READ", payload: { username: user.username, notification_id: id } }) });
        const res = await response.json();
        if (res.status === 'success') {
            loadNotifications(); // Tải lại để cập nhật trạng thái
        }
    } catch (e) { console.error(e); }
}

async function openStudentModal() {
    $('#modalStudent').modal('show');
    $('#student_id_old').val('');
    $('#st_id').val('').prop('readonly', false);
    $('#st_name').val('');
    $('#st_gender').val('');
    $('#st_dob').val('');
    $('#st_class').val('');
    $('#st_address').val('');
    $('#st_phone').val('');
    $('#st_reg_time').val('');
    $('#st_reg_loc').val('');
    
    await loadSchoolList();
    populateSchoolDropdown('st_school_select');
    $('#st_school_select').val('');
    $('#st_school_other').val('');
    toggleOtherSchool('st_school_select', 'st_school_other_div');

    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#st_group_select').val(user.group_id);
}

async function editStudent(index) {
    const s = globalGroupStudents[index];
    $('#student_id_old').val(s.id);
    $('#st_id').val(s.id).prop('readonly', true);
    $('#st_name').val(s.fullname);
    $('#st_gender').val(s.gender);
    $('#st_dob').val(s.dob);
    $('#st_class').val(s.class_name);
    $('#st_address').val(s.address);
    $('#st_phone').val(s.phone);
    $('#st_reg_time').val(s.reg_time);
    $('#st_reg_loc').val(s.reg_loc);
    
    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#st_group_select').val(user.group_id);

    await loadSchoolList();
    populateSchoolDropdown('st_school_select');
    if (schoolList.includes(s.school)) {
        $('#st_school_select').val(s.school);
    } else if (s.school) {
        $('#st_school_select').val('other');
        $('#st_school_other').val(s.school);
    } else {
        $('#st_school_select').val('');
    }
    toggleOtherSchool('st_school_select', 'st_school_other_div');

    $('#modalStudent').modal('show');
}

async function saveStudent() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const idOld = $('#student_id_old').val();
    const action = idOld ? 'UPDATE_DATA' : 'ADD_DATA';
    const selectedGroup = $('#st_group_select').val();
    
    if (!selectedGroup) return toastr.warning("Vui lòng chọn nhóm!");

    const schoolName = getSelectedSchool('st_school_select', 'st_school_other');
    if (!schoolName) return toastr.warning("Vui lòng chọn hoặc nhập trường học!");
    
    const dataArr = [
        $('#st_id').val(), 
        $('#st_name').val(), 
        $('#st_gender').val(),
        $('#st_dob').val(), 
        $('#st_class').val(),
        schoolName,
        $('#st_address').val(), 
        $('#st_phone').val(), 
        selectedGroup, 
        $('#st_reg_time').val(),
        $('#st_reg_loc').val(),
        "" // reg_act removed
    ];
    
    if (!idOld) {
        // Generate password for new student
        const randomPass = Math.floor(100000 + Math.random() * 900000).toString();
        dataArr.push(randomPass); // Col 13: Password
        dataArr.push('TRUE');     // Col 14: AllowChange
    }

    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: action, payload: { type: 'students', id: idOld, data: dataArr } }) });
        const res = await response.json();
        if (res.status === 'success') {
            $('#modalStudent').modal('hide');
            if (String(selectedGroup) !== String(user.group_id)) {
                Swal.fire('Đã chuyển nhóm!', 'Học sinh đã được chuyển sang nhóm mới.', 'success');
            } else {
                Swal.fire('Thành công!', res.message, 'success');
            }
            fetchStudentsByGroup(user.group_id);
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối Server', 'error'); }
}

function deleteStudent(id) {
    Swal.fire({ title: 'Xóa học sinh?', text: "Hành động này không thể hoàn tác!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Xóa' }).then(async (result) => {
        if (result.isConfirmed) {
            const user = JSON.parse(sessionStorage.getItem('user'));
            try {
                const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: 'students', id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { Swal.fire('Đã xóa!', res.message, 'success'); fetchStudentsByGroup(user.group_id); }
            } catch (e) { toastr.error("Lỗi xóa dữ liệu"); }
        }
    });
}

// Giữ nguyên hàm submitAttendance...
async function submitAttendance() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const attendanceData = [];
    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
        const sId = input.name.replace('st_', '');
        const status = input.value;
        let reason = '';
        if (status === 'absent_perm') {
            reason = $(`#reason_${sId}`).val().trim();
        }
        attendanceData.push({ student_id: sId, status: status, reason: reason });
    });
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            redirect: "follow",
            body: JSON.stringify({
                action: "SAVE_ATTENDANCE",
                payload: { group_id: user.group_id, recorded_by: user.fullname, attendance: attendanceData }
            })
        });
        const res = await response.json();
        if (res.status === "success") toastr.success('Lưu thành công!');
    } catch (error) { toastr.error("Lỗi lưu dữ liệu."); }
}

// XUẤT EXCEL (Dữ liệu đã được định dạng dd/mm/yyyy trong bảng HTML)
async function exportExcel() {
    await loadLib('XLSX');
    const user = JSON.parse(sessionStorage.getItem('user'));
    const groupName = user.group_name || user.group_id;
    const table = document.getElementById("excelTable");
    
    // Tạo workbook từ table (Nó sẽ lấy đúng nội dung dd/mm/yyyy hiển thị trên bảng)
    const wb = XLSX.utils.table_to_book(table, {sheet: "Danh sách"});
    
    XLSX.writeFile(wb, `Danh_sach_HS_${groupName.replace(/\s+/g, '_')}.xlsx`);
    toastr.info("Đang tải file Excel...");
}


async function sendFeedback() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const title = $('#fb_title').val().trim();
    const phone = $('#fb_phone').val().trim();
    const difficulty = $('#fb_difficulty').val().trim();
    const suggestion = $('#fb_suggestion').val().trim();
    const driveLink = $('#fb_drive_link').val().trim();
    const fileInput = document.getElementById('fb_file');

    if (!title || !phone) {
        return toastr.warning("Vui lòng nhập tiêu đề và số điện thoại!");
    }
    if (!difficulty && !suggestion) {
        return toastr.warning("Vui lòng nhập nội dung phản ánh hoặc kiến nghị!");
    }
    
    // Check Captcha
    const captchaInput = $('#captcha_input_fb').val().trim().toUpperCase();
    const captchaCode = $('#captcha_code_fb').text().trim();
    if (captchaInput !== captchaCode) {
        toastr.error("Mã xác nhận không đúng!");
        return;
    }

    const payload = {
        username: user.username,
        fullname: user.fullname,
        phone: phone,
        group_id: user.group_id,
        title: title,
        difficulty: difficulty,
        suggestion: suggestion,
        drive_link: driveLink
    };

    const send = async (finalPayload) => {
        Swal.fire({ title: 'Đang gửi...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SEND_FEEDBACK", payload: finalPayload }) });
            const res = await response.json();
            if (res.status === 'success') {
                Swal.fire('Thành công!', 'Đã gửi yêu cầu/file.', 'success');
                $('#fb_title, #fb_difficulty, #fb_suggestion, #fb_drive_link, #fb_file, #captcha_input_fb').val('');
                generateCaptcha('captcha_code_fb');
                loadFeedbackHistory();
            } else { Swal.fire('Lỗi', res.message, 'error'); }
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    };

    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        const maxFileSize = 20 * 1024 * 1024; // 20MB

        if (!allowedTypes.includes(file.type)) {
            return toastr.error("Loại file không được hỗ trợ! Chỉ chấp nhận file ảnh, PDF, DOC, DOCX.");
        }

        if (file.size > maxFileSize) {
            return toastr.warning("File quá lớn! Vui lòng chọn file dưới 20MB.");
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            payload.attachment = e.target.result;
            payload.attachment_name = file.name;
            send(payload);
        };
        reader.readAsDataURL(file);
    } else {
        send(payload);
    }
}

async function loadFeedbackHistory() {
    const feedbackList = $('#feedbackHistoryList');
    feedbackList.html(loadingSpinner);
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            redirect: "follow", body: JSON.stringify({ action: "GET_FEEDBACKS", payload: { username: user.username } })
        });
        const res = await response.json();
        if (res.status === 'success') {
            let html = '';
            if (res.data.length === 0) {
                html = '<div class="text-center text-muted p-5"><i class="fas fa-inbox fa-3x mb-3"></i><br>Bạn chưa gửi phản ánh nào.</div>';
            } else {
                res.data.forEach(fb => {
                    let statusBadge = fb.status === 'replied' 
                        ? '<span class="badge badge-success float-right"><i class="fas fa-check mr-1"></i>Đã trả lời</span>' 
                        : '<span class="badge badge-warning float-right"><i class="fas fa-clock mr-1"></i>Đang chờ xử lý</span>';
                    
                    let replySection = '';
                    if (fb.reply) {
                        replySection = `
                            <div class="callout callout-success mt-3 mb-0" style="background-color: #f0fff4; border-left: 5px solid #28a745;">
                                <h6 class="text-success font-weight-bold"><i class="fas fa-user-shield mr-1"></i> Phản hồi từ Admin:</h6>
                                <div class="text-dark" style="font-size: 0.95rem;">${fb.reply}</div>
                            </div>`;
                    }

                    html += `
                        <div class="card shadow-sm mb-3 border-0">
                            <div class="card-header bg-white border-bottom-0 pb-0">
                                <h5 class="card-title text-primary font-weight-bold">${fb.title}</h5>
                                ${statusBadge}
                            </div>
                            <div class="card-body pt-2">
                                <small class="text-muted d-block mb-2"><i class="far fa-clock mr-1"></i> Gửi lúc: ${fb.timestamp}</small>
                                ${fb.difficulty ? `<div class="mb-1"><strong><i class="fas fa-exclamation-circle text-danger mr-1"></i>Nội dung:</strong> ${fb.difficulty}</div>` : ''}
                                ${fb.suggestion ? `<div class="mb-1"><strong><i class="fas fa-lightbulb text-warning mr-1"></i>Kiến nghị:</strong> ${fb.suggestion}</div>` : ''}
                                ${fb.drive_link ? `<div class="mb-1"><a href="${fb.drive_link}" target="_blank" class="text-info"><i class="fab fa-google-drive mr-1"></i>Link Drive</a></div>` : ''}
                                ${fb.attachment ? `<div class="mb-1"><a href="${fb.attachment}" download="${fb.attachment_name || 'file'}" class="text-secondary"><i class="fas fa-paperclip mr-1"></i>File: ${fb.attachment_name}</a></div>` : ''}
                                ${replySection}
                            </div>
                        </div>`;
                });
            }
            feedbackList.html(html);
        }
    } catch (e) { 
        console.error(e); 
        feedbackList.html(errorAlert());
    }
}

// --- LOGIC ĐÁNH GIÁ HỌC SINH ---
let globalEvaluations = [];

async function loadEvaluationUI() {
    $('#evaluationList').html(getLoadingRowHtml(3));
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        // 1. Lấy cấu hình và danh sách đánh giá song song
        const [configRes, evalRes] = await Promise.all([
            fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_CONFIG" }) }).then(r => r.json()),
            fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_EVALUATIONS" }) }).then(r => r.json())
        ]);

        // 2. Kiểm tra trạng thái khóa
        const config = configRes.data || {};
        const isEnabled = String(config.evaluation_enabled).toUpperCase() === 'TRUE';
        let isLocked = !isEnabled;
        let lockMessage = "Hệ thống đánh giá hiện đang đóng.";

        if (isEnabled && config.evaluation_deadline) {
            const deadline = new Date(config.evaluation_deadline);
            deadline.setHours(23, 59, 59, 999); // Hết ngày
            if (new Date() > deadline) {
                isLocked = true;
                lockMessage = `Đã quá hạn đánh giá (${formatDate(config.evaluation_deadline)}).`;
            }
        }

        if (isLocked) {
            $('#evalAlertContainer').html(`<div class="alert alert-danger mb-0"><i class="fas fa-lock mr-2"></i>${lockMessage} Vui lòng liên hệ Admin nếu cần hỗ trợ.</div>`);
        } else {
            $('#evalAlertContainer').empty();
        }

        if (evalRes.status === 'success') {
            globalEvaluations = evalRes.data; 
        }

        // 2. Render danh sách học sinh kèm trạng thái đánh giá
        let html = '';
        if (globalGroupStudents.length === 0) {
            html = '<tr><td colspan="3" class="text-center">Chưa có học sinh trong nhóm.</td></tr>';
        } else {
            globalGroupStudents.forEach(st => {
                // Tìm đánh giá của học sinh này (cột 0 là StudentID)
                const evalData = globalEvaluations.find(e => String(e[0]) === String(st.id));
                const classification = evalData ? evalData[6] : '<span class="text-muted font-italic">Chưa đánh giá</span>';
                const btnClass = evalData ? 'btn-outline-primary' : 'btn-primary';
                const btnText = evalData ? '<i class="fas fa-edit"></i> Sửa' : '<i class="fas fa-star"></i> Đánh giá';
                const disabledAttr = isLocked ? 'disabled' : '';
                
                html += `<tr>
                    <td class="align-middle font-weight-bold">${st.fullname}</td>
                    <td class="align-middle">${classification}</td>
                    <td class="text-center">
                        <button class="btn btn-sm ${btnClass}" onclick="openEvaluateModal('${st.id}', '${st.fullname}')" ${disabledAttr}>${btnText}</button>
                    </td>
                </tr>`;
            });
        }
        $('#evaluationList').html(html);
    } catch (e) { 
        console.error("Lỗi tải đánh giá", e); 
        $('#evaluationList').html(getErrorRowHtml(3));
    }
}

// --- TROLL PUSH LOGIC ---
async function checkUrgentNotification(configData = null) {
    try {
        let conf = configData;
        if (!conf) {
            const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_CONFIG" }) });
            const res = await response.json();
            if (res.status === "success") conf = res.data;
        }

        if (conf && String(conf.troll_enabled).toUpperCase() === 'TRUE') {
                // Check Mode: Phone Notification vs Popup
                if (String(conf.troll_mode).toUpperCase() === 'TRUE') {
                    $('#pn-title').text(conf.troll_title || 'Thông báo');
                    $('#pn-body').html(conf.troll_content || '');
                    if (conf.troll_image) { $('#pn-img').attr('src', conf.troll_image).show(); } else { $('#pn-img').hide(); }
                    
                    // Link download file trong banner
                    if (conf.troll_image && conf.troll_file_name) { $('#pn-link').html(`<a href="${conf.troll_image}" download="${conf.troll_file_name}" class="btn btn-xs btn-light text-dark font-weight-bold"><i class="fas fa-download mr-1"></i>Tải: ${conf.troll_file_name}</a>`); } else { $('#pn-link').empty(); }

                    // Link liên kết trong banner
                    if (conf.troll_link) { $('#pn-link').append(`<a href="${conf.troll_link}" target="_blank" class="btn btn-xs btn-primary ml-1"><i class="fas fa-link mr-1"></i>Xem ngay</a>`); }

                    $('#phone-notification').addClass('show');
                    if (!conf.troll_youtube) setTimeout(closePhoneNotification, 10000); // Auto hide if no video
                    return;
                }

                let htmlContent = `<div style="text-align: left; white-space: pre-wrap;">${conf.troll_content || ''}</div>`;
                
                // Xử lý YouTube
                if (conf.troll_youtube) {
                    let videoId = conf.troll_youtube.split('v=')[1];
                    const ampersandPosition = videoId ? videoId.indexOf('&') : -1;
                    if (videoId && ampersandPosition > -1) {
                        videoId = videoId.substring(0, ampersandPosition);
                    }
                    // Nếu là link short youtu.be
                    if (!videoId && conf.troll_youtube.indexOf('youtu.be/') !== -1) {
                        videoId = conf.troll_youtube.split('youtu.be/')[1];
                    }
                    
                    if (videoId) {
                        htmlContent += `<div class="embed-responsive embed-responsive-16by9 mt-2 mb-2"><iframe class="embed-responsive-item" src="https://www.youtube.com/embed/${videoId}?autoplay=1" allowfullscreen></iframe></div>`;
                    }
                }

                // File đính kèm trong Popup
                let footerHtml = '';
                if (conf.troll_image && conf.troll_file_name) {
                    footerHtml = `<a href="${conf.troll_image}" download="${conf.troll_file_name}" class="btn btn-success"><i class="fas fa-download mr-2"></i>Tải file đính kèm: ${conf.troll_file_name}</a>`;
                }
                if (conf.troll_link) {
                    footerHtml += `<a href="${conf.troll_link}" target="_blank" class="btn btn-primary ml-2"><i class="fas fa-link mr-2"></i>Truy cập liên kết</a>`;
                }

                Swal.fire({
                    icon: 'warning',
                    title: conf.troll_title || 'THÔNG BÁO KHẨN',
                    html: htmlContent,
                    footer: footerHtml,
                    imageUrl: conf.troll_image || null,
                    imageWidth: 400,
                    imageAlt: 'Image',
                    confirmButtonText: 'Đã hiểu',
                    allowOutsideClick: false
                });
        }
    } catch (e) { console.error("Urgent notification check error", e); }
}

function closePhoneNotification() {
    $('#phone-notification').removeClass('show');
}

function openEvaluateModal(id, name) {
    $('#eval_st_id').val(id);
    $('#eval_st_name').val(name);
    $('#eval_st_display_name').text(name);
    
    // Reset form
    $('#eval_discipline, #eval_positivity, #eval_volunteering, #eval_classification').val('');
    
    // Fill data nếu đã có
    const evalData = globalEvaluations.find(e => String(e[0]) === String(id));
    if (evalData) {
        $('#eval_discipline').val(evalData[3]);
        $('#eval_positivity').val(evalData[4]);
        $('#eval_volunteering').val(evalData[5]);
        $('#eval_classification').val(evalData[6]);
    }
    
    $('#modalEvaluate').modal('show');
}

async function submitEvaluation() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const payload = {
        student_id: $('#eval_st_id').val(),
        student_name: $('#eval_st_name').val(),
        group_id: user.group_id,
        discipline: $('#eval_discipline').val(),
        positivity: $('#eval_positivity').val(),
        volunteering: $('#eval_volunteering').val(),
        classification: $('#eval_classification').val(),
        updated_by: user.fullname
    };

    if (!payload.classification) return toastr.warning("Vui lòng chọn mức xếp loại!");

    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_EVALUATION", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu phiếu đánh giá!', 'success');
            $('#modalEvaluate').modal('hide');
            loadEvaluationUI(); // Reload lại bảng
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- FUND MANAGEMENT FUNCTIONS ---
function loadFundTab() {
    const list = document.getElementById('fundStudentList');
    if (globalGroupStudents.length === 0) {
        list.innerHTML = '<tr><td colspan="3" class="text-center">Chưa có học sinh</td></tr>';
        return;
    }
    
    let html = '';
    globalGroupStudents.forEach((st, idx) => {
        html += `
        <tr class="fund-row">
            <td>${idx + 1}</td>
            <td class="font-weight-bold student-name">${st.fullname}</td>
            <td class="text-center">

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input fund-check" id="fund_chk_${idx}" data-name="${st.fullname}" onchange="calculateFund()">
                    <label class="custom-control-label" for="fund_chk_${idx}">Đã đóng</label>
                </div>
            </td>
        </tr>`;
    });

    list.innerHTML = html;
    calculateFund();
    loadFundHistory();
}

function calculateFund() {
    const amount = parseInt($('#fund_amount').val()) || 0;
    const checkedCount = $('.fund-check:checked').length;
    const total = amount * checkedCount;
    
    $('#fund_count').text(checkedCount);
    $('#fund_total').text(total.toLocaleString('vi-VN') + ' đ');
}

function filterFundList() {
    const term = $('#fund_search').val().toLowerCase();
    $('.fund-row').each(function() {
        const name = $(this).find('.student-name').text().toLowerCase();
        $(this).toggle(name.indexOf(term) > -1);
    });
}

function resetFundCheckboxes() {
    $('.fund-check').prop('checked', false);
    calculateFund();
    toastr.info("Đã reset trạng thái đóng tiền (Chưa lưu).");
}

async function saveFundLog() {
    const user = JSON.parse(sessionStorage.getItem('user'));

    const amountPerHead = parseInt($('#fund_amount').val()) || 0;
    const checkedBoxes = $('.fund-check:checked');
    
    if (checkedBoxes.length === 0) return toastr.warning("Chưa có ai đóng tiền!");

    const paidList = [];
    checkedBoxes.each(function() {

        paidList.push($(this).data('name'));
    });

    const payload = {
        group_id: user.group_id,
        manager: user.fullname,

        amount_per_head: amountPerHead,
        total_collected: amountPerHead * checkedBoxes.length,
        paid_students: paidList.join(', '),
        notes: $('#fund_notes').val(),
        timestamp: new Date().toLocaleString('vi-VN')
    };

    Swal.fire({ title: 'Đang lưu sổ quỹ...', didOpen: () => Swal.showLoading() });
    try {

        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_FUND_LOG", payload: payload }) });

        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu vào lịch sử quỹ!', 'success');
            loadFundHistory();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function saveManagerContribution() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const amount = parseInt($('#contrib_amount').val()) || 0;
    const notes = $('#contrib_notes').val();

    if (amount <= 0) return toastr.warning("Vui lòng nhập số tiền hợp lệ!");

    const payload = {
        group_id: user.group_id,
        manager: user.fullname,
        amount_per_head: amount,
        total_collected: amount,
        paid_students: "Quản lý đóng góp", // Đánh dấu đặc biệt
        notes: notes,
        timestamp: new Date().toLocaleString('vi-VN')
    };

    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_FUND_LOG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') { Swal.fire('Thành công', 'Đã lưu đóng góp!', 'success'); $('#modalContribution').modal('hide'); $('#contrib_amount, #contrib_notes').val(''); loadFundHistory(); } 
        else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

function showUnpaidModal() {
    const unpaid = [];
    $('.fund-check').each(function() {
        if (!$(this).is(':checked')) {
            unpaid.push($(this).data('name'));
        }
    });
    
    let html = '';
    if (unpaid.length === 0) html = '<div class="alert alert-success"><i class="fas fa-check-circle mr-2"></i>Tất cả mọi người đã đóng tiền!</div>';
    else {
        html = `<p class="font-weight-bold text-danger">Tổng cộng: ${unpaid.length} người chưa đóng.</p><ul class="list-group list-group-flush">`;
        unpaid.forEach(name => { html += `<li class="list-group-item py-2 px-0 border-bottom">${name}</li>`; });
        html += '</ul>';
    }
    $('#unpaidListContent').html(html);
    $('#modalUnpaid').modal('show');
}

function copyUnpaidList() {
    const names = [];
    $('#unpaidListContent li').each(function() { names.push($(this).text()); });
    if(names.length > 0) {
        navigator.clipboard.writeText(names.join('\n')).then(() => toastr.success('Đã sao chép danh sách!'));
    } else toastr.info('Danh sách trống');
}

async function saveExpenseLog() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const reason = $('#expense_reason').val();
    const amount = $('#expense_amount').val();
    const notes = $('#expense_notes').val();

    if (!reason || !amount) return toastr.warning("Vui lòng nhập lý do và số tiền!");

    const payload = {
        group_id: user.group_id,
        manager: user.fullname,
        reason: reason,
        amount: amount,
        notes: notes
    };

    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "SAVE_EXPENSE_LOG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu khoản chi!', 'success');
            $('#modalChiQuy').modal('hide');
            $('#expense_reason, #expense_amount, #expense_notes').val('');
            loadFundHistory();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function loadFundHistory() {
    const historyTable = $('#fundHistoryData');
    historyTable.html(getLoadingRowHtml(3));
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_FUND_LOGS", payload: { group_id: user.group_id } }) });
        const res = await response.json();
        if (res.status === 'success') {
            globalFundLogs = res.data; // Lưu dữ liệu để xuất Excel
            
            // Tính toán số dư
            let balance = 0;
            let html = '';
            
            // Đảo ngược mảng để tính từ cũ đến mới cho đúng logic số dư (nếu cần hiển thị số dư từng dòng), 
            // nhưng ở đây ta chỉ cần tổng cuối cùng. API thường trả về mới nhất trước.
            res.data.forEach(log => {
                const isThu = log.type === 'THU';
                const amount = parseInt(log.amount);
                
                if (isThu) balance += amount; else balance -= amount;

                const colorClass = isThu ? (log.paid_list === "Quản lý đóng góp" ? 'text-info' : 'text-success') : 'text-danger';
                const sign = isThu ? '+' : '-';
                const desc = isThu ? (log.paid_list === "Quản lý đóng góp" ? 'Quản lý đóng góp' : (log.paid_list ? `Thu: ${log.paid_list.split(',').length} người` : 'Thu quỹ')) : log.reason;
                const detailBtn = isThu ? `<button class="btn btn-xs btn-outline-info ml-1" onclick="Swal.fire('Danh sách đóng', '${log.paid_list}', 'info')"><i class="fas fa-list"></i></button>` : '';
                
                html += `<tr>
                    <td><small>${log.timestamp}</small></td>
                    <td class="${colorClass} font-weight-bold">${sign}${parseInt(log.amount).toLocaleString()}đ</td>
                    <td>
                        <span class="d-block text-truncate" style="max-width: 120px;" title="${desc} ${log.details}">${desc}</span>
                        ${detailBtn}
                    </td>
                </tr>`;
            });
            historyTable.html(html || '<tr><td colspan="3" class="text-center text-muted">Chưa có lịch sử</td></tr>');
            
            // Cập nhật số dư hiển thị
            $('#current_fund_balance').text(balance.toLocaleString('vi-VN'));
        }
    } catch (e) { 
        console.error(e); 
        historyTable.html(getErrorRowHtml(3));
    }
}

function exportFundHistoryExcel() {
    if (globalFundLogs.length === 0) return toastr.warning("Chưa có lịch sử để xuất!");
    const user = JSON.parse(sessionStorage.getItem('user'));
    
    const data = globalFundLogs.map(log => ({
        "Thời gian": log.timestamp,
        "Loại": log.type,
        "Số tiền": parseInt(log.amount),
        "Người thực hiện": log.manager,
        "Lý do / Chi tiết": log.type === 'THU' ? log.details : log.reason,
        "Ghi chú": log.type === 'THU' ? log.paid_list : log.notes
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Quy_Nhom");
    XLSX.writeFile(wb, `So_Quy_Nhom_${user.group_id}.xlsx`);
}

async function exportFundHistoryPdf() {
    await loadLib('pdfMake');
    if (globalFundLogs.length === 0) return toastr.warning("Chưa có lịch sử để xuất!");
    const user = JSON.parse(sessionStorage.getItem('user'));
    const groupName = user.group_name || user.group_id;
    const currentBalance = $('#current_fund_balance').text();

    const body = [
        [
            { text: 'Thời gian', bold: true, style: 'tableHeader' },
            { text: 'Nội dung', bold: true, style: 'tableHeader' },
            { text: 'Thu/Chi', bold: true, style: 'tableHeader', alignment: 'center' },
            { text: 'Số tiền', bold: true, style: 'tableHeader', alignment: 'right' }
        ]
    ];

    let totalThu = 0;
    let totalChi = 0;

    // Duyệt ngược để hiển thị theo trình tự thời gian nếu muốn, hoặc giữ nguyên
    // Ở đây giữ nguyên thứ tự hiển thị (Mới nhất ở trên) hoặc đảo ngược tùy ý. 
    // Thường báo cáo tài chính nên từ cũ đến mới để theo dõi dòng tiền, nhưng log thường xem mới nhất.
    // Ta sẽ xuất theo thứ tự hiện tại (Mới nhất trước).
    
    globalFundLogs.forEach(log => {
        const isThu = log.type === 'THU';
        const amount = parseInt(log.amount);
        if(isThu) totalThu += amount; else totalChi += amount;

        const desc = isThu ? (log.paid_list === "Quản lý đóng góp" ? 'Quản lý đóng góp' : log.details) : log.reason;
        const sign = isThu ? '+' : '-';
        const color = isThu ? '#28a745' : '#dc3545';

        body.push([
            { text: log.timestamp, fontSize: 9 },
            { text: desc + (log.notes ? ` (${log.notes})` : ''), fontSize: 9 },
            { text: isThu ? 'Thu' : 'Chi', fontSize: 9, alignment: 'center', color: color, bold: true },
            { text: `${sign} ${amount.toLocaleString('vi-VN')} đ`, fontSize: 9, alignment: 'right', color: color, bold: true }
        ]);
    });

    // Footer Row
    body.push([
        { text: 'TỔNG KẾT', colSpan: 2, bold: true, alignment: 'right' },
        {},
        { text: `Thu: ${totalThu.toLocaleString()} - Chi: ${totalChi.toLocaleString()}`, colSpan: 2, bold: true, alignment: 'right', fontSize: 9 }
    ]);

    const docDefinition = {
        content: [
            { text: 'BÁO CÁO TÀI CHÍNH QUỸ NHÓM', style: 'header', alignment: 'center', margin: [0, 0, 0, 5] },
            { text: `Nhóm: ${groupName}`, alignment: 'center', fontSize: 12, margin: [0, 0, 0, 20] },
            {
                columns: [
                    { text: `Người xuất: ${user.fullname}`, fontSize: 10 },
                    { text: `Ngày xuất: ${new Date().toLocaleString('vi-VN')}`, fontSize: 10, alignment: 'right' }
                ],
                margin: [0, 0, 0, 10]
            },
            {
                style: 'tableExample',
                table: {
                    headerRows: 1,
                    widths: ['auto', '*', 'auto', 'auto'],
                    body: body
                },
                layout: 'lightHorizontalLines'
            },
            { text: `Số dư hiện tại: ${currentBalance} đ`, style: 'total', alignment: 'right', margin: [0, 20, 0, 0], fontSize: 14, bold: true, color: '#007bff' }
        ],
        styles: {
            header: { fontSize: 18, bold: true },
            tableHeader: { fontSize: 10, fillColor: '#eeeeee', margin: [0, 5, 0, 5] },
            total: { fontSize: 14, bold: true }
        }
    };

    pdfMake.createPdf(docDefinition).download(`Bao_Cao_Quy_${groupName}.pdf`);
}

async function downloadTemplateIndex() {
    await loadLib('XLSX');
    const user = JSON.parse(sessionStorage.getItem('user'));
    const data = [{ "Họ và Tên": "Nguyễn Văn A", "Giới tính": "Nam", "Ngày sinh": "20/10/2010", "Trường học": "THCS A", "SĐT": "0909123456", "Địa chỉ": "123 Đường ABC" }];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
    XLSX.writeFile(wb, `Mau_DS_Nhom_${user.group_id}.xlsx`);
}

function uploadFileIndex() {
    const fileInput = document.getElementById('file_upload_index');
    const file = fileInput.files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");
    
    const user = JSON.parse(sessionStorage.getItem('user'));
    // Bypass limit for VIP Member
    if (user.role !== 'vip_member' && file.size > globalMaxUploadSize * 1024 * 1024) {
        // Show Drive Link if file is too big
        let msg = `File quá lớn (> ${globalMaxUploadSize}MB)!`;
        if (globalDriveLink) {
            msg += `<br>Vui lòng tải lên qua Google Drive: <a href="${globalDriveLink}" target="_blank" class="font-weight-bold">Tại đây</a>`;
            $('#upload_blocked_msg').removeClass('d-none');
            $('#upload_drive_link_display').html(`File của bạn quá lớn. Vui lòng gửi qua: <a href="${globalDriveLink}" target="_blank" class="font-weight-bold">${globalDriveLink}</a>`);
        }
        return toastr.error(msg);
    }

    // Show Modal
    $('#uploadFileName').text(file.name);
    $('#uploadProgressBar').css('width', '0%').text('0%');
    $('#uploadProgressText').text('Đang đọc file...');
    $('#modalUploadProgress').modal('show');

    const reader = new FileReader();
    
    reader.onprogress = function(e) {
        if (e.lengthComputable) {
            updateUploadModal((e.loaded / e.total) * 100, e.loaded, e.total, 'Đang đọc dữ liệu...');
        }
    };

    reader.onload = function(e) {
        const base64 = e.target.result;
        
        const payload = { 
            action: "UPLOAD_FILE", 
            payload: { uploader: user.username, group_id: user.group_id, filename: file.name, size: (file.size / 1024 / 1024).toFixed(2) + ' MB', data: base64, type: 'FILE' } 
        };

        uploadFileWithProgress(payload, (res) => {
            $('#modalUploadProgress').modal('hide');
            if (res.status === 'success') { Swal.fire('Thành công', 'File đã được tải lên!', 'success'); fileInput.value = ''; }
            else Swal.fire('Lỗi', res.message, 'error');
        }, (err) => {
            $('#modalUploadProgress').modal('hide');
            Swal.fire('Lỗi', err, 'error');
        });
    };
    reader.readAsDataURL(file);
}

function uploadFileWithProgress(payload, onSuccess, onError) {
    // Sử dụng fetch thay vì XMLHttpRequest để tránh lỗi Network Error/CORS với Google Apps Script
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        if (progress > 90) progress = 90;
        updateUploadModal(progress, 0, 0, 'Đang tải lên server...');
    }, 500);

    fetch(API_URL, {
        method: "POST",
        redirect: "follow",
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(res => {
        clearInterval(interval);
        updateUploadModal(100, 0, 0, 'Hoàn tất!');
        onSuccess(res);
    })
    .catch(err => {
        clearInterval(interval);
        onError("Lỗi kết nối mạng hoặc file quá lớn.");
    });
}

function updateUploadModal(percent, loaded, total, statusText) {
    const p = Math.round(percent);
    $('#uploadProgressBar').css('width', p + '%').text(p + '%');
    const loadedMB = (loaded / 1024 / 1024).toFixed(2);
    const totalMB = (total / 1024 / 1024).toFixed(2);
    $('#uploadProgressText').html(`${statusText}<br><b>${loadedMB} MB</b> / <b>${totalMB} MB</b>`);
}

async function submitDriveLink() {
    const link = $('#drive_link_submission').val().trim();
    if (!link) return toastr.warning("Vui lòng nhập link!");
    
    const user = JSON.parse(sessionStorage.getItem('user'));
    Swal.fire({ title: 'Đang gửi link...', didOpen: () => Swal.showLoading() });
    
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            redirect: "follow",
            body: JSON.stringify({ 
                action: "UPLOAD_FILE", 
                payload: { uploader: user.username, group_id: user.group_id, filename: "Google Drive Link", size: "Link", data: link, type: 'LINK' } 
            }) 
        });
        const res = await response.json();
        if (res.status === 'success') { 
            Swal.fire('Thành công', 'Đã gửi link cho Admin!', 'success'); 
            $('#drive_link_submission').val(''); 
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function processImportManagerTab() {
    await loadLib('XLSX');
    const user = JSON.parse(sessionStorage.getItem('user'));
    // Check Lock
    const conf = JSON.parse(sessionStorage.getItem('globalConfig') || '{}');
    
    // VIP Member Bypass
    if (user.role !== 'vip_member') {
    if (String(conf.student_import_locked).toUpperCase() === 'TRUE') {
        return Swal.fire('Đã khóa', 'Chức năng nhập học sinh đang bị khóa bởi Admin.', 'warning');
    }
    if (conf.student_import_deadline) {
        const deadline = new Date(conf.student_import_deadline);
        deadline.setHours(23,59,59);
        if (new Date() > deadline) {
            return Swal.fire('Hết hạn', 'Đã quá hạn nhập học sinh mới.', 'warning');
        }
    }
    }

    const file = document.getElementById('file_import').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!"); 
    
    // Bypass limit for VIP Member
    if (user.role !== 'vip_member' && file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File quá lớn! Giới hạn cho phép là ${globalMaxUploadSize}MB.`);
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        const mappedData = jsonData.map(row => ({ fullname: row["Họ và Tên"], gender: row["Giới tính"], dob: row["Ngày sinh"], group_id: user.group_id, school: row["Trường học"], phone: row["SĐT"], address: row["Địa chỉ"] })).filter(i => i.fullname);
        
        Swal.fire({ title: 'Đang tải lên...', didOpen: () => Swal.showLoading() });
        fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "IMPORT_STUDENTS", payload: { students: mappedData } }) })
        .then(r => r.json()).then(res => { if(res.status==='success'){ Swal.fire('Xong', `Thêm ${res.count} HS`, 'success'); fetchStudentsByGroup(user.group_id); } else Swal.fire('Lỗi', res.message, 'error'); });
    };
    reader.readAsArrayBuffer(file);
}

function openImportModal(context) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    // Check Lock
    const conf = JSON.parse(sessionStorage.getItem('globalConfig') || '{}');
    
    // VIP Member Bypass
    if (user.role !== 'vip_member') {
    if (String(conf.student_import_locked).toUpperCase() === 'TRUE') {
        return Swal.fire('Đã khóa', 'Chức năng nhập học sinh đang bị khóa bởi Admin.', 'warning');
    }
    }
    $('#modalImport').modal('show');
}

async function submitVote(pollId) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    
    // Lấy danh sách học sinh được chọn
    const selectedStudents = [];
    $(`.poll-student-check-${pollId}:checked`).each(function() {
        selectedStudents.push($(this).val());
    });

    const option = $(`input[name='poll_opt_${pollId}']:checked`).val();

    if (selectedStudents.length === 0) return toastr.warning("Vui lòng chọn ít nhất 1 học sinh!");
    if (!option) return toastr.warning("Vui lòng chọn một phương án!");

    const payload = {
        poll_id: pollId,
        manager: user.fullname,
        group_id: user.group_id,
        students: selectedStudents,
        option: option
    };

    Swal.fire({ title: 'Đang gửi bình chọn...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "VOTE_POLL", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', res.message, 'success');
        } else {
            Swal.fire('Lỗi', res.message, 'error');
        }
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function viewPollResults(pollId) {
    Swal.fire({ title: 'Đang tải kết quả...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_POLL_RESULTS", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const counts = res.data;
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let html = `<div class="text-left">`;
            for (const [opt, count] of Object.entries(counts)) {
                const percent = total === 0 ? 0 : Math.round((count / total) * 100);
                html += `<div class="mb-2"><div class="d-flex justify-content-between small"><span>${opt}</span><span>${count} phiếu (${percent}%)</span></div><div class="progress" style="height: 10px;"><div class="progress-bar bg-success" style="width: ${percent}%"></div></div></div>`;
            }
            html += `</div>`;
            Swal.fire({ title: `Kết quả (${total} phiếu)`, html: html });
        } else Swal.fire('Lỗi', 'Không thể tải kết quả', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- ATTENDANCE IMPORT ---
function openImportAttendanceModal() {
    $('#modalImportAttendance').modal('show');
}

async function downloadAttendanceTemplate() {
    await loadLib('XLSX');
    if (globalGroupStudents.length === 0) return toastr.warning("Chưa có học sinh để tạo mẫu!");
    const data = globalGroupStudents.map(s => ({
        "ID": s.id,
        "Họ và Tên": s.fullname,
        "Trạng thái (C/P/K)": "",
        "Lý do (Nếu có)": ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DiemDanh");
    XLSX.writeFile(wb, `Mau_Diem_Danh_${new Date().toLocaleDateString('vi-VN').replace(/\//g,'-')}.xlsx`);
}

async function processAttendanceImport() {
    await loadLib('XLSX');
    const file = document.getElementById('file_att_import').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        let count = 0;
        jsonData.forEach(row => {
            const id = row["ID"];
            const statusChar = (row["Trạng thái (C/P/K)"] || "").toUpperCase().trim();
            const reason = row["Lý do (Nếu có)"] || "";

            if (id) {
                let statusVal = 'absent'; // Default K
                if (statusChar === 'C' || statusChar === 'CÓ' || statusChar === 'X') statusVal = 'present';
                else if (statusChar === 'P') statusVal = 'absent_perm';
                
                // Update UI
                $(`input[name="st_${id}"][value="${statusVal}"]`).prop('checked', true);
                if (statusVal === 'absent_perm') {
                    $(`#reason_box_${id}`).removeClass('d-none');
                    $(`#reason_${id}`).val(reason);
                } else {
                    $(`#reason_box_${id}`).addClass('d-none');
                }
                count++;
            }
        });
        $('#modalImportAttendance').modal('hide');
        toastr.success(`Đã cập nhật trạng thái cho ${count} học sinh. Nhấn Lưu để hoàn tất.`);
    };
    reader.readAsArrayBuffer(file);
}

// --- RESOURCE MANAGER ---
async function loadResources() {
    $('#resource_list').html(loadingSpinner);
    try {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_UPLOADS" }) });
        const res = await response.json();
        if (res.status === 'success') {
            // Filter ADMIN uploads AND User's Group uploads
            globalResources = res.data.filter(f => f.group_id === 'ADMIN' || String(f.group_id) === String(user.group_id));
            filterResources('all');
        }
    } catch (e) { console.error(e); }
}

function filterResources(type) {
    $('.nav-link').removeClass('active');
    $(`#filter-${type}`).addClass('active');
    
    let filtered = globalResources;
    if (type === 'docs') filtered = globalResources.filter(f => f.filename.match(/\.(doc|docx|pdf|xls|xlsx|ppt|pptx|txt)$/i));
    if (type === 'media') filtered = globalResources.filter(f => f.filename.match(/\.(mp3|mp4|jpg|jpeg|png|gif|wav)$/i));
    
    renderResources(filtered);
}

function renderResources(list) {
    let html = '';
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (list.length === 0) html = '<div class="col-12 text-center text-muted mt-5">Không có tệp tin nào.</div>';
    
    list.forEach(f => {
        let icon = 'fa-file';
        let color = 'text-secondary';
        if (f.filename.match(/\.pdf$/i)) { icon = 'fa-file-pdf'; color = 'text-danger'; }
        else if (f.filename.match(/\.(doc|docx)$/i)) { icon = 'fa-file-word'; color = 'text-primary'; }
        else if (f.filename.match(/\.(xls|xlsx)$/i)) { icon = 'fa-file-excel'; color = 'text-success'; }
        else if (f.filename.match(/\.(jpg|png|gif)$/i)) { icon = 'fa-image'; color = 'text-purple'; }
        else if (f.filename.match(/\.(mp3|wav)$/i)) { icon = 'fa-music'; color = 'text-warning'; }
        else if (f.filename.match(/\.(mp4|avi)$/i)) { icon = 'fa-video'; color = 'text-danger'; }

        // Allow delete if uploader is current user
        const deleteBtn = (f.uploader === user.username) ? `<button class="btn btn-xs btn-danger ml-1" onclick="deleteResource('${f.id}')"><i class="fas fa-trash"></i></button>` : '';

        html += `
        <div class="col-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 shadow-sm resource-card">
                <div class="card-body text-center p-2">
                    <i class="fas ${icon} fa-3x ${color} mb-2"></i>
                    <h6 class="text-truncate" title="${f.filename}">${f.filename}</h6>
                    <small class="text-muted">${f.size}</small>
                </div>
                <div class="card-footer bg-white p-1 text-center">
                    <button class="btn btn-xs btn-primary" onclick="previewResource('${f.data}', '${f.filename}')"><i class="fas fa-eye"></i> Xem</button>
                    <a href="${f.data}" download="${f.filename}" class="btn btn-xs btn-success"><i class="fas fa-download"></i> Tải</a>
                    ${deleteBtn}
                </div>
            </div>
        </div>`;
    });
    $('#resource_list').html(html);
}

function searchResources() {
    const term = $('#resource_search').val().toLowerCase();
    const filtered = globalResources.filter(f => f.filename.toLowerCase().includes(term));
    renderResources(filtered);
}

function previewResource(url, filename) {
    $('#previewTitle').text(filename);
    let content = '';
    if (filename.match(/\.(jpg|jpeg|png|gif)$/i)) content = `<img src="${url}" style="max-width:100%; max-height:100%;">`;
    else if (filename.match(/\.mp4$/i)) content = `<video controls style="max-width:100%; max-height:100%;"><source src="${url}" type="video/mp4"></video>`;
    else if (filename.match(/\.mp3$/i)) content = `<audio controls><source src="${url}" type="audio/mpeg"></audio>`;
    else if (filename.match(/\.pdf$/i)) content = `<iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>`;
    else content = `<div class="text-center"><p>Không hỗ trợ xem trước định dạng này.</p><a href="${url}" download="${filename}" class="btn btn-primary">Tải xuống</a></div>`;
    
    $('#previewBody').html(content);
    $('#modalPreview').modal('show');
}

function deleteResource(id) {
    Swal.fire({ title: 'Xóa file?', text: "Bạn có chắc muốn xóa file này?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Xóa' }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: 'uploads', id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { toastr.success('Đã xóa file'); loadResources(); }
            } catch (e) { toastr.error("Lỗi xóa file"); }
        }
    });
}

async function loadRegistrations() {
    $('#regListBody').html(getLoadingRowHtml(6));
    try {
        const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "GET_REGISTRATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            res.data.forEach(r => {
                html += `<tr>
                    <td><code>${r.id}</code></td>
                    <td class="font-weight-bold text-danger">${r.pass}</td>
                    <td>${r.fullname}</td>
                    <td>${r.class_name}</td>
                    <td>${r.school}</td>
                    <td><button class="btn btn-sm btn-warning" onclick="regeneratePass('${r.id}')"><i class="fas fa-sync mr-1"></i>Đổi Pass</button></td>
                </tr>`;
            });
            $('#regListBody').html(html || '<tr><td colspan="6" class="text-center">Không có đăng ký chờ duyệt.</td></tr>');
        }
    } catch (e) { $('#regListBody').html(getErrorRowHtml(6)); }
}

async function regeneratePass(id) {
    if(!confirm('Tạo lại mật khẩu ngẫu nhiên cho ID này?')) return;
    const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "REGENERATE_PASS", payload: { id } }) });
    const res = await response.json();
    if(res.status === 'success') { toastr.success('Mật khẩu mới: ' + res.new_pass); loadRegistrations(); }
}

// Easter Egg Logic
var fireworksInterval;
async function startEasterEgg() {
    await loadLib('confetti');
    $('#modalCredits').modal('show');
    const audio = document.getElementById('eggAudio');
    if(audio) audio.play().catch(e => console.log("Audio play failed", e));
    var duration = 15 * 1000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };
    function randomInRange(min, max) { return Math.random() * (max - min) + min; }
    fireworksInterval = setInterval(function() { var timeLeft = animationEnd - Date.now(); if (timeLeft <= 0) { return clearInterval(fireworksInterval); } var particleCount = 50 * (timeLeft / duration); confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } })); confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } })); }, 250);
}
function stopEasterEgg() {
    $('#modalCredits').modal('hide'); const audio = document.getElementById('eggAudio'); if(audio) { audio.pause(); audio.currentTime = 0; }
    clearInterval(fireworksInterval); confetti.reset();
}

function getNextId(list, prop, prefix = '') {
    if (!list || list.length === 0) return prefix + '1';
    let max = 0;
    list.forEach(item => {
        let val = String(item[prop]);
        const match = val.match(/(\d+)$/);
        if (match) {
            const num = parseInt(match[1]);
            if (num > max) max = num;
        }
    });
    return prefix + (max + 1);
}

function initCardCollapseState() {
    $('.card[data-save-key]').each(function() {
        const key = $(this).data('save-key');
        const state = localStorage.getItem('card_state_' + key);
        if (state === 'collapsed') {
            $(this).addClass('collapsed-card');
            $(this).find('.card-body').hide();
            $(this).find('[data-card-widget="collapse"] i').removeClass('fa-minus').addClass('fa-plus');
        }
    });
    $(document).on('click', '[data-card-widget="collapse"]', function() {
        const card = $(this).closest('.card');
        const key = card.data('save-key');
        if (key) {
            setTimeout(() => {
                const isCollapsed = card.hasClass('collapsed-card');
                localStorage.setItem('card_state_' + key, isCollapsed ? 'collapsed' : 'expanded');
            }, 300);
        }
    });
}

async function runSpeedTest() {
    const btn = document.getElementById('btn-speedtest');
    const progress = document.getElementById('speed-progress');
    const result = document.getElementById('speed-result');
    
    btn.disabled = true;
    progress.classList.remove('d-none');
    
    // 0. Detect ISP & Network Type
    result.innerHTML = '<i class="fas fa-globe-asia fa-spin mr-2"></i>Đang kiểm tra nhà mạng...';
    
    try {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        const isCellular = connection && (connection.type === 'cellular' || connection.effectiveType === '4g' || connection.effectiveType === '3g');
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 1500);

        const ipRes = await fetch('https://ipapi.co/json/', { signal: controller.signal });
        clearTimeout(timeoutId);
        const ipData = await ipRes.json();
        
        const ispName = ipData.org || ipData.isp || "Không xác định";
        const ipAddr = ipData.ip || "---";
        const networkType = isCellular ? '<span class="text-warning"><i class="fas fa-signal mr-1"></i>4G/5G (Di động)</span>' : '<span class="text-success"><i class="fas fa-wifi mr-1"></i>Wifi/LAN</span>';

        if (isCellular) {
            if(!confirm(`Bạn đang dùng ${networkType}. Kiểm tra tốc độ sẽ tốn dữ liệu. Tiếp tục?`)) {
                throw new Error("User cancelled due to 4G");
            }
        }

        result.innerHTML = `
            <div class="text-left small mb-2 p-2 rounded border border-secondary" style="background: rgba(0,0,0,0.05);">
                <div><i class="fas fa-network-wired mr-1"></i>Mạng: <b>${networkType}</b></div>
                <div><i class="fas fa-building mr-1"></i>ISP: <b>${ispName}</b></div>
                <div><i class="fas fa-map-marker-alt mr-1"></i>IP: <b>${ipAddr}</b></div>
            </div>
            <i class="fas fa-satellite-dish fa-spin mr-2"></i>Đang kết nối máy chủ...`;
    } catch (e) {
        if (e.message === "User cancelled due to 4G") {
            progress.classList.add('d-none');
            result.innerHTML = '<span class="text-warning">Đã hủy kiểm tra.</span>';
            btn.disabled = false;
            return;
        }
        result.innerHTML = '<i class="fas fa-satellite-dish fa-spin mr-2"></i>Đang kết nối máy chủ...';
    }
    
    const servers = [
        { name: "VNPT", url: "https://vnexpress.net/favicon.ico" },
        { name: "FPT", url: "https://fpt.vn/favicon.ico" },
        { name: "Viettel", url: "https://viettel.vn/favicon.ico" }
    ];

    let bestServer = servers[0];
    let minPing = Infinity;

    for (const s of servers) {
        result.innerHTML = `<i class="fas fa-satellite-dish fa-spin mr-2"></i>Ping: ${s.name}...`;
        const start = Date.now();
        try {
            await fetch(s.url + '?t=' + start, { mode: 'no-cors', cache: 'no-store' });
            const ping = Date.now() - start;
            if (ping < minPing) { minPing = ping; bestServer = s; }
        } catch (e) {}
    }
    
    result.innerHTML = `<i class="fas fa-download fa-spin mr-2"></i>Đang tải xuống (Server VN)...`;
    const dlStart = Date.now();
    const testUrl = 'https://speed.cloudflare.com/__down?bytes=5000000'; 
    
    try {
        const dlRes = await fetch(testUrl + '&t=' + dlStart, { cache: "no-store" });
        const dlBlob = await dlRes.blob();
        const dlEnd = Date.now();
        const dlSpeed = ((dlBlob.size * 8) / ((dlEnd - dlStart) / 1000) / (1024 * 1024)).toFixed(2);
        
        result.innerHTML = `<i class="fas fa-upload fa-spin mr-2"></i>Đang tải lên...`;
        const ulStart = Date.now();
        const dummyData = new Blob([new Uint8Array(500 * 1024)]); // Tối ưu RAM
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: dummyData });
        const ulEnd = Date.now();
        const ulSpeed = ((dummyData.size * 8) / ((ulEnd - ulStart) / 1000) / (1024 * 1024)).toFixed(2);
        
        progress.classList.add('d-none');
        result.innerHTML = `
            <div class="text-success"><i class="fas fa-check-circle mr-1"></i>Hoàn tất!</div>
            <div>Ping: <b>${minPing}ms</b> (${bestServer.name})</div>
            <div>Download: <b>${dlSpeed} Mbps</b></div>
            <div>Upload: <b>${ulSpeed} Mbps</b></div>`;
    } catch (e) {
        progress.classList.add('d-none');
        result.innerHTML = '<span class="text-danger">Lỗi đo tốc độ!</span>';
    }
    btn.disabled = false;
}

function initFpsMonitor() {
    let lastTime = performance.now();
    let frames = 0;
    let lowFpsCount = 0;
    const fpsLoop = () => {
        const now = performance.now();
        frames++;
        if (now - lastTime >= 1000) {
            const fps = frames;
            if (fps < 30) {
                lowFpsCount++;
                if (lowFpsCount >= 3) {
                    $('.weather-overlay, .firefly, .star, .rain-drop, .snowflake').remove();
                    $('body').removeClass('jack-mode theme-matrix theme-neon');
                    if(window.matrixInterval) clearInterval(window.matrixInterval);
                    const audio = document.getElementById('jackAudio'); if(audio) audio.pause();
                    return;
                }
            } else { lowFpsCount = 0; }
            frames = 0; lastTime = now;
        }
        requestAnimationFrame(fpsLoop);
    };
    requestAnimationFrame(fpsLoop);
}
window.addEventListener('load', initFpsMonitor);
</script>









</body>
</html>
