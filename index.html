<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sinh hoạt hè - Nhóm</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .info-box-content { justify-content: center; }
        .table thead th { background-color: #f4f6f9; color: #333; border-top: none; text-align: center; }
        .table td, .table th { vertical-align: middle; padding: 12px 8px; }
        .btn-group-toggle .btn { padding: 0.35rem 0.5rem; font-size: 0.8rem; }
        .card-title { font-weight: bold; }
        .content-wrapper { background-color: #f4f6f9; }
        /* Youth Union Theme - Blue & White */
        .navbar-primary { background-color: #0069d9 !important; }
        .brand-link.bg-primary { background-color: #0069d9 !important; border-bottom: 1px solid #0056b3; }
        .sidebar-light-primary .nav-sidebar>.nav-item>.nav-link.active { background-color: #0069d9; color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .btn-primary { background-color: #0069d9; border-color: #0062cc; }
        .btn-primary:hover { background-color: #0056b3; border-color: #004085; }
        /* Poll Styles */
        .student-checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 5px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; border-radius: 4px; margin-bottom: 10px; }
        /* Maintenance Overlay */
        #maintenance-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #343a40; color: white; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #topMarquee { background: #d81b60; color: #fff; padding: 5px; font-weight: bold; display: none; z-index: 1040; position: relative; }
        
        /* Dark Mode Full Coverage */
        body.dark-mode { background-color: #454d55 !important; color: #fff; }
        body.dark-mode .content-wrapper { background-color: #343a40; color: #fff; }
        body.dark-mode .card { background-color: #343a40; color: #fff; }
        body.dark-mode .card-header { border-bottom-color: #454d55; }
        body.dark-mode .table { color: #fff; }
        body.dark-mode .table thead th { background-color: #3f474e; color: #fff; border-color: #454d55; }
        body.dark-mode .table td, body.dark-mode .table th { border-color: #454d55; }
        body.dark-mode .modal-content { background-color: #343a40; color: #fff; }
        body.dark-mode .close { color: #fff; }
        body.dark-mode .form-control { background-color: #454d55; color: #fff; border-color: #6c757d; }
        body.dark-mode .form-control:focus { background-color: #454d55; color: #fff; }
        body.dark-mode .list-group-item { background-color: #343a40; border-color: #454d55; }
        body.dark-mode .callout { background-color: #3f474e; border-color: #454d55; }

        /* Phone Notification Style */
        #phone-notification { position: fixed; top: -150px; left: 0; width: 100%; background: rgba(255, 255, 255, 0.98); color: #333; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1060; transition: top 0.5s ease; border-bottom: 3px solid #007bff; display: flex; align-items: center; backdrop-filter: blur(10px); }
        body.dark-mode #phone-notification { background: rgba(52, 58, 64, 0.98); color: #fff; border-bottom: 3px solid #17a2b8; }
        #phone-notification.show { top: 0; }
        #phone-notification img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; margin-right: 15px; }
        #phone-notification .content { flex-grow: 1; }
        #phone-notification .title { font-weight: bold; font-size: 1.1rem; margin-bottom: 2px; }
        #phone-notification .body { font-size: 0.95rem; opacity: 0.9; }
        #phone-notification .close-btn { background: none; border: none; font-size: 1.5rem; color: inherit; cursor: pointer; padding: 0 10px; }
        
        /* Hiệu ứng nút mới */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); transform: scale(1); }
        }
        .btn-new-highlight {
            animation: pulse-glow 2s infinite;
            border: 2px solid #ffc107 !important;
        }

        /* PRINT STYLES */
        @media print {
            .main-sidebar, .main-header, .btn, .no-print, .card-tools, .nav-pills, #phone-notification, #topMarquee { display: none !important; }
            .content-wrapper { margin-left: 0 !important; background: white !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd !important; }
        }
        
        /* VIP Styles from Profile */
        .vip-frame-container { position: relative; display: inline-block; }
        .vip-crown {
            position: absolute; top: -20px; right: -10px; 
            font-size: 1.5rem; color: #ffd700; 
            transform: rotate(15deg); 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            animation: floatCrown 2s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes floatCrown { 0%, 100% { transform: rotate(15deg) translateY(0); } 50% { transform: rotate(15deg) translateY(-3px); } }
        
        .vip-border-1 { border: 3px solid #c0c0c0 !important; box-shadow: 0 0 10px #c0c0c0; }
        .vip-border-2 { border: 3px solid #ffd700 !important; box-shadow: 0 0 15px #ffd700; animation: shineBorder 3s infinite linear; }
        @keyframes shineBorder { 0% { border-color: #ffd700; } 50% { border-color: #fff; } 100% { border-color: #ffd700; } }
        
        /* VIP 3 Styles */
        .vip-border-3 { border: 3px solid #00ffff !important; box-shadow: 0 0 15px #00ffff, 0 0 5px #fff inset; animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 0% { border-color: #00ffff; box-shadow: 0 0 15px #00ffff; } 50% { border-color: #fff; box-shadow: 0 0 25px #00ffff; } 100% { border-color: #00ffff; box-shadow: 0 0 15px #00ffff; } }
        
        .vip-border-4 { border: 3px solid #e5e4e2 !important; box-shadow: 0 0 15px #e5e4e2; animation: shineBorder 3s infinite linear; }
        .vip-border-5 { border: 3px solid #ffd700 !important; box-shadow: 0 0 20px #ffd700, 0 0 5px #fff inset; animation: pulseBorder 2s infinite; }
        
        .vip-diamond {
            position: absolute; top: -25px; right: -10px; 
            font-size: 1.8rem; color: #00ffff; 
            filter: drop-shadow(0 0 5px #00ffff);
            animation: floatDiamond 3s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes floatDiamond { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed">

<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user) { window.location.replace('login.html'); }
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker Registered', reg))
            .catch(err => console.log('Service Worker Failed', err));
        }
        
        // Request Notification Permission
        if ('Notification' in window && Notification.permission !== 'granted') {
            Notification.requestPermission();
        }
    })();
    function logout() { sessionStorage.clear(); window.location.replace('login.html'); }
</script>

<div class="wrapper">
    <div id="phone-notification">
        <img id="pn-img" src="" style="display:none;">
        <div class="content">
            <div id="pn-title" class="title"></div>
            <div id="pn-body" class="body"></div>
            <div id="pn-link" class="mt-1"></div>
        </div>
        <button class="close-btn" onclick="closePhoneNotification()">&times;</button>
    </div>
    <nav class="main-header navbar navbar-expand navbar-primary navbar-dark border-bottom-0">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
        </ul>
        <ul class="navbar-nav ml-auto">
            <li class="nav-item d-flex align-items-center">
                <a href="javascript:void(0)" class="nav-link" onclick="openNotificationModal()"><i class="fas fa-bell"></i><span class="badge badge-warning navbar-badge" id="notiBadge"></span></a>
            </li>
            <li class="nav-item d-flex align-items-center">
                <a href="profile.html" class="user-panel d-flex align-items-center mr-3" style="text-decoration: none;" title="Hồ sơ cá nhân">
                    <div class="vip-frame-container mr-2">
                        <img src="" class="img-circle elevation-2" id="userAvatar" alt="User" style="width: 35px; height: 35px; object-fit: cover;">
                        <div id="vipCrownArea"></div>
                    </div>
                    <span class="d-none d-md-inline font-weight-bold text-white" id="managerDisplayName">Quản lý</span>
                </a>
            </li>
            <li class="nav-item d-flex align-items-center">
                <a href="javascript:void(0)" onclick="logout()" class="btn btn-sm btn-danger font-weight-bold">
                    <i class="fas fa-sign-out-alt"></i> <span class="d-none d-md-inline">Thoát</span>
                </a>
            </li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-light-primary elevation-4">
        <a href="#" class="brand-link bg-primary">
            <span class="brand-text font-weight-bold pl-3">QUẢN LÝ SHH</span>
        </a>
        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link"><i class="nav-icon fas fa-id-card"></i><p>Hồ sơ cá nhân</p></a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-attendance" class="nav-link active" data-toggle="pill">
                            <i class="nav-icon fas fa-check-square"></i> <p>Điểm danh</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-students" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-user-friends"></i> <p>HS của nhóm</p>
                        </a>
                    </li>
                    <li class="nav-item d-none" id="nav-registrations">
                        <a href="#tab-registrations" class="nav-link" data-toggle="pill" onclick="loadRegistrations()">
                            <i class="nav-icon fas fa-user-plus"></i> <p>Duyệt Đăng Ký</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-upload" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-cloud-upload-alt"></i> <p>Trung tâm quản lý tệp tin</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-funds" class="nav-link" data-toggle="pill" onclick="loadFundTab()">
                            <i class="nav-icon fas fa-hand-holding-usd"></i> <p>Công cụ tính quỹ nhóm</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-evaluation" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-star"></i> <p>Đánh giá</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tab-feedback" class="nav-link" data-toggle="pill">
                            <i class="nav-icon fas fa-comments"></i> <p>Phản ánh kiến nghị</p>
                        </a>
                    </li>
                    <li class="nav-item">
            </nav>
        </div>
    </aside>

    <div class="content-wrapper text-sm">
        <div id="topMarquee"><marquee id="marqueeText" behavior="scroll" direction="left"></marquee></div>
        <div class="content">
            <div class="container-fluid pt-3">
                <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-attendance">
                <div class="callout callout-info mb-3 shadow-sm">
                    <h5><i class="fas fa-calendar-alt mr-2"></i>Hôm nay: <span id="currentDateDisplay"></span></h5>
                    <p class="text-muted mb-0">Chọn trạng thái cho từng học sinh và nhấn "Lưu kết quả".</p>
                </div>
                <div class="text-right mb-2"><button class="btn btn-sm btn-default" onclick="window.print()"><i class="fas fa-print"></i> In Phiếu Điểm Danh</button></div>
                <div class="text-right mb-2"><button class="btn btn-sm btn-info" onclick="openImportAttendanceModal()"><i class="fas fa-file-import"></i> Nhập Điểm Danh (Excel)</button></div>
                <div id="attendanceList" class="row">
                    <!-- Data loaded by JS -->
                </div>
                <button class="btn btn-success btn-block mt-4 shadow py-3" onclick="submitAttendance()">
                    <i class="fas fa-paper-plane mr-2"></i><b>LƯU KẾT QUẢ ĐIỂM DANH</b>
                </button>
            </div>

            <div class="tab-pane fade" id="tab-students">
                <div class="card card-outline card-primary shadow">
                    <div class="card-header d-flex align-items-center">
                        <h3 class="card-title text-uppercase flex-grow-1">
                            <i class="fas fa-table mr-2"></i>Danh sách học sinh <span class="text-primary" id="groupBadge">...</span>
                        </h3>
                        <div class="card-tools">
                            <button class="btn btn-default btn-sm shadow-sm mr-2" onclick="window.print()"><i class="fas fa-print"></i> In</button>
                            <button class="btn btn-info btn-sm shadow-sm mr-2 btn-manager-only" onclick="openImportModal('manager')"><i class="fas fa-file-import"></i> Nhập từ Excel</button>
                            <button class="btn btn-primary btn-sm shadow-sm mr-2 btn-manager-only" onclick="openStudentModal()">
                                <i class="fas fa-plus mr-1"></i> Thêm HS
                            </button>
                            <button class="btn btn-success btn-sm shadow-sm" onclick="exportExcel()">
                                <i class="fas fa-file-excel mr-1"></i> Xuất Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-bordered table-hover text-nowrap mb-0" id="excelTable">
                            <thead>
                                <tr class="text-center">
                                    <th width="50">STT</th>
                                    <th>Họ và Tên</th>
                                    <th>Ngày sinh</th>
                                    <th>Lớp</th>
                                    <th>Trường học</th>
                                    <th>Địa chỉ liên hệ</th>
                                    <th>Số điện thoại học sinh</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="groupStudentList">
                                <!-- Data loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-registrations">
                <div class="card card-outline card-warning shadow">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-user-clock mr-2"></i>Danh sách Đăng ký Tạm thời</h3>
                        <div class="card-tools"><button class="btn btn-tool" onclick="loadRegistrations()"><i class="fas fa-sync"></i></button></div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr><th>ID</th><th>Mật khẩu</th><th>Họ tên</th><th>Lớp</th><th>Trường</th><th>Thao tác</th></tr>
                            </thead>
                            <tbody id="regListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-upload">
                <div class="card card-outline card-primary shadow">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-folder-open mr-2"></i>Tài liệu sinh hoạt, hướng dẫn, kế hoạch chương trình và các file liên quan tới sinh hoạt hè</h3>
                        <div class="card-tools">
                            <button class="btn btn-tool" onclick="loadResources()"><i class="fas fa-sync"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- File Manager Interface -->
                        <div class="row">
                            <div class="col-md-3 border-right">
                                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                    <a class="nav-link active" id="filter-all" data-toggle="pill" href="#" onclick="filterResources('all')"><i class="fas fa-layer-group mr-2"></i>Tất cả</a>
                                    <a class="nav-link" id="filter-docs" data-toggle="pill" href="#" onclick="filterResources('docs')"><i class="fas fa-file-word mr-2"></i>Tài liệu (Word/PDF)</a>
                                    <a class="nav-link" id="filter-media" data-toggle="pill" href="#" onclick="filterResources('media')"><i class="fas fa-photo-video mr-2"></i>Media (Nhạc/Video)</a>
                                    <a class="nav-link" id="filter-other" data-toggle="pill" href="#" onclick="filterResources('other')"><i class="fas fa-archive mr-2"></i>Khác</a>
                                </div>
                                <hr>
                                <div class="alert alert-info p-2">
                                    <small><i class="fas fa-info-circle"></i> Dung lượng tối đa: <b id="limit_display">200</b>MB</small>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <div class="input-group mb-3">
                                    <input type="text" id="resource_search" class="form-control" placeholder="Tìm kiếm tệp tin..." onkeyup="searchResources()">
                                    <div class="input-group-append"><span class="input-group-text"><i class="fas fa-search"></i></span></div>
                                </div>
                                <div id="resource_list" class="row" style="max-height: 600px; overflow-y: auto;">
                                    <!-- Files loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <hr class="mt-4">
                        <h5 class="text-primary font-weight-bold"><i class="fas fa-cloud-upload-alt mr-2"></i>Gửi file cho Admin</h5>
                        <div class="form-group">
                            <label>Chọn file (Tối đa 200MB)</label>
                            <input type="file" id="file_upload_index" class="form-control-file border p-2">
                            <button class="btn btn-primary mt-2" onclick="uploadFileIndex()">Tải lên</button>
                        </div>
                        <div class="input-group">
                            <input type="text" id="drive_link_submission" class="form-control" placeholder="https://drive.google.com/...">
                            <div class="input-group-append">
                                <button class="btn btn-success" type="button" onclick="submitDriveLink()"><i class="fas fa-paper-plane mr-2"></i>Gửi Link</button>
                            </div>
                        </div>
                        <div class="mt-2 text-right">
                             <a href="https://j2team.dev/links" target="_blank" class="btn btn-xs btn-outline-secondary"><i class="fas fa-link mr-1"></i>Rút gọn link (J2Team)</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-funds">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow">
                            <div class="card-header"><h3 class="card-title font-weight-bold"><i class="fas fa-calculator mr-2"></i>Công cụ tính quỹ</h3></div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Số tiền thu / người (VNĐ)</label>
                                    <input type="number" id="fund_amount" class="form-control font-weight-bold text-success" value="20000" onchange="calculateFund()">
                                </div>
                                <div class="row text-center mb-3">
                                    <div class="col-6 border-right">
                                        <h5 class="text-muted">Đã đóng</h5>
                                        <h3 class="font-weight-bold text-primary" id="fund_count">0</h3>
                                    </div>
                                    <div class="col-6">
                                        <h5 class="text-muted">Tổng tiền</h5>
                                        <h3 class="font-weight-bold text-success" id="fund_total">0</h3>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-block font-weight-bold mb-2" onclick="saveFundLog()">
                                    <i class="fas fa-save mr-2"></i>LƯU VÀO SỔ QUỸ (THU)
                                </button>
                                <button class="btn btn-warning btn-block font-weight-bold mb-2" data-toggle="modal" data-target="#modalChiQuy">
                                    <i class="fas fa-file-invoice-dollar mr-2"></i>CHI QUỸ (RÚT TIỀN)
                                </button>
                                <button class="btn btn-outline-danger btn-block" onclick="resetFundCheckboxes()">
                                    <i class="fas fa-redo mr-2"></i>Reset (Tính đợt mới)
                                </button>
                            </div>
                        </div>
                        
                        <div class="card card-info card-outline shadow mt-3">
                            <div class="card-header d-flex p-2 align-items-center">
                                <h3 class="card-title font-weight-bold pl-2"><i class="fas fa-history mr-2"></i>Lịch sử Thu/Chi</h3>
                                <div class="ml-auto">
                                    <button class="btn btn-xs btn-default mr-1" onclick="window.print()"><i class="fas fa-print"></i> In</button>
                                    <button class="btn btn-xs btn-success" onclick="exportFundHistoryExcel()"><i class="fas fa-file-excel"></i> Xuất Excel</button>
                                </div>
                            </div>
                            <div class="card-body p-0 table-responsive" style="max-height: 300px;">
                                <table class="table table-sm table-striped">
                                    <thead><tr><th>Thời gian</th><th>Số tiền</th><th>Chi tiết</th></tr></thead>
                                    <tbody id="fundHistoryData"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card shadow">
                            <div class="card-header bg-light">
                                <h3 class="card-title font-weight-bold">Danh sách đóng tiền</h3>
                                <div class="card-tools">
                                    <div class="input-group input-group-sm" style="width: 200px;">
                                        <input type="text" id="fund_search" class="form-control float-right" placeholder="Tìm tên..." onkeyup="filterFundList()">
                                        <div class="input-group-append"><button type="submit" class="btn btn-default"><i class="fas fa-search"></i></button></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0 table-responsive" style="height: 600px;">
                                <table class="table table-hover table-head-fixed text-nowrap">
                                    <thead><tr><th width="50">#</th><th>Họ và Tên</th><th class="text-center">Trạng thái</th><th>Ghi Chú</th></tr></thead>
                                    <tbody id="fundStudentList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                        
            <!-- Modal Chi Quỹ -->
            <div class="modal fade" id="modalChiQuy" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header bg-warning"><h5 class="modal-title"><i class="fas fa-donate mr-2"></i>Chi quỹ nhóm</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
                        <div class="modal-body">
                            <div class="form-group"><label>Mục đích chi</label><input type="text" id="expense_reason" class="form-control" placeholder="Mua đồ dùng, tổ chức..."></div>
                            <div class="form-group"><label>Số tiền chi (VNĐ)</label><input type="number" id="expense_amount" class="form-control" placeholder="Nhập số tiền..."></div>
                            <div class="form-group"><label>Ghi chú thêm</label><textarea id="expense_notes" class="form-control" rows="3"></textarea></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-warning" onclick="saveExpenseLog()">Lưu Khoản Chi</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-evaluation">
                <div class="card card-outline card-purple shadow">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-star mr-2"></i>Đánh giá & Xếp loại Học sinh</h3>
                        <div class="card-tools">
                            <button class="btn btn-tool" onclick="loadEvaluationUI()"><i class="fas fa-sync"></i></button>
                        </div>
                    </div>
                    <div id="evalAlertContainer" class="p-3"></div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap">
                            <thead>
                                <tr class="bg-light">
                                    <th>Học sinh</th>
                                    <th>Xếp loại hiện tại</th>
                                    <th class="text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="evaluationList">
                                <!-- Data loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-feedback">
                <div class="row">
                    <!-- Cột trái: Form gửi -->
                    <div class="col-md-4">
                        <div class="card card-primary card-outline shadow-sm">
                            <div class="card-header">
                                <h3 class="card-title font-weight-bold"><i class="fas fa-pen-alt mr-2"></i>Tạo phản ánh kiến nghị mới</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Số điện thoại liên hệ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-phone"></i></span></div>
                                        <input type="text" id="fb_phone" class="form-control" placeholder="Nhập SĐT...">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Tiêu đề <span class="text-danger">*</span></label>
                                    <input type="text" id="fb_title" class="form-control" placeholder="VD: Lỗi điểm danh...">
                                </div>
                                <div class="form-group">
                                    <label>Mã xác nhận <span class="text-danger">*</span></label>
                                    <div class="d-flex">
                                        <canvas id="fbCaptchaCanvas" width="120" height="38" style="border:1px solid #ccc; cursor:pointer; border-radius:4px;" title="Click để đổi mã"></canvas>
                                        <input type="text" id="fb_captcha_input" class="form-control ml-2" placeholder="Nhập 4 số" maxlength="4">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Nội dung / Khó khăn</label>
                                    <textarea id="fb_difficulty" class="form-control" rows="4" placeholder="Mô tả chi tiết vấn đề, phản ánh..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Đề xuất (nếu có)</label>
                                    <textarea id="fb_suggestion" class="form-control" rows="2" placeholder="Kiến nghị giải pháp..."></textarea>
                                </div>
                                <div class="form-group bg-light p-2 rounded border">
                                    <label class="text-primary"><i class="fas fa-paperclip mr-2"></i>Đính kèm Ảnh/File (Max 20MB)</label>
                                    <input type="file" id="fb_file" class="form-control-file mb-2" accept="image/*,.doc,.docx,.pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
                                    <input type="text" id="fb_drive_link" class="form-control form-control-sm" placeholder="Hoặc dán Link Google Drive...">
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-info-circle"></i> Chỉ chấp nhận file ảnh, doc, pdf. File sẽ tự động xóa sau 7 ngày.
                                    </small>
                                </div>
                                <button class="btn btn-primary btn-block font-weight-bold" onclick="sendFeedback()">
                                    <i class="fas fa-paper-plane mr-2"></i> GỬI YÊU CẦU
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cột phải: Lịch sử -->
                    <div class="col-md-8">
                        <div class="card card-outline card-info shadow-sm h-100">
                            <div class="card-header border-0 bg-white">
                                <h3 class="card-title font-weight-bold text-info"><i class="fas fa-history mr-2"></i>Lịch sử phản ánh</h3>
                                <div class="card-tools">
                                    <button class="btn btn-tool" onclick="loadFeedbackHistory()"><i class="fas fa-sync"></i></button>
                                </div>
                            </div>
                            <div class="card-body bg-light p-3" style="max-height: 700px; overflow-y: auto;">
                                <div id="feedbackHistoryList">
                                    <!-- Data loaded by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Student -->
<div class="modal fade" id="modalStudent" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="modal-title">Thông tin Học sinh</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="student_id_old">
                <div class="form-group"><label>Mã Học sinh (ID)</label><input type="text" id="st_id" class="form-control" placeholder="Nhập mã HS..."></div>
                <div class="form-group"><label>Họ và Tên</label><input type="text" id="st_name" class="form-control" placeholder="Nguyễn Văn A"></div>
                <div class="form-group"><label>Ngày sinh</label><input type="text" id="st_dob" class="form-control" placeholder="dd/mm/yyyy"></div>
                <div class="form-group"><label>Lớp</label><input type="text" id="st_class" class="form-control"></div>
                <div class="form-group"><label>Địa chỉ</label><input type="text" id="st_address" class="form-control"></div>
                <div class="form-group"><label>Số điện thoại học sinh</label><input type="text" id="st_phone" class="form-control"></div>
                <div class="form-group"><label>Trường học</label><input type="text" id="st_school" class="form-control"></div>
                <div class="form-group bg-light p-2 border rounded">
                    <label class="text-primary"><i class="fas fa-exchange-alt mr-1"></i>Chuyển Nhóm (Nếu cần)</label>
                    <select id="st_group_select" class="form-control">
                        <!-- Options loaded via JS -->
                    </select>
                </div>
                <h6 class="text-info border-top pt-2 mt-2">Thông tin đăng ký</h6>
                <div class="form-group"><label>Thời gian</label><input type="text" id="st_reg_time" class="form-control"></div>
                <div class="form-group"><label>Địa điểm</label><input type="text" id="st_reg_loc" class="form-control"></div>
                <div class="form-group"><label>Hoạt động</label><textarea id="st_reg_act" class="form-control" rows="2"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveStudent()">Lưu dữ liệu</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Evaluate Student -->
<div class="modal fade" id="modalEvaluate" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title"><i class="fas fa-user-graduate mr-2"></i>Phiếu Đánh Giá Sinh Hoạt Hè</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="eval_st_id">
                <input type="hidden" id="eval_st_name">
                <h5 class="text-center font-weight-bold text-primary mb-3" id="eval_st_display_name"></h5>
                
                <div class="form-group">
                    <label class="font-weight-bold">1. Ý thức tổ chức kỷ luật:</label>
                    <textarea id="eval_discipline" class="form-control" rows="2" placeholder="Nhận xét về việc chấp hành giờ giấc, nội quy..."></textarea>
                </div>
                <div class="form-group">
                    <label class="font-weight-bold">2. Mức độ tích cực:</label>
                    <textarea id="eval_positivity" class="form-control" rows="2" placeholder="Nhận xét về sự hăng hái tham gia phong trào..."></textarea>
                </div>
                <div class="form-group">
                    <label class="font-weight-bold">3. Hoạt động tình nguyện:</label>
                    <textarea id="eval_volunteering" class="form-control" rows="2" placeholder="Nhận xét về tham gia vệ sinh môi trường, hỗ trợ..."></textarea>
                </div>
                <div class="form-group">
                    <label class="font-weight-bold text-danger">4. Xếp loại chung:</label>
                    <select id="eval_classification" class="form-control font-weight-bold">
                        <option value="">-- Chọn mức xếp loại --</option>
                        <option value="Xuất sắc">Xuất sắc (100% buổi, tích cực)</option>
                        <option value="Tốt">Tốt/Khá (Đều đặn, ý thức tốt)</option>
                        <option value="Trung bình">Trung bình (Không đầy đủ/Chưa tích cực)</option>
                        <option value="Yếu">Yếu (Không tham gia/Vi phạm)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-purple" style="background-color: #6f42c1; color: white;" onclick="submitEvaluation()">Lưu đánh giá</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Students -->
<div class="modal fade" id="modalImport" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-file-import mr-2"></i>Nhập danh sách học sinh từ Excel</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Vui lòng sử dụng file Excel theo đúng định dạng mẫu. Hệ thống sẽ tự động bỏ qua các học sinh đã tồn tại (trùng Tên trong nhóm của bạn).</p>
                <div class="form-group">
                    <label>1. Tải file mẫu</label><br>
                    <button class="btn btn-success" id="btnDownloadTemplate"><i class="fas fa-download mr-2"></i>Tải mẫu Excel</button>
                </div>
                <div class="form-group">
                    <label>2. Chọn file Excel của bạn</label>
                    <input type="file" id="file_import" class="form-control-file border p-2" accept=".xlsx, .xls">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-info" id="btnProcessImport">Bắt đầu Nhập</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Import Attendance -->
<div class="modal fade" id="modalImportAttendance" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-excel mr-2"></i>Nhập Điểm Danh từ Excel</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <p>Tải file mẫu, điền trạng thái (C: Có mặt, P: Vắng phép, K: Vắng không phép) và tải lên.</p>
                <button class="btn btn-outline-success btn-sm mb-3" onclick="downloadAttendanceTemplate()"><i class="fas fa-download mr-1"></i>Tải file mẫu</button>
                <input type="file" id="file_att_import" class="form-control-file border p-2" accept=".xlsx">
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-success" onclick="processAttendanceImport()">Xử lý</button></div>
        </div>
    </div>
</div>

<!-- Modal Notifications -->
<div class="modal fade" id="modalNotifications" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-bell mr-2"></i>Thông báo từ Admin</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; overflow-y: auto;">
                <ul class="products-list product-list-in-card pl-2 pr-2" id="notificationListModal"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal Change Password -->
<div class="modal fade" id="modalChangePass" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-key mr-2"></i>Đổi mật khẩu</h5>
                <button type="button" class="close" data-dismiss="modal" id="btnClosePassModal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="passAlert">Bạn đang sử dụng mật khẩu mặc định. Vui lòng đổi mật khẩu để tiếp tục!</div>
                <div class="form-group"><label>Mật khẩu cũ</label><input type="password" id="old_pass" class="form-control"></div>
                <div class="form-group"><label>Mật khẩu mới</label><input type="password" id="new_pass" class="form-control"></div>
                <div class="form-group"><label>Nhập lại mật khẩu</label><input type="password" id="confirm_pass" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-block" onclick="submitChangePass()">Xác nhận đổi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Change PIN -->
<div class="modal fade" id="modalChangePin" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white">
                <h5 class="modal-title font-weight-bold"><i class="fas fa-key mr-2"></i>Đổi mã PIN</h5>
                <button type="button" class="close text-white" data-dismiss="modal" id="btnClosePinModal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="pinAlert">Bạn đang sử dụng mã PIN mặc định. Vui lòng đổi mã PIN để tăng cường bảo mật!</div>
                <div class="form-group"><label>Mã PIN hiện tại</label><input type="password" id="current_pin" class="form-control" maxlength="4" inputmode="numeric" autocomplete="one-time-code"></div>
                <div class="form-group"><label>Mã PIN mới (4 số)</label><input type="password" id="new_pin" class="form-control" maxlength="4" inputmode="numeric" autocomplete="one-time-code"></div>
                <div class="form-group"><label>Nhập lại PIN mới</label><input type="password" id="confirm_pin" class="form-control" maxlength="4" inputmode="numeric" autocomplete="one-time-code"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-block" style="background-color: #6f42c1; color: white;" onclick="submitChangePin()">Xác nhận đổi PIN</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview File -->
<div class="modal fade" id="modalPreview" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document" style="height: 90%;">
        <div class="modal-content" style="height: 100%;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="previewTitle">Xem trước</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body p-0 d-flex justify-content-center align-items-center bg-light" id="previewBody" style="height: 100%; overflow: hidden;">
                <!-- Content loaded via JS -->
            </div>
        </div>
    </div>
</div>

<!-- Modal Change Avatar -->
<div class="modal fade" id="modalAvatar" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-image mr-2"></i>Đổi Ảnh đại diện</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body text-center">
                <div class="form-group"><label>Chọn ảnh từ thiết bị</label><input type="file" id="avatarFile" class="form-control-file border p-2" accept="image/*"></div>
                <div class="mt-3"><img id="previewAvatar" src="" style="max-width: 150px; max-height: 150px; border-radius: 50%; display: none;" class="shadow"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-block" onclick="submitAvatar()">Lưu ảnh đại diện</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";
let globalGroupStudents = [];
let globalNotifications = [];
let globalFundLogs = [];
let globalMaxUploadSize = 200; // Default 200MB
let globalDriveLink = "";
let globalResources = [];
let fbCaptchaCode = ""; // Store captcha code

// --- HELPER FUNCTIONS FOR LOADING/ERROR STATES ---
function getLoadingRowHtml(colspan) {
    return `<tr><td colspan="${colspan}" class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Đang tải dữ liệu...</p></td></tr>`;
}
function getErrorRowHtml(colspan, message = "Không thể tải dữ liệu.") {
    return `<tr><td colspan="${colspan}" class="text-center text-danger p-5"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></td></tr>`;
}
const loadingSpinner = `<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Đang tải dữ liệu...</p></div>`;
const errorAlert = (message = "Không thể tải dữ liệu.") => `<div class="text-center p-5 text-danger"><i class="fas fa-exclamation-triangle fa-2x"></i><p class="mt-2">${message}</p></div>`;


// Hàm hỗ trợ định dạng ngày tháng dd/mm/yyyy
function formatDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr; // Trả về gốc nếu không phải định dạng ngày
        const d = String(date.getDate()).padStart(2, '0');
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    } catch (e) {
        return dateStr;
    }
}

document.addEventListener("DOMContentLoaded", function() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const avatarUrl = user.avatar || 'https://via.placeholder.com/150';
    
    document.getElementById('managerDisplayName').innerText = user.fullname;
    document.getElementById('userAvatar').src = avatarUrl;
    
    const displayGroupName = user.group_name || user.group_id;
    if(document.getElementById('groupBadge')) document.getElementById('groupBadge').innerText = displayGroupName;
    
    
    document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric', year: 'numeric' });
    
    // Dark Mode Init
    if (localStorage.getItem('darkMode') === 'true') {
        $('body').addClass('dark-mode');
    }
    
    // Render VIP Honors
    try {
        const honors = JSON.parse(user.honors || '{}');
        const avatarNav = $('#userAvatar');
        
        if (honors.level === 'vip1') {
            avatarNav.addClass('vip-border-1');
        } else if (honors.level === 'vip2') {
            avatarNav.addClass('vip-border-2');
            $('#vipCrownArea').html('<i class="fas fa-crown vip-crown"></i>');
        } else if (honors.level === 'vip3') {
            avatarNav.addClass('vip-border-3');
            $('#vipCrownArea').html('<i class="fas fa-gem vip-diamond"></i>');
        }
        else if (honors.level === 'vip4') {
            avatarNav.addClass('vip-border-4');
            $('#vipCrownArea').html('<i class="fas fa-crown vip-crown" style="color: #e5e4e2;"></i>');
        } else if (honors.level === 'vip5') {
            avatarNav.addClass('vip-border-5');
            $('#vipCrownArea').html('<i class="fas fa-crown vip-crown"></i>');
        }
    } catch(e) {}

    fetchStudentsByGroup(user.group_id);
    loadGlobalConfig(); // Tải cấu hình hệ thống (Bảo trì, Marquee...)
    loadNotifications();
    loadGroupsForSelect(); // Tải danh sách nhóm để dùng khi chuyển nhóm
    loadResources(); // Tải tài nguyên
    loadFeedbackHistory();
    checkUrgentNotification(); // Kiểm tra thông báo khẩn
    generateFbCaptcha(); // Tạo captcha góp ý
    
    // Role specific UI
    if (user.role === 'supervisor') {
        $('.btn-manager-only').hide(); // Hide Add/Import buttons
        $('#nav-registrations').removeClass('d-none'); // Show Registrations tab
    }
    
    // Start Polling for Notifications (Push Simulation)
    setInterval(pollForNotifications, 60000); // Check every 60s

    // Kiểm tra mật khẩu mặc định
    if (user.is_default_pass) {
        $('#modalChangePass').modal('show');
        $('#passAlert').removeClass('d-none');
        $('#btnClosePassModal').hide(); // Ẩn nút đóng để bắt buộc đổi
    }

    // Kiểm tra mã PIN mặc định
    if (user.is_default_pin) {
        $('#modalChangePin').modal('show');
        $('#pinAlert').removeClass('d-none');
        $('#btnClosePinModal').hide();
    }

    // Tự động thu gọn sidebar khi click menu trên điện thoại
    $('.nav-sidebar .nav-link').on('click', function() {
        if (window.innerWidth < 992) {
            $('[data-widget="pushmenu"]').PushMenu('collapse');
        }
    });
});

// --- PUSH NOTIFICATION LOGIC (POLLING) ---
async function pollForNotifications() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (!user) return;
    
    try {
        // Fetch latest notifications (lightweight check if possible, here reusing existing API)
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS", payload: { username: user.username } }) });
        const res = await response.json();
        
        if (res.status === "success" && res.data.notifications && res.data.notifications.length > 0) {
            const latestNoti = res.data.notifications[0]; // Assuming sorted by newest
            const lastSeenId = localStorage.getItem('last_noti_id');
            
            if (latestNoti.id !== lastSeenId) {
                // New notification found!
                localStorage.setItem('last_noti_id', latestNoti.id);
                
                // Trigger Browser Notification
                if (Notification.permission === 'granted') {
                    new Notification("Thông báo mới từ SHH", {
                        body: latestNoti.title,
                        icon: 'https://via.placeholder.com/128?text=SHH' // Replace with app icon
                    });
                } else {
                    toastr.info("Có thông báo mới: " + latestNoti.title);
                }
                // Reload list in UI
                loadNotifications();
            }
        }
    } catch(e) { console.log("Polling error", e); }
}

// --- MAINTENANCE CHECK ---
async function loadGlobalConfig() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_CONFIG" }) });
        const res = await response.json();
        if (res.status === "success") {
            const conf = res.data;
            sessionStorage.setItem('globalConfig', JSON.stringify(conf)); // Lưu config để dùng cho check Lock
            
            // 1. Global Maintenance (Bảo trì toàn bộ)
            // 1. Global Maintenance (Bảo trì toàn bộ - Manual & Auto)
            const now = new Date();
            const start = conf.maintenance_start ? new Date(conf.maintenance_start) : null;
            const end = conf.maintenance_end ? new Date(conf.maintenance_end) : null;
            let isMaintenance = false;
            let showTimer = false;

            // Check Manual
            if (String(conf.maintenance_mode).toUpperCase() === 'TRUE') {
                const overlay = document.createElement('div');
                overlay.id = 'maintenance-overlay';
                overlay.innerHTML = '<i class="fas fa-tools fa-4x mb-3 text-warning"></i><h1 class="font-weight-bold">HỆ THỐNG ĐANG BẢO TRÌ</h1><p class="lead">Vui lòng quay lại sau.</p><button class="btn btn-outline-light mt-3 font-weight-bold" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất</button>';
                document.body.appendChild(overlay);
                document.body.style.overflow = 'hidden';
                return; // Dừng tải các thành phần khác
                isMaintenance = true;
            } 
            // Check Schedule
            else if (start && end && now >= start && now <= end) {
                isMaintenance = true;
                showTimer = true;
            }

            if (isMaintenance) {
                showMaintenanceOverlay(showTimer ? start : null, showTimer ? end : null);
                return;
            }

            // 2. Marquee (Chữ chạy)
            if (String(conf.marquee_enabled).toUpperCase() === 'TRUE' && conf.marquee_text) {
                $('#marqueeText').text(conf.marquee_text);
                $('#topMarquee').show();
            } else {
                $('#topMarquee').hide();
            }

            // Load Max Upload Size
            globalMaxUploadSize = parseInt(conf.max_upload_size) || 200;
            $('#limit_display').text(globalMaxUploadSize);
            globalDriveLink = conf.upload_drive_link || "";

            // Check Upload Maintenance
            if (String(conf.maint_upload).toUpperCase() === 'TRUE') {
                $('#upload_feature_area').hide();
                $('#upload_blocked_msg').removeClass('d-none');
                if (conf.upload_drive_link) {
                    $('#upload_drive_link_display').html(`Tính năng tải file trực tiếp đang tắt.`);
                } else {
                    $('#upload_drive_link_display').text("Vui lòng liên hệ Admin để biết thêm chi tiết.");
                }
            }

            // 3. Feature Maintenance (Bảo trì từng phần)
            const features = {
                'maint_attendance': 'tab-attendance',
                'maint_students': 'tab-students',
                'maint_funds': 'tab-funds',
                'maint_eval': 'tab-evaluation',
                'maint_feedback': 'tab-feedback',
                // 'maint_upload': 'tab-upload' // Handled separately above
            };

            for (const [key, tabId] of Object.entries(features)) {
                if (String(conf[key]).toUpperCase() === 'TRUE') {
                    $(`#${tabId}`).html('<div class="text-center p-5 text-muted"><i class="fas fa-tools fa-3x mb-3 text-warning"></i><h4>Tính năng đang bảo trì</h4><p>Vui lòng quay lại sau.</p></div>');
                }
            }
        }
    } catch(e) {}
}

function showMaintenanceOverlay(startTime, endTime) {
    const overlay = document.createElement('div');
    overlay.id = 'maintenance-overlay';
    
    let timeHtml = '';
    if (endTime) {
        timeHtml = `
            <div class="w-75 mt-4" style="max-width: 500px;">
                <h4 id="maint-timer" class="font-weight-bold mb-3 text-warning" style="font-family: monospace; font-size: 2.5rem; text-shadow: 0 0 10px rgba(0,0,0,0.5);">00:00:00</h4>
                <div class="progress" style="height: 25px; background-color: rgba(255,255,255,0.2);">
                    <div id="maint-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 0%; font-weight: bold; color: #000;">0%</div>
                </div>
                <p class="mt-2 text-light"><small>Hệ thống sẽ tự động mở lại vào: ${endTime.toLocaleString('vi-VN')}</small></p>
            </div>`;
    }

    overlay.innerHTML = `
        <i class="fas fa-tools fa-4x mb-3 text-warning"></i>
        <h1 class="font-weight-bold">HỆ THỐNG ĐANG BẢO TRÌ</h1>
        <p class="lead">Chúng tôi đang nâng cấp hệ thống để phục vụ tốt hơn.</p>
        ${timeHtml}
        <button class="btn btn-outline-light mt-4 font-weight-bold" onclick="logout()"><i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất</button>
    `;
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    if (endTime) {
        const updateTimer = () => {
            const now = new Date();
            const distance = endTime - now;
            if (distance < 0) { location.reload(); return; }

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            document.getElementById('maint-timer').innerText = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (startTime) {
                let percent = ((now - startTime) / (endTime - startTime)) * 100;
                percent = Math.min(100, Math.max(0, percent));
                const bar = document.getElementById('maint-progress');
                bar.style.width = `${percent}%`;
                bar.innerText = `${Math.round(percent)}%`;
            }
        };
        updateTimer(); setInterval(updateTimer, 1000);
    }
}

// --- LOGIC ĐỔI MẬT KHẨU ---
function openChangePassModal() {
    $('#modalChangePass').modal('show');
    $('#passAlert').addClass('d-none');
    $('#btnClosePassModal').show();
    $('#old_pass, #new_pass, #confirm_pass').val('');
}

async function submitChangePass() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const oldPass = $('#old_pass').val().trim();
    const newPass = $('#new_pass').val().trim();
    const confirmPass = $('#confirm_pass').val().trim();

    if (!oldPass) return toastr.warning("Vui lòng nhập mật khẩu cũ!");
    if (newPass.length < 6) return toastr.warning("Mật khẩu phải từ 6 ký tự trở lên!");
    if (newPass !== confirmPass) return toastr.error("Mật khẩu nhập lại không khớp!");

    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "CHANGE_PASSWORD", payload: { username: user.username, old_pass: oldPass, new_pass: newPass } }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Vui lòng đăng nhập lại!', 'success').then(() => logout());
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- LOGIC ĐỔI MÃ PIN ---
function openChangePinModal() {
    $('#modalChangePin').modal('show');
    $('#pinAlert').addClass('d-none');
    $('#btnClosePinModal').show();
    $('#current_pin, #new_pin, #confirm_pin').val('');
}

async function submitChangePin() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const currentPin = $('#current_pin').val().trim();
    const newPin = $('#new_pin').val().trim();
    const confirmPin = $('#confirm_pin').val().trim();

    if (newPin.length !== 4) return toastr.warning("Mã PIN mới phải có 4 số!");
    if (newPin !== confirmPin) return toastr.error("Mã PIN nhập lại không khớp!");
    if (currentPin === newPin) return toastr.warning("Mã PIN mới phải khác mã PIN hiện tại!");

    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "CHANGE_PIN", 
                payload: { username: user.username, current_pin: currentPin, new_pin: newPin } 
            }) 
        });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã đổi mã PIN thành công!', 'success');
            $('#modalChangePin').modal('hide');
            user.is_default_pin = false; // Cập nhật trạng thái trong session
            sessionStorage.setItem('user', JSON.stringify(user));
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- LOGIC ĐỔI AVATAR (FILE -> LINK BASE64) ---
function openAvatarModal() {
    $('#modalAvatar').modal('show');
    $('#avatarFile').val('');
    $('#previewAvatar').hide();
}

$('#avatarFile').change(function() {
    const file = this.files[0];
    if (file) {
        resizeImage(file, 300, 300, function(base64) {
            $('#previewAvatar').attr('src', base64).show();
        });
    }
});

function resizeImage(file, maxWidth, maxHeight, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } 
            else { if (h > maxHeight) { w *= maxHeight / h; h = maxHeight; } }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', 0.7)); // Nén ảnh JPEG 70%
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

async function submitAvatar() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const avatarBase64 = $('#previewAvatar').attr('src');
    if (!avatarBase64) return toastr.warning("Vui lòng chọn ảnh!");
    Swal.fire({ title: 'Đang tải lên...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "UPDATE_AVATAR", payload: { username: user.username, avatar: avatarBase64 } }) });
        const res = await response.json();
        if (res.status === 'success') {
            user.avatar = avatarBase64;
            sessionStorage.setItem('user', JSON.stringify(user));
            $('#userAvatar, #userAvatarInner').attr('src', avatarBase64);
            // Force refresh images in profile if open
            $('#modalAvatar').modal('hide');
            Swal.fire('Thành công', 'Đã cập nhật ảnh đại diện!', 'success');
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

let globalGroupsList = [];
async function loadGroupsForSelect() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_GROUPS_PUBLIC" }) });
        const res = await response.json();
        if (res.status === "success") {
            globalGroupsList = res.data;
            let html = '<option value="">-- Chọn nhóm --</option>';
            res.data.forEach(g => { html += `<option value="${g.id}">${g.name}</option>`; });
            $('#st_group_select').html(html);
        }
    } catch (e) { console.error(e); }
}

async function fetchStudentsByGroup(groupId) {
    const attContainer = document.getElementById('attendanceList');
    const tableBody = document.getElementById('groupStudentList');
    
    attContainer.innerHTML = loadingSpinner;
    tableBody.innerHTML = getLoadingRowHtml(7);

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "GET_STUDENTS_BY_GROUP",
                payload: { group_id: groupId }
            })
        });
        const res = await response.json();

        if (res.status === "success") {
            globalGroupStudents = res.data;
            let attHtml = '';
            let tableHtml = '';

            res.data.forEach((student, index) => {
                const user = JSON.parse(sessionStorage.getItem('user'));
                // Định dạng ngày sinh sang dd/mm/yyyy
                const formattedDob = formatDate(student.dob);

                attHtml += `
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="info-box shadow-sm border">
                            <div class="info-box-content">
                                <span class="info-box-text font-weight-bold" style="font-size:1.1rem">${student.fullname}</span>
                                <div class="btn-group btn-group-toggle mt-2 w-100" data-toggle="buttons">
                                    <label class="btn btn-outline-success active" onclick="$('#reason_box_${student.id}').addClass('d-none')">
                                        <input type="radio" name="st_${student.id}" value="present" checked> Có mặt
                                    </label>
                                    <label class="btn btn-outline-warning" onclick="$('#reason_box_${student.id}').removeClass('d-none'); $('#reason_${student.id}').focus()">
                                        <input type="radio" name="st_${student.id}" value="absent_perm"> Vắng (P)
                                    </label>
                                    <label class="btn btn-outline-danger" onclick="$('#reason_box_${student.id}').addClass('d-none')">
                                        <input type="radio" name="st_${student.id}" value="absent"> Vắng
                                    </label>
                                </div>
                                <div id="reason_box_${student.id}" class="mt-2 d-none">
                                    <input type="text" id="reason_${student.id}" class="form-control form-control-sm" placeholder="Nhập lý do vắng...">
                                </div>
                            </div>
                        </div>
                    </div>`;

                tableHtml += `
                    <tr>
                        <td class="text-center font-weight-bold">${index + 1}</td>
                        <td class="font-weight-bold">${student.fullname}</td>
                        <td class="text-center text-primary font-weight-bold">${formattedDob}</td>
                        <td>${student.class_name || '-'}</td>
                        <td>${student.school || '-'}</td>
                        <td style="white-space: normal;">${student.address || '-'}</td>
                        <td class="text-center">
                            ${student.phone ? `<a href="tel:${student.phone}" class="btn btn-xs btn-link"><i class="fas fa-phone mr-1"></i>${student.phone}</a>` : '-'}
                        </td>
                        <td class="text-center">${user.role !== 'supervisor' ? `
                            <button class="btn btn-xs btn-info" onclick="editStudent(${index})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-xs btn-danger" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i></button>
                        ` : '<span class="badge badge-secondary">Chỉ xem</span>'}</td>
                    </tr>`;
            });

            attContainer.innerHTML = attHtml || '<div class="col-12 text-center">Không có dữ liệu.</div>';
            tableBody.innerHTML = tableHtml || '<tr><td colspan="6" class="text-center">Không có dữ liệu.</td></tr>';
            checkAttendanceLock(); // Kiểm tra khóa sau khi render xong
            loadEvaluationUI(); // Tải đánh giá sau khi đã có danh sách học sinh
        }
    } catch (error) {
        toastr.error("Lỗi kết nối máy chủ.");
        attContainer.innerHTML = errorAlert();
        tableBody.innerHTML = getErrorRowHtml(7);
    }
}

function openNotificationModal() {
    $('#modalNotifications').modal('show');
}

async function loadNotifications() {
    const notiList = $('#notificationListModal');
    notiList.html(loadingSpinner);
    try {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_ADMIN_EXTRAS", payload: { username: user.username } }) });
        const res = await response.json();
        
        if (res.status === "success" && res.data.notifications) {
            globalNotifications = res.data.notifications; // Lưu vào biến toàn cục để check lock
            let html = '';
            const notis = res.data.notifications;
            const readIds = res.data.read_ids || [];

            let unreadCount = 0;
            if(notis.length === 0) {
                html = '<li class="item text-center p-3 text-muted">Không có thông báo nào.</li>';
            } else {
                notis.forEach(n => {
                    const isRead = readIds.includes(n.id);
                    const btnHtml = isRead 
                        ? '<span class="badge badge-secondary float-right ml-2"><i class="fas fa-check mr-1"></i>Đã xem</span>' 
                        : `<button class="btn btn-xs btn-outline-primary float-right ml-2" onclick="markRead('${n.id}')">Đã xem</button>`;
                    
                    if (!isRead) unreadCount++;

                    // --- XỬ LÝ BÌNH CHỌN (POLL) ---
                    let pollHtml = '';
                    if (n.type === 'poll') {
                        try {
                            const pollData = JSON.parse(n.content); // {question, options:[], deadline}
                            const isExpired = new Date() > new Date(pollData.deadline);
                            
                            if (isExpired) {
                                pollHtml = `<div class="mt-2 p-2 bg-light border rounded border-danger text-center"><span class="text-danger font-weight-bold">Bình chọn đã kết thúc</span></div>`;
                            } else {
                                let optionsHtml = '';
                                pollData.options.forEach((opt, idx) => {
                                    optionsHtml += `
                                        <div class="custom-control custom-radio mb-1">
                                            <input class="custom-control-input" type="radio" id="poll_${n.id}_${idx}" name="poll_opt_${n.id}" value="${opt}">
                                            <label for="poll_${n.id}_${idx}" class="custom-control-label font-weight-normal">${opt}</label>
                                        </div>`;
                                });

                                // Checkbox chọn nhiều học sinh
                                let studentListHtml = '<div class="student-checkbox-grid">';
                                globalGroupStudents.forEach((st, sIdx) => {
                                    studentListHtml += `
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input poll-student-check-${n.id}" id="ps_${n.id}_${sIdx}" value="${st.fullname}">
                                            <label class="custom-control-label small" for="ps_${n.id}_${sIdx}">${st.fullname}</label>
                                        </div>`;
                                });
                                studentListHtml += '</div>';

                                pollHtml = `
                                    <div class="mt-3 p-3 bg-white border rounded shadow-sm">
                                        <h6 class="font-weight-bold text-primary border-bottom pb-2 mb-2"><i class="fas fa-poll mr-2"></i>Bình chọn: ${pollData.question}</h6>
                                        <div class="mb-2 font-weight-bold text-dark small">1. Chọn học sinh tham gia:</div>
                                        ${studentListHtml}
                                        <div class="mb-2 font-weight-bold text-dark small">2. Chọn phương án (1 lựa chọn):</div>
                                        ${optionsHtml}
                                        <button class="btn btn-primary btn-sm btn-block mt-3" onclick="submitVote('${n.id}')"><i class="fas fa-paper-plane mr-2"></i>Gửi bình chọn</button>
                                        <button class="btn btn-info btn-sm btn-block mt-2" onclick="viewPollResults('${n.id}')"><i class="fas fa-chart-pie mr-2"></i>Xem kết quả</button>
                                        <small class="text-muted d-block mt-2 text-right">Hạn chót: ${formatDate(pollData.deadline)}</small>
                                    </div>`;
                            }
                            // Ẩn nội dung gốc vì đã hiển thị trong Poll Card
                            n.content = ''; 
                        } catch(e) { pollHtml = `<div class="text-danger">Lỗi hiển thị bình chọn</div>`; }
                    }

                    let meetingInfo = '';
                    if (n.type === 'online' && n.location) {
                        meetingInfo = `
                            <div class="mt-2 p-2 bg-light border rounded border-primary">
                                <i class="fas fa-video text-primary mr-2"></i><strong>Họp Online:</strong> 
                                <a href="${n.location}" target="_blank" class="btn btn-sm btn-primary ml-2"><i class="fas fa-external-link-alt mr-1"></i>Tham gia ngay</a>
                            </div>`;
                    } else if (n.type === 'offline' && n.location) {
                        meetingInfo = `
                            <div class="mt-2 p-2 bg-light border rounded border-success">
                                <i class="fas fa-map-marker-alt text-success mr-2"></i><strong>Địa điểm:</strong> <span class="text-dark">${n.location}</span>
                            </div>`;
                    }

                    let attachHtml = '';
                    if (n.attachment) {
                        // Kiểm tra loại file để hiển thị icon/text phù hợp
                        let isPdf = n.attachment.indexOf('application/pdf') !== -1;
                        let btnIcon = isPdf ? 'fa-file-pdf' : 'fa-file-word';
                        let fileName = n.attachment_name || (isPdf ? 'Tai_lieu.pdf' : 'Tai_lieu.docx');
                        
                        attachHtml = `
                            <div class="mt-2">
                                <a href="${n.attachment}" download="${fileName}" class="btn btn-sm btn-outline-dark text-truncate" style="max-width: 100%;"><i class="fas ${btnIcon} mr-1"></i> ${fileName}</a>
                            </div>`;
                    }

                    html += `
                    <li class="item">
                        <div class="product-info ml-2 mr-2">
                            <span class="product-title font-weight-bold text-primary">${n.title}
                                ${btnHtml}
                                <span class="badge badge-warning float-right ml-2">${n.datetime}</span>
                            </span>
                            <span class="product-description" style="white-space: pre-line; display: ${n.content ? 'block' : 'none'}">
                                ${n.content}
                            </span>
                            ${pollHtml}
                            ${attachHtml}
                            ${meetingInfo}
                            ${n.early === 'TRUE' ? '<span class="badge badge-success mt-1">Điểm danh sớm</span>' : ''}
                        </div>
                    </li>`;
                });
            }
            notiList.html(html);
            $('#notiBadge').text(unreadCount > 0 ? unreadCount : '');
            checkAttendanceLock(); // Kiểm tra khóa sau khi có dữ liệu thông báo
        }
    } catch (e) {
        console.error(e);
        notiList.html(`<li class="item">${errorAlert('Lỗi tải thông báo.')}</li>`);
    }
}

// --- HÀM KIỂM TRA KHÓA ĐIỂM DANH ---
function checkAttendanceLock() {
    const now = new Date();
    const currentHour = now.getHours();
    const submitBtn = document.querySelector('button[onclick="submitAttendance()"]');
    const inputs = document.querySelectorAll('input[name^="st_"]');
    
    // Xóa thông báo cũ nếu có
    $('.attendance-alert').remove();

    let isLocked = false;
    let message = "";

    // 1. Khóa nếu sau 20:00 (8h tối)
    if (currentHour >= 20) {
        isLocked = true;
        message = "Đã quá thời gian điểm danh trong ngày (Sau 20:00).";
    } else {
        // 2. Khóa nếu có lịch họp hôm nay mà chưa đến giờ (và không cho điểm danh sớm)
        // Format ngày hiện tại yyyy-MM-dd để so sánh
        const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        
        // Tìm thông báo có ngày trùng hôm nay
        const todayNoti = globalNotifications.find(n => n.datetime.startsWith(todayStr));
        
        if (todayNoti) {
            const meetingTime = new Date(todayNoti.datetime.replace(" ", "T")); // Chuyển đổi format cho Safari/Mobile
            const isEarlyAllowed = todayNoti.early === 'TRUE';
            
            if (now < meetingTime && !isEarlyAllowed) {
                isLocked = true;
                message = `Chưa đến giờ điểm danh (${todayNoti.datetime.split(' ')[1]}). Không cho phép điểm danh sớm.`;
            }
        }
    }

    if (isLocked) {
        if(submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<i class="fas fa-lock mr-2"></i> ${message}`;
            submitBtn.classList.remove('btn-success');
            submitBtn.classList.add('btn-secondary');
        }
        inputs.forEach(inp => inp.disabled = true);
        $('#attendanceList').prepend(`<div class="col-12 attendance-alert"><div class="alert alert-warning font-weight-bold"><i class="fas fa-exclamation-triangle mr-2"></i>${message}</div></div>`);
    } else {
        // Mở khóa nếu hợp lệ
        if(submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class="fas fa-paper-plane mr-2"></i><b>LƯU KẾT QUẢ ĐIỂM DANH</b>`;
            submitBtn.classList.add('btn-success');
            submitBtn.classList.remove('btn-secondary');
        }
        inputs.forEach(inp => inp.disabled = false);
    }
}

async function markRead(id) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "MARK_READ", payload: { username: user.username, notification_id: id } }) });
        const res = await response.json();
        if (res.status === 'success') {
            loadNotifications(); // Tải lại để cập nhật trạng thái
        }
    } catch (e) { console.error(e); }
}

// CRUD FUNCTIONS
function openStudentModal() {
    // Check Lock
    const conf = JSON.parse(sessionStorage.getItem('globalConfig') || '{}');
    if (String(conf.student_import_locked).toUpperCase() === 'TRUE') {
        return Swal.fire('Đã khóa', 'Chức năng thêm học sinh đang bị khóa bởi Admin.', 'warning');
    }
    if (conf.student_import_deadline) {
        const deadline = new Date(conf.student_import_deadline);
        deadline.setHours(23,59,59);
        if (new Date() > deadline) {
            return Swal.fire('Hết hạn', 'Đã quá hạn thêm học sinh mới.', 'warning');
        }
    }

    $('#modalStudent').modal('show');
    $('#student_id_old').val('');
    $('#st_id').prop('readonly', false).val('');
    $('#st_name, #st_dob, #st_class, #st_address, #st_phone, #st_school, #st_reg_time, #st_reg_loc, #st_reg_act').val('');
    
    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#st_group_select').val(user.group_id);
}

function editStudent(index) {
    const s = globalGroupStudents[index];
    $('#student_id_old').val(s.id);
    $('#st_id').val(s.id).prop('readonly', true);
    $('#st_name').val(s.fullname);
    $('#st_dob').val(s.dob);
    $('#st_class').val(s.class_name);
    $('#st_address').val(s.address);
    $('#st_phone').val(s.phone);
    $('#st_school').val(s.school);
    $('#st_reg_time').val(s.reg_time);
    $('#st_reg_loc').val(s.reg_loc);
    $('#st_reg_act').val(s.reg_act);
    
    const user = JSON.parse(sessionStorage.getItem('user'));
    $('#st_group_select').val(user.group_id);
    $('#modalStudent').modal('show');
}

async function saveStudent() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const idOld = $('#student_id_old').val();
    const action = idOld ? 'UPDATE_DATA' : 'ADD_DATA';
    const selectedGroup = $('#st_group_select').val();
    
    if (!selectedGroup) return toastr.warning("Vui lòng chọn nhóm!");
    
    const dataArr = [
        $('#st_id').val(), 
        $('#st_name').val(), 
        $('#st_dob').val(), 
        $('#st_class').val(),
        $('#st_school').val(),
        $('#st_address').val(), 
        $('#st_phone').val(), 
        selectedGroup, 
        $('#st_reg_time').val(),
        $('#st_reg_loc').val(),
        $('#st_reg_act').val()
    ];

    Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: action, payload: { type: 'students', id: idOld, data: dataArr } }) });
        const res = await response.json();
        if (res.status === 'success') {
            $('#modalStudent').modal('hide');
            if (String(selectedGroup) !== String(user.group_id)) {
                Swal.fire('Đã chuyển nhóm!', 'Học sinh đã được chuyển sang nhóm mới.', 'success');
            } else {
                Swal.fire('Thành công!', res.message, 'success');
            }
            fetchStudentsByGroup(user.group_id);
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối Server', 'error'); }
}

function deleteStudent(id) {
    Swal.fire({ title: 'Xóa học sinh?', text: "Hành động này không thể hoàn tác!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Xóa' }).then(async (result) => {
        if (result.isConfirmed) {
            const user = JSON.parse(sessionStorage.getItem('user'));
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: 'students', id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { Swal.fire('Đã xóa!', res.message, 'success'); fetchStudentsByGroup(user.group_id); }
            } catch (e) { toastr.error("Lỗi xóa dữ liệu"); }
        }
    });
}

// Giữ nguyên hàm submitAttendance...
async function submitAttendance() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const attendanceData = [];
    const inputs = document.querySelectorAll('input[type="radio"]:checked');
    inputs.forEach(input => {
        const sId = input.name.replace('st_', '');
        const status = input.value;
        let reason = '';
        if (status === 'absent_perm') {
            reason = $(`#reason_${sId}`).val().trim();
        }
        attendanceData.push({ student_id: sId, status: status, reason: reason });
    });
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
                action: "SAVE_ATTENDANCE",
                payload: { group_id: user.group_id, recorded_by: user.fullname, attendance: attendanceData }
            })
        });
        const res = await response.json();
        if (res.status === "success") toastr.success('Lưu thành công!');
    } catch (error) { toastr.error("Lỗi lưu dữ liệu."); }
}

// XUẤT EXCEL (Dữ liệu đã được định dạng dd/mm/yyyy trong bảng HTML)
function exportExcel() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const groupName = user.group_name || user.group_id;
    const table = document.getElementById("excelTable");
    
    // Tạo workbook từ table (Nó sẽ lấy đúng nội dung dd/mm/yyyy hiển thị trên bảng)
    const wb = XLSX.utils.table_to_book(table, {sheet: "Danh sách"});
    
    XLSX.writeFile(wb, `Danh_sach_HS_${groupName.replace(/\s+/g, '_')}.xlsx`);
    toastr.info("Đang tải file Excel...");
}

// --- FEEDBACK CAPTCHA ---
function generateFbCaptcha() {
    const canvas = document.getElementById('fbCaptchaCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const chars = "0123456789";
    fbCaptchaCode = "";
    for (let i = 0; i < 4; i++) fbCaptchaCode += chars[Math.floor(Math.random() * chars.length)];
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#f4f6f9";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.font = "bold 24px Arial";
    ctx.fillStyle = "#333";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(fbCaptchaCode, canvas.width/2, canvas.height/2);
}
$('#fbCaptchaCanvas').click(generateFbCaptcha);

async function sendFeedback() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const title = $('#fb_title').val().trim();
    const phone = $('#fb_phone').val().trim();
    const difficulty = $('#fb_difficulty').val().trim();
    const suggestion = $('#fb_suggestion').val().trim();
    const driveLink = $('#fb_drive_link').val().trim();
    const captchaIn = $('#fb_captcha_input').val().trim();
    const fileInput = document.getElementById('fb_file');

    if (!title || !phone) {
        return toastr.warning("Vui lòng nhập tiêu đề và số điện thoại!");
    }
    if (!difficulty && !suggestion) {
        return toastr.warning("Vui lòng nhập nội dung phản ánh hoặc kiến nghị!");
    }
    if (captchaIn !== fbCaptchaCode) {
        toastr.error("Mã xác nhận không đúng!");
        generateFbCaptcha();
        return;
    }

    const payload = {
        username: user.username,
        fullname: user.fullname,
        phone: phone,
        group_id: user.group_id,
        title: title,
        difficulty: difficulty,
        suggestion: suggestion,
        drive_link: driveLink
    };

    const send = async (finalPayload) => {
        Swal.fire({ title: 'Đang gửi...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SEND_FEEDBACK", payload: finalPayload }) });
            const res = await response.json();
            if (res.status === 'success') {
                Swal.fire('Thành công!', 'Đã gửi yêu cầu/file.', 'success');
                $('#fb_title, #fb_difficulty, #fb_suggestion, #fb_drive_link, #fb_file, #fb_captcha_input').val('');
                generateFbCaptcha();
                loadFeedbackHistory();
            } else Swal.fire('Lỗi', res.message, 'error');
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    };

    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        const maxFileSize = 20 * 1024 * 1024; // 20MB

        if (!allowedTypes.includes(file.type)) {
            return toastr.error("Loại file không được hỗ trợ! Chỉ chấp nhận file ảnh, PDF, DOC, DOCX.");
        }

        if (file.size > maxFileSize) {
            return toastr.warning("File quá lớn! Vui lòng chọn file dưới 20MB.");
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            payload.attachment = e.target.result;
            payload.attachment_name = file.name;
            send(payload);
        };
        reader.readAsDataURL(file);
    } else {
        send(payload);
    }
}

async function loadFeedbackHistory() {
    const feedbackList = $('#feedbackHistoryList');
    feedbackList.html(loadingSpinner);
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: "GET_FEEDBACKS", payload: { username: user.username } })
        });
        const res = await response.json();
        if (res.status === 'success') {
            let html = '';
            if (res.data.length === 0) {
                html = '<div class="text-center text-muted p-5"><i class="fas fa-inbox fa-3x mb-3"></i><br>Bạn chưa gửi phản ánh nào.</div>';
            } else {
                res.data.forEach(fb => {
                    let statusBadge = fb.status === 'replied' 
                        ? '<span class="badge badge-success float-right"><i class="fas fa-check mr-1"></i>Đã trả lời</span>' 
                        : '<span class="badge badge-warning float-right"><i class="fas fa-clock mr-1"></i>Đang chờ xử lý</span>';
                    
                    let replySection = '';
                    if (fb.reply) {
                        replySection = `
                            <div class="callout callout-success mt-3 mb-0" style="background-color: #f0fff4; border-left: 5px solid #28a745;">
                                <h6 class="text-success font-weight-bold"><i class="fas fa-user-shield mr-1"></i> Phản hồi từ Admin:</h6>
                                <div class="text-dark" style="font-size: 0.95rem;">${fb.reply}</div>
                            </div>`;
                    }

                    html += `
                        <div class="card shadow-sm mb-3 border-0">
                            <div class="card-header bg-white border-bottom-0 pb-0">
                                <h5 class="card-title text-primary font-weight-bold">${fb.title}</h5>
                                ${statusBadge}
                            </div>
                            <div class="card-body pt-2">
                                <small class="text-muted d-block mb-2"><i class="far fa-clock mr-1"></i> Gửi lúc: ${fb.timestamp}</small>
                                ${fb.difficulty ? `<div class="mb-1"><strong><i class="fas fa-exclamation-circle text-danger mr-1"></i>Nội dung:</strong> ${fb.difficulty}</div>` : ''}
                                ${fb.suggestion ? `<div class="mb-1"><strong><i class="fas fa-lightbulb text-warning mr-1"></i>Kiến nghị:</strong> ${fb.suggestion}</div>` : ''}
                                ${fb.drive_link ? `<div class="mb-1"><a href="${fb.drive_link}" target="_blank" class="text-info"><i class="fab fa-google-drive mr-1"></i>Link Drive</a></div>` : ''}
                                ${fb.attachment ? `<div class="mb-1"><a href="${fb.attachment}" download="${fb.attachment_name || 'file'}" class="text-secondary"><i class="fas fa-paperclip mr-1"></i>File: ${fb.attachment_name}</a></div>` : ''}
                                ${replySection}
                            </div>
                        </div>`;
                });
            }
            feedbackList.html(html);
        }
    } catch (e) { 
        console.error(e); 
        feedbackList.html(errorAlert());
    }
}

// --- LOGIC ĐÁNH GIÁ HỌC SINH ---
let globalEvaluations = [];

async function loadEvaluationUI() {
    $('#evaluationList').html(getLoadingRowHtml(3));
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        // 1. Lấy cấu hình và danh sách đánh giá song song
        const [configRes, evalRes] = await Promise.all([
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_CONFIG" }) }).then(r => r.json()),
            fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_EVALUATIONS" }) }).then(r => r.json())
        ]);

        // 2. Kiểm tra trạng thái khóa
        const config = configRes.data || {};
        const isEnabled = String(config.evaluation_enabled).toUpperCase() === 'TRUE';
        let isLocked = !isEnabled;
        let lockMessage = "Hệ thống đánh giá hiện đang đóng.";

        if (isEnabled && config.evaluation_deadline) {
            const deadline = new Date(config.evaluation_deadline);
            deadline.setHours(23, 59, 59, 999); // Hết ngày
            if (new Date() > deadline) {
                isLocked = true;
                lockMessage = `Đã quá hạn đánh giá (${formatDate(config.evaluation_deadline)}).`;
            }
        }

        if (isLocked) {
            $('#evalAlertContainer').html(`<div class="alert alert-danger mb-0"><i class="fas fa-lock mr-2"></i>${lockMessage} Vui lòng liên hệ Admin nếu cần hỗ trợ.</div>`);
        } else {
            $('#evalAlertContainer').empty();
        }

        if (evalRes.status === 'success') {
            globalEvaluations = evalRes.data; 
        }

        // 2. Render danh sách học sinh kèm trạng thái đánh giá
        let html = '';
        if (globalGroupStudents.length === 0) {
            html = '<tr><td colspan="3" class="text-center">Chưa có học sinh trong nhóm.</td></tr>';
        } else {
            globalGroupStudents.forEach(st => {
                // Tìm đánh giá của học sinh này (cột 0 là StudentID)
                const evalData = globalEvaluations.find(e => String(e[0]) === String(st.id));
                const classification = evalData ? evalData[6] : '<span class="text-muted font-italic">Chưa đánh giá</span>';
                const btnClass = evalData ? 'btn-outline-primary' : 'btn-primary';
                const btnText = evalData ? '<i class="fas fa-edit"></i> Sửa' : '<i class="fas fa-star"></i> Đánh giá';
                const disabledAttr = isLocked ? 'disabled' : '';
                
                html += `<tr>
                    <td class="align-middle font-weight-bold">${st.fullname}</td>
                    <td class="align-middle">${classification}</td>
                    <td class="text-center">
                        <button class="btn btn-sm ${btnClass}" onclick="openEvaluateModal('${st.id}', '${st.fullname}')" ${disabledAttr}>${btnText}</button>
                    </td>
                </tr>`;
            });
        }
        $('#evaluationList').html(html);
    } catch (e) { 
        console.error("Lỗi tải đánh giá", e); 
        $('#evaluationList').html(getErrorRowHtml(3));
    }
}

// --- TROLL PUSH LOGIC ---
async function checkUrgentNotification() {
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_CONFIG" }) });
        const res = await response.json();
        if (res.status === "success") {
            const conf = res.data;
            if (String(conf.troll_enabled).toUpperCase() === 'TRUE') {
                // Check Mode: Phone Notification vs Popup
                if (String(conf.troll_mode).toUpperCase() === 'TRUE') {
                    $('#pn-title').text(conf.troll_title || 'Thông báo');
                    $('#pn-body').html(conf.troll_content || '');
                    if (conf.troll_image) { $('#pn-img').attr('src', conf.troll_image).show(); } else { $('#pn-img').hide(); }
                    
                    // Link download file trong banner
                    if (conf.troll_image && conf.troll_file_name) { $('#pn-link').html(`<a href="${conf.troll_image}" download="${conf.troll_file_name}" class="btn btn-xs btn-light text-dark font-weight-bold"><i class="fas fa-download mr-1"></i>Tải: ${conf.troll_file_name}</a>`); } else { $('#pn-link').empty(); }

                    $('#phone-notification').addClass('show');
                    if (!conf.troll_youtube) setTimeout(closePhoneNotification, 10000); // Auto hide if no video
                    return;
                }

                let htmlContent = `<div style="text-align: left; white-space: pre-wrap;">${conf.troll_content || ''}</div>`;
                
                // Xử lý YouTube
                if (conf.troll_youtube) {
                    let videoId = conf.troll_youtube.split('v=')[1];
                    const ampersandPosition = videoId ? videoId.indexOf('&') : -1;
                    if (videoId && ampersandPosition > -1) {
                        videoId = videoId.substring(0, ampersandPosition);
                    }
                    // Nếu là link short youtu.be
                    if (!videoId && conf.troll_youtube.indexOf('youtu.be/') !== -1) {
                        videoId = conf.troll_youtube.split('youtu.be/')[1];
                    }
                    
                    if (videoId) {
                        htmlContent += `<div class="embed-responsive embed-responsive-16by9 mt-2 mb-2"><iframe class="embed-responsive-item" src="https://www.youtube.com/embed/${videoId}?autoplay=1" allowfullscreen></iframe></div>`;
                    }
                }

                // File đính kèm trong Popup
                let footerHtml = '';
                if (conf.troll_image && conf.troll_file_name) {
                    footerHtml = `<a href="${conf.troll_image}" download="${conf.troll_file_name}" class="btn btn-success"><i class="fas fa-download mr-2"></i>Tải file đính kèm: ${conf.troll_file_name}</a>`;
                }

                Swal.fire({
                    icon: 'warning',
                    title: conf.troll_title || 'THÔNG BÁO KHẨN',
                    html: htmlContent,
                    footer: footerHtml,
                    imageUrl: conf.troll_image || null,
                    imageWidth: 400,
                    imageAlt: 'Image',
                    confirmButtonText: 'Đã hiểu',
                    allowOutsideClick: false
                });
            }
        }
    } catch (e) { console.error("Urgent notification check error", e); }
}

function closePhoneNotification() {
    $('#phone-notification').removeClass('show');
}

function openEvaluateModal(id, name) {
    $('#eval_st_id').val(id);
    $('#eval_st_name').val(name);
    $('#eval_st_display_name').text(name);
    
    // Reset form
    $('#eval_discipline, #eval_positivity, #eval_volunteering, #eval_classification').val('');
    
    // Fill data nếu đã có
    const evalData = globalEvaluations.find(e => String(e[0]) === String(id));
    if (evalData) {
        $('#eval_discipline').val(evalData[3]);
        $('#eval_positivity').val(evalData[4]);
        $('#eval_volunteering').val(evalData[5]);
        $('#eval_classification').val(evalData[6]);
    }
    
    $('#modalEvaluate').modal('show');
}

async function submitEvaluation() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const payload = {
        student_id: $('#eval_st_id').val(),
        student_name: $('#eval_st_name').val(),
        group_id: user.group_id,
        discipline: $('#eval_discipline').val(),
        positivity: $('#eval_positivity').val(),
        volunteering: $('#eval_volunteering').val(),
        classification: $('#eval_classification').val(),
        updated_by: user.fullname
    };

    if (!payload.classification) return toastr.warning("Vui lòng chọn mức xếp loại!");

    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_EVALUATION", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu phiếu đánh giá!', 'success');
            $('#modalEvaluate').modal('hide');
            loadEvaluationUI(); // Reload lại bảng
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- FUND MANAGEMENT FUNCTIONS ---
function loadFundTab() {
    const list = document.getElementById('fundStudentList');
    if (globalGroupStudents.length === 0) {
        list.innerHTML = '<tr><td colspan="3" class="text-center">Chưa có học sinh</td></tr>';
        return;
    }
    
    let html = '';
    globalGroupStudents.forEach((st, idx) => {
        html += `
        <tr class="fund-row">
            <td>${idx + 1}</td>
            <td class="font-weight-bold student-name">${st.fullname}</td>
            <td class="text-center">

                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input fund-check" id="fund_chk_${idx}" data-name="${st.fullname}" onchange="calculateFund()">
                    <label class="custom-control-label" for="fund_chk_${idx}">Đã đóng</label>
                </div>
            </td>
        </tr>`;
    });

    list.innerHTML = html;
    calculateFund();
    loadFundHistory();
}

function calculateFund() {
    const amount = parseInt($('#fund_amount').val()) || 0;
    const checkedCount = $('.fund-check:checked').length;
    const total = amount * checkedCount;
    
    $('#fund_count').text(checkedCount);
    $('#fund_total').text(total.toLocaleString('vi-VN') + ' đ');
}

function filterFundList() {
    const term = $('#fund_search').val().toLowerCase();
    $('.fund-row').each(function() {
        const name = $(this).find('.student-name').text().toLowerCase();
        $(this).toggle(name.indexOf(term) > -1);
    });
}

function resetFundCheckboxes() {
    $('.fund-check').prop('checked', false);
    calculateFund();
    toastr.info("Đã reset trạng thái đóng tiền (Chưa lưu).");
}

async function saveFundLog() {
    const user = JSON.parse(sessionStorage.getItem('user'));

    const amountPerHead = parseInt($('#fund_amount').val()) || 0;
    const checkedBoxes = $('.fund-check:checked');
    
    if (checkedBoxes.length === 0) return toastr.warning("Chưa có ai đóng tiền!");

    const paidList = [];
    checkedBoxes.each(function() {

        paidList.push($(this).data('name'));
    });

    const payload = {
        group_id: user.group_id,
        manager: user.fullname,

        amount_per_head: amountPerHead,
        total_collected: amountPerHead * checkedBoxes.length,
        paid_students: paidList.join(', '),
        notes: $('#fund_notes').val(),
        timestamp: new Date().toLocaleString('vi-VN')
    };

    Swal.fire({ title: 'Đang lưu sổ quỹ...', didOpen: () => Swal.showLoading() });
    try {

        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_FUND_LOG", payload: payload }) });

        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu vào lịch sử quỹ!', 'success');
            loadFundHistory();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function saveExpenseLog() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const reason = $('#expense_reason').val();
    const amount = $('#expense_amount').val();
    const notes = $('#expense_notes').val();

    if (!reason || !amount) return toastr.warning("Vui lòng nhập lý do và số tiền!");

    const payload = {
        group_id: user.group_id,
        manager: user.fullname,
        reason: reason,
        amount: amount,
        notes: notes
    };

    Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "SAVE_EXPENSE_LOG", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã lưu khoản chi!', 'success');
            $('#modalChiQuy').modal('hide');
            $('#expense_reason, #expense_amount, #expense_notes').val('');
            loadFundHistory();
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function loadFundHistory() {
    const historyTable = $('#fundHistoryData');
    historyTable.html(getLoadingRowHtml(3));
    const user = JSON.parse(sessionStorage.getItem('user'));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_FUND_LOGS", payload: { group_id: user.group_id } }) });
        const res = await response.json();
        if (res.status === 'success') {
            globalFundLogs = res.data; // Lưu dữ liệu để xuất Excel
            let html = '';
            res.data.forEach(log => {
                const isThu = log.type === 'THU';
                const colorClass = isThu ? 'text-success' : 'text-danger';
                const sign = isThu ? '+' : '-';
                const desc = isThu ? (log.paid_list ? `Thu: ${log.paid_list.split(',').length} người` : 'Thu quỹ') : log.reason;
                const detailBtn = isThu ? `<button class="btn btn-xs btn-outline-info ml-1" onclick="Swal.fire('Danh sách đóng', '${log.paid_list}', 'info')"><i class="fas fa-list"></i></button>` : '';
                
                html += `<tr>
                    <td><small>${log.timestamp}</small></td>
                    <td class="${colorClass} font-weight-bold">${sign}${parseInt(log.amount).toLocaleString()}đ</td>
                    <td>
                        <span class="d-block text-truncate" style="max-width: 120px;" title="${desc} ${log.details}">${desc}</span>
                        ${detailBtn}
                    </td>
                </tr>`;
            });
            historyTable.html(html || '<tr><td colspan="3" class="text-center text-muted">Chưa có lịch sử</td></tr>');
        }
    } catch (e) { 
        console.error(e); 
        historyTable.html(getErrorRowHtml(3));
    }
}

function exportFundHistoryExcel() {
    if (globalFundLogs.length === 0) return toastr.warning("Chưa có lịch sử để xuất!");
    const user = JSON.parse(sessionStorage.getItem('user'));
    
    const data = globalFundLogs.map(log => ({
        "Thời gian": log.timestamp,
        "Loại": log.type,
        "Số tiền": parseInt(log.amount),
        "Người thực hiện": log.manager,
        "Lý do / Chi tiết": log.type === 'THU' ? log.details : log.reason,
        "Ghi chú": log.type === 'THU' ? log.paid_list : log.notes
    }));
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Quy_Nhom");
    XLSX.writeFile(wb, `So_Quy_Nhom_${user.group_id}.xlsx`);
}

function downloadTemplateIndex() {
    const user = JSON.parse(sessionStorage.getItem('user'));
    const data = [{ "Họ và Tên": "Nguyễn Văn A", "Ngày sinh": "20/10/2010", "Trường học": "THCS A", "SĐT": "0909123456", "Địa chỉ": "123 Đường ABC" }];
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
    XLSX.writeFile(wb, `Mau_DS_Nhom_${user.group_id}.xlsx`);
}

async function uploadFileIndex() {
    const fileInput = document.getElementById('file_upload_index');
    const file = fileInput.files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");
    
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        // Show Drive Link if file is too big
        let msg = `File quá lớn (> ${globalMaxUploadSize}MB)!`;
        if (globalDriveLink) {
            msg += `<br>Vui lòng tải lên qua Google Drive: <a href="${globalDriveLink}" target="_blank" class="font-weight-bold">Tại đây</a>`;
            $('#upload_blocked_msg').removeClass('d-none');
            $('#upload_drive_link_display').html(`File của bạn quá lớn. Vui lòng gửi qua: <a href="${globalDriveLink}" target="_blank" class="font-weight-bold">${globalDriveLink}</a>`);
        }
        return toastr.error(msg);
    }

    const reader = new FileReader();
    reader.onload = async function(e) {
        const base64 = e.target.result;
        const user = JSON.parse(sessionStorage.getItem('user'));
        
        Swal.fire({ title: 'Đang tải lên...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { 
                method: "POST", 
                body: JSON.stringify({ 
                    action: "UPLOAD_FILE", 
                    payload: { uploader: user.username, group_id: user.group_id, filename: file.name, size: (file.size / 1024 / 1024).toFixed(2) + ' MB', data: base64, type: 'FILE' } 
                }) 
            });
            const res = await response.json();
            if (res.status === 'success') { Swal.fire('Thành công', 'File đã được tải lên!', 'success'); fileInput.value = ''; }
            else Swal.fire('Lỗi', res.message, 'error');
        } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    };
    reader.readAsDataURL(file);
}

async function submitDriveLink() {
    const link = $('#drive_link_submission').val().trim();
    if (!link) return toastr.warning("Vui lòng nhập link!");
    
    const user = JSON.parse(sessionStorage.getItem('user'));
    Swal.fire({ title: 'Đang gửi link...', didOpen: () => Swal.showLoading() });
    
    try {
        const response = await fetch(API_URL, { 
            method: "POST", 
            body: JSON.stringify({ 
                action: "UPLOAD_FILE", 
                payload: { uploader: user.username, group_id: user.group_id, filename: "Google Drive Link", size: "Link", data: link, type: 'LINK' } 
            }) 
        });
        const res = await response.json();
        if (res.status === 'success') { 
            Swal.fire('Thành công', 'Đã gửi link cho Admin!', 'success'); 
            $('#drive_link_submission').val(''); 
        } else Swal.fire('Lỗi', res.message, 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

function processImportManagerTab() {
    // Check Lock
    const conf = JSON.parse(sessionStorage.getItem('globalConfig') || '{}');
    if (String(conf.student_import_locked).toUpperCase() === 'TRUE') {
        return Swal.fire('Đã khóa', 'Chức năng nhập học sinh đang bị khóa bởi Admin.', 'warning');
    }
    if (conf.student_import_deadline) {
        const deadline = new Date(conf.student_import_deadline);
        deadline.setHours(23,59,59);
        if (new Date() > deadline) {
            return Swal.fire('Hết hạn', 'Đã quá hạn nhập học sinh mới.', 'warning');
        }
    }

    const user = JSON.parse(sessionStorage.getItem('user'));
    const file = document.getElementById('file_import').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!"); 
    
    if (file.size > globalMaxUploadSize * 1024 * 1024) {
        return toastr.warning(`File quá lớn! Giới hạn cho phép là ${globalMaxUploadSize}MB.`);
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        
        const mappedData = jsonData.map(row => ({ fullname: row["Họ và Tên"], dob: row["Ngày sinh"], group_id: user.group_id, school: row["Trường học"], phone: row["SĐT"], address: row["Địa chỉ"] })).filter(i => i.fullname);
        
        Swal.fire({ title: 'Đang tải lên...', didOpen: () => Swal.showLoading() });
        fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "IMPORT_STUDENTS", payload: { students: mappedData } }) })
        .then(r => r.json()).then(res => { if(res.status==='success'){ Swal.fire('Xong', `Thêm ${res.count} HS`, 'success'); fetchStudentsByGroup(user.group_id); } else Swal.fire('Lỗi', res.message, 'error'); });
    };
    reader.readAsArrayBuffer(file);
}

function openImportModal(context) {
    // Check Lock
    const conf = JSON.parse(sessionStorage.getItem('globalConfig') || '{}');
    if (String(conf.student_import_locked).toUpperCase() === 'TRUE') {
        return Swal.fire('Đã khóa', 'Chức năng nhập học sinh đang bị khóa bởi Admin.', 'warning');
    }
    $('#modalImport').modal('show');
}

async function submitVote(pollId) {
    const user = JSON.parse(sessionStorage.getItem('user'));
    
    // Lấy danh sách học sinh được chọn
    const selectedStudents = [];
    $(`.poll-student-check-${pollId}:checked`).each(function() {
        selectedStudents.push($(this).val());
    });

    const option = $(`input[name='poll_opt_${pollId}']:checked`).val();

    if (selectedStudents.length === 0) return toastr.warning("Vui lòng chọn ít nhất 1 học sinh!");
    if (!option) return toastr.warning("Vui lòng chọn một phương án!");

    const payload = {
        poll_id: pollId,
        manager: user.fullname,
        group_id: user.group_id,
        students: selectedStudents,
        option: option
    };

    Swal.fire({ title: 'Đang gửi bình chọn...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "VOTE_POLL", payload: payload }) });
        const res = await response.json();
        if (res.status === 'success') {
            Swal.fire('Thành công', res.message, 'success');
        } else {
            Swal.fire('Lỗi', res.message, 'error');
        }
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

async function viewPollResults(pollId) {
    Swal.fire({ title: 'Đang tải kết quả...', didOpen: () => Swal.showLoading() });
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_POLL_RESULTS", payload: { poll_id: pollId } }) });
        const res = await response.json();
        if (res.status === 'success') {
            const counts = res.data;
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let html = `<div class="text-left">`;
            for (const [opt, count] of Object.entries(counts)) {
                const percent = total === 0 ? 0 : Math.round((count / total) * 100);
                html += `<div class="mb-2"><div class="d-flex justify-content-between small"><span>${opt}</span><span>${count} phiếu (${percent}%)</span></div><div class="progress" style="height: 10px;"><div class="progress-bar bg-success" style="width: ${percent}%"></div></div></div>`;
            }
            html += `</div>`;
            Swal.fire({ title: `Kết quả (${total} phiếu)`, html: html });
        } else Swal.fire('Lỗi', 'Không thể tải kết quả', 'error');
    } catch (e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
}

// --- ATTENDANCE IMPORT ---
function openImportAttendanceModal() {
    $('#modalImportAttendance').modal('show');
}

function downloadAttendanceTemplate() {
    if (globalGroupStudents.length === 0) return toastr.warning("Chưa có học sinh để tạo mẫu!");
    const data = globalGroupStudents.map(s => ({
        "ID": s.id,
        "Họ và Tên": s.fullname,
        "Trạng thái (C/P/K)": "",
        "Lý do (Nếu có)": ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DiemDanh");
    XLSX.writeFile(wb, `Mau_Diem_Danh_${new Date().toLocaleDateString('vi-VN').replace(/\//g,'-')}.xlsx`);
}

function processAttendanceImport() {
    const file = document.getElementById('file_att_import').files[0];
    if (!file) return toastr.warning("Vui lòng chọn file!");

    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        let count = 0;
        jsonData.forEach(row => {
            const id = row["ID"];
            const statusChar = (row["Trạng thái (C/P/K)"] || "").toUpperCase().trim();
            const reason = row["Lý do (Nếu có)"] || "";

            if (id) {
                let statusVal = 'absent'; // Default K
                if (statusChar === 'C' || statusChar === 'CÓ' || statusChar === 'X') statusVal = 'present';
                else if (statusChar === 'P') statusVal = 'absent_perm';
                
                // Update UI
                $(`input[name="st_${id}"][value="${statusVal}"]`).prop('checked', true);
                if (statusVal === 'absent_perm') {
                    $(`#reason_box_${id}`).removeClass('d-none');
                    $(`#reason_${id}`).val(reason);
                } else {
                    $(`#reason_box_${id}`).addClass('d-none');
                }
                count++;
            }
        });
        $('#modalImportAttendance').modal('hide');
        toastr.success(`Đã cập nhật trạng thái cho ${count} học sinh. Nhấn Lưu để hoàn tất.`);
    };
    reader.readAsArrayBuffer(file);
}

// --- RESOURCE MANAGER ---
async function loadResources() {
    $('#resource_list').html(loadingSpinner);
    try {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_UPLOADS" }) });
        const res = await response.json();
        if (res.status === 'success') {
            // Filter ADMIN uploads AND User's Group uploads
            globalResources = res.data.filter(f => f.group_id === 'ADMIN' || String(f.group_id) === String(user.group_id));
            filterResources('all');
        }
    } catch (e) { console.error(e); }
}

function filterResources(type) {
    $('.nav-link').removeClass('active');
    $(`#filter-${type}`).addClass('active');
    
    let filtered = globalResources;
    if (type === 'docs') filtered = globalResources.filter(f => f.filename.match(/\.(doc|docx|pdf|xls|xlsx|ppt|pptx|txt)$/i));
    if (type === 'media') filtered = globalResources.filter(f => f.filename.match(/\.(mp3|mp4|jpg|jpeg|png|gif|wav)$/i));
    
    renderResources(filtered);
}

function renderResources(list) {
    let html = '';
    const user = JSON.parse(sessionStorage.getItem('user'));
    if (list.length === 0) html = '<div class="col-12 text-center text-muted mt-5">Không có tệp tin nào.</div>';
    
    list.forEach(f => {
        let icon = 'fa-file';
        let color = 'text-secondary';
        if (f.filename.match(/\.pdf$/i)) { icon = 'fa-file-pdf'; color = 'text-danger'; }
        else if (f.filename.match(/\.(doc|docx)$/i)) { icon = 'fa-file-word'; color = 'text-primary'; }
        else if (f.filename.match(/\.(xls|xlsx)$/i)) { icon = 'fa-file-excel'; color = 'text-success'; }
        else if (f.filename.match(/\.(jpg|png|gif)$/i)) { icon = 'fa-image'; color = 'text-purple'; }
        else if (f.filename.match(/\.(mp3|wav)$/i)) { icon = 'fa-music'; color = 'text-warning'; }
        else if (f.filename.match(/\.(mp4|avi)$/i)) { icon = 'fa-video'; color = 'text-danger'; }

        // Allow delete if uploader is current user
        const deleteBtn = (f.uploader === user.username) ? `<button class="btn btn-xs btn-danger ml-1" onclick="deleteResource('${f.id}')"><i class="fas fa-trash"></i></button>` : '';

        html += `
        <div class="col-6 col-md-4 col-lg-3 mb-3">
            <div class="card h-100 shadow-sm resource-card">
                <div class="card-body text-center p-2">
                    <i class="fas ${icon} fa-3x ${color} mb-2"></i>
                    <h6 class="text-truncate" title="${f.filename}">${f.filename}</h6>
                    <small class="text-muted">${f.size}</small>
                </div>
                <div class="card-footer bg-white p-1 text-center">
                    <button class="btn btn-xs btn-primary" onclick="previewResource('${f.data}', '${f.filename}')"><i class="fas fa-eye"></i> Xem</button>
                    <a href="${f.data}" download="${f.filename}" class="btn btn-xs btn-success"><i class="fas fa-download"></i> Tải</a>
                    ${deleteBtn}
                </div>
            </div>
        </div>`;
    });
    $('#resource_list').html(html);
}

function searchResources() {
    const term = $('#resource_search').val().toLowerCase();
    const filtered = globalResources.filter(f => f.filename.toLowerCase().includes(term));
    renderResources(filtered);
}

function previewResource(url, filename) {
    $('#previewTitle').text(filename);
    let content = '';
    if (filename.match(/\.(jpg|jpeg|png|gif)$/i)) content = `<img src="${url}" style="max-width:100%; max-height:100%;">`;
    else if (filename.match(/\.mp4$/i)) content = `<video controls style="max-width:100%; max-height:100%;"><source src="${url}" type="video/mp4"></video>`;
    else if (filename.match(/\.mp3$/i)) content = `<audio controls><source src="${url}" type="audio/mpeg"></audio>`;
    else if (filename.match(/\.pdf$/i)) content = `<iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>`;
    else content = `<div class="text-center"><p>Không hỗ trợ xem trước định dạng này.</p><a href="${url}" download="${filename}" class="btn btn-primary">Tải xuống</a></div>`;
    
    $('#previewBody').html(content);
    $('#modalPreview').modal('show');
}

function deleteResource(id) {
    Swal.fire({ title: 'Xóa file?', text: "Bạn có chắc muốn xóa file này?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Xóa' }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: 'DELETE_DATA', payload: { type: 'uploads', id: id } }) });
                const res = await response.json();
                if (res.status === 'success') { toastr.success('Đã xóa file'); loadResources(); }
            } catch (e) { toastr.error("Lỗi xóa file"); }
        }
    });
}

async function loadRegistrations() {
    $('#regListBody').html(getLoadingRowHtml(6));
    try {
        const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "GET_REGISTRATIONS" }) });
        const res = await response.json();
        if (res.status === "success") {
            let html = '';
            res.data.forEach(r => {
                html += `<tr>
                    <td><code>${r.id}</code></td>
                    <td class="font-weight-bold text-danger">${r.pass}</td>
                    <td>${r.fullname}</td>
                    <td>${r.class_name}</td>
                    <td>${r.school}</td>
                    <td><button class="btn btn-sm btn-warning" onclick="regeneratePass('${r.id}')"><i class="fas fa-sync mr-1"></i>Đổi Pass</button></td>
                </tr>`;
            });
            $('#regListBody').html(html || '<tr><td colspan="6" class="text-center">Không có đăng ký chờ duyệt.</td></tr>');
        }
    } catch (e) { $('#regListBody').html(getErrorRowHtml(6)); }
}

async function regeneratePass(id) {
    if(!confirm('Tạo lại mật khẩu ngẫu nhiên cho ID này?')) return;
    const response = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "REGENERATE_PASS", payload: { id } }) });
    const res = await response.json();
    if(res.status === 'success') { toastr.success('Mật khẩu mới: ' + res.new_pass); loadRegistrations(); }
}
</script>









</body>
</html>
