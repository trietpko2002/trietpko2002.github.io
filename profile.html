<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân | Quản lý SHH</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .profile-user-img { width: 120px; height: 120px; object-fit: cover; border: 3px solid #adb5bd; border-radius: 50%; }
        .list-group-item { background-color: transparent; }
        body.dark-mode .card { background-color: #343a40; color: white; }
        body.dark-mode .form-control { background-color: #454d55; color: white; border-color: #6c757d; }
        
        /* VIP Styles */
        .vip-frame-container { position: relative; display: inline-block; }
        .vip-crown {
            position: absolute; top: -30px; right: -15px; 
            font-size: 2.5rem; color: #ffd700; 
            transform: rotate(15deg); 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            animation: floatCrown 2s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes floatCrown { 0%, 100% { transform: rotate(15deg) translateY(0); } 50% { transform: rotate(15deg) translateY(-5px); } }
        
        .vip-border-1 { border: 4px solid #c0c0c0 !important; box-shadow: 0 0 15px #c0c0c0; }
        .vip-border-2 { border: 5px solid #ffd700 !important; box-shadow: 0 0 20px #ffd700, 0 0 10px #fff inset; animation: shineBorder 3s infinite linear; }
        @keyframes shineBorder { 0% { border-color: #ffd700; } 50% { border-color: #fff; } 100% { border-color: #ffd700; } }
        
        .vip-border-3 { border: 5px solid #00ffff !important; box-shadow: 0 0 20px #00ffff, 0 0 10px #fff inset; animation: pulseBorder 2s infinite; }
        @keyframes pulseBorder { 0% { border-color: #00ffff; box-shadow: 0 0 20px #00ffff; } 50% { border-color: #fff; box-shadow: 0 0 30px #00ffff; } 100% { border-color: #00ffff; box-shadow: 0 0 20px #00ffff; } }
        
        .vip-border-4 { border: 5px solid #e5e4e2 !important; box-shadow: 0 0 20px #e5e4e2, 0 0 10px #fff inset; animation: shineBorder 3s infinite linear; }
        .vip-border-5 { border: 5px solid #ffd700 !important; box-shadow: 0 0 25px #ffd700, 0 0 15px #fff inset; animation: pulseBorder 2s infinite; }
        
        /* VIP 10 */
        .vip-border-10 { 
            border: 4px solid #ffd700 !important; 
            box-shadow: 0 0 15px #ff4500, 0 0 30px #ffd700; 
            animation: fiery 1s infinite alternate; 
        }
        @keyframes fiery { from { box-shadow: 0 0 10px #ff4500, 0 0 20px #ffd700; border-color: #ffd700; } to { box-shadow: 0 0 20px #ff0000, 0 0 40px #ff8c00; border-color: #fff; } }
        .vip-wing { position: absolute; top: -10px; font-size: 2.5rem; color: #ff4500; filter: drop-shadow(0 2px 2px rgba(255,215,0,0.8)); z-index: 10; }
        .vip-wing-left { left: -35px; transform: rotate(-20deg); }
        .vip-wing-right { right: -35px; transform: rotate(20deg); }
        .vip-crown-10 { position: absolute; top: -45px; left: 50%; transform: translateX(-50%); font-size: 3rem; color: #ffd700; filter: drop-shadow(0 0 10px #ffd700); animation: floatCrown 2s ease-in-out infinite; z-index: 11; }
        
        .vip-diamond {
            position: absolute; top: -35px; right: -15px; 
            font-size: 2.5rem; color: #00ffff; 
            filter: drop-shadow(0 0 5px #00ffff);
            animation: floatDiamond 3s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes floatDiamond { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .honor-tag { background: linear-gradient(45deg, #ff6b6b, #f06595); color: white; padding: 3px 10px; border-radius: 15px; font-size: 0.8rem; margin: 2px; display: inline-block; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .honor-tag.gold { background: linear-gradient(45deg, #ffd700, #fdb931); color: #000; font-weight: bold; border: 1px solid #fff; box-shadow: 0 0 5px #ffd700; }
        

        /* Hacker Title Effect */
        .hacker-gold {
            background: linear-gradient(90deg, #ffd700, #fff, #ffd700);
            background-size: 200% auto;
            color: #000;
            font-weight: bold;
            border: 2px solid #ffd700;
            box-shadow: 0 0 10px #ffd700;
            animation: shineText 2s linear infinite;
            padding: 5px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            display: inline-block;
            margin: 2px;
        }
        @keyframes shineText { to { background-position: 200% center; } }/* Hacker Title Effect */

        /* Settings & Effects */
        .settings-btn { position: fixed; bottom: 20px; right: 20px; z-index: 9999; width: 50px; height: 50px; border-radius: 50%; background: #007bff; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: transform 0.3s; }
        .settings-btn:hover { transform: rotate(90deg); background: #0056b3; }
        .weather-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998; }
        .weather-snow { background-image: url('https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/ajax-loader.gif'); background-size: 500px; animation: snow 10s linear infinite; opacity: 0.5; }
        @keyframes snow { 0% { background-position: 0 0, 0 0; } 100% { background-position: 500px 1000px, 400px 400px; } }
        .weather-rain { background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 100%); background-size: 2px 20px; animation: rain 0.5s linear infinite; }
        @keyframes rain { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        .weather-sunny { background: radial-gradient(circle at 90% 10%, rgba(255,255,0,0.3) 0%, rgba(255,255,0,0) 50%); mix-blend-mode: screen; animation: sunny 5s ease-in-out infinite alternate; }
        @keyframes sunny { 0% { opacity: 0.5; transform: scale(1); } 100% { opacity: 0.8; transform: scale(1.1); } }
        .weather-dandelion { background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Dandelion_seed.png/640px-Dandelion_seed.png'); background-size: 50px; animation: dandelion 15s linear infinite; pointer-events: none; opacity: 0.6; }
        @keyframes dandelion { 0% { background-position: 0% 100%; } 100% { background-position: 100% 0%; } }
        .weather-starry { background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); overflow: hidden; }
        .star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; animation: twinkle 2s infinite; }
        @keyframes twinkle { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .firefly { position: fixed; width: 6px; height: 6px; background: #ffff00; border-radius: 50%; box-shadow: 0 0 10px #ffff00, 0 0 20px #ffff00; animation: fly 10s infinite alternate; pointer-events: none; z-index: 9998; }
        @keyframes fly { 0% { transform: translate(0, 0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translate(100vw, -50vh); opacity: 0; } }
        
        body.jack-mode { background-color: #000 !important; color: #fff !important; }

        /* Modern Rounded UI Overrides */
        .card { border-radius: 20px; border: none; box-shadow: 0 0 20px rgba(0,0,0,0.05); background: linear-gradient(135deg, #ffffff 0%, #f4f6f9 100%); }
        .card-header { border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .btn { border-radius: 50px; }
        .form-control { border-radius: 15px; }
        .modal-content { border-radius: 25px; border: none; }
        .nav-pills .nav-link { border-radius: 50px; }
        .nav-sidebar .nav-link { border-radius: 10px; }
        .custom-select { border-radius: 15px; }
        .info-box { border-radius: 20px; }

        /* Dark Mode Card Gradient */
        body.dark-mode .card { background: linear-gradient(135deg, #343a40, #2b3035); color: #fff; }
        /* Fix 1 Page Scroll */
        html, body { height: 100vh; overflow: hidden; }
        .content-wrapper { height: calc(100vh - 57px) !important; overflow-y: auto; }

        /* Connection Status */
        .connection-status {
            position: fixed; bottom: 10px; left: 10px; z-index: 10000;
            background: rgba(0, 0, 0, 0.7); color: #fff; padding: 6px 12px;
            border-radius: 30px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1); user-select: none;
        }
        .connection-status i { margin-right: 6px; }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed layout-navbar-fixed">
<script>
    (function checkSecurity() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user) { window.location.replace('login.html'); }
    })();
</script>

<!-- Connection Status Widget -->
<div id="connection-status" class="connection-status" style="display:none;">
    <i class="fas fa-wifi" id="conn-icon"></i>
    <span id="conn-text">Kết nối</span>
    <span id="conn-ms" class="ml-2 badge badge-dark">--ms</span>
</div>

<div class="wrapper">
    <div class="settings-btn" onclick="openUserSettings()" title="Cài đặt giao diện"><i class="fas fa-cog"></i></div>
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-arrow-left mr-2"></i>Quay lại Trang chủ</a></li>
        </ul>
    </nav>

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="index.html" class="brand-link">
            <span class="brand-text font-weight-light pl-3">QUẢN LÝ SHH</span>
        </a>
        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column">
                    <li class="nav-item"><a href="index.html" class="nav-link"><i class="nav-icon fas fa-home"></i><p>Trang chủ</p></a></li>
                    <li class="nav-item"><a href="about.html" target="_blank" class="nav-link"><i class="nav-icon fas fa-question-circle"></i><p>Hướng dẫn sử dụng</p></a></li>
                    <li class="nav-item"><a href="#" class="nav-link active"><i class="nav-icon fas fa-id-card"></i><p>Hồ sơ cá nhân</p></a></li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6"><h1>Hồ sơ cá nhân</h1></div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-4">
                        <!-- Profile Image -->
                        <div class="card card-primary card-outline">
                            <div class="card-body box-profile">
                                <div class="text-center position-relative">
                                    <div class="vip-frame-container">
                                        <img class="profile-user-img img-fluid img-circle" src="" id="profileAvatar" alt="User profile picture">
                                        <div id="vipCrownArea"></div>
                                        <button class="btn btn-xs btn-primary position-absolute" style="bottom: 0; right: 0;" onclick="$('#avatarInput').click()"><i class="fas fa-camera"></i></button>
                                        <input type="file" id="avatarInput" class="d-none" accept="image/*">
                                    </div>
                                </div>
                                <h3 class="profile-username text-center mt-3" id="displayFullname">...</h3>
                                <div id="honorTagsArea" class="text-center mb-2"></div>
                                <p class="text-muted text-center" id="displayGroup">Quản lý nhóm</p>
                                <ul class="list-group list-group-unbordered mb-3">
                                    <li class="list-group-item"><b>Vai trò</b> <a class="float-right" id="displayRole">Manager</a></li>
                                    <li class="list-group-item"><b>Trạng thái</b> <a class="float-right text-success">Hoạt động</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header p-2">
                                <ul class="nav nav-pills">
                                    <li class="nav-item"><a class="nav-link active" href="#settings" data-toggle="tab">Cập nhật thông tin</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#password" data-toggle="tab">Đổi mật khẩu</a></li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content">
                                    <!-- Tab Settings -->
                                    <div class="tab-pane active" id="settings">
                                        <form class="form-horizontal">
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Tên hiển thị</label>
                                                <div class="col-sm-9">
                                                    <input type="text" class="form-control" id="inputName">
                                                    <small class="text-muted"><i class="fas fa-info-circle"></i> Giới hạn: Đổi 1 lần / 7 ngày.</small>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Tên đăng nhập (Username)</label>
                                                <div class="col-sm-9">
                                                    <input type="text" class="form-control" id="inputUsername">
                                                    <small class="text-muted"><i class="fas fa-exclamation-triangle text-warning"></i> Giới hạn: Đổi 1 lần / 30 ngày. Cần đăng nhập lại sau khi đổi.</small>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Số điện thoại</label>
                                                <div class="col-sm-9">
                                                    <input type="text" class="form-control" id="inputPhone" placeholder="0909...">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Email</label>
                                                <div class="col-sm-9">
                                                    <input type="email" class="form-control" id="inputEmail" placeholder="example@email.com">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="offset-sm-3 col-sm-9">
                                                    <label>Mã xác nhận</label>
                                                    <div class="d-flex align-items-center mb-2">
                                                        <span id="captcha_code_profile" class="bg-light border px-3 py-1 font-weight-bold mr-2 h5 mb-0" style="letter-spacing: 3px; user-select: none; border-radius: 4px;"></span>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="generateCaptcha('captcha_code_profile')"><i class="fas fa-sync"></i></button>
                                                    </div>
                                                    <input type="text" id="captcha_input_profile" class="form-control" placeholder="Nhập mã xác nhận">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="offset-sm-3 col-sm-9">
                                                    <button type="button" class="btn btn-primary" onclick="updateProfile()">Lưu thay đổi</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    <!-- Tab Password -->
                                    <div class="tab-pane" id="password">
                                        <form class="form-horizontal">
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Mật khẩu cũ</label>
                                                <div class="col-sm-9"><input type="password" class="form-control" id="oldPass"></div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Mật khẩu mới</label>
                                                <div class="col-sm-9"><input type="password" class="form-control" id="newPass"></div>
                                            </div>
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">Nhập lại mật khẩu</label>
                                                <div class="col-sm-9"><input type="password" class="form-control" id="confirmPass"></div>
                                            </div>
                                            <div class="form-group row">
                                                <div class="offset-sm-3 col-sm-9">
                                                    <button type="button" class="btn btn-danger" onclick="changePassword()">Đổi mật khẩu</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Modal User Settings -->
<div class="modal fade" id="modalUserSettings" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-magic mr-2"></i>Cài đặt Giao diện & Hiệu ứng</h5>
                <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="form-group d-flex justify-content-between align-items-center">
                    <label class="mb-0">Chế độ Tối (Dark Mode)</label>
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="user_dark_mode" onchange="toggleUserDarkMode()">
                        <label class="custom-control-label" for="user_dark_mode"></label>
                    </div>
                </div>
                <hr>
                <div class="form-group">
                    <label><i class="fas fa-cloud-sun mr-2"></i>Chọn Hiệu ứng nền</label>
                    <select id="user_effect" class="form-control" onchange="previewUserEffect()">
                        <option value="">-- Mặc định (Theo Admin) --</option>
                        <option value="jack97">Đom đóm + Chân mèo (Jack J97)</option>
                    </select>
                    <small class="text-muted mt-2 d-block" id="effect_desc"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="saveUserSettings()">Lưu Cài đặt</button>
            </div>
        </div>
    </div>
</div>

<!-- Jack J97 Audio -->
<audio id="jackAudio">
    <source src="https://github.com/trietpko2002/trietpko2002.github.io/raw/main/music/dom_dom.mp3" type="audio/mpeg">
</audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.1/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzxtNKV1ZPvO3hRhgFTuMs49QeuD5ALRnA4aRYQy20MXGLMmgLLfjkmEy3B-XM500RisA/exec";
    
    $(document).ready(function() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        $('#profileAvatar').attr('src', user.avatar || 'https://via.placeholder.com/150');
        $('#displayFullname').text(user.fullname);
        $('#displayGroup').text('Nhóm: ' + (user.group_name || user.group_id));
        $('#displayRole').text(user.role.toUpperCase());
        
        // Render VIP & Honors
        try {
            const honors = JSON.parse(user.honors || '{}');
            const avatar = $('#profileAvatar');
            
            if (honors.level === 'vip1') avatar.addClass('vip-border-1');
            else if (honors.level === 'vip2') { avatar.addClass('vip-border-2'); $('#vipCrownArea').html('<i class="fas fa-crown vip-crown"></i>'); }
            else if (honors.level === 'vip3') { avatar.addClass('vip-border-3'); $('#vipCrownArea').html('<i class="fas fa-gem vip-diamond"></i>'); }
            else if (honors.level === 'vip4') { avatar.addClass('vip-border-4'); $('#vipCrownArea').html('<i class="fas fa-crown vip-crown" style="color: #e5e4e2;"></i>'); }
            else if (honors.level === 'vip5') { avatar.addClass('vip-border-5'); $('#vipCrownArea').html('<i class="fas fa-crown vip-crown"></i>'); }
            else if (honors.level === 'vip10') { 
                avatar.addClass('vip-border-10'); 
                $('#vipCrownArea').html('<i class="fas fa-crown vip-crown-10"></i><i class="fas fa-dove vip-wing vip-wing-left"></i><i class="fas fa-dove vip-wing vip-wing-right"></i>');
                $('#displayRole').html('<span class="badge badge-warning" style="font-size: 1rem; background: linear-gradient(90deg, #ffd700, #ff8c00); color: #000;">CẤP QUẢN LÝ XỊN SÒ</span>');
            }

            if (honors.titles && honors.titles.length > 0) {
                let tags = '';
                honors.titles.forEach(t => {
                    if (t === "CẤP QUẢN LÝ XỊN SÒ") {
                        tags += `<span class="hacker-gold">${t}</span>`;
                    } else {
                        const tagClass = (honors.level === 'vip4' || honors.level === 'vip5') ? 'honor-tag gold' : 'honor-tag';
                        tags += `<span class="${tagClass}">${t}</span>`;
                    }
                });
                $('#honorTagsArea').html(tags);
            }
        } catch(e) {}
        
        // Fill Form
        $('#inputName').val(user.fullname);
        $('#inputUsername').val(user.username);
        $('#inputEmail').val(user.email || ''); // Email mới thêm
        $('#inputPhone').val(user.phone || ''); // Phone mới thêm
        
        loadUserSettings();
        generateCaptcha('captcha_code_profile');
    });

    function generateCaptcha(elementId) {
        const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let result = '';
        for (let i = 0; i < 5; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById(elementId).innerText = result;
    }

    // Xử lý Avatar
    $('#avatarInput').change(function() {
        const file = this.files[0];
        if(file) {
            resizeImage(file, 300, 300, function(base64) {
                $('#profileAvatar').attr('src', base64);
                updateAvatar(base64);
            });
        }
    });

    function resizeImage(file, maxWidth, maxHeight, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > h) { if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } } 
                else { if (h > maxHeight) { w *= maxHeight / h; h = maxHeight; } }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    async function updateAvatar(base64) {
        const user = JSON.parse(sessionStorage.getItem('user'));
        try {
            await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "UPDATE_AVATAR", payload: { username: user.username, avatar: base64 } }) });
            user.avatar = base64;
            sessionStorage.setItem('user', JSON.stringify(user));
            toastr.success("Đã cập nhật ảnh đại diện!");
        } catch(e) { toastr.error("Lỗi cập nhật ảnh"); }
    }

    async function updateProfile() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const newName = $('#inputName').val().trim();
        const newUsername = $('#inputUsername').val().trim();
        const newEmail = $('#inputEmail').val().trim();
        const newPhone = $('#inputPhone').val().trim();

        const captchaInput = $('#captcha_input_profile').val().trim();
        const captchaCode = $('#captcha_code_profile').text().trim();
        if (captchaInput.toUpperCase() !== captchaCode) return toastr.error("Mã xác nhận không đúng!");
        if(!newName || !newUsername) return toastr.warning("Tên và Username không được để trống!");

        Swal.fire({ title: 'Đang lưu...', didOpen: () => Swal.showLoading() });
        
        try {
            const response = await fetch(API_URL, { 
                method: "POST", 
                redirect: "follow",
                body: JSON.stringify({ 
                    action: "UPDATE_PROFILE", 
                    payload: { 
                        current_username: user.username,
                        new_username: newUsername,
                        fullname: newName,
                        email: newEmail,
                        phone: newPhone
                    } 
                }) 
            });
            const res = await response.json();
            
            if (res.status === 'success') {
                Swal.fire('Thành công', res.message, 'success');
                // Cập nhật session
                user.fullname = newName;
                user.email = newEmail;
                user.phone = newPhone;
                if(user.username !== newUsername) {
                    user.username = newUsername;
                    Swal.fire('Thông báo', 'Bạn đã đổi Username. Vui lòng đăng nhập lại.', 'info').then(() => {
                        sessionStorage.clear();
                        window.location.replace('login.html');
                    });
                } else {
                    sessionStorage.setItem('user', JSON.stringify(user));
                    $('#displayFullname').text(newName);
                }
                generateCaptcha('captcha_code_profile');
                $('#captcha_input_profile').val('');
            } else {
                Swal.fire('Lỗi', res.message, 'error');
            }
        } catch(e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    }

    async function changePassword() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const oldPass = $('#oldPass').val();
        const newPass = $('#newPass').val();
        const confirmPass = $('#confirmPass').val();

        if(!oldPass) return toastr.warning("Vui lòng nhập mật khẩu cũ!");
        if(newPass.length < 6) return toastr.warning("Mật khẩu quá ngắn!");
        if(newPass !== confirmPass) return toastr.error("Mật khẩu không khớp!");

        Swal.fire({ title: 'Đang xử lý...', didOpen: () => Swal.showLoading() });
        try {
            const response = await fetch(API_URL, { method: "POST", redirect: "follow", body: JSON.stringify({ action: "CHANGE_PASSWORD", payload: { username: user.username, old_pass: oldPass, new_pass: newPass } }) });
            const res = await response.json();
            if (res.status === 'success') {
                Swal.fire('Thành công', 'Đổi mật khẩu thành công!', 'success');
                $('#oldPass, #newPass, #confirmPass').val('');
            } else Swal.fire('Lỗi', res.message, 'error');
        } catch(e) { Swal.fire('Lỗi', 'Lỗi kết nối', 'error'); }
    }

    // --- USER SETTINGS ---
    function openUserSettings() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const settings = JSON.parse(localStorage.getItem(`userSettings_${user.username}`) || '{}');
        $('#user_dark_mode').prop('checked', settings.darkMode === true);
        $('#user_effect').val(settings.effect || '');
        $('#modalUserSettings').modal('show');
    }

    function toggleUserDarkMode() {
        if ($('#user_dark_mode').is(':checked')) $('body').addClass('dark-mode');
        else $('body').removeClass('dark-mode');
    }

    function previewUserEffect() {
        const effect = $('#user_effect').val();
        const desc = $('#effect_desc');
        if (effect === 'jack97') desc.text('Chế độ Fan Jack: Nhạc Đom Đóm + Chân mèo + Dark Mode.');
        else desc.text('');
    }

    function saveUserSettings() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        const settings = { darkMode: $('#user_dark_mode').is(':checked'), effect: $('#user_effect').val() };
        localStorage.setItem(`userSettings_${user.username}`, JSON.stringify(settings));
        applyUserSettings(settings);
        $('#modalUserSettings').modal('hide');
        toastr.success('Đã lưu cài đặt cá nhân!');
    }

    function loadUserSettings() {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user) return;
        const settings = JSON.parse(localStorage.getItem(`userSettings_${user.username}`) || '{}');
        applyUserSettings(settings);
    }

    function applyUserSettings(settings) {
        if (settings.darkMode) $('body').addClass('dark-mode'); else $('body').removeClass('dark-mode');
        $('.weather-overlay').remove(); $('.firefly').remove(); $('.star').remove(); $('body').removeClass('cursor-cat jack-mode');
        const audio = document.getElementById('jackAudio'); if(audio) { audio.pause(); audio.currentTime = 0; }
        const effect = settings.effect;
        if (!effect) return;
        const weatherDiv = document.createElement('div'); weatherDiv.className = `weather-overlay weather-${effect}`;
        if (effect === 'snow') {
            weatherDiv.style.backgroundImage = "url('data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIj48Y2lyY2xlIGN4PSI1IiBjeT0iNSIgcj0iMiIgZmlsbD0id2hpdGUiIG9wYWNpdHk9IjAuNSIvPjwvc3ZnPg==')";
            document.body.appendChild(weatherDiv);
        } else if (effect === 'dandelion' || effect === 'rain' || effect === 'sunny') {
            document.body.appendChild(weatherDiv);
        } else if (effect === 'starry') {
            document.body.appendChild(weatherDiv);
            for(let i=0; i<50; i++) { const star = document.createElement('div'); star.className = 'star'; star.style.top = Math.random() * 100 + '%'; star.style.left = Math.random() * 100 + '%'; star.style.animationDelay = Math.random() * 2 + 's'; weatherDiv.appendChild(star); }
        } else if (effect === 'jack97') {
            $('body').addClass('jack-mode');
            for(let i=0; i<20; i++) { const f = document.createElement('div'); f.className = 'firefly'; f.style.top = Math.random() * 100 + 'vh'; f.style.left = Math.random() * 100 + 'vw'; f.style.animationDuration = (Math.random() * 5 + 5) + 's'; f.style.animationDelay = Math.random() * 5 + 's'; document.body.appendChild(f); }
            if(audio) audio.play().catch(e => console.log("Autoplay blocked", e));
        }
    }

    // --- CONNECTION STATUS LOGIC ---
    function updateConnectionStatus() {
        const statusEl = document.getElementById('connection-status');
        const iconEl = document.getElementById('conn-icon');
        const textEl = document.getElementById('conn-text');
        const msEl = document.getElementById('conn-ms');
        
        if(!statusEl) return;
        if (!navigator.onLine) { setConnStatus('offline', 'Mất kết nối', '--'); return; }

        const start = Date.now();
        fetch('manifest.json?t=' + start, { method: 'HEAD', cache: 'no-store' })
        .then(() => {
            const latency = Date.now() - start;
            if (latency < 300) setConnStatus('online', 'Tốt', latency + 'ms');
            else if (latency < 1000) setConnStatus('slow', 'Trung bình', latency + 'ms');
            else setConnStatus('offline', 'Yếu', latency + 'ms');
        })
        .catch(() => setConnStatus('offline', 'Lỗi mạng', '--'));
    }

    function setConnStatus(type, text, ms) {
        const el = document.getElementById('connection-status');
        const icon = document.getElementById('conn-icon');
        const txt = document.getElementById('conn-text');
        const badge = document.getElementById('conn-ms');
        
        el.style.display = 'flex';
        txt.innerText = text; badge.innerText = ms;
        el.style.border = '1px solid rgba(255,255,255,0.1)'; el.style.background = 'rgba(0, 0, 0, 0.7)';
        
        if(type === 'online') { icon.className = 'fas fa-wifi'; badge.className = 'ml-2 badge badge-success'; el.style.borderColor = '#28a745'; icon.style.color = '#28a745'; }
        else if(type === 'slow') { icon.className = 'fas fa-network-wired'; badge.className = 'ml-2 badge badge-warning'; el.style.borderColor = '#ffc107'; icon.style.color = '#ffc107'; }
        else { icon.className = 'fas fa-exclamation-triangle'; badge.className = 'ml-2 badge badge-danger'; el.style.borderColor = '#dc3545'; el.style.background = 'rgba(50, 0, 0, 0.8)'; icon.style.color = '#dc3545'; }
    }

    setInterval(updateConnectionStatus, 5000);
    window.addEventListener('load', updateConnectionStatus);
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', () => setConnStatus('offline', 'Mất kết nối', '--'));
</script>
</body>
</html>